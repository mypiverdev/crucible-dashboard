<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CremoLogix — Architecture</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --navy: #1E3A5F; --blue: #2D7DD2; --green: #28A745; --amber: #F4A261;
  --red: #E63946; --light-bg: #F8F9FA; --text: #333333; --text-light: #666666;
  --border: #DEE2E6; --white: #FFFFFF;
}
@page { size: letter; margin: 0.75in; }
html { font-size: 10.5pt; }
body { font-family: system-ui, 'Segoe UI', sans-serif; color: var(--text); line-height: 1.6; background: var(--white); }
@media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } .cover { box-shadow: none !important; } .no-print { display: none !important; } }
.cover { background: linear-gradient(135deg, #1E3A5F 0%, #0F1F33 60%, #162D4A 100%); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 100vh; position: relative; overflow: hidden; }
.cover::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(ellipse at 30% 20%, rgba(45,125,210,0.12) 0%, transparent 50%), radial-gradient(ellipse at 70% 80%, rgba(45,125,210,0.08) 0%, transparent 50%); pointer-events: none; }
.cover-content { position: relative; z-index: 1; max-width: 700px; }
.cover .brand-mark { font-size: 1.4rem; font-weight: 300; letter-spacing: 0.35em; text-transform: uppercase; color: rgba(255,255,255,0.7); margin-bottom: 60px; border: 1px solid rgba(255,255,255,0.2); display: inline-block; padding: 10px 28px; border-radius: 4px; }
.cover h1 { font-size: 3rem; color: white; margin-bottom: 20px; font-weight: 700; letter-spacing: -0.02em; }
.cover .subtitle { font-size: 1.3rem; color: rgba(255,255,255,0.8); font-weight: 300; margin-bottom: 60px; line-height: 1.5; }
.cover .divider-line { width: 80px; height: 2px; background: var(--blue); margin: 0 auto 40px; }
.cover .meta { font-size: 0.95rem; color: rgba(255,255,255,0.6); line-height: 2; }
.cover .confidential { position: absolute; bottom: 40px; left: 0; right: 0; text-align: center; font-size: 0.8rem; letter-spacing: 0.15em; text-transform: uppercase; color: rgba(255,255,255,0.35); }
.page-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 56px; border-bottom: 2px solid var(--navy); font-size: 0.78rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.08em; }
.page-header .logo-text { font-weight: 700; color: var(--navy); letter-spacing: 0.15em; }
.content { padding: 48px 56px; max-width: 900px; margin: 0 auto; }
h1 { font-size: 2.4rem; color: var(--navy); font-weight: 700; letter-spacing: -0.02em; line-height: 1.2; margin: 36px 0 16px; }
h2 { font-size: 1.6rem; color: var(--navy); font-weight: 700; letter-spacing: -0.01em; line-height: 1.3; margin: 32px 0 14px; border-bottom: 2px solid var(--blue); padding-bottom: 8px; }
h3 { font-size: 1.2rem; color: var(--navy); font-weight: 600; line-height: 1.3; margin: 24px 0 10px; }
h4 { font-size: 1.05rem; color: var(--navy); font-weight: 600; margin: 18px 0 8px; }
p { margin-bottom: 14px; line-height: 1.7; }
strong { color: var(--navy); }
ul, ol { margin-bottom: 16px; padding-left: 0; list-style: none; }
ul li, ol li { padding: 6px 0 6px 26px; position: relative; line-height: 1.6; }
ul li::before { content: '\25B6'; position: absolute; left: 0; color: var(--blue); font-size: 0.55rem; top: 12px; }
ol { counter-reset: item; }
ol li { counter-increment: item; }
ol li::before { content: counter(item); position: absolute; left: 0; width: 22px; height: 22px; background: var(--navy); color: #fff; border-radius: 50%; font-size: 0.7rem; font-weight: 700; display: flex; align-items: center; justify-content: center; top: 8px; }
table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.92rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
thead th { background: var(--navy); color: white; padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.04em; border: 1px solid #15304D; }
tbody td { padding: 11px 16px; border: 1px solid var(--border); vertical-align: top; line-height: 1.5; }
tbody tr:nth-child(even) { background: #F8F9FA; }
tbody tr:hover { background: #EBF3FB; }
blockquote { border-left: 4px solid var(--blue); background: #EBF3FB; padding: 20px 24px; border-radius: 0 8px 8px 0; margin: 20px 0; }
blockquote p:last-child { margin-bottom: 0; }
code { background: rgba(45,125,210,0.08); padding: 2px 7px; border-radius: 4px; font-size: 0.88rem; color: var(--blue); font-weight: 500; }
pre { background: #1b2e4a; color: #e2e8f0; padding: 20px 24px; border-radius: 10px; overflow-x: auto; margin: 20px 0; box-shadow: 0 4px 12px rgba(26,43,74,0.12); }
pre code { background: none; padding: 0; color: #e2e8f0; font-size: 0.85rem; }
hr { border: none; height: 2px; background: linear-gradient(90deg, var(--blue), transparent); margin: 32px 0; }
a { color: var(--blue); text-decoration: none; font-weight: 500; }
a:hover { text-decoration: underline; }
img { max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin: 16px 0; }
.back-link { position: fixed; top: 16px; right: 20px; z-index: 100; background: var(--navy); color: white; padding: 8px 18px; border-radius: 6px; font-size: 0.82rem; font-weight: 600; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: background 0.15s; }
.back-link:hover { background: #264E7A; text-decoration: none; color: white; }
</style>
</head>
<body>
<a class="back-link no-print" href="../..">&#8592; Dashboard</a>
<div class="cover">
  <div class="cover-content">
    <div class="brand-mark">CremoLogix</div>
    <h1>Architecture</h1>
    <div class="subtitle">AI-assisted underwriting platform for CDFIs — automates financial analysis while maintaining full human control over credit decisions</div>
    <div class="divider-line"></div>
    <div class="meta">February 10, 2026<br>Crucible Product Development Pipeline</div>
  </div>
  <div class="confidential">Confidential</div>
</div>
<div class="page-header no-print">
  <span class="logo-text">CremoLogix</span>
  <span>Architecture</span>
</div>
<div class="content" id="content"></div>
<script>
  const md = "# CremoLogix -- Architecture Document\n\n**Version:** 2.0\n**Date:** February 9, 2026\n**Status:** Phase 3 Review\n**Companion to:** `specification.md` (authoritative for schema, API contracts, workflow, and screen inventory)\n\n---\n\n## 1. Architecture Overview\n\nThis document covers **system design decisions, deployment architecture, data flow patterns, and infrastructure design** for CremoLogix MVP. It complements `specification.md` (which defines the schema, API contracts, AI pipeline, and workflow details) — it does not duplicate them.\n\n### 1.1 Guiding Principles\n\n| Principle | Implementation |\n|-----------|---------------|\n| **Human Decision Mandate** | No automated credit decisions. All approval/denial paths require Credit Manager action. |\n| **AI as Sidecar** | CremoLogix operates alongside the LOS, never inside it. Data pushes out; no dependencies on LOS availability. |\n| **Multi-Tenant from Day 1** | tenant_id on all tables, RLS policies, JWT-derived tenant context — even though MVP is single-tenant (Siura Capital). |\n| **Audit Everything** | Append-only audit trail. Every mutation, AI decision, override, and integration event logged with full context. |\n| **Progressive Computation** | Financial analysis, scoring, and deal health update incrementally as data arrives — no \"big bang\" recalculation. |\n| **Fail Safe, Not Silent** | All external integration failures surface to users with clear status. No silent data loss. |\n\n### 1.2 Technology Decisions\n\n| Decision | Choice | Rationale |\n|----------|--------|-----------|\n| Cloud Platform | **Microsoft Azure** | Client has Azure credits; strong PaaS offerings for containers, PostgreSQL, Redis |\n| Core API Framework | **NestJS** (Node.js 20 + TypeScript) | Module system, dependency injection, guards/interceptors for RBAC + audit, OpenAPI generation |\n| AI/ML Pipeline | **Python 3.11 + FastAPI** | ML ecosystem (PyTorch, scikit-learn), Azure Document Intelligence SDK, LLM orchestration, separate scaling |\n| Frontend | **React 18 + TypeScript + Vite** | Component reuse across 7 portals, TailwindCSS + shadcn/ui design system |\n| Database | **Azure Database for PostgreSQL Flexible Server** | RLS for tenant isolation, JSONB for flexible data, partitioning for audit logs |\n| Cache / Queue | **Azure Cache for Redis 7** | Session store, rate limit counters, BullMQ job queues |\n| Object Storage | **Azure Blob Storage** (Azurite for dev) | Document storage with encryption, SAS URLs, lifecycle policies |\n| Container Orchestration | **Azure Container Apps** (MVP) | Serverless containers, built-in scaling, Dapr sidecar support. AKS post-MVP. |\n| OCR | **Azure Document Intelligence** | Superior financial document handling, native Azure integration |\n| Infrastructure as Code | **Terraform** (AzureRM provider) | Cloud-agnostic definitions, state management, environment parity |\n| CI/CD | **GitHub Actions** | PR checks, automated testing, staging/production deployment pipelines |\n| ORM | **Prisma** | Type-safe queries, migration system, excellent NestJS integration |\n| Credit Bureau | **Experian** (soft pull) | Largest small business data coverage, Connect API |\n| KYC Provider | **Persona** | Best-in-class developer API, strong liveness detection, mobile-optimized |\n| Background Check | **Checkr** | Developer-friendly API, fast turnaround, webhook-native |\n\n---\n\n## 2. System Topology\n\n### 2.1 Component Architecture\n\n```\n                          ┌─────────────────────────────────────────┐\n                          │         Azure Front Door (CDN)           │\n                          │   TLS termination, WAF, static assets    │\n                          └─────────────────┬───────────────────────┘\n                                            │\n                          ┌─────────────────┴───────────────────────┐\n                          │       Azure Container Apps Environment    │\n                          │   VNet-integrated, auto-scaling            │\n                          │   /api/* → Core API    /ml/* → ML Pipeline│\n                          └───────┬─────────────────────┬───────────┘\n                                  │                     │\n                    ┌─────────────┴──────┐    ┌────────┴──────────┐\n                    │   CORE API (NestJS) │    │  ML PIPELINE      │\n                    │   Container App     │    │  (FastAPI)        │\n                    │   2-4 replicas      │    │  Container App    │\n                    │                     │    │  1-2 replicas     │\n                    │  ┌───────────────┐  │    │  ┌─────────────┐  │\n                    │  │ Auth Module   │  │    │  │ OCR Service  │  │\n                    │  │ Case Module   │  │    │  │ Classifier   │  │\n                    │  │ Financial Mod │  │    │  │ Extractor    │  │\n                    │  │ Scoring Mod   │  │    │  │ Risk NLP     │  │\n                    │  │ Review Module │  │    │  │ Narrative    │  │\n                    │  │ Admin Module  │  │    │  │ Memo Builder │  │\n                    │  │ PreQual Mod   │  │    │  │ Question Gen │  │\n                    │  │ Audit Module  │  │    │  └─────────────┘  │\n                    │  │ Notif Module  │  │    │                    │\n                    │  │ Integ Module  │  │    │                    │\n                    │  └───────────────┘  │    └────────┬──────────┘\n                    └───────┬─────────────┘             │\n                            │                           │\n              ┌─────────────┼───────────────────────────┘\n              │             │\n    ┌─────────┴──────┐ ┌───┴──────────┐ ┌──────────────┐\n    │ PostgreSQL 16  │ │Azure Cache   │ │ Azure Blob   │\n    │ Flexible Server│ │for Redis 7   │ │ Storage      │\n    │ Zone-Redundant │ │              │ │              │\n    │ ~30 tables     │ │ Sessions,    │ │ Documents,   │\n    │ RLS on all     │ │ Job Queues,  │ │ Exports,     │\n    │ Partitioned    │ │ Rate Limits  │ │ OCR text     │\n    │ audit_logs     │ │              │ │ AES-256 SSE  │\n    └────────────────┘ └──────────────┘ └──────────────┘\n              │\n    ┌─────────┴──────────────────────────────────────┐\n    │            EXTERNAL SERVICES                    │\n    │  ┌────────┐ ┌───────┐ ┌───────┐ ┌───────────┐  │\n    │  │Experian│ │Persona│ │Checkr │ │ Salesforce │  │\n    │  │(Credit)│ │(KYC)  │ │(Bkgnd)│ │ CRM       │  │\n    │  └────────┘ └───────┘ └───────┘ └───────────┘  │\n    │  ┌──────────────┐ ┌─────────┐ ┌─────────┐      │\n    │  │Azure Doc     │ │SendGrid │ │ LOS API │      │\n    │  │Intelligence  │ │(Email)  │ │(Sidecar)│      │\n    │  └──────────────┘ └─────────┘ └─────────┘      │\n    └────────────────────────────────────────────────┘\n```\n\n### 2.2 Service Communication\n\n| From | To | Protocol | Pattern |\n|------|----|----------|---------|\n| React SPA → Core API | HTTPS REST | Synchronous request/response via Azure Front Door |\n| Core API → ML Pipeline | Internal HTTP (VNet) | Synchronous for small ops, async via BullMQ for heavy ops |\n| Core API → PostgreSQL | TCP (pg driver) | Connection pool (max 20), RLS session var set per request |\n| Core API → Redis | TCP (TLS) | Session reads, rate limit checks, job enqueue |\n| Core API → Blob Storage | HTTPS (Azure SDK) | SAS URL generation, direct upload/download |\n| Core API → External APIs | HTTPS REST | Webhook callbacks, OAuth flows, retry with backoff |\n| ML Pipeline → Blob Storage | HTTPS (azure-storage-blob) | Read document files for OCR processing |\n| ML Pipeline → PostgreSQL | TCP | Write extraction results, normalization output |\n| ML Pipeline → Azure Doc Intelligence | HTTPS | OCR, form recognition, table extraction |\n| BullMQ Worker → ML Pipeline | Internal HTTP | Dequeue job, invoke ML endpoint, update status |\n\n### 2.3 Inter-Module Dependencies (NestJS)\n\n```\nAuthModule ──────────────────────────────────────┐\n  │                                              │\n  ├── TenantModule (middleware: set RLS context)  │\n  │                                              │\nPreQualModule ← CreditBureauProvider             │\n  │            ← KYCProvider                     │\n  │            ← BackgroundCheckProvider         │\n  │                                              │\nCaseModule ← WorkflowModule                      │\n  │                                              │\nDocumentModule ← S3Provider                      │\n  │                                              │\n  ├── ExtractionModule (calls ML Pipeline)       │\n  │     │                                        │\n  │     ├── NormalizationModule (FNE)            │\n  │     │     │                                  │\n  │     │     ├── FinancialAnalysisModule         │\n  │     │     │     │                            │\n  │     │     │     ├── RiskModule               │\n  │     │     │     │     │                      │\n  │     │     │     │     ├── FollowUpModule      │\n  │     │     │     │                            │\n  │     │     │     ├── ScoringModule             │\n  │     │     │     │     │                      │\n  │     │     │     │     ├── PacketModule        │\n  │     │     │     │           │                │\n  │     │     │     │           ├── ReviewModule  │\n  │                                              │\n  ├── DealHealthModule (reads pre-qual + financial)│\n  │                                              │\n  ├── NotificationModule ← SendGridProvider      │\n  │                                              │\n  ├── IntegrationModule ← SalesforceProvider     │\n  │                     ← LOSProvider            │\n  │                                              │\n  ├── AuditModule (interceptor on all mutations)  │\n  │                                              │\n  └── AdminModule (configures all above)          │\n```\n\n---\n\n## 3. Data Flow Patterns\n\n### 3.1 Pre-Qualification Flow (B-01 → Case Creation)\n\n```\nBorrower submits Easy Apply (B-01)\n  │\n  ├── [1] Application created (status: draft)\n  │     └── Demographic data collected (Section 1071 — separate screen, firewalled)\n  │\n  ├── [2] Credit bureau soft pull (async, ~2s)\n  │     ├── PASS (score >= threshold) → proceed\n  │     └── FAIL → B-03 holding message + ECOA adverse action email\n  │\n  ├── [3] KYC verification session created → SMS link to B-04\n  │     ├── Borrower completes photo ID + selfie\n  │     ├── Provider callback → PASS → proceed\n  │     └── FAIL → B-03 + manual review queue\n  │\n  ├── [4] Background check triggered (async, 1-3 business days)\n  │     ├── Results → IA-02 (Intake Agent review)\n  │     ├── Intake Agent: Approve → proceed\n  │     └── Intake Agent: Reject (with reason) → end\n  │\n  ├── [5] Initial Deal Health Score computed\n  │     ├── Score >= auto-exit threshold → proceed\n  │     └── Score < threshold → flag for review\n  │\n  └── [6] Case created → Phase 1 (Configuration) → underwriter assigned\n```\n\n### 3.2 Document Processing Flow (Upload → Normalized Financials)\n\n```\nDocument uploaded (Borrower B-09 or Underwriter UW-05)\n  │\n  ├── [1] S3 upload via pre-signed URL\n  │     └── Metadata record in `documents` table (status: uploaded)\n  │\n  ├── [2] Virus scan (ClamAV Lambda)\n  │     ├── Clean → proceed\n  │     └── Infected → quarantine, notify user\n  │\n  ├── [3] BullMQ job enqueued → ML Pipeline\n  │     │\n  │     ├── [3a] OCR (Textract for complex, pdfplumber for text PDFs)\n  │     │     └── Raw text + bounding boxes → S3\n  │     │\n  │     ├── [3b] Classification (DistilBERT)\n  │     │     └── Document type identified (tax_return_business, bank_statement, etc.)\n  │     │\n  │     ├── [3c] Extraction (LLM with type-specific prompts)\n  │     │     └── Structured data + per-field confidence → `extraction_results`\n  │     │\n  │     └── [3d] Validation (cross-field, cross-document, YoY checks)\n  │           └── Status: auto_validated | manual_review_needed\n  │\n  ├── [4] FNE Normalization (triggered when extraction validated)\n  │     ├── Entity type routing (Sole Prop → Schedule C, S-Corp → 1120-S, etc.)\n  │     ├── Line-by-line mapping to standardized buckets\n  │     ├── Cross-validation (10 rules: XV-001 through XV-010)\n  │     └── Output → `normalized_financials` table\n  │\n  └── [5] Financial Analysis auto-triggered\n        ├── 9 sub-analyses computed from normalized data\n        ├── Deal Health Score updated (progressive)\n        └── Risk assessment triggered when all analyses complete\n```\n\n### 3.3 Underwriting Decision Flow (Analysis → Credit Decision)\n\n```\nFinancial Analysis Complete\n  │\n  ├── [1] Risk Assessment\n  │     ├── Rule-based identification (DSCR, D/E, collateral, etc.)\n  │     ├── AI-augmented identification (LLM review)\n  │     └── Risk narrative generated → `risk_items` table\n  │\n  ├── [2] Follow-Up Questions (if gaps identified)\n  │     ├── AI generates context-aware questions\n  │     ├── Underwriter reviews, approves, sends to borrower\n  │     ├── Borrower responds (B-09 or email)\n  │     └── Narrative conversion (first-person → third-person)\n  │\n  ├── [3] Override Management\n  │     ├── Underwriter can override any AI-produced value\n  │     └── Mandatory rationale logged (immutable audit)\n  │\n  ├── [4] Scoring\n  │     ├── Model → Categories → Factors evaluated\n  │     ├── Progressive: re-normalizes weights as data arrives\n  │     ├── Underwriter MUST confirm score (cannot auto-advance)\n  │     └── Recommendation: approve | approve_with_conditions | decline | insufficient_data\n  │\n  ├── [5] Packet Assembly\n  │     ├── 17-section credit memo assembled by LLM\n  │     ├── Underwriter edits in TipTap WYSIWYG editor\n  │     ├── Quality check (all sections, figures match, no placeholders)\n  │     └── Finalized packet → PDF/Word export\n  │\n  └── [6] Credit Review (Human Decision Mandate)\n        ├── Credit Manager reviews complete package (read-only)\n        ├── Decision: Approve | Approve with Conditions | Return | Decline\n        ├── Return → loops back to override_management or follow_up_questions\n        └── Approve/Decline → export_closeout → LOS push → case archived\n```\n\n---\n\n## 4. Multi-Tenant Architecture\n\n### 4.1 Isolation Strategy\n\n**Approach:** Shared database, shared schema, row-level tenant isolation.\n\n```\n                    ┌─────────────────────────┐\n                    │     JWT Token            │\n                    │  {                       │\n                    │    sub: \"user-uuid\",     │\n                    │    tenant_id: \"siura\",   │\n                    │    roles: [\"underwriter\"]│\n                    │  }                       │\n                    └──────────┬──────────────┘\n                               │\n                    ┌──────────▼──────────────┐\n                    │  NestJS TenantMiddleware │\n                    │  Sets PostgreSQL var:    │\n                    │  app.current_tenant_id   │\n                    └──────────┬──────────────┘\n                               │\n                    ┌──────────▼──────────────┐\n                    │  PostgreSQL RLS Policy   │\n                    │  ON SELECT/INSERT/UPDATE │\n                    │  USING (tenant_id =      │\n                    │    current_setting(       │\n                    │    'app.current_tenant_id'│\n                    │    )::uuid)              │\n                    └─────────────────────────┘\n```\n\n**Defense in Depth:**\n1. JWT contains `tenant_id` — cannot be spoofed (RS256 signed)\n2. NestJS middleware sets PostgreSQL session variable before every query\n3. RLS policies enforce isolation at the database level\n4. Application code also includes `WHERE tenant_id = ?` as a belt-and-suspenders check\n5. Integration credentials are stored per-tenant in `integration_configs`\n\n### 4.2 Tenant Onboarding Flow\n\n```\n1. Create tenant record in `tenants` table\n2. Create admin user for tenant\n3. Configure loan products (AD-02)\n4. Configure scoring model (AD-03)\n5. Configure workflow (AD-04)\n6. Configure document checklists (AD-05)\n7. Configure integrations (AD-08) — credit bureau, KYC, background check, Salesforce\n8. Enable CDFI reporting modules (AD-11)\n9. Run test application end-to-end\n```\n\n### 4.3 Scaling Path\n\n| Tenant Count | Strategy | Trigger |\n|-------------|----------|---------|\n| 1-10 | Shared DB, shared schema, RLS | MVP |\n| 10-50 | Add read replicas, connection pooling (PgBouncer) | Query latency > 200ms |\n| 50+ | Schema-per-tenant or dedicated DB per large tenant | Regulatory requirement or data volume |\n\n---\n\n## 5. Security Architecture\n\n### 5.1 Authentication Flow\n\n```\nLogin Request\n  │\n  ├── Validate credentials (bcrypt compare)\n  ├── Check: account locked? email verified? tenant active?\n  │\n  ├── Generate RS256 access token (15-min expiry)\n  │     Claims: sub, tenant_id, roles[], email, jti\n  │\n  ├── Generate opaque refresh token → Redis (7-day TTL)\n  │     Key: refresh:{jti}  Value: {user_id, tenant_id, session_id}\n  │\n  ├── Track session (max 5 concurrent per user)\n  │     Exceeds 5 → evict oldest session\n  │\n  └── Return: { access_token, refresh_token, expires_in: 900 }\n\nToken Refresh\n  │\n  ├── Validate refresh token exists in Redis\n  ├── Generate new access token + new refresh token (rotation)\n  ├── Delete old refresh token from Redis\n  └── Return new token pair\n```\n\n### 5.2 Authorization Matrix\n\n| Action | Borrower | Underwriter | Credit Manager | Admin |\n|--------|----------|-------------|----------------|-------|\n| Submit application | Own only | — | — | — |\n| Upload documents | Own case | Assigned case | — | — |\n| View financial analysis | — | Assigned case | All cases (read-only) | All |\n| Override AI data | — | Assigned case | — | — |\n| Confirm scoring | — | Assigned case | — | — |\n| Submit review decision | — | — | All cases | — |\n| Configure scoring model | — | — | — | Yes |\n| Manage users | — | — | — | Yes |\n| View audit logs | Own actions | Own cases | All cases | All |\n\n### 5.3 Data Encryption\n\n| Layer | Method | Key Management |\n|-------|--------|----------------|\n| Transport | TLS 1.3 (min 1.2) | Azure Front Door managed certificates |\n| Database at rest | PostgreSQL Flexible Server encryption | Azure-managed keys (automatic rotation) |\n| Blob Storage at rest | SSE with Azure-managed keys (AES-256) | Azure Storage service encryption |\n| Integration credentials | AES-256-GCM | Azure Key Vault (customer-managed key) |\n| SSN field | Application-level AES-256 | Dedicated Key Vault key, masked in UI (last 4) |\n\n### 5.4 API Security Layers\n\n```\nRequest → Rate Limiter → CORS Check → JWT Validation → Tenant Context\n  → RBAC Guard → Input Validation (Zod) → Business Logic → Audit Log\n```\n\nRate limits per role: Borrower 60/min, UW/CM 120/min, Admin 200/min, Unauth 20/min.\n\n---\n\n## 6. Infrastructure Architecture (Azure)\n\n### 6.1 MVP Deployment Topology\n\n```\nRegion: East US\n├── Resource Group: rg-cremologix-{env}\n│\n├── Azure Front Door (Standard)\n│   ├── WAF policy (OWASP 3.2 ruleset)\n│   ├── Custom domain: cremologix.com\n│   ├── Origin: Container Apps environment (API)\n│   └── Origin: Static Web App (SPA)\n│\n├── Virtual Network (10.0.0.0/16)\n│   ├── Subnet: snet-apps (10.0.1.0/24)\n│   │   └── Container Apps Environment (VNet-integrated)\n│   │       ├── Core API (NestJS) — 2-4 replicas, 1 vCPU / 2GB\n│   │       ├── ML Pipeline (FastAPI) — 1-2 replicas, 2 vCPU / 4GB\n│   │       └── BullMQ Worker — 1-2 replicas, 1 vCPU / 2GB\n│   │\n│   ├── Subnet: snet-data (10.0.2.0/24)\n│   │   ├── PostgreSQL Flexible Server (D2s_v3, Zone-Redundant HA)\n│   │   └── Azure Cache for Redis (C1 Standard, 1GB)\n│   │\n│   └── Subnet: snet-private-endpoints (10.0.3.0/24)\n│       ├── Private Endpoint: Blob Storage\n│       └── Private Endpoint: Key Vault\n│\n├── Storage Account: stcremologix{env}\n│   ├── Container: documents (versioning enabled)\n│   ├── Container: exports\n│   ├── Container: ocr-text\n│   └── Lifecycle: Cool tier after 90 days, Archive after 1 year\n│\n├── Azure Static Web Apps\n│   └── React SPA (auto-deploy from GitHub)\n│\n├── Azure Key Vault\n│   ├── db-connection-string\n│   ├── jwt-signing-keys (RS256 keypair)\n│   ├── external-api-keys (Experian, Persona, Checkr, Salesforce)\n│   └── ssn-encryption-key\n│\n├── Azure Document Intelligence\n│   └── S0 tier (custom models + prebuilt tax forms)\n│\n├── Azure Functions (Consumption Plan)\n│   └── ClamAV virus scanner (triggered on blob upload)\n│\n├── Azure Monitor\n│   ├── Application Insights (Core API + ML Pipeline)\n│   ├── Log Analytics Workspace (structured JSON logs)\n│   ├── Custom metrics (case throughput, AI latency)\n│   └── Alert rules (error rate, latency, queue depth)\n│\n└── Azure Container Registry\n    └── cremologixcr{env} (Basic tier)\n```\n\n### 6.2 Estimated Monthly Cost (MVP)\n\n| Resource | Specification | Est. Cost |\n|----------|--------------|-----------|\n| Container Apps (Core API, 2 replicas) | 1 vCPU / 2GB x 2 | ~$60 |\n| Container Apps (ML Pipeline, 1 replica) | 2 vCPU / 4GB x 1 | ~$60 |\n| Container Apps (Worker, 1 replica) | 1 vCPU / 2GB x 1 | ~$30 |\n| PostgreSQL Flexible Server (Zone-HA) | D2s_v3 (2 vCPU / 8GB) | ~$140 |\n| Azure Cache for Redis | C1 Standard (1GB) | ~$40 |\n| Blob Storage (50GB) | Hot tier | ~$5 |\n| Azure Front Door (Standard) | + WAF | ~$35 |\n| Static Web Apps | Free tier (or Standard $9) | $0 |\n| Key Vault | ~20 secrets + 10K operations | ~$5 |\n| Azure Container Registry | Basic | ~$5 |\n| Azure Monitor + App Insights | Logs + metrics | ~$30 |\n| Azure Functions (ClamAV) | ~2000 invocations/mo | ~$5 |\n| Document Intelligence | S0, ~2000 pages/mo | ~$200 |\n| **Azure Subtotal** | | **~$615/mo** |\n| LLM API (Anthropic Claude) | ~2000 docs/mo | ~$500/mo |\n| SendGrid (5000 emails/mo) | Pro plan | $90/mo |\n| Experian Connect API | ~100 pulls/mo | ~$200/mo |\n| Persona (KYC) | ~100 verifications/mo | ~$150/mo |\n| Checkr (Background) | ~80 checks/mo | ~$200/mo |\n| GitHub Team | 4 seats | $44/mo |\n| **Total** | | **~$1,799/mo** |\n\n*Note: Azure credits can offset the Azure Subtotal (~$615/mo). External service costs (LLM, SendGrid, Experian, Persona, Checkr) are billed separately.*\n\n### 6.3 Scaling Triggers\n\n| Metric | Threshold | Action |\n|--------|-----------|--------|\n| API response time p95 | > 500ms for 10 min | Container Apps auto-scale: 2 → 4 replicas |\n| ML Pipeline queue depth | > 50 jobs for 5 min | Container Apps auto-scale: 1 → 2 replicas |\n| PostgreSQL CPU | > 70% sustained | Scale up to D4s_v3 |\n| Redis memory | > 80% | Scale to C2 Standard |\n| Blob Storage | > 100 GB | Enable Cool tier lifecycle rules |\n\n### 6.4 Azure Container Apps Configuration\n\n```yaml\n# Core API Container App\nproperties:\n  configuration:\n    ingress:\n      external: true\n      targetPort: 3000\n      transport: http\n    secrets:\n      - name: db-connection-string\n        keyVaultUrl: https://kv-cremologix.vault.azure.net/secrets/db-connection-string\n  template:\n    containers:\n      - name: core-api\n        image: cremologixcr.azurecr.io/core-api:latest\n        resources:\n          cpu: 1.0\n          memory: 2Gi\n        env:\n          - name: DATABASE_URL\n            secretRef: db-connection-string\n          - name: REDIS_URL\n            value: rediss://cremologix-redis.redis.cache.windows.net:6380\n          - name: AZURE_STORAGE_ACCOUNT\n            value: stcremologixprod\n    scale:\n      minReplicas: 2\n      maxReplicas: 4\n      rules:\n        - name: http-scaling\n          http:\n            metadata:\n              concurrentRequests: \"50\"\n```\n\n---\n\n## 7. Error Handling & Resilience\n\n### 7.1 External Integration Resilience\n\nAll external API calls follow the same pattern:\n\n```\n┌─────────────┐     ┌──────────┐     ┌──────────┐\n│ Attempt 1   │────>│ Attempt 2│────>│ Attempt 3│────> Circuit Open\n│ (immediate) │     │ (5s wait)│     │ (15s wait)│     (30s cooldown)\n└─────────────┘     └──────────┘     └──────────┘\n```\n\n- **Retry policy:** 3 attempts, exponential backoff (1s, 5s, 15s)\n- **Circuit breaker:** Opens after 5 consecutive failures. Half-open after 30s cooldown. Closes after 2 successes.\n- **Fallback behavior per service:**\n\n| Service | Fallback |\n|---------|----------|\n| Experian (Credit Bureau) | Queue for retry. Manual entry available. |\n| Persona (KYC) | Session expires. Borrower can retry (3 attempts). |\n| Checkr (Background Check) | Queue for retry. Intake Agent notified of delay. |\n| Azure Doc Intelligence (OCR) | Fall back to Tesseract (self-hosted container). |\n| SendGrid (Email) | Fall back to Azure Communication Services. |\n| Salesforce | Events queued in Redis. Retry on next sync cycle. |\n| LOS API | Export queued. Retry on next cycle. Manual download always available. |\n\n### 7.2 Data Consistency\n\n- **Database transactions:** All multi-table writes wrapped in transactions\n- **Idempotent operations:** Webhook callbacks deduplicated by provider reference ID\n- **Optimistic locking:** `updated_at` checked on concurrent case updates\n- **Eventual consistency:** Deal Health Score recomputed asynchronously after data changes (< 5s lag)\n\n---\n\n## 8. Monitoring & Observability\n\n### 8.1 Three Pillars\n\n| Pillar | Tool | Key Metrics |\n|--------|------|-------------|\n| **Logs** | Azure Log Analytics (structured JSON via Application Insights) | Request/response, errors, AI pipeline events |\n| **Metrics** | Azure Monitor Custom Metrics + Application Insights | API latency, queue depth, case throughput, AI confidence |\n| **Traces** | Application Insights (distributed tracing) | End-to-end request tracing across Core API + ML Pipeline |\n\n### 8.2 Business Dashboards (Azure Monitor)\n\n| Dashboard | Key Metrics |\n|-----------|-------------|\n| Pipeline Health | Cases/day, avg cycle time, SLA breach rate, phase distribution |\n| AI Performance | OCR accuracy, extraction confidence, classification accuracy, processing time |\n| Integration Status | Credit bureau success rate, KYC pass rate, Salesforce sync lag |\n| System Health | API error rate, p95 latency, database connections, queue depth |\n\n### 8.3 Alerting\n\n| Alert | Condition | Channel |\n|-------|-----------|---------|\n| High Error Rate | > 1% 5xx for 5 min | PagerDuty + Slack |\n| Slow API | p95 > 1s for 10 min | Slack |\n| Queue Backup | > 100 pending jobs for 15 min | Slack |\n| Database Connection Exhaustion | > 18 of 20 connections for 5 min | PagerDuty |\n| Integration Failure | Circuit breaker opened | Slack + email to admin |\n| SLA Breach | Case in phase > SLA target | In-app notification + email |\n\n---\n\n## 9. Development & Deployment\n\n### 9.1 Environment Parity\n\n| Environment | Database | External APIs | AI Models | Deploy Trigger |\n|-------------|----------|---------------|-----------|----------------|\n| Local Dev | Docker Compose (PostgreSQL + Redis + Azurite) | Mock/sandbox | Sandbox keys | Manual |\n| Staging | PostgreSQL Flexible (B1ms) + Azure Redis (C0) | Sandbox/test accounts | Production keys (rate-limited) | Push to `develop` |\n| Production | PostgreSQL Flexible (D2s_v3, Zone-HA) + Azure Redis (C1) | Production accounts | Production keys | Push to `main` (manual approve) |\n\n### 9.2 CI/CD Pipeline\n\n```\nPR Opened\n  ├── Lint (ESLint + Prettier)\n  ├── Type Check (tsc --noEmit)\n  ├── Unit Tests (Jest, >70% coverage)\n  ├── Integration Tests (TestContainers for PostgreSQL)\n  └── Security Scan (npm audit, Snyk)\n\nMerge to develop\n  ├── Build Docker images\n  ├── Push to Azure Container Registry\n  ├── Deploy to Staging (Container Apps revision)\n  ├── Run E2E smoke tests\n  └── Notify Slack\n\nMerge to main (manual approval required)\n  ├── Run database migrations (staging first, then production)\n  ├── Deploy to Production (Container Apps revision with traffic splitting)\n  ├── Run production smoke tests\n  ├── Monitor error rate for 15 min (Application Insights)\n  └── Auto-rollback if error rate > 2% (revert to previous revision)\n```\n\n### 9.3 Database Migration Strategy\n\n- **Tool:** Prisma Migrate (integrated with NestJS)\n- **Forward-only in production** — no down migrations\n- **Large schema changes:** use expand-contract pattern (add new → migrate data → drop old)\n- **Seed data:** separate scripts for each environment (dev: test data, staging: sample data, production: tenant + admin only)\n\n---\n\n## 10. Key Architecture Decisions Record (ADR)\n\n| # | Decision | Options Considered | Chosen | Rationale |\n|---|----------|-------------------|--------|-----------|\n| ADR-001 | API Framework | Express.js, NestJS, Fastify | **NestJS** | Module system maps to domain boundaries, guards for RBAC, interceptors for audit, OpenAPI generation |\n| ADR-002 | AI/ML Runtime | Node.js (all-in-one), Python microservice | **Python FastAPI** | ML ecosystem, model serving, separate scaling from API |\n| ADR-003 | Multi-Tenant Isolation | Schema-per-tenant, DB-per-tenant, RLS | **RLS (shared schema)** | Simplest for MVP, tenant count < 10, upgrade path to schema-per-tenant |\n| ADR-004 | JWT Signing | HS256 (symmetric), RS256 (asymmetric) | **RS256** | Key rotation without service restart, public key verification by any service |\n| ADR-005 | Token Strategy | Long-lived access, Short access + refresh | **15-min access + 7-day refresh** | Limits exposure window, supports session revocation |\n| ADR-006 | Job Queue | Redis pub/sub, BullMQ, Azure Service Bus | **BullMQ** | Redis already in stack, retry/backoff/priority built in, dashboard for monitoring |\n| ADR-007 | ORM | TypeORM, Prisma, raw SQL | **Prisma** | Type-safe queries, migration system, good NestJS integration |\n| ADR-008 | Container Orchestration | Azure Container Apps, AKS, Azure Functions | **Azure Container Apps** | Serverless containers, built-in scaling, simpler than AKS for MVP, upgrade path to AKS |\n| ADR-011 | Cloud Platform | AWS, Azure, GCP | **Azure** | Client has Azure credits, strong PaaS (Container Apps, Flexible Server, Doc Intelligence) |\n| ADR-012 | Credit Bureau | Experian, TransUnion, Equifax | **Experian** | Largest small business data coverage, Connect API for soft pulls |\n| ADR-013 | KYC Provider | Persona, Jumio, Onfido, Socure | **Persona** | Best developer API, strong liveness detection, mobile-optimized, webhook-native |\n| ADR-014 | Background Check | Checkr, Sterling, GoodHire | **Checkr** | Developer-friendly API, fast turnaround, comprehensive checks, webhook-native |\n| ADR-015 | OCR | Azure Doc Intelligence, AWS Textract, Tesseract | **Azure Doc Intelligence** | Native Azure integration, superior financial document handling, prebuilt tax form models |\n| ADR-009 | Financial Normalization | AI-driven, rule-based | **Rule-based (FNE)** | Deterministic, auditable, no model drift. ML enhancement in v2. |\n| ADR-010 | Credit Decisions | AI-automated, human-required | **Human-required (mandate)** | Regulatory compliance, CDFI mission, client trust |\n\n---\n\n*End of Architecture Document*\n";
  document.getElementById('content').innerHTML = marked.parse(md);
</script>
</body>
</html>