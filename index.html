<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crucible</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --bg: #f0f4f8;
      --surface: #ffffff;
      --surface-2: #f7f9fc;
      --surface-3: #edf2f7;
      --surface-hover: #e8eef6;
      --border: #d8e2ee;
      --border-hover: #b0c4de;
      --text: #1a2b4a;
      --text-2: #4a6180;
      --text-3: #8298b5;
      --accent: #3b6cf5;
      --accent-light: #5b8af7;
      --accent-muted: rgba(59,108,245,0.08);
      --accent-muted-2: rgba(59,108,245,0.15);
      --green: #0fa573;
      --green-muted: rgba(15,165,115,0.08);
      --green-surface: rgba(15,165,115,0.05);
      --amber: #e0870b;
      --amber-muted: rgba(224,135,11,0.08);
      --rose: #e5395a;
      --rose-muted: rgba(229,57,90,0.08);
      --teal: #0d9488;
      --teal-muted: rgba(13,148,136,0.08);
      --violet: #7c5ce0;
      --violet-muted: rgba(124,92,224,0.08);
      --navy: #1e3a5f;
      --sidebar-bg: #1b2e4a;
      --sidebar-hover: rgba(255,255,255,0.10);
      --sidebar-active: rgba(59,108,245,0.25);
      --sidebar-text: rgba(255,255,255,0.7);
      --sidebar-text-bright: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ==================== HEADER ==================== */
    header {
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: var(--navy);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo svg { width: 22px; height: 22px; }

    .logo span {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.3px;
      color: #ffffff;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-stat {
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pulse {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 8px rgba(15,165,115,0.6);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* ==================== LAYOUT ==================== */
    .layout {
      display: flex;
      height: calc(100vh - 56px);
    }

    /* ==================== SIDEBAR ==================== */
    .sidebar {
      width: 260px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      background: var(--sidebar-bg);
      overflow-y: auto;
    }

    .sidebar-section {
      padding: 16px 12px 8px;
    }

    .sidebar-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: rgba(255,255,255,0.3);
      padding: 0 8px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 10px;
      border-radius: 7px;
      cursor: pointer;
      transition: all 0.1s ease;
      font-size: 13px;
      color: var(--sidebar-text);
      margin-bottom: 2px;
    }

    .nav-item:hover {
      background: var(--sidebar-hover);
      color: var(--sidebar-text-bright);
    }

    .nav-item.active {
      background: var(--sidebar-active);
      color: var(--sidebar-text-bright);
    }

    .nav-item .indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .nav-item .name {
      flex: 1;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav-item .badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 7px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .badge-discovery { background: rgba(15,165,115,0.2); color: #4ade80; }
    .badge-specification { background: rgba(96,165,250,0.2); color: #7cacf8; }
    .badge-architecture { background: rgba(167,139,250,0.2); color: #c4b5fd; }
    .badge-build { background: rgba(251,191,36,0.15); color: #fbbf24; }
    .badge-complete { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.35); }
    .badge-unknown { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.35); }

    .phase-dots {
      display: flex;
      gap: 3px;
      margin-top: 6px;
      padding: 0 10px;
    }

    .phase-dot {
      flex: 1;
      height: 3px;
      border-radius: 2px;
      background: rgba(255,255,255,0.1);
    }

    .phase-dot.done { background: #4ade80; }
    .phase-dot.current { background: #7cacf8; }

    /* ==================== MAIN ==================== */
    .main {
      flex: 1;
      overflow-y: auto;
      background: var(--bg);
    }

    /* ==================== EMPTY STATE ==================== */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px;
    }

    .empty-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    .empty-state h3 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .empty-state p {
      font-size: 13px;
      color: var(--text-2);
      max-width: 320px;
      line-height: 1.6;
    }

    .empty-state code {
      background: var(--accent-muted);
      padding: 2px 7px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
    }

    /* ==================== HOME VIEW ==================== */
    .home { max-width: 960px; margin: 0 auto; padding: 40px 32px 60px; }

    .greeting { margin-bottom: 32px; }
    .greeting h1 { font-size: 26px; font-weight: 700; color: var(--navy); letter-spacing: -0.5px; margin-bottom: 6px; }
    .greeting p { font-size: 15px; color: var(--text-2); line-height: 1.5; }
    .greeting p strong { color: var(--text); }
    .greeting .date { font-size: 13px; color: var(--text-3); margin-top: 4px; }

    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 28px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; box-shadow: 0 1px 3px rgba(26,43,74,0.04); }
    .stat-card .stat-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-3); margin-bottom: 8px; }
    .stat-card .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; }
    .stat-card .stat-sub { font-size: 12px; color: var(--text-3); margin-top: 2px; }
    .sv-blue { color: var(--accent); }
    .sv-green { color: var(--green); }
    .sv-amber { color: var(--amber); }
    .sv-violet { color: var(--violet); }

    .home-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }

    .home-section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-3); margin-bottom: 12px; }

    .home-project-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
      padding: 18px 20px; cursor: pointer; transition: all 0.15s ease;
      box-shadow: 0 1px 3px rgba(26,43,74,0.04); margin-bottom: 10px;
    }
    .home-project-card:hover { border-color: var(--accent); box-shadow: 0 3px 12px rgba(59,108,245,0.08); transform: translateY(-1px); }

    .hpc-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .hpc-name { font-size: 15px; font-weight: 600; color: var(--navy); }
    .hpc-badge { font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 100px; }
    .hpc-badge-discovery { background: rgba(15,165,115,0.08); color: var(--green); border: 1px solid rgba(15,165,115,0.15); }
    .hpc-badge-specification { background: rgba(59,108,245,0.08); color: var(--accent); border: 1px solid rgba(59,108,245,0.12); }
    .hpc-badge-architecture { background: rgba(124,92,224,0.08); color: var(--violet); border: 1px solid rgba(124,92,224,0.12); }
    .hpc-badge-build { background: rgba(224,135,11,0.08); color: var(--amber); border: 1px solid rgba(224,135,11,0.12); }
    .hpc-badge-unknown { background: var(--surface-3); color: var(--text-3); border: 1px solid var(--border); }

    .hpc-desc { font-size: 13px; color: var(--text-2); line-height: 1.5; margin-bottom: 12px; }

    .hpc-progress { display: flex; gap: 4px; }
    .hpc-seg { flex: 1; height: 4px; border-radius: 2px; background: var(--surface-3); }
    .hpc-seg.done { background: var(--green); }
    .hpc-seg.active { background: var(--accent); }

    .hpc-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
    .hpc-meta { font-size: 12px; color: var(--text-3); }
    .hpc-deliverables { display: flex; gap: 4px; }
    .hpc-dd { width: 18px; height: 18px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600; background: var(--surface-3); color: var(--text-3); border: 1px solid var(--border); }
    .hpc-dd.ready { background: var(--green-muted); color: var(--green); border-color: rgba(15,165,115,0.2); }

    .activity-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; box-shadow: 0 1px 3px rgba(26,43,74,0.04); }
    .activity-item { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--surface-3); }
    .activity-item:last-child { border-bottom: none; }
    .act-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
    .act-dot.green { background: var(--green); }
    .act-dot.blue { background: var(--accent); }
    .act-dot.violet { background: var(--violet); }
    .act-dot.amber { background: var(--amber); }
    .act-text { font-size: 13px; color: var(--text-2); line-height: 1.5; }
    .act-text strong { color: var(--text); font-weight: 600; }
    .act-time { font-size: 11px; color: var(--text-3); margin-top: 2px; }

    .tip-banner {
      background: linear-gradient(135deg, rgba(59,108,245,0.06), rgba(124,92,224,0.06));
      border: 1px solid rgba(59,108,245,0.12); border-radius: 12px;
      padding: 18px 22px; display: flex; align-items: center; gap: 14px; margin-top: 16px;
    }
    .tip-icon { width: 38px; height: 38px; border-radius: 10px; background: var(--accent); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .tip-text { font-size: 13px; color: var(--text-2); line-height: 1.5; }
    .tip-text strong { color: var(--text); }
    .tip-text code { background: rgba(59,108,245,0.1); padding: 2px 7px; border-radius: 4px; font-size: 12px; font-weight: 600; color: var(--accent); }

    /* ==================== PROJECT VIEW ==================== */
    .project-header {
      padding: 32px 40px 0;
    }

    .project-title-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .project-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--navy);
    }

    .project-status-chip {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 100px;
      background: var(--green-muted);
      color: var(--green);
      border: 1px solid rgba(15,165,115,0.15);
    }

    .project-desc {
      font-size: 14px;
      color: var(--text-2);
      margin-bottom: 28px;
      line-height: 1.5;
    }

    /* ==================== PHASE PROGRESS ==================== */
    .phase-bar {
      display: flex;
      align-items: stretch;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin: 0 40px 32px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(26,43,74,0.04);
    }

    .phase-step {
      flex: 1;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-right: 1px solid var(--border);
    }

    .phase-step:last-child { border-right: none; }
    .phase-step.done { background: var(--green-surface); }
    .phase-step.active { background: var(--accent-muted); }

    .phase-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
      background: var(--surface-3);
      color: var(--text-3);
    }

    .phase-step.done .phase-num { background: var(--green); color: #fff; }
    .phase-step.active .phase-num {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 8px rgba(59,108,245,0.3);
    }

    .phase-text .phase-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-3);
    }

    .phase-step.done .phase-name { color: var(--green); }
    .phase-step.active .phase-name { color: var(--accent); }

    .phase-text .phase-detail {
      font-size: 11px;
      color: var(--text-3);
      margin-top: 1px;
    }

    .phase-step.active .phase-detail { color: var(--text-2); }

    /* ==================== CONTENT GRID ==================== */
    .content-area {
      padding: 0 40px 40px;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
    }

    /* ==================== SECTIONS ==================== */
    .section { margin-bottom: 24px; }

    .section-header {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-3);
      margin-bottom: 12px;
    }

    /* ==================== DELIVERABLE ROWS ==================== */
    .doc-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .doc-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 0 1px 2px rgba(26,43,74,0.03);
    }

    .doc-row:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(59,108,245,0.08);
      transform: translateY(-1px);
    }

    .doc-row.disabled {
      opacity: 0.35;
      cursor: default;
      pointer-events: none;
    }

    .doc-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .doc-icon.green { background: var(--green-muted); color: var(--green); }
    .doc-icon.blue { background: var(--accent-muted-2); color: var(--accent); }
    .doc-icon.violet { background: var(--violet-muted); color: var(--violet); }
    .doc-icon.amber { background: var(--amber-muted); color: var(--amber); }
    .doc-icon.teal { background: var(--teal-muted); color: var(--teal); }

    .doc-info { flex: 1; min-width: 0; }
    .doc-name { font-size: 13px; font-weight: 600; margin-bottom: 1px; }
    .doc-desc { font-size: 12px; color: var(--text-3); }

    .doc-arrow {
      color: var(--text-3);
      font-size: 16px;
      flex-shrink: 0;
      transition: color 0.1s;
    }

    .doc-row:hover .doc-arrow { color: var(--accent); }

    /* ==================== ACTION CARDS ==================== */
    .action-cards {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .action-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 0 1px 2px rgba(26,43,74,0.03);
    }

    .action-card:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(59,108,245,0.08);
      transform: translateY(-1px);
    }

    .action-card.disabled {
      opacity: 0.25;
      cursor: default;
      pointer-events: none;
    }

    .action-icon {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
      color: #fff;
    }

    .action-icon.demo { background: linear-gradient(135deg, #3b6cf5, #2554d4); }
    .action-icon.report { background: linear-gradient(135deg, #0fa573, #0b8a5e); }
    .action-icon.proposal { background: linear-gradient(135deg, #e0870b, #c47508); }

    .action-info { flex: 1; }
    .action-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .action-desc { font-size: 12px; color: var(--text-2); }

    /* ==================== STATUS PANEL ==================== */
    .status-panel { position: sticky; top: 0; }

    .status-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(26,43,74,0.04);
    }

    .status-card-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-3);
      margin-bottom: 14px;
    }

    .status-rows {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-row .label { font-size: 13px; color: var(--text-2); }
    .status-row .value { font-size: 13px; font-weight: 600; color: var(--text); }
    .status-row .value.green { color: var(--green); }
    .status-row .value.amber { color: var(--amber); }
    .status-row .value.accent { color: var(--accent); }

    .progress-track {
      margin-top: 14px;
      height: 6px;
      border-radius: 3px;
      background: var(--surface-3);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      transition: width 0.3s ease;
    }

    .progress-label {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-3);
      text-align: right;
    }

    /* Gate list */
    .gate-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .gate-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }

    .gate-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
    }

    .gate-icon.pass {
      background: var(--green-muted);
      color: var(--green);
      border: 1.5px solid rgba(15,165,115,0.2);
    }

    .gate-icon.pending {
      background: var(--surface-3);
      color: var(--text-3);
      border: 1.5px solid var(--border);
    }

    .gate-icon.active {
      background: var(--accent-muted);
      color: var(--accent);
      border: 1.5px solid rgba(59,108,245,0.2);
    }

    .gate-label { color: var(--text-2); font-weight: 500; }
    .gate-label.done { color: var(--text-3); }

    /* ==================== MODAL ==================== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(26,43,74,0.4);
      z-index: 100;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.open { display: flex; align-items: center; justify-content: center; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      width: 92vw;
      max-width: 960px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 80px rgba(26,43,74,0.2);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-2);
    }

    .modal-header h3 { font-size: 15px; font-weight: 600; color: var(--navy); }

    .modal-close {
      background: var(--surface-3);
      border: 1px solid var(--border);
      color: var(--text-2);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.1s;
    }

    .modal-close:hover { background: var(--surface-hover); color: var(--text); }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 32px 36px;
    }

    /* ==================== MARKDOWN REPORT STYLING ==================== */
    .markdown-body {
      line-height: 1.7;
      font-size: 15px;
      color: #333;
      max-width: 100%;
    }

    /* Document title (first h1) */
    .markdown-body h1:first-child {
      font-size: 28px;
      color: #fff;
      background: linear-gradient(135deg, var(--navy) 0%, #0F1F33 100%);
      margin: -32px -36px 28px;
      padding: 40px 36px;
      border-bottom: none;
      border-radius: 0;
      letter-spacing: -0.5px;
      line-height: 1.3;
    }

    .markdown-body h1 {
      font-size: 24px;
      color: var(--navy);
      font-weight: 700;
      letter-spacing: -0.3px;
      margin: 36px 0 16px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--accent);
      line-height: 1.3;
    }

    .markdown-body h2 {
      font-size: 20px;
      color: var(--navy);
      font-weight: 700;
      letter-spacing: -0.2px;
      margin: 28px 0 14px;
      padding-bottom: 8px;
      border-bottom: 2px solid #d8e2ee;
    }

    .markdown-body h3 {
      font-size: 16px;
      color: var(--navy);
      font-weight: 600;
      margin: 22px 0 10px;
      line-height: 1.3;
    }

    .markdown-body h4 {
      font-size: 14px;
      color: var(--navy);
      font-weight: 600;
      margin: 18px 0 8px;
    }

    .markdown-body p { margin-bottom: 14px; line-height: 1.7; }

    .markdown-body ul, .markdown-body ol {
      margin-bottom: 16px;
      padding-left: 0;
      list-style: none;
    }

    .markdown-body ul li, .markdown-body ol li {
      padding: 6px 0 6px 24px;
      position: relative;
      line-height: 1.6;
    }

    .markdown-body ul li::before {
      content: '\25B6';
      position: absolute;
      left: 0;
      color: var(--accent);
      font-size: 8px;
      top: 11px;
    }

    .markdown-body ol { counter-reset: item; }
    .markdown-body ol li { counter-increment: item; }
    .markdown-body ol li::before {
      content: counter(item);
      position: absolute;
      left: 0;
      width: 20px;
      height: 20px;
      background: var(--navy);
      color: #fff;
      border-radius: 50%;
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      top: 8px;
    }

    .markdown-body strong { color: var(--navy); font-weight: 600; }

    .markdown-body code {
      background: rgba(59,108,245,0.08);
      padding: 2px 7px;
      border-radius: 4px;
      font-size: 13px;
      color: var(--accent);
      font-weight: 500;
    }

    .markdown-body pre {
      background: #1b2e4a;
      color: #e2e8f0;
      border: none;
      padding: 20px 24px;
      border-radius: 10px;
      overflow-x: auto;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(26,43,74,0.12);
    }

    .markdown-body pre code {
      background: none;
      padding: 0;
      color: #e2e8f0;
      font-size: 13px;
    }

    .markdown-body blockquote {
      border-left: 4px solid var(--accent);
      background: #EBF3FB;
      padding: 18px 24px;
      border-radius: 0 10px 10px 0;
      margin: 20px 0;
      color: #333;
    }

    .markdown-body blockquote p:last-child { margin-bottom: 0; }

    .markdown-body blockquote strong {
      display: block;
      color: var(--navy);
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    /* Tables — navy header, striped rows, hover */
    .markdown-body table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 14px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    .markdown-body thead th {
      background: var(--navy);
      color: #fff;
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: 1px solid #15304D;
    }

    .markdown-body tbody td {
      padding: 11px 16px;
      border: 1px solid #dee2e6;
      vertical-align: top;
      line-height: 1.5;
    }

    .markdown-body tbody tr:nth-child(even) { background: #f8f9fa; }
    .markdown-body tbody tr:hover { background: #EBF3FB; }

    .markdown-body hr {
      border: none;
      height: 2px;
      background: linear-gradient(90deg, var(--accent), transparent);
      margin: 32px 0;
    }

    /* Images */
    .markdown-body img {
      max-width: 100%;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      margin: 16px 0;
    }

    /* Links */
    .markdown-body a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      border-bottom: 1px solid rgba(59,108,245,0.3);
      transition: border-color 0.15s;
    }
    .markdown-body a:hover { border-bottom-color: var(--accent); }

    /* ==================== REPORT VIEWER ==================== */
    .report-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(26,43,74,0.5);
      z-index: 200;
      backdrop-filter: blur(6px);
    }

    .report-overlay.open { display: flex; align-items: center; justify-content: center; }

    .report-viewer {
      background: var(--surface);
      border-radius: 14px;
      width: 94vw;
      max-width: 1100px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 80px rgba(26,43,74,0.25);
    }

    .report-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-2);
    }

    .report-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .report-header-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #fff;
    }

    .report-header-icon.research { background: linear-gradient(135deg, #0fa573, #0b8a5e); }
    .report-header-icon.proposal { background: linear-gradient(135deg, #e0870b, #c47508); }

    .report-header h3 { font-size: 15px; font-weight: 600; color: var(--navy); }
    .report-header .report-project { font-size: 12px; color: var(--text-3); margin-top: 1px; }

    .report-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .report-btn {
      background: var(--surface-3);
      border: 1px solid var(--border);
      color: var(--text-2);
      height: 32px;
      padding: 0 14px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.1s;
    }

    .report-btn:hover { background: var(--surface-hover); color: var(--text); }

    .report-close {
      background: var(--surface-3);
      border: 1px solid var(--border);
      color: var(--text-2);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.1s;
    }

    .report-close:hover { background: var(--surface-hover); color: var(--text); }

    .report-frame {
      flex: 1;
      border: none;
      width: 100%;
      height: 100%;
      background: #fff;
    }

    /* ==================== SCROLLBAR ==================== */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-3); }

    /* ==================== HAMBURGER TOGGLE ==================== */
    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: background 0.1s;
    }
    .menu-toggle:hover { background: rgba(255,255,255,0.1); }
    .menu-toggle svg { width: 22px; height: 22px; display: block; }

    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 39;
    }
    .sidebar-backdrop.open { display: block; }

    /* ==================== RESPONSIVE ==================== */

    /* Tablet: <= 1024px */
    @media (max-width: 1024px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .home-cols { grid-template-columns: 1fr; }
      .content-area { grid-template-columns: 1fr; }
      .status-panel { position: static; }
      .phase-bar { margin: 0 20px 24px; }
      .project-header { padding: 24px 20px 0; }
      .content-area { padding: 0 20px 32px; }
      .home { padding: 28px 20px 40px; }
    }

    /* Mobile: <= 768px */
    @media (max-width: 768px) {
      .menu-toggle { display: block; }

      .sidebar {
        position: fixed;
        top: 56px;
        left: 0;
        bottom: 0;
        z-index: 40;
        transform: translateX(-100%);
        transition: transform 0.25s ease;
        box-shadow: 4px 0 20px rgba(0,0,0,0.2);
      }
      .sidebar.open { transform: translateX(0); }

      .layout { height: calc(100vh - 56px); }

      .stats-row { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .stat-card { padding: 14px 16px; }
      .stat-card .stat-value { font-size: 24px; }

      .phase-bar { margin: 0 16px 20px; flex-wrap: wrap; }
      .phase-step { min-width: 48%; padding: 12px 14px; }
      .phase-step:nth-child(2) { border-right: none; }

      .project-header { padding: 20px 16px 0; }
      .project-title { font-size: 20px; }
      .project-desc { font-size: 13px; margin-bottom: 20px; }
      .content-area { padding: 0 16px 28px; gap: 16px; }

      .home { padding: 20px 16px 32px; }
      .greeting h1 { font-size: 22px; }
      .greeting p { font-size: 14px; }

      .home-project-card { padding: 14px 16px; }
      .hpc-name { font-size: 14px; }
      .hpc-desc { font-size: 12px; margin-bottom: 10px; }

      .doc-row { padding: 10px 12px; gap: 10px; }
      .doc-icon { width: 32px; height: 32px; font-size: 14px; }
      .doc-name { font-size: 12px; }
      .doc-desc { font-size: 11px; }

      .action-card { padding: 14px; gap: 12px; }
      .action-icon { width: 38px; height: 38px; font-size: 16px; }
      .action-name { font-size: 13px; }

      .modal { width: 96vw; height: 92vh; border-radius: 10px; }
      .modal-body { padding: 20px; }
      .markdown-body h1:first-child { margin: -20px -20px 20px; padding: 28px 20px; font-size: 22px; }
      .markdown-body h1 { font-size: 20px; }
      .markdown-body h2 { font-size: 17px; }
      .markdown-body { font-size: 14px; }

      .report-viewer { width: 96vw; height: 92vh; border-radius: 10px; }

      .tip-banner { padding: 14px 16px; gap: 10px; }
      .tip-icon { width: 32px; height: 32px; font-size: 15px; border-radius: 8px; }
      .tip-text { font-size: 12px; }
    }

    /* Small mobile: <= 480px */
    @media (max-width: 480px) {
      header { padding: 0 16px; }
      .logo span { font-size: 14px; }
      .header-stat { font-size: 12px; }

      .stats-row { grid-template-columns: 1fr 1fr; gap: 8px; }
      .stat-card .stat-label { font-size: 10px; }
      .stat-card .stat-value { font-size: 20px; }
      .stat-card .stat-sub { font-size: 11px; }

      .phase-bar { flex-direction: column; }
      .phase-step { border-right: none; border-bottom: 1px solid var(--border); }
      .phase-step:last-child { border-bottom: none; }

      .greeting h1 { font-size: 20px; }

      .section-header { font-size: 10px; }
      .status-card { padding: 16px; }
      .status-card-title { font-size: 10px; }
      .gate-item { font-size: 12px; }
    }
  </style>

<script>
// --- Embedded PMO data (generated by build-static.js) ---
window.__STATIC_MODE__ = true;
window.__PROJECTS_DATA__ = {"projects":{"cremologix":{"name":"CremoLogix","phase":"build","status":"planning","updated":"2026-02-10","description":"AI-assisted underwriting platform for CDFIs","completedStreams":["Phase 2: Deal Health Score, BullMQ Workers, Cross-Validation, Unit Tests","Phase 3 Streams 1-4: Infrastructure, Memo Editor, Integrations, Observability","Phase 3 Stream 5: Testing & Quality (425 API + 12 Frontend + 11 E2E tests)","Phase 3 Stream 6: Pilot Launch Prep (Siura Capital)"],"currentPhase":"Staging Deployed — Awaiting Pilot Onboarding","staging":{"apiUrl":"https://ca-cremologix-api-stg.nicewater-be741216.westus3.azurecontainerapps.io","webUrl":"https://ca-cremologix-web-stg.nicewater-be741216.westus3.azurecontainerapps.io","region":"westus3","resourceGroup":"rg-cremologix-stg"},"state":{"project":"cremologix","name":"CremoLogix","description":"AI-assisted underwriting platform for CDFIs — automates financial analysis while maintaining full human control over credit decisions","created":"2026-02-09","migrated_from":"C:\\projects\\Ideas\\CremoLogix + C:\\projects\\CremoLogix-Prototype","phase":"build","status":"planning","phases":{"discovery":{"status":"approved","agents_completed":["business-analyst","ux-designer"],"feedback_gate":"passed","approved_at":"2026-02-09","decisions":["Deferrals approved: Vendor Marketplace, Education Portal content, External Funding web portal → Phase 2+","4 GO conditions noted: strict MVP phasing, FNE POC, CDFI design partner, legal review of denied applicant nurture"],"notes":"Migrated from existing docs — executive summary, market analysis, BA reevaluation, 79-screen prototype across 9 portals"},"specification":{"status":"approved","agents_completed":["technical-analyst","feedback-agent"],"feedback_gate":"passed","approved_at":"2026-02-09","decisions":["Build scope tags introduced: 60 MVP, 1 MVP-LITE, 23 POST-MVP screens","B-14 Vendor Marketplace → POST-MVP (demo only)","B-13 Education Portal → MVP-LITE (curated links only)","D-01–D-05 Denied Applicant → POST-MVP (pending legal opinion)","EF-01–EF-04 External Funding → POST-MVP (PDF packet for now)","FO-01–FO-08 FinOps Resource → POST-MVP","AD-11 CDFI Reporting → MVP (tenant-configurable, all enabled for Siura)","Credit bureau integration → MVP (API + manual entry fallback)","Human Decision Mandate added as architectural constraint","Deal Health Score specified: 11 factors, configurable weights + ranges","Financial Normalization Engine specified: 6 entity types, line-by-line mappings"],"addendum_docs":["docs/fne-specification.md","docs/deal-health-specification.md"],"notes":"Spec reviewed at 75% ready, 2 critical gaps resolved (FNE + Deal Health), 5 scope decisions made, 23 screens deferred to POST-MVP"},"architecture":{"status":"pending_review","agents_completed":["solutions-architect","technical-advisor","feedback-agent"],"feedback_gate":"passed","decisions":["Cloud platform: Azure (client has credits)","Container orchestration: Azure Container Apps (AKS post-MVP)","Database: Azure PostgreSQL Flexible Server (Zone-Redundant HA)","Object storage: Azure Blob Storage","CDN/WAF: Azure Front Door","OCR: Azure Document Intelligence","Secrets: Azure Key Vault","Monitoring: Azure Monitor + Application Insights","ORM: Prisma","Credit Bureau: Experian (Connect API, soft pull)","KYC: Persona (liveness detection, webhook-native)","Background Check: Checkr (developer-friendly API)","15 ADRs documented in architecture.md"],"optimizations_applied":["architecture.md rewritten v2.0 — system topology, data flows, Azure infrastructure, security, monitoring, 15 ADRs","All 3 docs migrated from AWS to Azure platform","Pre-qualification pipeline added (4-gate funnel: credit→KYC→background→Deal Health)","Credit bureau, KYC, and background check integration specs added (specification.md Sections 6.4-6.6)","FNE and Deal Health API endpoints added to specification.md (Sections 4.12-4.14)","Section 1071 data collection fields specified with demographics table and collection rules","technology.md sub-projects rewritten: 12 → 18 sub-projects aligned with specification.md","Implementation roadmap updated: 40 weeks, 3 parallel streams","Project structure updated: NestJS modules + Python/FastAPI pipeline + React portals","Estimated Azure cost: ~$615/mo (offset by credits) + ~$1,184/mo external services"],"approved_at":"2026-02-09","notes":"Architecture rewritten v2.0, Azure-optimized, vendor picks locked (Experian, Persona, Checkr, Prisma). 15 ADRs documented."},"build":{"status":"ready","agents_completed":["build-planner"],"feedback_gate":"pending","deliverables":["cremologix/CLAUDE.md — rewritten for NestJS + FastAPI + React 18 architecture","cremologix/docs/build-plan.md — 18 sub-projects, 6 phases, 40-week roadmap","cremologix/docs/architecture.md — replaced with approved v2.0","cremologix/specs/phase-1.md through phase-4.md — per-phase execution specs"],"notes":"Build Planner complete. CLAUDE.md rewritten (Next.js → NestJS+FastAPI+React). Build plan, architecture, and phase specs created in app repo. Ready for developer execution."}},"history":[{"timestamp":"2026-02-09T00:00:00Z","event":"project_migrated","details":"CremoLogix migrated into Crucible framework from existing documentation and prototype"},{"timestamp":"2026-02-09T00:01:00Z","event":"phase1_approved","details":"Discovery approved. Deferrals agreed. 4 GO conditions noted. Advancing to specification review."},{"timestamp":"2026-02-09T00:02:00Z","event":"phase2_approved","details":"Specification approved. Build scope tags added (60 MVP + 1 MVP-LITE + 23 POST-MVP). FNE and Deal Health Score specs written. Credit bureau moved to MVP. Human Decision Mandate established. Advancing to architecture review."},{"timestamp":"2026-02-09T00:03:00Z","event":"cross_doc_audit_optimization","details":"Cross-document audit found critical conflicts between legacy docs and spec. Applied 10 optimizations: supersession notices on architecture.md/technology.md, pre-qualification pipeline (4 gates), 3 new integration specs (credit bureau, KYC, background), FNE+Deal Health API endpoints, Section 1071 data fields, 18-project rewrite of technology.md, FNE dependency chain in financial analysis."},{"timestamp":"2026-02-09T00:04:00Z","event":"phase3_approved","details":"Architecture approved. Azure platform selected (client credits). Vendor picks locked: Experian (credit), Persona (KYC), Checkr (background), Prisma (ORM). 15 ADRs documented. Architecture.md rewritten v2.0. Estimated cost: $1,799/mo ($615 Azure + $1,184 external). Advancing to build phase."},{"timestamp":"2026-02-09T00:05:00Z","event":"build_planner_complete","details":"Build Planner delivered: CLAUDE.md rewritten for NestJS+FastAPI+React (replaced Next.js), build-plan.md with 18 sub-projects across 6 phases (40 weeks), architecture.md v2.0 copied to app repo, 4 phase spec files created. App repo ready for developer execution starting with SUB-01 (Auth) and SUB-02 (Schema)."}]},"deliverables":{"discovery":true,"specification":true,"architecture":true,"technology":true,"buildPlan":false},"demo":true,"researchReport":"cremologix.html","buildProposal":null},"drill-or-drop":{"name":"Drill or Drop","phase":"specification","status":"in_progress","updated":"2026-02-09","description":"AI-powered well investment decision tool — AFE analysis with drill/no-drill recommendations via interactive dashboard","state":{"project":"drill-or-drop","name":"Drill or Drop","description":"AI-powered well investment decision tool — analyzes AFE proposals and delivers drill/no-drill recommendations via an interactive dashboard with scenario modeling and live updates","created":"2026-02-09","phase":"specification","status":"in_progress","phases":{"discovery":{"status":"approved","agents_completed":["business-analyst","feedback-agent","ui-ux-designer"],"feedback_gate":"passed","approved_at":"2026-02-09","decisions":["Chat AI deferred to post-MVP — predefined scenario controls for v1","Portfolio view deferred to post-MVP","Live commodity pricing deferred — fixed price deck for v1","Enverus CSV import primary path; API as upgrade","Cloud-hosted deployment, no data sensitivity constraints","Mobile-responsive design promoted to v1 requirement","Economics engine expanded: back-in after payout, sliding scale, minimum royalties, promoted interest, custom one-off deal structures","Same-day automated results target (30-day typical election window, 1-week worst case)","Historical decision data available (spreadsheets) — build import path","Single master Excel for land records","50 operators, 3-5 AFEs/month","Basins: Permian, Eagle Ford, Haynesville, Powder River","1 user per role MVP, scalable to 5","No existing tool integrations needed"]},"specification":{"status":"in_progress","agents_completed":[],"feedback_gate":"pending","notes":"Starting technical specification"},"architecture":{"status":"not_started","agents_completed":[],"feedback_gate":"pending"},"build":{"status":"not_started","agents_completed":[],"feedback_gate":"pending"}},"history":[{"timestamp":"2026-02-09T00:00:00Z","event":"project_created","details":"Drill or Drop project created. Starting discovery intake."},{"timestamp":"2026-02-09T01:00:00Z","event":"discovery_approved","details":"Discovery approved. Key scope changes: mobile-responsive v1, expanded economics engine (complex fiscal terms + custom deals), Enverus CSV primary. Advancing to specification."},{"timestamp":"2026-02-09T02:00:00Z","event":"prototype_updated","details":"Interactive prototype v2.0 built at demos/drill-or-drop.html. 6 roles, 48 screens total (Admin 7, Land 8, Technical 8, Commercial 10, CAG 8, Approver 7). Covers all 25 P0 features from discovery v2.1. Self-contained HTML, no external dependencies."}]},"deliverables":{"discovery":true,"specification":false,"architecture":false,"technology":false,"buildPlan":false},"demo":true,"researchReport":"drill-or-drop.html","buildProposal":null},"challey":{"name":"Challey","phase":"discovery","status":"in_progress","updated":"2026-02-10","description":"Chore tracking app where parents assign chores with rewards and kids mark them complete to earn those rewards","state":{"project":"challey","name":"Challey","phase":"discovery","step":"prototype_building","status":"in_progress","created":"2026-02-10","updated":"2026-02-10","client":{"name":"Maggie","age":13,"context":"First-time app creator, wants something simple, fast, and awesome"},"description":"Chore tracking app where parents assign chores with rewards and kids mark them complete to earn those rewards","clientFeedback":{"siblings":"Support up to 10 kids per family","rewards":"Points-based system — parents create reward catalog, kids redeem with points earned from chore complexity","verification":"Photo proof required on every chore — no auto-approve","device":"Phone-first (mobile app)","parents":"Dad is family admin, can invite other adults (Mom, grandparents, etc.)","privacy":"Private app — only invited family members can see anything","education":"Integrate with Google Classroom (MVP), Microsoft Teams + Edlink (POST-MVP) so kids earn points for schoolwork too","design":"Navy and ocean blue color palette — teen-friendly, not childish"},"history":[{"date":"2026-02-10","event":"Project created","agent":"pm"},{"date":"2026-02-10","event":"BA discovery complete - Skills 1-8","agent":"ba"},{"date":"2026-02-10","event":"Feedback Agent Mode 1 — discovery approved by client with additions: points system, photo proof, multi-adult, education integration, navy/ocean blue theme","agent":"feedback"}],"gates":{"discovery_approved":true,"prototype_approved":false,"specification_approved":false,"architecture_approved":false,"build_authorized":false}},"deliverables":{"discovery":true,"specification":false,"architecture":false,"technology":false,"buildPlan":false},"demo":true,"researchReport":null,"buildProposal":null}}};
window.__DOCS_DATA__ = {"cremologix/architecture":"# CremoLogix -- Architecture Document\n\n**Version:** 2.0\n**Date:** February 9, 2026\n**Status:** Phase 3 Review\n**Companion to:** `specification.md` (authoritative for schema, API contracts, workflow, and screen inventory)\n\n---\n\n## 1. Architecture Overview\n\nThis document covers **system design decisions, deployment architecture, data flow patterns, and infrastructure design** for CremoLogix MVP. It complements `specification.md` (which defines the schema, API contracts, AI pipeline, and workflow details) — it does not duplicate them.\n\n### 1.1 Guiding Principles\n\n| Principle | Implementation |\n|-----------|---------------|\n| **Human Decision Mandate** | No automated credit decisions. All approval/denial paths require Credit Manager action. |\n| **AI as Sidecar** | CremoLogix operates alongside the LOS, never inside it. Data pushes out; no dependencies on LOS availability. |\n| **Multi-Tenant from Day 1** | tenant_id on all tables, RLS policies, JWT-derived tenant context — even though MVP is single-tenant (Siura Capital). |\n| **Audit Everything** | Append-only audit trail. Every mutation, AI decision, override, and integration event logged with full context. |\n| **Progressive Computation** | Financial analysis, scoring, and deal health update incrementally as data arrives — no \"big bang\" recalculation. |\n| **Fail Safe, Not Silent** | All external integration failures surface to users with clear status. No silent data loss. |\n\n### 1.2 Technology Decisions\n\n| Decision | Choice | Rationale |\n|----------|--------|-----------|\n| Cloud Platform | **Microsoft Azure** | Client has Azure credits; strong PaaS offerings for containers, PostgreSQL, Redis |\n| Core API Framework | **NestJS** (Node.js 20 + TypeScript) | Module system, dependency injection, guards/interceptors for RBAC + audit, OpenAPI generation |\n| AI/ML Pipeline | **Python 3.11 + FastAPI** | ML ecosystem (PyTorch, scikit-learn), Azure Document Intelligence SDK, LLM orchestration, separate scaling |\n| Frontend | **React 18 + TypeScript + Vite** | Component reuse across 7 portals, TailwindCSS + shadcn/ui design system |\n| Database | **Azure Database for PostgreSQL Flexible Server** | RLS for tenant isolation, JSONB for flexible data, partitioning for audit logs |\n| Cache / Queue | **Azure Cache for Redis 7** | Session store, rate limit counters, BullMQ job queues |\n| Object Storage | **Azure Blob Storage** (Azurite for dev) | Document storage with encryption, SAS URLs, lifecycle policies |\n| Container Orchestration | **Azure Container Apps** (MVP) | Serverless containers, built-in scaling, Dapr sidecar support. AKS post-MVP. |\n| OCR | **Azure Document Intelligence** | Superior financial document handling, native Azure integration |\n| Infrastructure as Code | **Terraform** (AzureRM provider) | Cloud-agnostic definitions, state management, environment parity |\n| CI/CD | **GitHub Actions** | PR checks, automated testing, staging/production deployment pipelines |\n| ORM | **Prisma** | Type-safe queries, migration system, excellent NestJS integration |\n| Credit Bureau | **Experian** (soft pull) | Largest small business data coverage, Connect API |\n| KYC Provider | **Persona** | Best-in-class developer API, strong liveness detection, mobile-optimized |\n| Background Check | **Checkr** | Developer-friendly API, fast turnaround, webhook-native |\n\n---\n\n## 2. System Topology\n\n### 2.1 Component Architecture\n\n```\n                          ┌─────────────────────────────────────────┐\n                          │         Azure Front Door (CDN)           │\n                          │   TLS termination, WAF, static assets    │\n                          └─────────────────┬───────────────────────┘\n                                            │\n                          ┌─────────────────┴───────────────────────┐\n                          │       Azure Container Apps Environment    │\n                          │   VNet-integrated, auto-scaling            │\n                          │   /api/* → Core API    /ml/* → ML Pipeline│\n                          └───────┬─────────────────────┬───────────┘\n                                  │                     │\n                    ┌─────────────┴──────┐    ┌────────┴──────────┐\n                    │   CORE API (NestJS) │    │  ML PIPELINE      │\n                    │   Container App     │    │  (FastAPI)        │\n                    │   2-4 replicas      │    │  Container App    │\n                    │                     │    │  1-2 replicas     │\n                    │  ┌───────────────┐  │    │  ┌─────────────┐  │\n                    │  │ Auth Module   │  │    │  │ OCR Service  │  │\n                    │  │ Case Module   │  │    │  │ Classifier   │  │\n                    │  │ Financial Mod │  │    │  │ Extractor    │  │\n                    │  │ Scoring Mod   │  │    │  │ Risk NLP     │  │\n                    │  │ Review Module │  │    │  │ Narrative    │  │\n                    │  │ Admin Module  │  │    │  │ Memo Builder │  │\n                    │  │ PreQual Mod   │  │    │  │ Question Gen │  │\n                    │  │ Audit Module  │  │    │  └─────────────┘  │\n                    │  │ Notif Module  │  │    │                    │\n                    │  │ Integ Module  │  │    │                    │\n                    │  └───────────────┘  │    └────────┬──────────┘\n                    └───────┬─────────────┘             │\n                            │                           │\n              ┌─────────────┼───────────────────────────┘\n              │             │\n    ┌─────────┴──────┐ ┌───┴──────────┐ ┌──────────────┐\n    │ PostgreSQL 16  │ │Azure Cache   │ │ Azure Blob   │\n    │ Flexible Server│ │for Redis 7   │ │ Storage      │\n    │ Zone-Redundant │ │              │ │              │\n    │ ~30 tables     │ │ Sessions,    │ │ Documents,   │\n    │ RLS on all     │ │ Job Queues,  │ │ Exports,     │\n    │ Partitioned    │ │ Rate Limits  │ │ OCR text     │\n    │ audit_logs     │ │              │ │ AES-256 SSE  │\n    └────────────────┘ └──────────────┘ └──────────────┘\n              │\n    ┌─────────┴──────────────────────────────────────┐\n    │            EXTERNAL SERVICES                    │\n    │  ┌────────┐ ┌───────┐ ┌───────┐ ┌───────────┐  │\n    │  │Experian│ │Persona│ │Checkr │ │ Salesforce │  │\n    │  │(Credit)│ │(KYC)  │ │(Bkgnd)│ │ CRM       │  │\n    │  └────────┘ └───────┘ └───────┘ └───────────┘  │\n    │  ┌──────────────┐ ┌─────────┐ ┌─────────┐      │\n    │  │Azure Doc     │ │SendGrid │ │ LOS API │      │\n    │  │Intelligence  │ │(Email)  │ │(Sidecar)│      │\n    │  └──────────────┘ └─────────┘ └─────────┘      │\n    └────────────────────────────────────────────────┘\n```\n\n### 2.2 Service Communication\n\n| From | To | Protocol | Pattern |\n|------|----|----------|---------|\n| React SPA → Core API | HTTPS REST | Synchronous request/response via Azure Front Door |\n| Core API → ML Pipeline | Internal HTTP (VNet) | Synchronous for small ops, async via BullMQ for heavy ops |\n| Core API → PostgreSQL | TCP (pg driver) | Connection pool (max 20), RLS session var set per request |\n| Core API → Redis | TCP (TLS) | Session reads, rate limit checks, job enqueue |\n| Core API → Blob Storage | HTTPS (Azure SDK) | SAS URL generation, direct upload/download |\n| Core API → External APIs | HTTPS REST | Webhook callbacks, OAuth flows, retry with backoff |\n| ML Pipeline → Blob Storage | HTTPS (azure-storage-blob) | Read document files for OCR processing |\n| ML Pipeline → PostgreSQL | TCP | Write extraction results, normalization output |\n| ML Pipeline → Azure Doc Intelligence | HTTPS | OCR, form recognition, table extraction |\n| BullMQ Worker → ML Pipeline | Internal HTTP | Dequeue job, invoke ML endpoint, update status |\n\n### 2.3 Inter-Module Dependencies (NestJS)\n\n```\nAuthModule ──────────────────────────────────────┐\n  │                                              │\n  ├── TenantModule (middleware: set RLS context)  │\n  │                                              │\nPreQualModule ← CreditBureauProvider             │\n  │            ← KYCProvider                     │\n  │            ← BackgroundCheckProvider         │\n  │                                              │\nCaseModule ← WorkflowModule                      │\n  │                                              │\nDocumentModule ← S3Provider                      │\n  │                                              │\n  ├── ExtractionModule (calls ML Pipeline)       │\n  │     │                                        │\n  │     ├── NormalizationModule (FNE)            │\n  │     │     │                                  │\n  │     │     ├── FinancialAnalysisModule         │\n  │     │     │     │                            │\n  │     │     │     ├── RiskModule               │\n  │     │     │     │     │                      │\n  │     │     │     │     ├── FollowUpModule      │\n  │     │     │     │                            │\n  │     │     │     ├── ScoringModule             │\n  │     │     │     │     │                      │\n  │     │     │     │     ├── PacketModule        │\n  │     │     │     │           │                │\n  │     │     │     │           ├── ReviewModule  │\n  │                                              │\n  ├── DealHealthModule (reads pre-qual + financial)│\n  │                                              │\n  ├── NotificationModule ← SendGridProvider      │\n  │                                              │\n  ├── IntegrationModule ← SalesforceProvider     │\n  │                     ← LOSProvider            │\n  │                                              │\n  ├── AuditModule (interceptor on all mutations)  │\n  │                                              │\n  └── AdminModule (configures all above)          │\n```\n\n---\n\n## 3. Data Flow Patterns\n\n### 3.1 Pre-Qualification Flow (B-01 → Case Creation)\n\n```\nBorrower submits Easy Apply (B-01)\n  │\n  ├── [1] Application created (status: draft)\n  │     └── Demographic data collected (Section 1071 — separate screen, firewalled)\n  │\n  ├── [2] Credit bureau soft pull (async, ~2s)\n  │     ├── PASS (score >= threshold) → proceed\n  │     └── FAIL → B-03 holding message + ECOA adverse action email\n  │\n  ├── [3] KYC verification session created → SMS link to B-04\n  │     ├── Borrower completes photo ID + selfie\n  │     ├── Provider callback → PASS → proceed\n  │     └── FAIL → B-03 + manual review queue\n  │\n  ├── [4] Background check triggered (async, 1-3 business days)\n  │     ├── Results → IA-02 (Intake Agent review)\n  │     ├── Intake Agent: Approve → proceed\n  │     └── Intake Agent: Reject (with reason) → end\n  │\n  ├── [5] Initial Deal Health Score computed\n  │     ├── Score >= auto-exit threshold → proceed\n  │     └── Score < threshold → flag for review\n  │\n  └── [6] Case created → Phase 1 (Configuration) → underwriter assigned\n```\n\n### 3.2 Document Processing Flow (Upload → Normalized Financials)\n\n```\nDocument uploaded (Borrower B-09 or Underwriter UW-05)\n  │\n  ├── [1] S3 upload via pre-signed URL\n  │     └── Metadata record in `documents` table (status: uploaded)\n  │\n  ├── [2] Virus scan (ClamAV Lambda)\n  │     ├── Clean → proceed\n  │     └── Infected → quarantine, notify user\n  │\n  ├── [3] BullMQ job enqueued → ML Pipeline\n  │     │\n  │     ├── [3a] OCR (Textract for complex, pdfplumber for text PDFs)\n  │     │     └── Raw text + bounding boxes → S3\n  │     │\n  │     ├── [3b] Classification (DistilBERT)\n  │     │     └── Document type identified (tax_return_business, bank_statement, etc.)\n  │     │\n  │     ├── [3c] Extraction (LLM with type-specific prompts)\n  │     │     └── Structured data + per-field confidence → `extraction_results`\n  │     │\n  │     └── [3d] Validation (cross-field, cross-document, YoY checks)\n  │           └── Status: auto_validated | manual_review_needed\n  │\n  ├── [4] FNE Normalization (triggered when extraction validated)\n  │     ├── Entity type routing (Sole Prop → Schedule C, S-Corp → 1120-S, etc.)\n  │     ├── Line-by-line mapping to standardized buckets\n  │     ├── Cross-validation (10 rules: XV-001 through XV-010)\n  │     └── Output → `normalized_financials` table\n  │\n  └── [5] Financial Analysis auto-triggered\n        ├── 9 sub-analyses computed from normalized data\n        ├── Deal Health Score updated (progressive)\n        └── Risk assessment triggered when all analyses complete\n```\n\n### 3.3 Underwriting Decision Flow (Analysis → Credit Decision)\n\n```\nFinancial Analysis Complete\n  │\n  ├── [1] Risk Assessment\n  │     ├── Rule-based identification (DSCR, D/E, collateral, etc.)\n  │     ├── AI-augmented identification (LLM review)\n  │     └── Risk narrative generated → `risk_items` table\n  │\n  ├── [2] Follow-Up Questions (if gaps identified)\n  │     ├── AI generates context-aware questions\n  │     ├── Underwriter reviews, approves, sends to borrower\n  │     ├── Borrower responds (B-09 or email)\n  │     └── Narrative conversion (first-person → third-person)\n  │\n  ├── [3] Override Management\n  │     ├── Underwriter can override any AI-produced value\n  │     └── Mandatory rationale logged (immutable audit)\n  │\n  ├── [4] Scoring\n  │     ├── Model → Categories → Factors evaluated\n  │     ├── Progressive: re-normalizes weights as data arrives\n  │     ├── Underwriter MUST confirm score (cannot auto-advance)\n  │     └── Recommendation: approve | approve_with_conditions | decline | insufficient_data\n  │\n  ├── [5] Packet Assembly\n  │     ├── 17-section credit memo assembled by LLM\n  │     ├── Underwriter edits in TipTap WYSIWYG editor\n  │     ├── Quality check (all sections, figures match, no placeholders)\n  │     └── Finalized packet → PDF/Word export\n  │\n  └── [6] Credit Review (Human Decision Mandate)\n        ├── Credit Manager reviews complete package (read-only)\n        ├── Decision: Approve | Approve with Conditions | Return | Decline\n        ├── Return → loops back to override_management or follow_up_questions\n        └── Approve/Decline → export_closeout → LOS push → case archived\n```\n\n---\n\n## 4. Multi-Tenant Architecture\n\n### 4.1 Isolation Strategy\n\n**Approach:** Shared database, shared schema, row-level tenant isolation.\n\n```\n                    ┌─────────────────────────┐\n                    │     JWT Token            │\n                    │  {                       │\n                    │    sub: \"user-uuid\",     │\n                    │    tenant_id: \"siura\",   │\n                    │    roles: [\"underwriter\"]│\n                    │  }                       │\n                    └──────────┬──────────────┘\n                               │\n                    ┌──────────▼──────────────┐\n                    │  NestJS TenantMiddleware │\n                    │  Sets PostgreSQL var:    │\n                    │  app.current_tenant_id   │\n                    └──────────┬──────────────┘\n                               │\n                    ┌──────────▼──────────────┐\n                    │  PostgreSQL RLS Policy   │\n                    │  ON SELECT/INSERT/UPDATE │\n                    │  USING (tenant_id =      │\n                    │    current_setting(       │\n                    │    'app.current_tenant_id'│\n                    │    )::uuid)              │\n                    └─────────────────────────┘\n```\n\n**Defense in Depth:**\n1. JWT contains `tenant_id` — cannot be spoofed (RS256 signed)\n2. NestJS middleware sets PostgreSQL session variable before every query\n3. RLS policies enforce isolation at the database level\n4. Application code also includes `WHERE tenant_id = ?` as a belt-and-suspenders check\n5. Integration credentials are stored per-tenant in `integration_configs`\n\n### 4.2 Tenant Onboarding Flow\n\n```\n1. Create tenant record in `tenants` table\n2. Create admin user for tenant\n3. Configure loan products (AD-02)\n4. Configure scoring model (AD-03)\n5. Configure workflow (AD-04)\n6. Configure document checklists (AD-05)\n7. Configure integrations (AD-08) — credit bureau, KYC, background check, Salesforce\n8. Enable CDFI reporting modules (AD-11)\n9. Run test application end-to-end\n```\n\n### 4.3 Scaling Path\n\n| Tenant Count | Strategy | Trigger |\n|-------------|----------|---------|\n| 1-10 | Shared DB, shared schema, RLS | MVP |\n| 10-50 | Add read replicas, connection pooling (PgBouncer) | Query latency > 200ms |\n| 50+ | Schema-per-tenant or dedicated DB per large tenant | Regulatory requirement or data volume |\n\n---\n\n## 5. Security Architecture\n\n### 5.1 Authentication Flow\n\n```\nLogin Request\n  │\n  ├── Validate credentials (bcrypt compare)\n  ├── Check: account locked? email verified? tenant active?\n  │\n  ├── Generate RS256 access token (15-min expiry)\n  │     Claims: sub, tenant_id, roles[], email, jti\n  │\n  ├── Generate opaque refresh token → Redis (7-day TTL)\n  │     Key: refresh:{jti}  Value: {user_id, tenant_id, session_id}\n  │\n  ├── Track session (max 5 concurrent per user)\n  │     Exceeds 5 → evict oldest session\n  │\n  └── Return: { access_token, refresh_token, expires_in: 900 }\n\nToken Refresh\n  │\n  ├── Validate refresh token exists in Redis\n  ├── Generate new access token + new refresh token (rotation)\n  ├── Delete old refresh token from Redis\n  └── Return new token pair\n```\n\n### 5.2 Authorization Matrix\n\n| Action | Borrower | Underwriter | Credit Manager | Admin |\n|--------|----------|-------------|----------------|-------|\n| Submit application | Own only | — | — | — |\n| Upload documents | Own case | Assigned case | — | — |\n| View financial analysis | — | Assigned case | All cases (read-only) | All |\n| Override AI data | — | Assigned case | — | — |\n| Confirm scoring | — | Assigned case | — | — |\n| Submit review decision | — | — | All cases | — |\n| Configure scoring model | — | — | — | Yes |\n| Manage users | — | — | — | Yes |\n| View audit logs | Own actions | Own cases | All cases | All |\n\n### 5.3 Data Encryption\n\n| Layer | Method | Key Management |\n|-------|--------|----------------|\n| Transport | TLS 1.3 (min 1.2) | Azure Front Door managed certificates |\n| Database at rest | PostgreSQL Flexible Server encryption | Azure-managed keys (automatic rotation) |\n| Blob Storage at rest | SSE with Azure-managed keys (AES-256) | Azure Storage service encryption |\n| Integration credentials | AES-256-GCM | Azure Key Vault (customer-managed key) |\n| SSN field | Application-level AES-256 | Dedicated Key Vault key, masked in UI (last 4) |\n\n### 5.4 API Security Layers\n\n```\nRequest → Rate Limiter → CORS Check → JWT Validation → Tenant Context\n  → RBAC Guard → Input Validation (Zod) → Business Logic → Audit Log\n```\n\nRate limits per role: Borrower 60/min, UW/CM 120/min, Admin 200/min, Unauth 20/min.\n\n---\n\n## 6. Infrastructure Architecture (Azure)\n\n### 6.1 MVP Deployment Topology\n\n```\nRegion: East US\n├── Resource Group: rg-cremologix-{env}\n│\n├── Azure Front Door (Standard)\n│   ├── WAF policy (OWASP 3.2 ruleset)\n│   ├── Custom domain: cremologix.com\n│   ├── Origin: Container Apps environment (API)\n│   └── Origin: Static Web App (SPA)\n│\n├── Virtual Network (10.0.0.0/16)\n│   ├── Subnet: snet-apps (10.0.1.0/24)\n│   │   └── Container Apps Environment (VNet-integrated)\n│   │       ├── Core API (NestJS) — 2-4 replicas, 1 vCPU / 2GB\n│   │       ├── ML Pipeline (FastAPI) — 1-2 replicas, 2 vCPU / 4GB\n│   │       └── BullMQ Worker — 1-2 replicas, 1 vCPU / 2GB\n│   │\n│   ├── Subnet: snet-data (10.0.2.0/24)\n│   │   ├── PostgreSQL Flexible Server (D2s_v3, Zone-Redundant HA)\n│   │   └── Azure Cache for Redis (C1 Standard, 1GB)\n│   │\n│   └── Subnet: snet-private-endpoints (10.0.3.0/24)\n│       ├── Private Endpoint: Blob Storage\n│       └── Private Endpoint: Key Vault\n│\n├── Storage Account: stcremologix{env}\n│   ├── Container: documents (versioning enabled)\n│   ├── Container: exports\n│   ├── Container: ocr-text\n│   └── Lifecycle: Cool tier after 90 days, Archive after 1 year\n│\n├── Azure Static Web Apps\n│   └── React SPA (auto-deploy from GitHub)\n│\n├── Azure Key Vault\n│   ├── db-connection-string\n│   ├── jwt-signing-keys (RS256 keypair)\n│   ├── external-api-keys (Experian, Persona, Checkr, Salesforce)\n│   └── ssn-encryption-key\n│\n├── Azure Document Intelligence\n│   └── S0 tier (custom models + prebuilt tax forms)\n│\n├── Azure Functions (Consumption Plan)\n│   └── ClamAV virus scanner (triggered on blob upload)\n│\n├── Azure Monitor\n│   ├── Application Insights (Core API + ML Pipeline)\n│   ├── Log Analytics Workspace (structured JSON logs)\n│   ├── Custom metrics (case throughput, AI latency)\n│   └── Alert rules (error rate, latency, queue depth)\n│\n└── Azure Container Registry\n    └── cremologixcr{env} (Basic tier)\n```\n\n### 6.2 Estimated Monthly Cost (MVP)\n\n| Resource | Specification | Est. Cost |\n|----------|--------------|-----------|\n| Container Apps (Core API, 2 replicas) | 1 vCPU / 2GB x 2 | ~$60 |\n| Container Apps (ML Pipeline, 1 replica) | 2 vCPU / 4GB x 1 | ~$60 |\n| Container Apps (Worker, 1 replica) | 1 vCPU / 2GB x 1 | ~$30 |\n| PostgreSQL Flexible Server (Zone-HA) | D2s_v3 (2 vCPU / 8GB) | ~$140 |\n| Azure Cache for Redis | C1 Standard (1GB) | ~$40 |\n| Blob Storage (50GB) | Hot tier | ~$5 |\n| Azure Front Door (Standard) | + WAF | ~$35 |\n| Static Web Apps | Free tier (or Standard $9) | $0 |\n| Key Vault | ~20 secrets + 10K operations | ~$5 |\n| Azure Container Registry | Basic | ~$5 |\n| Azure Monitor + App Insights | Logs + metrics | ~$30 |\n| Azure Functions (ClamAV) | ~2000 invocations/mo | ~$5 |\n| Document Intelligence | S0, ~2000 pages/mo | ~$200 |\n| **Azure Subtotal** | | **~$615/mo** |\n| LLM API (Anthropic Claude) | ~2000 docs/mo | ~$500/mo |\n| SendGrid (5000 emails/mo) | Pro plan | $90/mo |\n| Experian Connect API | ~100 pulls/mo | ~$200/mo |\n| Persona (KYC) | ~100 verifications/mo | ~$150/mo |\n| Checkr (Background) | ~80 checks/mo | ~$200/mo |\n| GitHub Team | 4 seats | $44/mo |\n| **Total** | | **~$1,799/mo** |\n\n*Note: Azure credits can offset the Azure Subtotal (~$615/mo). External service costs (LLM, SendGrid, Experian, Persona, Checkr) are billed separately.*\n\n### 6.3 Scaling Triggers\n\n| Metric | Threshold | Action |\n|--------|-----------|--------|\n| API response time p95 | > 500ms for 10 min | Container Apps auto-scale: 2 → 4 replicas |\n| ML Pipeline queue depth | > 50 jobs for 5 min | Container Apps auto-scale: 1 → 2 replicas |\n| PostgreSQL CPU | > 70% sustained | Scale up to D4s_v3 |\n| Redis memory | > 80% | Scale to C2 Standard |\n| Blob Storage | > 100 GB | Enable Cool tier lifecycle rules |\n\n### 6.4 Azure Container Apps Configuration\n\n```yaml\n# Core API Container App\nproperties:\n  configuration:\n    ingress:\n      external: true\n      targetPort: 3000\n      transport: http\n    secrets:\n      - name: db-connection-string\n        keyVaultUrl: https://kv-cremologix.vault.azure.net/secrets/db-connection-string\n  template:\n    containers:\n      - name: core-api\n        image: cremologixcr.azurecr.io/core-api:latest\n        resources:\n          cpu: 1.0\n          memory: 2Gi\n        env:\n          - name: DATABASE_URL\n            secretRef: db-connection-string\n          - name: REDIS_URL\n            value: rediss://cremologix-redis.redis.cache.windows.net:6380\n          - name: AZURE_STORAGE_ACCOUNT\n            value: stcremologixprod\n    scale:\n      minReplicas: 2\n      maxReplicas: 4\n      rules:\n        - name: http-scaling\n          http:\n            metadata:\n              concurrentRequests: \"50\"\n```\n\n---\n\n## 7. Error Handling & Resilience\n\n### 7.1 External Integration Resilience\n\nAll external API calls follow the same pattern:\n\n```\n┌─────────────┐     ┌──────────┐     ┌──────────┐\n│ Attempt 1   │────>│ Attempt 2│────>│ Attempt 3│────> Circuit Open\n│ (immediate) │     │ (5s wait)│     │ (15s wait)│     (30s cooldown)\n└─────────────┘     └──────────┘     └──────────┘\n```\n\n- **Retry policy:** 3 attempts, exponential backoff (1s, 5s, 15s)\n- **Circuit breaker:** Opens after 5 consecutive failures. Half-open after 30s cooldown. Closes after 2 successes.\n- **Fallback behavior per service:**\n\n| Service | Fallback |\n|---------|----------|\n| Experian (Credit Bureau) | Queue for retry. Manual entry available. |\n| Persona (KYC) | Session expires. Borrower can retry (3 attempts). |\n| Checkr (Background Check) | Queue for retry. Intake Agent notified of delay. |\n| Azure Doc Intelligence (OCR) | Fall back to Tesseract (self-hosted container). |\n| SendGrid (Email) | Fall back to Azure Communication Services. |\n| Salesforce | Events queued in Redis. Retry on next sync cycle. |\n| LOS API | Export queued. Retry on next cycle. Manual download always available. |\n\n### 7.2 Data Consistency\n\n- **Database transactions:** All multi-table writes wrapped in transactions\n- **Idempotent operations:** Webhook callbacks deduplicated by provider reference ID\n- **Optimistic locking:** `updated_at` checked on concurrent case updates\n- **Eventual consistency:** Deal Health Score recomputed asynchronously after data changes (< 5s lag)\n\n---\n\n## 8. Monitoring & Observability\n\n### 8.1 Three Pillars\n\n| Pillar | Tool | Key Metrics |\n|--------|------|-------------|\n| **Logs** | Azure Log Analytics (structured JSON via Application Insights) | Request/response, errors, AI pipeline events |\n| **Metrics** | Azure Monitor Custom Metrics + Application Insights | API latency, queue depth, case throughput, AI confidence |\n| **Traces** | Application Insights (distributed tracing) | End-to-end request tracing across Core API + ML Pipeline |\n\n### 8.2 Business Dashboards (Azure Monitor)\n\n| Dashboard | Key Metrics |\n|-----------|-------------|\n| Pipeline Health | Cases/day, avg cycle time, SLA breach rate, phase distribution |\n| AI Performance | OCR accuracy, extraction confidence, classification accuracy, processing time |\n| Integration Status | Credit bureau success rate, KYC pass rate, Salesforce sync lag |\n| System Health | API error rate, p95 latency, database connections, queue depth |\n\n### 8.3 Alerting\n\n| Alert | Condition | Channel |\n|-------|-----------|---------|\n| High Error Rate | > 1% 5xx for 5 min | PagerDuty + Slack |\n| Slow API | p95 > 1s for 10 min | Slack |\n| Queue Backup | > 100 pending jobs for 15 min | Slack |\n| Database Connection Exhaustion | > 18 of 20 connections for 5 min | PagerDuty |\n| Integration Failure | Circuit breaker opened | Slack + email to admin |\n| SLA Breach | Case in phase > SLA target | In-app notification + email |\n\n---\n\n## 9. Development & Deployment\n\n### 9.1 Environment Parity\n\n| Environment | Database | External APIs | AI Models | Deploy Trigger |\n|-------------|----------|---------------|-----------|----------------|\n| Local Dev | Docker Compose (PostgreSQL + Redis + Azurite) | Mock/sandbox | Sandbox keys | Manual |\n| Staging | PostgreSQL Flexible (B1ms) + Azure Redis (C0) | Sandbox/test accounts | Production keys (rate-limited) | Push to `develop` |\n| Production | PostgreSQL Flexible (D2s_v3, Zone-HA) + Azure Redis (C1) | Production accounts | Production keys | Push to `main` (manual approve) |\n\n### 9.2 CI/CD Pipeline\n\n```\nPR Opened\n  ├── Lint (ESLint + Prettier)\n  ├── Type Check (tsc --noEmit)\n  ├── Unit Tests (Jest, >70% coverage)\n  ├── Integration Tests (TestContainers for PostgreSQL)\n  └── Security Scan (npm audit, Snyk)\n\nMerge to develop\n  ├── Build Docker images\n  ├── Push to Azure Container Registry\n  ├── Deploy to Staging (Container Apps revision)\n  ├── Run E2E smoke tests\n  └── Notify Slack\n\nMerge to main (manual approval required)\n  ├── Run database migrations (staging first, then production)\n  ├── Deploy to Production (Container Apps revision with traffic splitting)\n  ├── Run production smoke tests\n  ├── Monitor error rate for 15 min (Application Insights)\n  └── Auto-rollback if error rate > 2% (revert to previous revision)\n```\n\n### 9.3 Database Migration Strategy\n\n- **Tool:** Prisma Migrate (integrated with NestJS)\n- **Forward-only in production** — no down migrations\n- **Large schema changes:** use expand-contract pattern (add new → migrate data → drop old)\n- **Seed data:** separate scripts for each environment (dev: test data, staging: sample data, production: tenant + admin only)\n\n---\n\n## 10. Key Architecture Decisions Record (ADR)\n\n| # | Decision | Options Considered | Chosen | Rationale |\n|---|----------|-------------------|--------|-----------|\n| ADR-001 | API Framework | Express.js, NestJS, Fastify | **NestJS** | Module system maps to domain boundaries, guards for RBAC, interceptors for audit, OpenAPI generation |\n| ADR-002 | AI/ML Runtime | Node.js (all-in-one), Python microservice | **Python FastAPI** | ML ecosystem, model serving, separate scaling from API |\n| ADR-003 | Multi-Tenant Isolation | Schema-per-tenant, DB-per-tenant, RLS | **RLS (shared schema)** | Simplest for MVP, tenant count < 10, upgrade path to schema-per-tenant |\n| ADR-004 | JWT Signing | HS256 (symmetric), RS256 (asymmetric) | **RS256** | Key rotation without service restart, public key verification by any service |\n| ADR-005 | Token Strategy | Long-lived access, Short access + refresh | **15-min access + 7-day refresh** | Limits exposure window, supports session revocation |\n| ADR-006 | Job Queue | Redis pub/sub, BullMQ, Azure Service Bus | **BullMQ** | Redis already in stack, retry/backoff/priority built in, dashboard for monitoring |\n| ADR-007 | ORM | TypeORM, Prisma, raw SQL | **Prisma** | Type-safe queries, migration system, good NestJS integration |\n| ADR-008 | Container Orchestration | Azure Container Apps, AKS, Azure Functions | **Azure Container Apps** | Serverless containers, built-in scaling, simpler than AKS for MVP, upgrade path to AKS |\n| ADR-011 | Cloud Platform | AWS, Azure, GCP | **Azure** | Client has Azure credits, strong PaaS (Container Apps, Flexible Server, Doc Intelligence) |\n| ADR-012 | Credit Bureau | Experian, TransUnion, Equifax | **Experian** | Largest small business data coverage, Connect API for soft pulls |\n| ADR-013 | KYC Provider | Persona, Jumio, Onfido, Socure | **Persona** | Best developer API, strong liveness detection, mobile-optimized, webhook-native |\n| ADR-014 | Background Check | Checkr, Sterling, GoodHire | **Checkr** | Developer-friendly API, fast turnaround, comprehensive checks, webhook-native |\n| ADR-015 | OCR | Azure Doc Intelligence, AWS Textract, Tesseract | **Azure Doc Intelligence** | Native Azure integration, superior financial document handling, prebuilt tax form models |\n| ADR-009 | Financial Normalization | AI-driven, rule-based | **Rule-based (FNE)** | Deterministic, auditable, no model drift. ML enhancement in v2. |\n| ADR-010 | Credit Decisions | AI-automated, human-required | **Human-required (mandate)** | Regulatory compliance, CDFI mission, client trust |\n\n---\n\n*End of Architecture Document*\n","cremologix/deal-health-specification":"# CremoLogix — Deal Health Score Specification\n\n**Status:** Draft\n**Date:** February 9, 2026\n**Purpose:** Define the composite scoring model that drives pre-qualification gates, progressive commitment, and auto-exit triggers.\n\n---\n\n## 1. Overview\n\nThe Deal Health Score is a real-time composite score (0–100) that reflects how likely a deal is to close successfully. It updates progressively as data arrives and drives three critical functions:\n\n1. **Visual indicator** — Circular gauge on underwriter/CM dashboards (red → yellow → green)\n2. **Gate triggers** — Auto-advance or auto-exit decisions at pre-qualification gates\n3. **Prioritization** — Cases ranked by health in underwriter queue\n\n---\n\n## 2. Score Factors\n\n### 2.1 Factor Definitions\n\n| # | Factor | Weight | Data Source | Available At | Score Logic |\n|---|--------|--------|-------------|-------------|-------------|\n| F1 | Credit Score | 15% | Credit bureau API or manual entry | Stage 1 (Intake) | 750+ = 100, 700-749 = 80, 650-699 = 60, 600-649 = 40, <600 = 20 |\n| F2 | KYC Verification | 5% | KYC vendor API | Stage 2 | Pass = 100, Fail = 0 |\n| F3 | Background Check | 10% | Background check vendor | Stage 3 | Clear = 100, Minor flags = 60, Major flags = 20, Disqualifying = 0 |\n| F4 | Time in Business | 5% | Application form | Stage 1 | 5+ years = 100, 3-5 = 80, 2-3 = 60, 1-2 = 40, <1 = 20 |\n| F5 | Revenue Trend | 10% | Financial Normalization Engine | Stage 4 (progressive) | Growing >10% = 100, Growing 0-10% = 80, Flat = 60, Declining 0-10% = 40, Declining >10% = 20 |\n| F6 | Debt Service Coverage Ratio | 15% | Financial Normalization Engine | Stage 4 (progressive) | >1.50 = 100, 1.25-1.50 = 80, 1.10-1.25 = 60, 1.00-1.10 = 40, <1.00 = 20 |\n| F7 | Collateral Adequacy | 10% | Appraisal / borrower input | Stage 4 (progressive) | LTV <60% = 100, 60-70% = 80, 70-80% = 60, 80-90% = 40, >90% = 20, Unsecured = 50 |\n| F8 | Document Completion | 10% | Document tracker | Stage 4 (progressive) | 100% = 100, 75-99% = 75, 50-74% = 50, 25-49% = 25, <25% = 10 |\n| F9 | Borrower Responsiveness | 5% | System timestamps | Stage 4+ | Avg response <24h = 100, 24-48h = 80, 48-72h = 60, 72h-7d = 40, >7d = 20 |\n| F10 | Anomaly Count | 10% | Risk flagging engine | Stage 4+ | 0 flags = 100, 1 flag = 80, 2-3 flags = 60, 4-5 flags = 40, >5 flags = 20 |\n| F11 | Industry Risk | 5% | Application form + NAICS lookup | Stage 1 | Low risk = 100, Moderate = 70, High = 40, Restricted = 10 |\n\n**Total Weight: 100%**\n\n### 2.2 Configurability (Weights + Ranges)\n\nAll factor configuration is managed by Admin via **AD-03 (Scoring Configuration)** and stored in `deal_health_config`. Two things are configurable per factor:\n\n**A. Weights** — How much each factor matters relative to the others.\n- Adjustable via sliders on AD-03\n- Constraint: all weights must sum to 100%\n- Default weights shown in table above are Siura Capital defaults\n\n**B. Score Ranges** — How raw values map to 0–100 scores.\n- Each factor has a set of ranges (breakpoints) that map raw values to scores\n- Admin can adjust these breakpoints to match their risk appetite\n- Example: A CDFI focused on startups might set Credit Score 650+ = 100 instead of 750+ = 100\n\nThe ranges in the table above are **defaults for Siura Capital**. Each factor's ranges are stored as a JSON array of `{ min, max, score }` objects in `factor_ranges_jsonb`:\n\n```json\n{\n  \"F1_credit_score\": {\n    \"type\": \"numeric_range\",\n    \"ranges\": [\n      { \"min\": 750, \"max\": null, \"score\": 100 },\n      { \"min\": 700, \"max\": 749, \"score\": 80 },\n      { \"min\": 650, \"max\": 699, \"score\": 60 },\n      { \"min\": 600, \"max\": 649, \"score\": 40 },\n      { \"min\": null, \"max\": 599, \"score\": 20 }\n    ]\n  },\n  \"F2_kyc\": {\n    \"type\": \"binary\",\n    \"pass_score\": 100,\n    \"fail_score\": 0\n  },\n  \"F3_background\": {\n    \"type\": \"categorical\",\n    \"categories\": [\n      { \"value\": \"clear\", \"score\": 100 },\n      { \"value\": \"minor_flags\", \"score\": 60 },\n      { \"value\": \"major_flags\", \"score\": 20 },\n      { \"value\": \"disqualifying\", \"score\": 0 }\n    ]\n  },\n  \"F6_dscr\": {\n    \"type\": \"numeric_range\",\n    \"ranges\": [\n      { \"min\": 1.50, \"max\": null, \"score\": 100 },\n      { \"min\": 1.25, \"max\": 1.49, \"score\": 80 },\n      { \"min\": 1.10, \"max\": 1.24, \"score\": 60 },\n      { \"min\": 1.00, \"max\": 1.09, \"score\": 40 },\n      { \"min\": null, \"max\": 0.99, \"score\": 20 }\n    ]\n  }\n}\n```\n\n**AD-03 UI for range configuration:** Each factor shows its ranges as editable rows (min/max/score). Admin can add, remove, or modify ranges. The system validates that ranges don't overlap and cover the full value space.\n\n**Note:** Product-specific underwriting thresholds (e.g., \"minimum DSCR for SBA 7(a) loans\") belong in AD-02 (Loan Product Configuration), not here. Deal Health is a pipeline health indicator across all products. Product-specific criteria feed into the underwriting score, which is a separate system.\n\n---\n\n## 3. Score Calculation\n\n### 3.1 Formula\n\n```\nDeal Health Score = Σ (Factor_i_Score × Factor_i_Weight)\n```\n\nWhere each `Factor_i_Score` is 0–100 and `Factor_i_Weight` is 0.00–1.00.\n\n### 3.2 Progressive Scoring\n\nNot all factors are available at intake. The score is calculated using **only available factors**, with weights re-normalized:\n\n```\nAvailable_Weight_Sum = Σ (Weight_i) for all factors where data exists\nProgressive_Score = Σ (Factor_i_Score × Factor_i_Weight) / Available_Weight_Sum × 100\n```\n\n**Example at Stage 1 (only F1, F4, F11 available):**\n- F1 Credit Score: 80 × 0.15 = 12.0\n- F4 Time in Business: 100 × 0.05 = 5.0\n- F11 Industry Risk: 70 × 0.05 = 3.5\n- Available_Weight_Sum = 0.15 + 0.05 + 0.05 = 0.25\n- Progressive_Score = (12.0 + 5.0 + 3.5) / 0.25 × 100 = **82.0**\n\nAs more factors arrive, the score becomes more accurate and the confidence increases.\n\n### 3.3 Confidence Indicator\n\nScore confidence reflects how many factors are contributing:\n\n| Available Weight Sum | Confidence Level | Display |\n|---------------------|-----------------|---------|\n| >= 0.80 | High | Solid gauge, no indicator |\n| 0.50 – 0.79 | Medium | Gauge with \"~\" prefix (e.g., ~74) |\n| < 0.50 | Low | Gauge with \"?\" prefix and dashed border |\n\n---\n\n## 4. Thresholds & Zones\n\n### 4.1 Health Zones\n\n| Zone | Score Range | Color | Meaning |\n|------|-----------|-------|---------|\n| Healthy | 70–100 | Green | Deal is on track. No intervention needed. |\n| Watch | 50–69 | Yellow/Amber | Deal has concerns. Underwriter should monitor closely. |\n| At Risk | 30–49 | Red | Deal has significant issues. May require escalation. |\n| Critical | 0–29 | Dark Red | Deal is unlikely to close. Auto-exit candidate. |\n\n### 4.2 Threshold Configurability\n\nAll thresholds are configurable per tenant via AD-03. The values above are Siura Capital defaults.\n\n---\n\n## 5. Auto-Exit Triggers\n\nThe Deal Health Score can trigger automatic case actions. These are **suggestions** that require human confirmation (per the Human Decision Mandate). The system flags the case; a human acts.\n\n### 5.1 Trigger Rules\n\n| Trigger | Condition | Action | Human Required? |\n|---------|-----------|--------|----------------|\n| Auto-Exit Suggestion | Score drops below 30 AND Confidence >= High | Flag case as \"Auto-Exit Candidate\" on CM dashboard | Yes — CM must confirm or override |\n| Stall Alert | Score unchanged for >7 days AND Document Completion < 75% | Notification to underwriter + borrower reminder | No — automated notification |\n| Escalation Suggestion | Score drops >20 points in a single update | Flag for underwriter review with \"Score Drop Alert\" | Yes — underwriter reviews |\n| Health Recovery | Score rises from Red → Yellow or Yellow → Green | Notification to underwriter: \"Deal health improving\" | No — informational |\n\n### 5.2 Gate Integration\n\nAt pre-qualification gates, the Deal Health Score determines advancement:\n\n| Gate | Factor(s) Checked | Pass | Fail |\n|------|-------------------|------|------|\n| Credit Gate (Stage 1) | F1 (Credit Score) | F1 >= 40 (score 600+) | Route to denial (B-03) |\n| KYC Gate (Stage 2) | F2 (KYC Verification) | F2 = 100 (pass) | Route to denial (B-03) |\n| Background Gate (Stage 3) | F3 (Background Check) | F3 >= 20 (no disqualifying findings) | Route to denial (B-03) |\n| Deal Health Gate (Stage 4) | Composite Score | Score >= 30 (not Critical) | Flag for CM review — auto-exit candidate |\n| Inactivity Gate | F9 (Responsiveness) | Response within 14 days | Stall alert → 30-day timeout → withdrawal suggestion |\n\n**Note:** Credit, KYC, and Background gates use individual factors, not the composite score. The Deal Health Gate at Stage 4 uses the composite score. All denial routing goes through the holding message (B-03) followed by compliant adverse action notice.\n\n---\n\n## 6. Update Triggers\n\nThe Deal Health Score recalculates when:\n\n| Event | Factors Affected |\n|-------|-----------------|\n| Credit bureau result received | F1 |\n| KYC verification complete | F2 |\n| Background check complete | F3 |\n| New document uploaded | F8 |\n| Document extraction complete | F5, F6, F7, F10 (as financial data populates) |\n| Risk flag added/removed | F10 |\n| Borrower responds to question | F9 |\n| Financial analysis complete | F5, F6 |\n| Collateral appraisal received | F7 |\n\nRecalculation is **synchronous** — triggered immediately on data change, not batched. The score is stored and the delta from previous score is logged.\n\n---\n\n## 7. Database Schema\n\n### 7.1 Deal Health Score Table\n\n```\nTABLE: deal_health_scores\n---------------------------------------------------------------\nColumn              | Type         | Constraints\n---------------------------------------------------------------\nid                  | UUID         | PK\ntenant_id           | UUID         | FK → tenants.id, NOT NULL\ncase_id             | UUID         | FK → cases.id, NOT NULL\nscore               | DECIMAL(5,2) | NOT NULL (0.00–100.00)\nconfidence          | VARCHAR(10)  | NOT NULL ('high','medium','low')\nzone                | VARCHAR(10)  | NOT NULL ('healthy','watch','at_risk','critical')\navailable_weight    | DECIMAL(3,2) | NOT NULL (0.00–1.00)\nfactor_scores_jsonb | JSONB        | NOT NULL — individual factor scores and inputs\nprevious_score      | DECIMAL(5,2) | NULL — score before this calculation\nscore_delta         | DECIMAL(5,2) | NULL — change from previous\ntrigger_event       | VARCHAR(100) | NOT NULL — what caused recalculation\ncreated_at          | TIMESTAMPTZ  | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEX: idx_deal_health_case (tenant_id, case_id, created_at DESC)\nINDEX: idx_deal_health_zone (tenant_id, zone)\n```\n\n### 7.2 Deal Health Configuration Table\n\n```\nTABLE: deal_health_config\n---------------------------------------------------------------\nColumn              | Type         | Constraints\n---------------------------------------------------------------\nid                  | UUID         | PK\ntenant_id           | UUID         | FK → tenants.id, NOT NULL, UNIQUE\nfactor_weights_jsonb| JSONB        | NOT NULL — weights per factor (must sum to 1.0)\nfactor_ranges_jsonb | JSONB        | NOT NULL — score ranges per factor (see Section 2.2 for structure)\nzone_thresholds_jsonb| JSONB       | NOT NULL — {healthy: 70, watch: 50, at_risk: 30, critical: 0}\nauto_exit_threshold | DECIMAL(5,2) | NOT NULL DEFAULT 30.00\nstall_days          | INTEGER      | NOT NULL DEFAULT 7\ninactivity_timeout  | INTEGER      | NOT NULL DEFAULT 30\ncreated_at          | TIMESTAMPTZ  | NOT NULL DEFAULT now()\nupdated_at          | TIMESTAMPTZ  | NOT NULL DEFAULT now()\n---------------------------------------------------------------\n```\n\n### 7.3 Factor Scores JSONB Structure\n\n```json\n{\n  \"F1_credit_score\": { \"raw_value\": 720, \"score\": 80, \"weight\": 0.15, \"weighted\": 12.0, \"source\": \"credit_bureau\", \"available\": true },\n  \"F2_kyc\": { \"raw_value\": \"pass\", \"score\": 100, \"weight\": 0.05, \"weighted\": 5.0, \"source\": \"kyc_vendor\", \"available\": true },\n  \"F3_background\": { \"raw_value\": \"clear\", \"score\": 100, \"weight\": 0.10, \"weighted\": 10.0, \"source\": \"background_vendor\", \"available\": true },\n  \"F4_time_in_business\": { \"raw_value\": 7, \"score\": 100, \"weight\": 0.05, \"weighted\": 5.0, \"source\": \"application\", \"available\": true },\n  \"F5_revenue_trend\": { \"raw_value\": 0.08, \"score\": 80, \"weight\": 0.10, \"weighted\": 8.0, \"source\": \"fne\", \"available\": true },\n  \"F6_dscr\": { \"raw_value\": 1.35, \"score\": 80, \"weight\": 0.15, \"weighted\": 12.0, \"source\": \"fne\", \"available\": true },\n  \"F7_collateral\": { \"raw_value\": 0.72, \"score\": 60, \"weight\": 0.10, \"weighted\": 6.0, \"source\": \"appraisal\", \"available\": true },\n  \"F8_doc_completion\": { \"raw_value\": 0.85, \"score\": 75, \"weight\": 0.10, \"weighted\": 7.5, \"source\": \"doc_tracker\", \"available\": true },\n  \"F9_responsiveness\": { \"raw_value\": 18, \"score\": 100, \"weight\": 0.05, \"weighted\": 5.0, \"source\": \"system\", \"available\": true },\n  \"F10_anomaly_count\": { \"raw_value\": 1, \"score\": 80, \"weight\": 0.10, \"weighted\": 8.0, \"source\": \"risk_engine\", \"available\": true },\n  \"F11_industry_risk\": { \"raw_value\": \"moderate\", \"score\": 70, \"weight\": 0.05, \"weighted\": 3.5, \"source\": \"naics_lookup\", \"available\": true }\n}\n```\n\n---\n\n## 8. API Endpoints\n\n| Method | Endpoint | Purpose |\n|--------|----------|---------|\n| GET | `/api/v1/cases/{caseId}/health` | Get current Deal Health Score + factor breakdown |\n| GET | `/api/v1/cases/{caseId}/health/history` | Get score history (all recalculations) |\n| PUT | `/api/v1/admin/deal-health/config` | Update factor weights and thresholds (Admin only) |\n| GET | `/api/v1/admin/deal-health/config` | Get current configuration |\n\nScore recalculation is triggered internally by data events, not by API call.\n\n---\n\n## 9. UI Integration\n\n| Screen | Component | Data |\n|--------|-----------|------|\n| UW-01 (Dashboard) | Deal Health gauge per case in table | Current score + zone |\n| UW-02 (Deal Detail) | Large Deal Health gauge + history mini-chart | Current score + factor breakdown + trend |\n| CM-01 (Manager Dashboard) | Deal Health gauge per case | Current score + zone |\n| CM-04 (Final Review) | Deal Health history chart | Full score history with events |\n| CM-05 (All Deals) | Filterable by health zone | Zone filter in filter bar |\n| AD-03 (Scoring Config) | Weight sliders + threshold config | deal_health_config |\n\n---\n\n## 10. Acceptance Criteria\n\n1. Score calculates correctly at Stage 1 with only 3 factors available (Credit, Time in Business, Industry Risk)\n2. Score updates in real-time when a new document extraction completes\n3. Score recalculates with re-normalized weights when new factors become available\n4. Score drop >20 points triggers an alert on the underwriter dashboard\n5. Score below 30 (Critical zone) flags the case as \"Auto-Exit Candidate\" on CM dashboard\n6. Admin can adjust weights via AD-03 and the change takes effect on next recalculation\n7. Complete score history is viewable on UW-02 and CM-04 with event annotations\n8. All score calculations are logged in the audit trail\n\n---\n\n## 11. Example Walkthrough\n\n### New Application (Stage 1)\n- Borrower applies: Credit Score 720, Business age 7 years, Industry: Restaurant (Moderate risk)\n- Available factors: F1, F4, F11 (weight sum = 0.25)\n- F1: 720 → score 80 × 0.15 = 12.0\n- F4: 7 years → score 100 × 0.05 = 5.0\n- F11: Restaurant → Moderate → score 70 × 0.05 = 3.5\n- Progressive Score = (12.0 + 5.0 + 3.5) / 0.25 = **82.0** (Green, Low confidence)\n\n### After KYC + Background (Stages 2-3)\n- KYC passes, Background clear\n- Available factors: F1, F2, F3, F4, F11 (weight sum = 0.40)\n- Score = (12.0 + 5.0 + 10.0 + 5.0 + 3.5) / 0.40 = **88.75** (Green, Low confidence)\n\n### After Financial Analysis (Stage 4 midpoint)\n- Tax returns extracted: Revenue declining 5%, DSCR 1.15, 2 risk flags, 60% docs complete\n- Available factors: F1-F6, F8, F10, F11 (weight sum = 0.90)\n- Score = (12.0 + 5.0 + 10.0 + 5.0 + 4.0 + 9.0 + 5.0 + 6.0 + 3.5) / 0.90 = **66.1** (Yellow, High confidence)\n- Score dropped from 88.75 → 66.1 (delta -22.65) → **Score Drop Alert triggered**\n\n### After All Data In (Stage 4 complete)\n- Collateral LTV 72%, all docs received, borrower responsive, 1 risk flag resolved\n- All 11 factors available (weight sum = 1.00)\n- Score = 12.0 + 5.0 + 10.0 + 5.0 + 4.0 + 9.0 + 6.0 + 10.0 + 5.0 + 8.0 + 3.5 = **77.5** (Green, High confidence)\n- Score recovered from Yellow to Green → **Health Recovery notification**\n","cremologix/discovery":"# CremoLogix -- Discovery Document\n\n**Status:** CONDITIONAL GO\n**Date:** February 9, 2026\n**Source Files:**\n- `C:/projects/Ideas/CremoLogix/Implementation FIles/00-cremologix-executive-summary.md`\n- `C:/projects/CremoLogix_BA_Reevaluation.md`\n\n---\n\n## 1. Problem Definition\n\nCremoLogix addresses 11 problem components identified through business analysis re-evaluation. These define the full scope of what the platform must solve.\n\n| # | Problem Component | Description |\n|---|---|---|\n| P1 | Origination & Intake | Multi-channel intake (direct + broker), conversational interface, progressive commitment |\n| P2 | Automated Pre-Qualification Gates | Credit threshold, KYC, background/business validation -- kill bad deals early |\n| P3 | AI-Assisted Underwriting & Financial Analysis | Financial normalization, spreading, progressive analysis, deal health scoring |\n| P4 | Human Review & Decision Workflow | Underwriter review, escalation, credit manager decision, case assignment |\n| P5 | Digital Closing | Term sheet generation, e-signature, document management |\n| P6 | Debt Servicing & Covenant Compliance | Post-closing monitoring, covenant tracking, payment management |\n| P7 | Borrower Success Ecosystem | AI Financial Advisor, FinOps Resource, education portal, vendor marketplace |\n| P8 | Denied Applicant Nurture | Reason-based routing, re-qualification monitoring, subscription advisory |\n| P9 | Conversational UX | Chat-style document collection, adaptive sequencing, borrower footnotes |\n| P10 | CDFI-Specific Requirements | TLR reporting, flexible underwriting, impact metrics, Section 1071 readiness |\n| P11 | Regulatory Compliance | ECOA/FCRA adverse action, fair lending, KYC/BSA, data privacy, AI transparency |\n\n---\n\n## 2. Value Proposition\n\n### For Underwriters\n- Reduce cycle time from 5-7 days to 2-3 days\n- 2x productivity (more applications per underwriter)\n- Eliminate manual data entry and calculations\n- Professional credit memos auto-generated\n\n### For CDFIs\n- Scale lending without compromising quality\n- Complete audit trail for compliance\n- Consistent underwriting standards\n- Seamless LOS integration\n\n### For Borrowers\n- Modern portal experience\n- Clear document requirements with progress tracking\n- Voice AI assistant for questions\n- Faster decisions\n\n### Key Innovation\nBidirectional evidence linking -- every decision traceable to source documents, every document linked to decisions.\n\n### MVP Goal\nSingle-tenant prototype demonstrating complete underwriting workflow in 6-9 months.\n\n---\n\n## 3. Market & Competitive Analysis\n\n### Category 1: Full-Lifecycle Platforms\n\n#### nCino\n- **Problem Coverage:** P1 (partial -- no conversational intake), P3 (partial -- credit analysis, not financial normalization), P4 (strong -- workflow engine), P5 (strong), P6 (partial -- portfolio management, not deep covenant), P11 (partial)\n- **Not Covered:** P2 (no automated pre-qual gates), P7 (no borrower success), P8 (no denied applicant nurture), P9 (no conversational UX), P10 (no CDFI-specific)\n- **Strengths:** Market leader in commercial lending automation; Salesforce ecosystem; deep workflow engine; 2,700+ FI customers; new 2025 modular packages for smaller institutions\n- **Weaknesses:** Expensive for CDFIs; Salesforce dependency adds cost and complexity; no borrower-facing engagement beyond basic portal; no AI financial advisory\n- **Tradeoffs:** Optimizes for enterprise breadth and Salesforce integration; sacrifices CDFI accessibility and borrower experience depth\n- **Coverage: 4 of 11 components (partial coverage on 2 more)**\n\n#### Moody's Lending Suite (CreditLens + QUIQspread)\n- **Problem Coverage:** P3 (strong -- best-in-class financial spreading, 95%+ accuracy), P4 (partial -- credit lifecycle management), P6 (partial -- covenant monitoring)\n- **Not Covered:** P1, P2, P5, P7, P8, P9, P10, P11\n- **Strengths:** Gold standard for automated financial spreading (22M+ firms); strong covenant monitoring; deep risk assessment and benchmarking\n- **Weaknesses:** Enterprise pricing prohibitive for CDFIs; no borrower-facing tools; no conversational intake; no CDFI features\n- **Tradeoffs:** Optimizes for analytical depth and institutional scale; sacrifices accessibility and end-to-end lifecycle coverage\n- **Coverage: 1 of 11 components fully, 2 partial**\n\n#### TurnKey Lender\n- **Problem Coverage:** P1 (partial -- multi-channel but no conversational), P3 (partial -- AI decisioning but not deep normalization), P4 (partial -- workflow automation), P5 (partial), P6 (partial -- servicing and collection)\n- **Not Covered:** P2 (no progressive commitment gates), P7, P8, P9, P10 (claims CDFI focus but no TLR/impact reporting)\n- **Strengths:** Closest full-lifecycle competitor at CDFI-accessible pricing ($500/mo); explicit CDFI marketing; 90%+ automation claim; no-code configuration; fast deployment\n- **Weaknesses:** Less sophisticated spreading than Moody's; no borrower success; no denied applicant features; no conversational AI; CDFI claim is marketing, not feature-deep\n- **Tradeoffs:** Optimizes for breadth and affordability; sacrifices depth in analysis, borrower experience, and post-decision support\n- **Coverage: 0 of 11 fully, 5 partial**\n\n#### Baker Hill NextGen / UN/FY\n- **Problem Coverage:** P1 (partial -- guided workflows), P3 (partial -- AI-driven origination), P4 (partial -- workflow automation)\n- **Not Covered:** P2, P5, P6, P7, P8, P9, P10, P11\n- **Strengths:** Strong community bank focus; 90-day implementation; AI cuts origination costs 60%\n- **Weaknesses:** Primarily origination-focused; no post-closing depth; no CDFI-specific features\n- **Coverage: 0 of 11 fully, 3 partial**\n\n### Category 2: Post-Closing / Covenant Compliance\n\n#### CovenantIQ\n- **Problem Coverage:** P6 (strong -- AI-powered covenant extraction and monitoring with shared borrower dashboard)\n- **Not Covered:** P1-P5, P7-P11\n- **Strengths:** Best-in-class AI covenant extraction; direct connection to borrower financial systems; data normalization; proactive compliance alerts; shared lender-borrower dashboard\n- **Weaknesses:** Middle-market focus, not CDFI; post-closing only; no origination\n- **Coverage: 1 of 11 fully**\n\n#### BankStride\n- **Problem Coverage:** P6 (partial -- covenant tracking, document collection, borrower reminders)\n- **Not Covered:** P1-P5, P7-P11\n- **Strengths:** Purpose-built loan monitoring; automated borrower reminders; login-less borrower portal\n- **Weaknesses:** No AI analysis; post-closing only; narrow focus\n- **Coverage: 0 of 11 fully, 1 partial**\n\n### Category 3: Borrower Success / Financial Advisory\n\n#### Nav\n- **Problem Coverage:** P7 (partial -- credit monitoring, financial health, marketplace), P8 (partial -- implicit denied applicant pathway via credit building)\n- **Not Covered:** P1-P6, P9-P11\n- **Strengths:** Closest analog to borrower success concept; 350K+ businesses; combines credit monitoring with financing marketplace; credit building tools\n- **Weaknesses:** Not lender-integrated; not embeddable; marketplace model may conflict with CDFI mission; no covenant monitoring\n- **Coverage: 0 of 11 fully, 2 partial**\n\n#### Compass AI\n- **Problem Coverage:** P7 (partial -- AI CFO assistant, financial recommendations with dollar estimates)\n- **Not Covered:** P1-P6, P8-P11\n- **Strengths:** Truly AI-driven (not human-dependent); 24/7 AI CFO; actionable recommendations; affordable ($49-99/mo)\n- **Weaknesses:** Standalone; no lender integration; no lending features; focused on financial planning\n- **Coverage: 0 of 11 fully, 1 partial**\n\n#### Knolli\n- **Problem Coverage:** P3 (partial -- data normalization from CSV/Excel/PDF), P7 (partial -- CFO workflow automation)\n- **Not Covered:** P1, P2, P4-P6, P8-P11\n- **Strengths:** Strong data normalization (potential analog for financial spreading); KPI mapping; multi-client support\n- **Weaknesses:** Not lending-specific; startup/growth focused, not SMB lending; no lender integration\n- **Coverage: 0 of 11 fully, 2 partial**\n\n### Category 4: Denied Applicant / Credit Repair\n\n#### Credit Repair Cloud\n- **Problem Coverage:** P8 (tangential -- dispute management and credit tracking, but not lender-integrated)\n- **Not Covered:** P1-P7, P9-P11\n- **Strengths:** Market leader in credit repair software; tracks credit changes; automated dispute creation\n- **Weaknesses:** Designed for credit repair businesses, not lenders; no lender integration; no re-qualification triggers; consumer credit only\n- **Coverage: 0 of 11 (tangential only)**\n\n**MARKET GAP CONFIRMED:** No product in this category addresses lender-integrated denied applicant nurture with automated re-qualification monitoring.\n\n### Category 5: Conversational Lending\n\n#### Casca (Cascading AI)\n- **Problem Coverage:** P1 (partial -- multi-channel intake), P9 (strong -- best-in-class conversational lending), P3 (partial -- automated document collection and analysis)\n- **Not Covered:** P2, P4-P8, P10, P11\n- **Strengths:** Best conversational lending experience; 90% less manual effort; 300% higher conversion; AI handles both applicant and officer interactions; $29M Series A (2025)\n- **Weaknesses:** Origination only; no post-closing; no borrower success; no CDFI-specific\n- **Tradeoffs:** Optimizes for conversational origination experience; sacrifices lifecycle completeness\n- **Coverage: 1 of 11 fully, 2 partial**\n\n#### Lendflow\n- **Problem Coverage:** P1 (partial -- embeddable widgets), P9 (partial -- conversational widgets), P3 (partial -- 50+ AI agents for lending)\n- **Not Covered:** P2, P4-P8, P10, P11\n- **Strengths:** 50+ AI agents; embeddable; API-first; Experian partnership\n- **Weaknesses:** Infrastructure/marketplace model; requires integration work; no servicing\n- **Coverage: 0 of 11 fully, 3 partial**\n\n### Category 6: Broker Portal / Multi-Channel\n\n#### LendingWise\n- **Problem Coverage:** P1 (partial -- broker and borrower portals with status tracking)\n- **Not Covered:** P2-P11\n- **Strengths:** True broker portal; CRM integration; affordable ($75-100/user/mo); fast setup\n- **Weaknesses:** Private/bridge lending focus; limited AI; no complex commercial underwriting\n- **Coverage: 0 of 11 fully, 1 partial**\n\n#### Abrigo (Sageworks)\n- **Problem Coverage:** P1 (partial), P4 (partial -- credit risk assessment), P10 (partial -- explicitly partners with CDFIs)\n- **Not Covered:** P2, P3, P5-P9, P11\n- **Strengths:** Only competitor besides Craftsman that explicitly partners with CDFIs; auto-decision for policy loans; standardized templates\n- **Weaknesses:** No AI chatbot; no borrower success; no covenant monitoring; less innovative than AI-native entrants\n- **Coverage: 0 of 11 fully, 3 partial**\n\n### Category 7: Financial Normalization / Spreading\n\n#### Moody's QUIQspread\n- **Problem Coverage:** P3 (strong -- 95%+ accuracy, 22M+ firms, standardized spreading)\n- **Not Covered:** P1, P2, P4-P11\n- **Strengths:** Industry gold standard; continuously improving ML; integrates with CreditLens\n- **Weaknesses:** Enterprise pricing; not CDFI-accessible; limited tax return spreading\n- **Coverage: 1 of 11 fully (for the spreading sub-component only)**\n\n#### FlashSpread (BeSmartee)\n- **Problem Coverage:** P3 (partial -- tax return spreading only, not full normalization)\n- **Not Covered:** P1, P2, P4-P11\n- **Strengths:** Tax return specialization (1040, 1120, K-1); 96% time reduction; community bank friendly; affordable\n- **Weaknesses:** Spreading only; limited normalization across business types; no common-sizing across diverse entities\n- **Coverage: 0 of 11 fully, 1 partial**\n\n### Category 8: Deal Health / Pipeline Intelligence\n\n#### Dealpath\n- **Problem Coverage:** P4 (partial -- pipeline and deal management)\n- **Not Covered:** P1-P3, P5-P11\n- **Strengths:** Purpose-built CRE deal management; AI data extraction; used by top 10 CRE investors\n- **Weaknesses:** CRE only; not SMB or CDFI; institutional pricing\n- **Coverage: 0 of 11 fully, 1 partial**\n\n### CDFI-Specific Platforms\n\n#### Craftsman Technology Group (CDFI Accelerator)\n- **Problem Coverage:** P1 (partial -- pipeline tracking, lead conversion), P10 (strong -- purpose-built for CDFIs, TLR reporting, TA tracking)\n- **Not Covered:** P2, P3, P5-P9, P11\n- **Strengths:** Only platform purpose-built for CDFIs with one-click TLR reporting; 100+ CDFI clients; SBA Nexus reporting\n- **Weaknesses:** Salesforce-dependent; no AI underwriting; no financial spreading; no borrower success; no covenant monitoring\n- **Coverage: 1 of 11 fully, 1 partial**\n\n#### Fundingo\n- **Problem Coverage:** P1 (partial -- origination), P5 (partial -- closing), P6 (partial -- servicing), P10 (partial -- serves CDFIs)\n- **Not Covered:** P2, P3, P7-P9, P11\n- **Strengths:** Covers origination through servicing; NACHA file generation; SOC 2 Type II; serves CDFIs\n- **Weaknesses:** Less AI sophistication; no conversational AI; no borrower success; no denied applicant nurture\n- **Coverage: 0 of 11 fully, 4 partial**\n\n### Cross-Solution Patterns\n\n#### Common Strengths Across Solutions\n1. **Workflow automation** -- Nearly all platforms automate basic origination workflows\n2. **Document management** -- Standard capability across the market\n3. **Dashboard and reporting** -- Expected feature, not a differentiator\n4. **API integrations** -- Most platforms offer credit bureau, e-signature, and data source integrations\n\n#### Common Weaknesses (Repeated Market Gaps)\n1. **No borrower success ecosystem** -- Zero platforms offer integrated post-closing borrower advisory, education, and marketplace within a lending system\n2. **No denied applicant nurture** -- Zero platforms connect denial workflows to improvement pathways with automated re-qualification\n3. **No conversational UX for commercial lending** -- Casca is the only notable entrant; no CDFI-focused conversational lending exists\n4. **No CDFI-grade financial normalization** -- QUIQspread is enterprise-only; FlashSpread is limited to tax returns; no tool common-sizes across diverse small business entity types at CDFI-accessible pricing\n5. **No real-time deal health scoring for SMB lending** -- Pipeline intelligence tools serve PE/CRE only\n6. **CDFI platforms are technologically behind** -- Craftsman, Fundingo, and Builders Patch serve CDFIs but lack AI, conversational UX, and lifecycle depth\n\n#### Repeated Tradeoffs the Market Makes\n1. **Breadth vs. Depth** -- Full-lifecycle platforms (nCino, TurnKey) cover many stages shallowly; specialist tools (QUIQspread, CovenantIQ) go deep on one stage\n2. **Enterprise vs. Accessible** -- Best-in-class tools (Moody's, nCino, FIS) are enterprise-priced; CDFI-accessible tools (Craftsman, Fundingo) are feature-limited\n3. **Origination vs. Post-Closing** -- The market heavily invests in origination; post-closing is an afterthought for nearly all platforms\n4. **Lender-Centric vs. Borrower-Centric** -- Nearly all platforms are designed for lender efficiency; borrower experience is secondary\n\n### Coverage Gap Matrix\n\n| Problem Component | # Solutions with Full Coverage | # Solutions with Partial Coverage | Gap Severity |\n|---|---|---|---|\n| P1: Origination & Intake | 0 | 8 | Medium (many partial, none complete with conversational + broker) |\n| P2: Automated Pre-Qual Gates | 0 | 0 | **Critical (no competitor has progressive commitment gates)** |\n| P3: AI Underwriting & Normalization | 2 (QUIQspread, CovenantIQ for their niches) | 6 | High (no integrated normalization + spreading + deal health) |\n| P4: Human Review Workflow | 1 (nCino) | 5 | Low-Medium (well-served by incumbents) |\n| P5: Digital Closing | 0 | 3 | Low (commodity, easily assembled from DocuSign + templates) |\n| P6: Covenant Compliance | 1 (CovenantIQ) | 4 | Medium (specialists exist but not integrated) |\n| P7: Borrower Success | 0 | 2 (Nav, Compass AI tangential) | **Critical (blue ocean -- no integrated solution)** |\n| P8: Denied Applicant Nurture | 0 | 0 | **Critical (entirely unaddressed by any product)** |\n| P9: Conversational UX | 1 (Casca) | 2 | High (Casca leads but is not CDFI-focused or lifecycle-complete) |\n| P10: CDFI-Specific | 1 (Craftsman) | 3 | High (Craftsman covers reporting but nothing else) |\n| P11: Regulatory Compliance | 0 | 2 | Medium (compliance is built per-platform, not a standalone product gap) |\n\n---\n\n## 4. Product Viability & Differentiation\n\n### Viability Statement\n\n**CremoLogix is competitively viable.** The expanded platform vision -- covering the full lifecycle from origination through borrower success and denied applicant nurture -- targets a combination of capabilities that **no single competitor addresses**. The three most differentiated components (Borrower Success Ecosystem, Denied Applicant Nurture, and CDFI-focused Conversational AI) have zero direct competition.\n\n### Meaningfully Different (Structural Advantages)\n\n1. **Denied Applicant Nurture with Re-Qualification Monitoring** -- This is a novel capability. No competitor offers lender-integrated denied applicant pathways with automated re-qualification triggers. This creates a new revenue stream (subscription advisory) and a new pipeline source (nurture-to-conversion). This is not a feature reword -- it is a fundamentally different approach to denied applicants.\n\n2. **Integrated Borrower Success Ecosystem** -- Nav and Compass AI offer fragments of this (credit monitoring, AI advisory) but neither is embedded within a lending platform. The integration of AI Financial Advisor + FinOps Resource + Education Portal + Vendor Marketplace + Business Progression Monitoring within the same platform that originated and services the loan is structurally unique.\n\n3. **Financial Normalization Engine** -- The concept of common-sizing all financial data into objective standardized buckets to level the playing field for diverse borrower types (sole proprietor, LLC, nonprofit, etc.) is not offered by any competitor at CDFI-accessible pricing. QUIQspread normalizes but is enterprise-only and not designed for CDFI borrower diversity.\n\n4. **Progressive Commitment Model** -- No competitor implements automated kill gates that progressively invest resources only as deals prove viable. Most platforms treat all applications equally through the full pipeline. This is a process innovation, not a feature.\n\n5. **CDFI-Native Design** -- While Craftsman, Fundingo, and Abrigo serve CDFIs, none was built from the ground up for CDFI-specific needs (flexible underwriting, impact reporting, Section 1071 readiness) combined with modern AI capabilities.\n\n### Marginally Different\n\n6. **Conversational Document Collection** -- Casca leads here, and CremoLogix's conversational UX would need to match Casca's quality to be competitive. The difference is marginal in UX approach but meaningful in context (CDFI-focused vs. general, lifecycle-integrated vs. origination-only).\n\n7. **Three-Layer Analysis Model** -- This is a structured approach to analysis documentation that does not exist elsewhere, but the differentiation is more about methodology than technology. It is valuable but not a standalone selling point.\n\n### Not Different (Parity Requirements)\n\n8. **Workflow automation, document management, dashboards, e-signature** -- These are table stakes. Every competitor offers them. CremoLogix must reach parity but will not differentiate here.\n\n9. **Credit bureau integration, KYC vendor integration, Plaid/banking data** -- Commodity integrations. Required but not differentiating.\n\n### Parity Requirements (Must-Have to Compete)\n\n| Capability | Must Exist By | Difficulty |\n|---|---|---|\n| Loan origination workflow | Day 1 | Medium -- standard, well-understood |\n| Credit bureau soft pull | Day 1 | Low -- API integration |\n| Document upload and management | Day 1 | Low -- standard |\n| Dashboard and reporting | Day 1 | Medium -- design-intensive |\n| KYC identity verification | Day 1 | Low -- vendor API |\n| E-signature integration | Day 1 | Low -- DocuSign/similar API |\n| Financial spreading | Day 1 | **High -- requires ML/AI or integration** |\n| Credit memo generation | Day 1 | Medium-High -- requires AI text generation |\n| Covenant monitoring | Post-MVP | Medium -- needs calendar + document tracking |\n| Multi-channel intake (broker portal) | Day 1 | Medium -- second portal to build |\n\n### Fatal Flaw Analysis\n\n#### Potential Fatal Flaws Examined\n\n1. **FCRA Permissible Purpose for Denied Applicant Monitoring** -- The compliance research identified that FCRA has NO permissible purpose for ongoing credit bureau monitoring of denied applicants. **This is NOT fatal** because the business logic already contemplates consent-based monitoring alternatives (borrower-initiated credit sharing, Plaid-connected data, prescreened offer framework). The compliance report confirms these alternatives are legally viable. However, this constraint DOES limit the sophistication of re-qualification monitoring and must be designed carefully.\n\n2. **Fair Lending Risk of AI Underwriting** -- The Massachusetts AG v. Earnest settlement ($2.5M, July 2025) and Colorado AI Act (effective June 2026) create real regulatory risk. **This is NOT fatal** because: (a) the risk applies to ALL AI-based lenders, not just CremoLogix; (b) CDFIs' flexible underwriting mandate actually provides more latitude than conventional lenders; (c) the platform's three-layer analysis model and virtual workpapers create an unusually strong audit trail. The risk is manageable with proper model governance.\n\n3. **Scope Complexity** -- The expanded vision (~80+ screens, 8 user types, 11 workflow stages) is significantly more complex than the original underwriting sidecar. **This is a REAL concern** but not fatal. It requires careful phasing and MVP scoping. Attempting to build everything simultaneously would be execution suicide.\n\n4. **Financial Normalization Engine** -- No off-the-shelf solution exists for CDFI-grade common-sizing across diverse business types. This must be built, likely using ML models trained on CDFI lending data. **This is HIGH execution risk** because the accuracy requirements are demanding and the training data may be limited. However, it can be phased -- start with rule-based normalization and evolve to ML.\n\n5. **Incumbents with Lock-In** -- nCino has 2,700+ FI customers. Craftsman has 100+ CDFIs. However, the 2025 Richmond Fed CDFI Survey indicates CDFIs are actively seeking better technology, and no incumbent covers the lifecycle envisioned. **Not fatal** -- the gap is large enough to overcome switching inertia.\n\n**No Fatal Flaws Identified.** None of the examined risks are individually sufficient to kill viability. The combination of scope complexity + financial normalization execution risk is the most concerning pair.\n\n### Structural Advantages\n\n1. **Greenfield Design** -- Unlike nCino (Salesforce legacy) or Craftsman (Salesforce dependency), CremoLogix can be architected from scratch for the full lifecycle without legacy constraints.\n2. **CDFI Regulatory Latitude** -- CDFIs have explicit exemptions from ATR/QM requirements and can use alternative underwriting approaches. This is a structural advantage competitors serving conventional banks cannot leverage.\n3. **Revenue Model Innovation** -- The denied applicant subscription advisory model creates recurring revenue from applications that competitors treat as dead leads. This is a unique revenue stream.\n4. **Data Compounding** -- Each borrower interaction (origination, servicing, advisory) generates data that improves the Financial Normalization Engine and AI models. This creates a flywheel that strengthens with scale.\n5. **Mission Alignment** -- CDFIs exist to serve underserved communities. A platform designed to maximize borrower success (not just lender efficiency) aligns with CDFI mission in a way that repurposed bank software never will.\n\n### Key Assumptions and Risks\n\n| Assumption | Assessment |\n|---|---|\n| CDFIs will pay for a platform that covers the full lifecycle | **Reasonable** -- Richmond Fed survey confirms demand; CDFIs currently use 3-5 fragmented tools |\n| Financial Normalization Engine can achieve sufficient accuracy | **Risky** -- No comparable product exists; requires ML expertise and CDFI training data |\n| Denied applicant nurture creates measurable conversion pipeline | **Reasonable but unproven** -- No market data exists; this is a bet on a novel concept |\n| Borrower success ecosystem reduces default rates | **Reasonable** -- Logically sound (supported borrowers perform better) but no CDFI-specific data |\n| Conversational UX increases application completion rates | **Reasonable** -- Casca reports 300% higher conversion; academic literature supports guided UX |\n| CDFIs will switch from Craftsman/Fundingo/spreadsheets | **Reasonable** -- If the value proposition is clear and onboarding is supported |\n| AI compliance risk is manageable | **Reasonable** -- With proper model governance, audit trails, and fair lending testing |\n\n### Overall Risk Classification\n\n**MEDIUM RISK** -- The product idea is sound, the market gap is real, and the differentiation is structural (not cosmetic). The primary risks are execution-related (scope, financial normalization accuracy) and regulatory (AI fair lending). Neither is a market risk -- no competitor is threatening to close these gaps.\n\n---\n\n## 5. Solution-Problem Alignment\n\n### Overall Assessment: PARTIALLY ALIGNED -- with 13 identified gaps\n\nThe core workflows (origination, underwriting, decision-making, closing) are well-defined and internally coherent. The gaps are concentrated in: (1) specification depth for novel components, (2) CDFI-specific features that are assumed but not specified, (3) regulatory compliance details, and (4) operational mechanics for post-closing.\n\n### Problem-to-Solution Mapping\n\n**P1: Origination & Intake** -- FULLY ALIGNED. Both channels defined with clear workflows, entry points, and system behaviors. No gaps.\n\n**P2: Automated Pre-Qualification Gates** -- FULLY ALIGNED. Each gate has defined trigger, logic, pass/fail behavior, and denied applicant routing. No gaps.\n\n**P3: AI-Assisted Underwriting & Financial Analysis** -- PARTIALLY ALIGNED.\n- **Gap 1:** The Financial Normalization Engine is NOT detailed in the business logic document. The document mentions \"spreading financial statements into standardized format\" but does not define the common-sizing logic, entity type handling, or objective bucket structure. This is a significant specification gap.\n- **Gap 2:** The Deal Health Scoring Engine is referenced but its inputs, weights, thresholds, and calculation logic are not specified.\n\n**P4: Human Review & Decision Workflow** -- FULLY ALIGNED. Comprehensive workflow defined for case assignment, progressive monitoring, escalation, and final decision with clear role boundaries. No gaps.\n\n**P5: Digital Closing** -- FULLY ALIGNED. Both term sheet stages defined with clear triggers and content. No gaps.\n\n**P6: Debt Servicing & Covenant Compliance** -- MOSTLY ALIGNED.\n- **Gap 3:** Payment processing mechanics are not defined (payment collection, processing integrations, delinquency workflows, collection procedures).\n- **Gap 4:** Loan modification workflows are not defined (rate changes, term extensions, covenant waivers).\n\n**P7: Borrower Success Ecosystem** -- MOSTLY ALIGNED.\n- **Gap 5:** The AI Financial Advisor's behavior is described at a high level but its data inputs, analysis methodology, recommendation types, and guardrails are not specified. Given regulatory complexity (Investment Advisers Act, UDAAP), this needs deeper definition.\n- **Gap 6:** Vendor Marketplace curation, onboarding, and revenue model are not defined.\n\n**P8: Denied Applicant Nurture** -- MOSTLY ALIGNED.\n- **Gap 7:** The re-qualification monitoring mechanism needs to specify HOW monitoring occurs without violating FCRA. The business logic document states \"system monitors credit score\" without specifying the data source.\n- **Gap 8:** Subscription pricing model, tiers, and value proposition are not defined.\n\n**P9: Conversational UX** -- FULLY ALIGNED. Well-specified conversational workflow with adaptive sequencing, real-time analysis, and footnote capture. Minor observation: the relationship between the conversational interface and the borrower dashboard needs clearer specification.\n\n**P10: CDFI-Specific Requirements** -- PARTIALLY ALIGNED.\n- **Gap 9:** CDFI Fund TLR reporting requirements are not addressed in the business logic.\n- **Gap 10:** Impact metrics tracking (jobs created, housing units, community development purpose) is not specified.\n- **Gap 11:** Section 1071 small business lending data collection is not addressed (Tier 1 by July 2026).\n\n**P11: Regulatory Compliance** -- PARTIALLY ALIGNED.\n- **Gap 12:** Specific regulatory requirements not reflected in the business logic: Colorado AI Act (SB 24-205) pre-decision disclosure requirements (effective June 2026), SR 11-7 model documentation requirements for AI/ML models, GLBA privacy notice requirements, state privacy law compliance (CCPA/CPRA baseline).\n- **Gap 13:** Fair lending testing framework is not specified. Each automated gate is a \"policy\" subject to disparate impact analysis. No testing methodology is defined.\n\n### Workflow Coherence Check\n\n| Workflow | Coherent? | Issue |\n|---|---|---|\n| Direct Borrower: Landing to Credit to KYC to Background to DD to Underwriter to CM to Closing | Yes | Clean, well-sequenced |\n| Broker: Packet to Parse to Credit to KYC to Background to DD to ... | Yes | Document reconciliation logic is sound |\n| Escalation: Underwriter to CM to Response to Underwriter | Yes | Clear back-and-forth with workpaper preservation |\n| Denial to Decision Engine to Routing to Nurture to Re-qualification to Reapply | Mostly | **Broken chain:** Re-qualification monitoring mechanism undefined (FCRA gap) |\n| Post-Closing: Close to Servicing to Covenant Monitoring to Incentives | Mostly | **Missing link:** Payment processing not specified |\n| External Funding: CM Approval to Packet to External Review to Decision | Yes | Near-term and future state both defined |\n\n---\n\n## 6. Optimization Recommendations\n\n### Critical Gaps (Must Address Before Architecture)\n\n#### Recommendation 1: Define Financial Normalization Engine Specification\n**Gap Addressed:** Gap 1 (Financial Normalization Engine not specified)\n- Add dedicated section defining: input types (tax returns 1040/1120/1120-S/1065, financial statements, QuickBooks data, bank statements, Plaid cash flow data), entity type handling (sole proprietor, LLC, S-Corp, C-Corp, nonprofit, partnership), common-sizing methodology (standardized income buckets, standardized balance sheet buckets, standardized cash flow categories), output format (normalized financial profile enabling apples-to-apples comparison regardless of entity type)\n- **Phasing:** Rule-based normalization in MVP, ML-enhanced in v2\n- **Tradeoff:** Acceptable -- rule-based normalization is a functional starting point\n\n#### Recommendation 2: Specify Re-Qualification Monitoring Mechanism (FCRA-Compliant)\n**Gap Addressed:** Gap 7 (FCRA permissible purpose)\n- Replace \"system monitors credit score\" with specific consent-based mechanisms:\n  - For credit-denied applicants: Platform invites denied applicant to share credit data through consumer-consented services. The platform DOES NOT pull credit reports on denied applicants.\n  - For financially-denied applicants: Platform monitors through consented integrations (Plaid bank data, QuickBooks, voluntary financial statement uploads).\n  - Re-qualification trigger: When consented data indicates qualification criteria are met, system generates soft term sheet and invitation. Borrower must submit a NEW application.\n- **Tradeoff:** Monitoring is less comprehensive than automated credit pulls, but legally sound\n\n#### Recommendation 3: Add CDFI Reporting Features to Business Logic\n**Gap Addressed:** Gaps 9, 10, 11 (CDFI Fund TLR, impact metrics, Section 1071)\n- **CDFI Fund TLR Report Generator:** Automated generation requiring census tract, community development purpose, target market indicators per transaction\n- **Impact Metrics Dashboard:** Track jobs created/retained, housing units, businesses assisted, demographic breakdowns, geographic distribution\n- **Section 1071 Data Collection:** Collect applicant demographics (race, ethnicity, sex), business ownership demographics, application disposition, pricing data, geographic data. Store separately from underwriting data.\n- **Tradeoff:** Additional data collection at intake adds form length, but these are regulatory requirements\n\n#### Recommendation 4: Specify Deal Health Scoring Logic\n**Gap Addressed:** Gap 2 (Deal Health Scoring not specified)\n- Define the Deal Health Score as a composite of weighted factors: credit score, KYC verification status, background check results, time in business, revenue trend, DSCR, collateral adequacy, document completion rate, borrower responsiveness, anomaly count\n- Score updates in real time as each data point arrives\n- Configurable thresholds for: green (healthy), yellow (watch), red (at risk), auto-exit\n- **Tradeoff:** Initial weights are estimates; accuracy improves with portfolio data\n\n### Important Gaps (Should Address Before Build)\n\n#### Recommendation 5: Define Payment Processing Mechanics\n**Gap Addressed:** Gap 3\n- Payment collection via ACH (NACHA file generation) or integrated payment processor; payment tracking and reconciliation; late payment detection with automated notification escalation; delinquency workflow\n\n#### Recommendation 6: Define Loan Modification Workflow\n**Gap Addressed:** Gap 4\n- Modification types: rate change, term extension, payment deferral, covenant waiver, loan restructuring; expedited approval workflow; modification agreement generation and e-signature\n\n#### Recommendation 7: Add Fair Lending Testing Framework\n**Gap Addressed:** Gap 13\n- Quarterly disparate impact analysis; annual comprehensive fair lending audit; per-model documentation; each automated gate must have documented business justification and disparate impact analysis; AI model governance board\n\n#### Recommendation 8: Specify AI Financial Advisor Guardrails\n**Gap Addressed:** Gap 5\n- Define as a **financial education and coaching tool** (not an investment advisor)\n- Provides: general financial health observations, cash flow trend analysis, expense benchmarking, seasonal pattern alerts, debt management principles\n- Does NOT provide: specific investment recommendations, tax advice, insurance recommendations\n- Required disclaimers and prohibited-topics list\n\n### Deferrable Gaps (Can Address Post-Launch)\n\n#### Recommendation 9: Vendor Marketplace as Phase 2\n**Gap Addressed:** Gap 6. Defer to post-launch. Focus MVP on core lending lifecycle + borrower success (AI Advisor + FinOps + Education).\n\n#### Recommendation 10: Education Portal as Curated Content Initially\nLaunch with curated external content rather than original content creation.\n\n#### Recommendation 11: External Funding Stakeholder Portal as Phase 2\nNear-term approach (PDF packet via email) is the MVP approach.\n\n#### Recommendation 12: Clarify Dashboard vs. Conversational Interface Relationship\nSpecify two primary borrower interfaces: Conversational Interface (where borrower DOES things, primary during Stages 1-4) and Borrower Dashboard (where borrower SEES things, persistent status view).\n\n#### Recommendation 13: Add Colorado AI Act Compliance Requirements\nBefore any AI-assisted credit decision, the system must: notify the applicant that an AI system will be used, disclose the purpose, provide contact information for questions. Effective June 2026.\n\n---\n\n## 7. Go/No-Go Recommendation\n\n### CONDITIONAL GO\n\nCremoLogix should proceed to architecture and build, subject to the following conditions:\n\n### Condition 1: Strict MVP Phasing\nThe platform must NOT attempt to build all ~80+ screens and 11 stages simultaneously.\n- **Phase 1 (MVP):** Stages 1-8 (origination through closing) for Direct Borrower and Underwriter/Credit Manager roles. Core integrations. Financial Normalization Engine (rule-based). Deal Health Score. Credit Memo Generator. Conversational UX. Borrower Dashboard.\n- **Phase 2:** Broker portal, Intake Agent workflows, External Funding Stakeholder (PDF workflow), Debt Servicing & Covenant Monitoring, AI Financial Advisor.\n- **Phase 3:** Denied Applicant Nurture ecosystem, FinOps Resource portal, Education Portal (curated), Vendor Marketplace, External Stakeholder web portal.\n- **Phase 4:** Advanced ML normalization, predictive analytics, business progression incentives, full Section 1071 reporting.\n\n### Condition 2: Financial Normalization Engine POC\nBefore committing to full build, create a proof-of-concept demonstrating: ability to ingest tax returns and financial statements, rule-based common-sizing into standardized buckets, handling of at least 3 entity types, output suitable for ratio analysis.\n\n### Condition 3: CDFI Design Partner\nSecure at least one CDFI as an early design partner before completing architecture. This provides: real workflow validation, training data, beta testing environment, credibility for subsequent sales.\n\n### Condition 4: Legal Review of Denied Applicant Nurture\nBefore building, obtain formal legal counsel opinion on: FCRA-compliant re-qualification monitoring, Investment Advisers Act applicability, state-by-state advisory licensing, subscription service regulatory classification.\n\n### Rationale\n\n**Why GO (with conditions):**\n1. The market gap is real and confirmed across 50+ products with ZERO competitors covering the full lifecycle envisioned\n2. The differentiation is structural, not cosmetic -- cannot be replicated by adding features to existing platforms\n3. The timing is favorable -- CDFIs actively seeking better technology, AI regulation crystallizing, Section 1071 deadlines creating urgency\n4. The revenue model is sound with multiple streams including novel denied-applicant subscription advisory\n5. CDFI regulatory latitude provides a unique advantage competitors serving conventional banks cannot leverage\n\n**Why CONDITIONS (not unconditional GO):**\n1. Scope is the #1 execution risk -- 3-4x more complex than original underwriting sidecar\n2. Financial Normalization Engine is unproven -- no comparable product exists\n3. Regulatory landscape is evolving -- denied applicant nurture model operates in a gray area\n4. CDFI design partner reduces adoption risk\n\n**What would change to NO-GO:** If legal review determines denied applicant nurture is not legally viable. If Financial Normalization Engine POC fails. If no CDFI design partner can be secured within 6 months.\n\n**What would change to UNCONDITIONAL GO:** If a CDFI design partner is already committed. If legal review confirms all regulatory approaches. If the team has proven AI/ML expertise.\n\n---\n\n## 8. User Roles, Cost Structure, Revenue Model\n\n### User Roles (5 Core, Expanded to 8)\n\n| Role | Purpose |\n|---|---|\n| **Administrator** | System configuration, user management, CDFI reporting |\n| **Intake Agent** | Create applications from various sources (future: AI agent replacement) |\n| **Underwriter** | Process applications, analyze financials, prepare credit memos |\n| **Manager / Credit Manager** | Oversight, quality control, final approval authority |\n| **Borrower** | Submit information, respond to clarification requests, post-closing management |\n| **Broker** (expanded) | Submit applicant packets, track deal status |\n| **External Funding Stakeholder** (expanded) | Review and approve/deny referred loan packages |\n| **FinOps Resource** (expanded) | Financial advisory for active borrowers and denied applicants |\n\n### Cost Structure\n\n**Development (Year 1):** ~$300-400K\n- Personnel: ~$250K (3 developers at 6-9 months)\n- Third-party services: ~$300-500/month\n- Infrastructure: ~$200/month (MVP)\n\n**Per Application Variable Cost:** ~$30-50\n- Tax transcripts: $15-30\n- Bank data (Plaid): $1-2\n- OCR: $1-2/document\n- AI processing: ~$5-10\n\n### Revenue Model\n\n- **Application fee:** $150 (borrower pays)\n- **CDFI subscription:** $5K-15K/year per tenant\n- **Professional services:** Custom pricing\n- **Denied applicant subscription advisory:** Recurring monthly revenue (novel revenue stream)\n- **Marketplace commissions** (Phase 3): Revenue from vendor partnerships\n\n### Team Structure\n\n**Engineering Team (3 developers for 6-9 months):**\n- 1x Backend Lead (Node.js/TypeScript, databases, AI integration)\n- 1x Backend Developer (APIs, integrations, testing)\n- 1x Frontend Developer (React, UI/UX, design system)\n\n**Support Roles (as needed):**\n- Product Manager (part-time)\n- UX Designer (contract)\n- QA Engineer (part-time)\n- DevOps (contract)\n\n---\n\n## 9. Risk Mitigation & Success Criteria\n\n### Top 5 Risks & Mitigations\n\n| Risk | Probability | Impact | Mitigation |\n|---|---|---|---|\n| **Execution complexity** (scope is 3-4x original) | High | High | Strict phasing (Condition 1) |\n| **Financial normalization accuracy** (novel capability) | Medium-High | High | POC requirement (Condition 2) |\n| **Regulatory uncertainty** (AI fair lending, FCRA) | Medium | High | Legal review (Condition 4); model governance framework |\n| **Adoption inertia** (CDFIs switching from existing tools) | Medium | Medium | CDFI design partner (Condition 3) |\n| **AI extraction accuracy** (errors in financial data) | Medium | High | Mandatory underwriter review, confidence scoring, fallback to manual entry |\n\n### Additional Risks\n- Third-party API downtime or rate limits -- Mitigated by retry logic, fallback providers, graceful degradation\n- Security breach -- Mitigated by pen testing, security audits, encryption, monitoring\n- Performance at scale -- Mitigated by load testing, caching, horizontal scaling\n- Scope creep -- Mitigated by strict MVP definition, change control process, post-MVP roadmap\n- FinOps Resource marketplace risk -- Building a professional marketplace is a business within a business; warrants deferral\n\n### Outstanding Assumptions\n1. Financial Normalization Engine can achieve acceptable accuracy with rule-based approach in MVP\n2. CDFIs will adopt a new full-lifecycle platform over existing fragmented tools\n3. Denied applicant nurture creates measurable conversion pipeline\n4. Consent-based re-qualification monitoring is operationally feasible at scale\n5. Platform development team has AI/ML expertise for normalization and analysis agents\n\n### MVP Success Criteria\n\n**Functional:**\n- Complete one application end-to-end (all stages)\n- Generate accurate credit memo with citations\n- Export credit packet (PDF + documents)\n- Manager can approve/reject with justification\n- Complete audit trail captured\n- Borrower can upload docs and answer questions\n\n**Technical:**\n- >95% AI extraction accuracy\n- <30 second document processing time\n- <2 second API response time (p95)\n- >70% test coverage\n- Zero critical security vulnerabilities\n- SOC 2 controls documented\n\n**Business:**\n- 2-3 pilot CDFIs using the system\n- >20 applications processed\n- Underwriter productivity improvement demonstrated\n- Positive user feedback (NPS >40)\n\n### Next Steps (Aligned to CONDITIONAL GO)\n\n1. **Immediately:** Obtain legal counsel opinion on denied applicant nurture structure (Condition 4)\n2. **Within 2 weeks:** Begin Financial Normalization Engine POC (Condition 2)\n3. **Within 4 weeks:** Identify and engage CDFI design partner candidate(s) (Condition 3)\n4. **Parallel:** Proceed to Technical Specification scoped to Phase 1 MVP\n5. **Parallel:** Proceed to Architecture & Technology with phased build strategy\n6. **Gate:** All 4 conditions must be met or on track before committing to full development resources\n\n---\n\n*Recommendation: CONDITIONAL GO*\n*Conditions: (1) Strict MVP phasing, (2) Financial Normalization Engine POC, (3) CDFI design partner, (4) Legal review of denied applicant nurture*\n","cremologix/fne-specification":"# Financial Normalization Engine (FNE) -- Specification Addendum\n\n**Document Type:** Specification Addendum\n**Parent Document:** `C:/projects/pmo/cremologix/docs/specification.md`\n**Status:** Implementation-Ready\n**Date:** February 9, 2026\n**Gap Addressed:** Discovery Document Gap 1 (Section 6, Recommendation 1)\n\n---\n\n## Table of Contents\n\n1. [Purpose](#1-purpose)\n2. [Input Sources](#2-input-sources)\n3. [Entity Type Handling](#3-entity-type-handling)\n4. [Standardized Output Buckets](#4-standardized-output-buckets)\n5. [Cross-Validation Rules](#5-cross-validation-rules)\n6. [Confidence Scoring](#6-confidence-scoring)\n7. [Entity-Specific Normalization Rules](#7-entity-specific-normalization-rules)\n8. [Multi-Period Handling](#8-multi-period-handling)\n9. [Global Cash Flow (Personal + Business Combined)](#9-global-cash-flow-personal--business-combined)\n10. [Database Schema](#10-database-schema)\n11. [API Endpoints](#11-api-endpoints)\n12. [Phasing](#12-phasing)\n13. [Acceptance Criteria](#13-acceptance-criteria)\n\n---\n\n## 1. Purpose\n\nThe Financial Normalization Engine (FNE) is the core analytical component of CremoLogix responsible for transforming raw financial data from diverse sources and entity types into a standardized format that enables apples-to-apples comparison regardless of how the borrower's business is structured.\n\n### Problem Statement\n\nSmall businesses present financial data in radically different formats depending on their entity type. A sole proprietor reports business income on Schedule C of their personal Form 1040. An S-Corp reports on Form 1120-S with officer compensation on a separate line. A nonprofit reports on Form 990 with entirely different terminology. A CDFI underwriter must mentally normalize all of these into comparable metrics -- a process that is slow, error-prone, and inconsistent across underwriters.\n\n### What the FNE Does\n\n1. **Ingests** extracted financial data from multiple document types (tax returns, financial statements, bank statements, accounting software exports, Plaid data).\n2. **Maps** source-specific line items to standardized buckets using entity-type-aware rules.\n3. **Applies add-backs** to arrive at Adjusted Cash Flow -- the key number for debt service coverage ratio (DSCR) calculation.\n4. **Cross-validates** data across sources to identify discrepancies and assign confidence scores.\n5. **Outputs** a normalized financial profile that feeds directly into the Financial Analysis Engine (specification.md Section 5.2), the Scoring Engine (Section 5.7), and the Credit Memo Assembly Engine (Section 5.6).\n\n### Position in the Pipeline\n\n```\n[Document Upload] -> [OCR/Extraction Pipeline (spec 5.1)] -> [Extraction Results]\n                                                                     |\n                                                                     v\n                                                          +---------------------+\n                                                          | FINANCIAL           |\n                                                          | NORMALIZATION       |\n                                                          | ENGINE (this spec)  |\n                                                          +---------------------+\n                                                                     |\n                                                                     v\n                                                          [Normalized Financials]\n                                                                     |\n                                          +-------------+------------+------------+\n                                          |             |                         |\n                                          v             v                         v\n                                   [Financial    [Scoring Engine     [Credit Memo Assembly\n                                    Analysis      (spec 5.7)]         (spec 5.6)]\n                                    Engine\n                                    (spec 5.2)]\n```\n\n### Design Principles\n\n- **Entity-agnostic output:** The normalized output format is identical regardless of whether the borrower is a sole proprietor or a C-Corp. Downstream consumers never need to know the entity type.\n- **Transparent mappings:** Every normalized value traces back to a specific source field, source document, and mapping rule. The underwriter can see exactly how each number was derived.\n- **Conservative add-backs:** Add-backs default to the most conservative interpretation. The underwriter can override with justification.\n- **Source hierarchy:** When the same data point exists in multiple sources, the FNE uses the most reliable source (tax return > audited financials > compiled financials > internal financials > bank statements > manual entry).\n\n---\n\n## 2. Input Sources\n\nThe FNE accepts extracted data from the following source types. Each source feeds into the normalization pipeline through the Extraction Results table (specification.md Section 3.9) with `extraction_type` and `structured_data_jsonb` fields.\n\n### 2.1 Business Tax Returns\n\n| Form | Entity Type | Key Data Extracted |\n|------|------------|-------------------|\n| **Form 1120** | C-Corporation | Gross receipts, COGS, officer compensation, salaries/wages, rents, taxes, interest, depreciation, depletion, advertising, pension plans, employee benefits, other deductions, taxable income, tax paid, net income |\n| **Form 1120-S** | S-Corporation | Gross receipts, COGS, officer compensation, salaries/wages, rents, taxes, interest, depreciation, advertising, pension plans, employee benefits, other deductions, ordinary business income, Schedule K items (distributions, separately stated income/deductions) |\n| **Form 1065** | Partnership | Gross receipts, COGS, guaranteed payments, salaries/wages, rents, taxes, interest, depreciation, other deductions, ordinary business income, Schedule K items, partner capital accounts |\n| **Schedule C (Form 1040)** | Sole Proprietorship | Gross receipts, COGS, advertising, car/truck expenses, commissions, contract labor, depreciation, insurance, interest, legal/professional, office expense, rent, repairs, supplies, taxes, travel, meals, utilities, wages, other expenses, net profit |\n| **Form 990** | Nonprofit | Total revenue (contributions + program service + investment + other), total expenses by functional classification (program, management, fundraising), salaries/compensation, professional fees, occupancy, depreciation, net assets |\n\n### 2.2 Personal Tax Returns\n\n| Form | Purpose | Key Data Extracted |\n|------|---------|-------------------|\n| **Form 1040** | Guarantor income and obligations | Wages (W-2), business income (Schedule C), rental income (Schedule E), interest/dividends (Schedule B), capital gains (Schedule D), total income, AGI, tax liability |\n| **Schedule E** | Rental and pass-through income | Rental income/loss per property, partnership/S-Corp income (K-1 summary), estate/trust income |\n| **Schedule K-1 (1065)** | Partnership pass-through | Ordinary income, guaranteed payments, rental income, interest, dividends, capital gains, Section 179, distributions |\n| **Schedule K-1 (1120-S)** | S-Corp pass-through | Ordinary income, rental income, interest, dividends, capital gains, Section 179, distributions |\n\n### 2.3 Internal Financial Statements\n\n| Statement | Key Data Extracted |\n|-----------|-------------------|\n| **Profit & Loss (Income Statement)** | Revenue by line, COGS by line, operating expense detail, other income/expense, net income. Statement type classified as: audited, reviewed, compiled, or internal/unaudited. |\n| **Balance Sheet** | All asset, liability, and equity line items. Current vs. long-term classification. |\n| **Cash Flow Statement** | Operating, investing, and financing cash flows. Beginning and ending cash balances. |\n\n### 2.4 Bank Statements\n\n| Source | Key Data Extracted |\n|--------|-------------------|\n| **Bank Statements (3-12 months)** | Monthly beginning/ending balances, total deposits, total withdrawals, average daily balance, overdraft occurrences, NSF count, large deposit detail (>$5,000), recurring payment identification |\n\n### 2.5 Accounting Software Data\n\n| Source | Key Data Extracted |\n|--------|-------------------|\n| **QuickBooks / Xero (via Plaid or direct export)** | Chart of accounts with balances, trial balance, P&L detail, balance sheet detail, general ledger transactions, accounts receivable aging, accounts payable aging |\n\n### 2.6 Plaid Transaction Data\n\n| Source | Key Data Extracted |\n|--------|-------------------|\n| **Plaid Transactions API** | Categorized transactions (income, expenses by category), recurring revenue identification, recurring expense identification, cash flow patterns, seasonal trends |\n\n### 2.7 Supplementary Documents\n\n| Document | Key Data Extracted |\n|----------|-------------------|\n| **AR Aging Report** | Current, 30-day, 60-day, 90-day, 90+ day buckets. Total AR. Concentration by customer. |\n| **AP Aging Report** | Current, 30-day, 60-day, 90-day, 90+ day buckets. Total AP. |\n| **Debt Schedule** | Creditor name, original amount, current balance, monthly payment, interest rate, maturity date, collateral, payment status (current/delinquent). |\n| **Personal Financial Statement (PFS)** | Personal assets, personal liabilities, personal income sources, personal expense obligations. |\n\n---\n\n## 3. Entity Type Handling\n\nThe FNE must handle six entity types. Each has a different primary tax form, different treatment of owner compensation, and different rules for separating personal from business financials.\n\n### 3.1 Sole Proprietor\n\n| Attribute | Detail |\n|-----------|--------|\n| **Primary Tax Form** | Schedule C (filed with Form 1040) |\n| **Owner Compensation Treatment** | No salary line on Schedule C. Net profit (Line 31) IS the owner's compensation. The entire net profit is an add-back for DSCR because the owner must live on this money AND service debt. Owner's reasonable compensation must be estimated and subtracted from the add-back. **Formula:** `Add-Back for Owner Comp = Schedule C Net Profit - Estimated Owner Living Expenses`. In practice, use the personal debt obligations from the PFS or 1040 as the proxy for living expenses -- this flows through Global Cash Flow (Section 9). |\n| **Pass-Through Income** | All business income flows directly to Form 1040 Line 8. There is no separate entity-level tax. |\n| **Personal vs. Business Separation** | Schedule C IS the business. All other 1040 income (W-2, Schedule E, etc.) is personal. Business expenses on Schedule C are the only business expenses. Mixed-use assets (home office, vehicle) require allocation -- use the percentages reported on Schedule C. |\n| **Key Add-Backs** | Depreciation (Line 13), depletion (Line 12), amortization (included in \"Other Expenses\"), one-time/non-recurring expenses (identified by underwriter or AI), home office deduction (Form 8829 -- add back if the borrower owns the home), owner's personal expenses run through the business (identified via bank statement cross-validation). |\n\n### 3.2 LLC (Limited Liability Company)\n\n| Attribute | Detail |\n|-----------|--------|\n| **Primary Tax Form** | Depends on LLC election: Single-member LLC files Schedule C (treat as Sole Proprietor). Multi-member LLC defaults to Form 1065 (treat as Partnership). LLC electing S-Corp status files Form 1120-S (treat as S-Corp). LLC electing C-Corp status files Form 1120 (treat as C-Corp). |\n| **Owner Compensation Treatment** | Follows the treatment of the tax election. Single-member: same as Sole Proprietor. Multi-member/Partnership: guaranteed payments + distributions. S-Corp election: officer salary + distributions. C-Corp election: officer salary + dividends. |\n| **Pass-Through Income** | Single-member: flows to 1040 Schedule C. Multi-member: flows to partners via K-1. S-Corp election: flows to shareholders via K-1. C-Corp election: no pass-through (entity-level tax). |\n| **Personal vs. Business Separation** | Same as the elected entity type. The FNE determines the LLC's tax election from the tax form filed and routes to the appropriate normalization rules. |\n| **Key Add-Backs** | Same as the elected entity type. Additionally, for multi-member LLCs, all member guaranteed payments and distributions are add-backs (same as Partnership). |\n| **Detection Logic** | The FNE detects LLC tax election by examining: (a) the `business_type` field on the application, (b) which tax form was uploaded/extracted, (c) if the application says \"LLC\" but a Schedule C was filed, classify as single-member LLC (Sole Proprietor treatment). |\n\n### 3.3 S-Corporation\n\n| Attribute | Detail |\n|-----------|--------|\n| **Primary Tax Form** | Form 1120-S (U.S. Income Tax Return for an S Corporation) |\n| **Owner Compensation Treatment** | Officer compensation (Line 7) is a W-2 salary paid to the owner(s). This is already deducted as a business expense on the 1120-S. For DSCR purposes, officer compensation is added back because it represents discretionary owner pay that could be redirected to debt service. **Additionally:** Shareholder distributions (Schedule K, Line 16d or from Schedule M-2) are NOT on the income statement but represent cash taken out by owners. Distributions are added to Adjusted Cash Flow. **Formula:** `Owner Comp Add-Back = Line 7 (Officer Compensation) + Distributions to Shareholders` |\n| **Pass-Through Income** | Ordinary business income (Line 21) flows to shareholders via Schedule K-1. Each shareholder reports their pro-rata share on personal Form 1040 Schedule E. The entity itself pays no federal income tax (with limited exceptions). |\n| **Personal vs. Business Separation** | The 1120-S is entirely business. Personal income is on the guarantor's Form 1040. K-1 income from the S-Corp appears on the guarantor's Schedule E -- this is the same income already captured on the 1120-S, so the FNE must NOT double-count it when computing Global Cash Flow. |\n| **Key Add-Backs** | Officer compensation (Line 7), depreciation (Line 14), amortization (if in Other Deductions), charitable contributions (Line 12a of Schedule K -- these are passed through to shareholders, not deducted at entity level, but appear in some internal P&Ls), one-time expenses, above-market rent paid to related parties (identified by comparing rent to market rates or flagged by underwriter). |\n\n### 3.4 C-Corporation\n\n| Attribute | Detail |\n|-----------|--------|\n| **Primary Tax Form** | Form 1120 (U.S. Corporation Income Tax Return) |\n| **Owner Compensation Treatment** | Officer compensation (Line 12) is a W-2 salary. Unlike S-Corps, C-Corps pay entity-level income tax (Line 31), so retained earnings stay in the corporation. Dividends paid to shareholders are NOT deductible by the corporation and come from after-tax profits. **For DSCR:** Add back officer compensation. Do NOT add back dividends (they are after-tax and already accounted for in net income). **Formula:** `Owner Comp Add-Back = Line 12 (Compensation of Officers)`. Note: if the C-Corp pays minimal officer salary and instead pays large \"management fees\" to a related entity, the FNE flags this for underwriter review. |\n| **Pass-Through Income** | None. C-Corps are taxed at the entity level. Shareholders only receive income via W-2 salary or dividends. This is the \"double taxation\" structure. |\n| **Personal vs. Business Separation** | Clean separation. The 1120 is entirely business. The owner's W-2 and dividends appear on their personal 1040. No K-1 overlap. |\n| **Key Add-Backs** | Officer compensation (Line 12), depreciation (Line 20), amortization (Line 26 or in Other Deductions), depletion (Line 21), federal income tax paid (Line 31 -- this is an add-back because it is a non-cash charge for DSCR purposes in the sense that it would not exist if the business were structured as a pass-through), charitable contributions (Line 19), one-time/non-recurring expenses, above-market related-party rent. |\n\n### 3.5 Partnership\n\n| Attribute | Detail |\n|-----------|--------|\n| **Primary Tax Form** | Form 1065 (U.S. Return of Partnership Income) |\n| **Owner Compensation Treatment** | Partners do NOT receive W-2 salaries. Instead, they receive: (a) Guaranteed payments (Line 10) -- fixed payments to partners regardless of profit, functionally equivalent to salary. (b) Distributions (Schedule K, Line 19a or from capital account analysis). (c) Pro-rata share of ordinary income. **For DSCR:** Add back guaranteed payments to all partners. Add back distributions. **Formula:** `Owner Comp Add-Back = Line 10 (Guaranteed Payments) + Distributions to Partners` |\n| **Pass-Through Income** | All income flows through to partners via Schedule K-1. The partnership pays no entity-level tax. Each partner reports their share on personal Form 1040 Schedule E. |\n| **Personal vs. Business Separation** | The 1065 is entirely business. Each partner's K-1 income appears on their personal 1040 Schedule E. Same double-count risk as S-Corp -- the FNE must not count K-1 income from THIS business in both the business and personal cash flows. |\n| **Key Add-Backs** | Guaranteed payments (Line 10), depreciation (Line 16a), amortization (if in Other Deductions), Section 179 expense (Line 14 of Schedule K), partner distributions, one-time expenses, above-market related-party transactions. |\n\n### 3.6 Nonprofit\n\n| Attribute | Detail |\n|-----------|--------|\n| **Primary Tax Form** | Form 990 (Return of Organization Exempt From Income Tax). Small nonprofits may file 990-EZ or 990-N (e-Postcard). |\n| **Owner Compensation Treatment** | Nonprofits have no owners. Key personnel compensation (Part VII of Form 990) lists officers, directors, and highest-compensated employees. The Executive Director/CEO salary is the functional equivalent of \"owner compensation\" for analysis purposes. **For DSCR:** Do NOT add back ED/CEO compensation unless the position is vacant or the incumbent is the loan guarantor (rare for nonprofits). Instead, focus on total program revenue vs. total expenses to determine operating surplus. |\n| **Pass-Through Income** | Not applicable. Nonprofits do not distribute income. |\n| **Personal vs. Business Separation** | Nonprofits are separate legal entities. If a personal guarantor is required (unusual for nonprofits, common for CDFI loans to small nonprofits), their personal financials are entirely separate from the 990. |\n| **Key Add-Backs** | Depreciation (Part IX, Line 22 or from the financial statements -- Form 990 does not always break out depreciation as a separate line), amortization, one-time capital campaign expenses (if material), in-kind expense offsets (donated goods/services recorded as both revenue and expense -- normalize by removing both sides), non-cash grants/contributions. |\n| **Special Considerations** | Revenue mix matters: program service revenue is more reliable than contributions/grants for DSCR. The FNE should flag if >50% of revenue comes from a single grant or donor (concentration risk). Functional expense allocation (program vs. management vs. fundraising) maps to operating expense categories but requires special handling. Net assets (unrestricted, temporarily restricted, permanently restricted -- or under ASC 958: without donor restrictions, with donor restrictions) replace equity on the balance sheet. |\n\n---\n\n## 4. Standardized Output Buckets\n\nAll entity types normalize into the following identical output structure. Every downstream consumer (Financial Analysis Engine, Scoring Engine, Credit Memo Assembly) reads from these buckets without knowing or caring about the entity type.\n\n### 4.1 Income Statement Normalization\n\n| Bucket | Code | Description | Computation |\n|--------|------|-------------|-------------|\n| **Gross Revenue** | `IS_GROSS_REVENUE` | Total top-line revenue before any deductions | Direct mapping from source |\n| **Cost of Goods Sold / Cost of Services** | `IS_COGS` | Direct costs of producing goods or delivering services | Direct mapping; for service businesses this may be zero |\n| **Gross Profit** | `IS_GROSS_PROFIT` | Revenue minus direct costs | `IS_GROSS_REVENUE - IS_COGS` |\n| **Operating Expenses: Payroll** | `IS_OPEX_PAYROLL` | Employee wages, salaries, payroll taxes, benefits. Excludes owner compensation (tracked separately). | Sum of wages, salaries, payroll tax, benefits lines. Owner/officer comp is separated out. |\n| **Operating Expenses: Rent/Occupancy** | `IS_OPEX_RENT` | Rent, lease payments, property taxes on business premises, utilities, maintenance | Sum of rent + utilities + property maintenance lines |\n| **Operating Expenses: Marketing** | `IS_OPEX_MARKETING` | Advertising, marketing, promotion, sponsorships | Direct mapping |\n| **Operating Expenses: Insurance** | `IS_OPEX_INSURANCE` | Business insurance premiums (property, liability, workers comp, E&O) | Direct mapping |\n| **Operating Expenses: Professional Services** | `IS_OPEX_PROFESSIONAL` | Legal, accounting, consulting, IT services | Direct mapping |\n| **Operating Expenses: Depreciation** | `IS_OPEX_DEPRECIATION` | Depreciation of tangible fixed assets | Direct mapping |\n| **Operating Expenses: Amortization** | `IS_OPEX_AMORTIZATION` | Amortization of intangible assets, startup costs, loan fees | Direct mapping; often embedded in \"Other Deductions\" on tax returns |\n| **Operating Expenses: Other Operating** | `IS_OPEX_OTHER` | All operating expenses not categorized above | Catch-all for remaining operating expenses |\n| **Total Operating Expenses** | `IS_TOTAL_OPEX` | Sum of all operating expense categories | `SUM(IS_OPEX_*)` |\n| **Owner Compensation (memo line)** | `IS_OWNER_COMP` | Total compensation to owners/officers including salary, guaranteed payments. This is a memo line -- it is included in Total Operating Expenses where applicable but tracked separately for add-back purposes. | Entity-specific mapping (see Section 7) |\n| **Net Operating Income (NOI)** | `IS_NOI` | Operating profit before non-operating items | `IS_GROSS_PROFIT - IS_TOTAL_OPEX` |\n| **Non-Operating Income** | `IS_NON_OP_INCOME` | Interest income, investment income, gain on sale of assets, other non-operating income | Direct mapping |\n| **Non-Operating Expenses** | `IS_NON_OP_EXPENSE` | Interest expense, loss on sale of assets, other non-operating expenses | Direct mapping |\n| **Net Income (As Reported)** | `IS_NET_INCOME` | Bottom-line net income as reported on the tax return or financial statement | Direct mapping from source. This is the starting point for add-backs. |\n| **Add-Back: Owner Compensation** | `AB_OWNER_COMP` | Owner/officer salary, guaranteed payments, and/or draws added back for DSCR | Entity-specific (see Section 7) |\n| **Add-Back: Depreciation** | `AB_DEPRECIATION` | Non-cash depreciation expense | Same as `IS_OPEX_DEPRECIATION` |\n| **Add-Back: Amortization** | `AB_AMORTIZATION` | Non-cash amortization expense | Same as `IS_OPEX_AMORTIZATION` |\n| **Add-Back: One-Time Items** | `AB_ONE_TIME` | Non-recurring expenses identified by underwriter or AI. Examples: lawsuit settlement, relocation costs, one-time equipment write-off. | Underwriter-identified with AI suggestions. Each item must have a description and justification. |\n| **Add-Back: Related-Party Rent Adjustment** | `AB_RELATED_RENT` | If rent is paid to a related party above or below market rate, the difference is adjusted. Example: owner rents building to their own business at $3,000/mo when market rate is $2,000/mo. Add back $12,000/yr. | `(Reported Rent - Market Rate Rent) * 12`. Requires underwriter input for market rate. |\n| **Add-Back: Federal Income Tax (C-Corp only)** | `AB_FIT` | Federal income tax is added back for C-Corps because pass-through entities do not pay entity-level tax. This normalizes C-Corp cash flow to be comparable with pass-through entities. | Form 1120 Line 31. Zero for all non-C-Corp entities. |\n| **Total Add-Backs** | `AB_TOTAL` | Sum of all add-backs | `SUM(AB_*)` |\n| **Adjusted Cash Flow** | `IS_ADJUSTED_CF` | The key number for DSCR. Represents the cash available to service debt after normalizing for entity type differences. | `IS_NET_INCOME + AB_TOTAL` |\n\n**DSCR Formula:**\n```\nDSCR = Adjusted Cash Flow / Annual Debt Service\n\nWhere:\n  Annual Debt Service = Sum of all annual P&I payments on existing debt\n                      + Annual P&I on the proposed new loan\n```\n\n### 4.2 Balance Sheet Normalization\n\n| Bucket | Code | Description |\n|--------|------|-------------|\n| **Cash & Cash Equivalents** | `BS_CASH` | Cash, checking, savings, money market, CDs < 90 days |\n| **Accounts Receivable** | `BS_AR` | Trade receivables net of allowance for doubtful accounts |\n| **Inventory** | `BS_INVENTORY` | Raw materials, WIP, finished goods |\n| **Other Current Assets** | `BS_OTHER_CURRENT_ASSETS` | Prepaid expenses, short-term notes receivable, other assets due within 12 months |\n| **Total Current Assets** | `BS_TOTAL_CURRENT` | `BS_CASH + BS_AR + BS_INVENTORY + BS_OTHER_CURRENT_ASSETS` |\n| **Property, Plant & Equipment (Net)** | `BS_PPE_NET` | PP&E net of accumulated depreciation |\n| **Real Estate** | `BS_REAL_ESTATE` | Real property owned, net of depreciation. Separated from PP&E for collateral analysis. |\n| **Intangible Assets** | `BS_INTANGIBLES` | Goodwill, patents, trademarks, franchise rights, net of amortization |\n| **Other Long-Term Assets** | `BS_OTHER_LT_ASSETS` | Long-term investments, notes receivable > 12 months, other |\n| **Total Assets** | `BS_TOTAL_ASSETS` | `BS_TOTAL_CURRENT + BS_PPE_NET + BS_REAL_ESTATE + BS_INTANGIBLES + BS_OTHER_LT_ASSETS` |\n| **Accounts Payable** | `BS_AP` | Trade payables |\n| **Current Portion of Long-Term Debt** | `BS_CPLTD` | Principal payments due within 12 months on long-term obligations |\n| **Accrued Expenses** | `BS_ACCRUED` | Accrued wages, taxes, interest, other |\n| **Other Current Liabilities** | `BS_OTHER_CURRENT_LIAB` | Short-term notes, lines of credit drawn, other current obligations |\n| **Total Current Liabilities** | `BS_TOTAL_CURRENT_LIAB` | `BS_AP + BS_CPLTD + BS_ACCRUED + BS_OTHER_CURRENT_LIAB` |\n| **Notes Payable (Long-Term)** | `BS_NOTES_LT` | Term loans, equipment financing, other notes with maturity > 12 months |\n| **Mortgages** | `BS_MORTGAGES` | Real estate secured long-term debt |\n| **Other Long-Term Liabilities** | `BS_OTHER_LT_LIAB` | Deferred revenue (long-term), capital lease obligations, other |\n| **Total Liabilities** | `BS_TOTAL_LIABILITIES` | `BS_TOTAL_CURRENT_LIAB + BS_NOTES_LT + BS_MORTGAGES + BS_OTHER_LT_LIAB` |\n| **Equity / Net Assets** | `BS_EQUITY` | For for-profit entities: paid-in capital + retained earnings + current year net income. For nonprofits: net assets without donor restrictions + net assets with donor restrictions. |\n| **Total Liabilities & Equity** | `BS_TOTAL_LIAB_EQUITY` | `BS_TOTAL_LIABILITIES + BS_EQUITY`. Must equal `BS_TOTAL_ASSETS`. |\n\n### 4.3 Cash Flow Normalization\n\n| Bucket | Code | Description |\n|--------|------|-------------|\n| **Operating Cash Flow** | `CF_OPERATING` | Cash from core business operations. If a formal cash flow statement is provided, use it. If not, compute from income statement + balance sheet changes using the indirect method. |\n| **Investing Cash Flow** | `CF_INVESTING` | Cash used for capital expenditures, asset purchases/sales, investment activity |\n| **Financing Cash Flow** | `CF_FINANCING` | Cash from/to debt (borrowing/repayment), equity (contributions/distributions), dividends |\n| **Net Change in Cash** | `CF_NET_CHANGE` | `CF_OPERATING + CF_INVESTING + CF_FINANCING` |\n| **Free Cash Flow** | `CF_FREE` | `CF_OPERATING - Capital Expenditures (from CF_INVESTING)` |\n\n**Indirect Method Computation (when no cash flow statement is provided):**\n```\nCF_OPERATING = Net Income\n             + Depreciation & Amortization\n             - Increase in Accounts Receivable (or + Decrease)\n             - Increase in Inventory (or + Decrease)\n             + Increase in Accounts Payable (or - Decrease)\n             + Increase in Accrued Expenses (or - Decrease)\n             +/- Other non-cash adjustments\n\nCF_INVESTING = - Capital Expenditures\n               + Proceeds from Asset Sales\n               +/- Other investing activities\n\nCF_FINANCING = + New Borrowings\n               - Debt Repayments\n               + Capital Contributions\n               - Distributions/Dividends\n               +/- Other financing activities\n```\n\n---\n\n## 5. Cross-Validation Rules\n\nThe FNE cross-validates data across sources to identify discrepancies. Each rule produces a validation result with a status of `pass`, `warning`, or `fail`, a computed variance, and a confidence impact.\n\n### 5.1 Validation Rule Definitions\n\n| Rule ID | Rule Name | Comparison | Tolerance | Status Logic | Confidence Impact on Fail |\n|---------|-----------|-----------|-----------|-------------|--------------------------|\n| `XV-001` | **Tax vs. Financial Statement Net Income** | Tax return net income vs. P&L net income for the same fiscal year | 5% of the larger absolute value | Pass: within 5%. Warning: 5-15%. Fail: >15%. | -0.20 on affected income fields |\n| `XV-002` | **Bank Deposits vs. Reported Revenue** | Sum of bank statement deposits (excluding transfers, loan proceeds, owner contributions) vs. tax return / P&L gross revenue | 15% of reported revenue | Pass: within 15%. Warning: 15-25%. Fail: >25%. | -0.15 on `IS_GROSS_REVENUE` |\n| `XV-003` | **Tax Depreciation vs. Balance Sheet** | Accumulated depreciation change on balance sheet vs. depreciation expense on tax return | 10% | Pass: within 10%. Warning: 10-20%. Fail: >20%. | -0.10 on `IS_OPEX_DEPRECIATION` and `BS_PPE_NET` |\n| `XV-004` | **AR Aging vs. Balance Sheet AR** | AR aging report total vs. balance sheet accounts receivable | 5% | Pass: within 5%. Warning: 5-10%. Fail: >10%. | -0.15 on `BS_AR` |\n| `XV-005` | **Debt Schedule vs. Balance Sheet Liabilities** | Sum of debt schedule balances vs. total liabilities (excluding AP, accrued) | 10% | Pass: within 10%. Warning: 10-20%. Fail: >20%. | -0.15 on all liability buckets |\n| `XV-006` | **Plaid Categories vs. Reported Expenses** | Plaid-categorized expenses by category vs. reported expense categories | 20% per category | Pass: within 20%. Warning: 20-35%. Fail: >35% for 3+ categories. | -0.10 per failing category |\n| `XV-007` | **Balance Sheet Balances** | Total Assets must equal Total Liabilities + Equity | 0.1% (rounding only) | Pass: balanced. Fail: unbalanced. | -0.30 on all balance sheet fields |\n| `XV-008` | **YoY Revenue Reasonableness** | Year-over-year revenue change | 50% swing in either direction | Pass: within 50%. Warning: >50% (flag for explanation). | -0.05 (informational) |\n| `XV-009` | **Bank Balance vs. Balance Sheet Cash** | Average month-end bank balance vs. balance sheet cash for period end | 20% | Pass: within 20%. Warning: 20-40%. Fail: >40%. | -0.10 on `BS_CASH` |\n| `XV-010` | **K-1 Income vs. 1120-S/1065 Income** | Sum of all K-1 ordinary income vs. entity return ordinary income | 1% (should match exactly, tolerance for rounding) | Pass: within 1%. Fail: >1%. | -0.25 on pass-through income fields |\n\n### 5.2 Validation Execution\n\nCross-validation runs automatically after normalization completes. Results are stored in the `normalization_audit` table (see Section 10). The underwriter sees a validation summary with:\n\n- Number of rules evaluated\n- Number passed / warned / failed\n- Specific discrepancies with source values and computed variance\n- Suggested resolution (e.g., \"Bank deposits exceed reported revenue by 22%. This may indicate unreported income, loan proceeds coded as deposits, or inter-account transfers. Request clarification.\")\n\n### 5.3 Tolerance Calculation\n\nAll tolerances are computed as:\n```\nVariance = |Value_A - Value_B| / MAX(|Value_A|, |Value_B|)\n\nIf both values are zero, the rule passes automatically.\nIf one value is zero and the other is not, the rule fails automatically.\n```\n\n---\n\n## 6. Confidence Scoring\n\nThe FNE assigns confidence scores at three levels: per-field, per-section (cross-validation), and overall.\n\n### 6.1 Source Reliability Hierarchy\n\nEach data source has a base confidence weight:\n\n| Source Type | Base Confidence | Rationale |\n|-------------|----------------|-----------|\n| Tax Return (IRS transcript) | 0.98 | IRS-verified, highest reliability |\n| Tax Return (borrower-provided copy) | 0.92 | Could be altered, but penalties for falsification are severe |\n| Audited Financial Statements | 0.95 | CPA-attested, GAAP-compliant |\n| Reviewed Financial Statements | 0.88 | CPA-reviewed but not fully audited |\n| Compiled Financial Statements | 0.80 | CPA-compiled from management data, no assurance |\n| Internal / Unaudited Financial Statements | 0.70 | Management-prepared, no external validation |\n| Bank Statements (direct from bank) | 0.95 | Institution-sourced, reliable for cash data |\n| Bank Statements (borrower-provided PDF) | 0.85 | Could be altered |\n| Plaid-connected bank data | 0.93 | API-sourced, reliable |\n| QuickBooks / Accounting Software (Plaid-connected) | 0.85 | System-of-record but borrower-maintained |\n| QuickBooks / Accounting Software (exported file) | 0.75 | Could be modified before export |\n| AR/AP Aging (from accounting software) | 0.80 | System-generated but borrower-maintained |\n| AR/AP Aging (manual/PDF) | 0.65 | Borrower-prepared, limited verification |\n| Debt Schedule (manual) | 0.60 | Borrower-prepared, should cross-validate against credit report |\n| Manual Entry (underwriter) | 0.50 | No source document; requires justification |\n\n### 6.2 Per-Field Confidence Calculation\n\nEach normalized field's confidence is computed as:\n\n```\nField_Confidence = Source_Base_Confidence\n                 * OCR_Confidence_Factor\n                 * Cross_Validation_Factor\n                 * Extraction_Confidence_Factor\n\nWhere:\n  OCR_Confidence_Factor = OCR confidence for the specific field region (from extraction pipeline)\n                          Range: 0.50 - 1.00\n                          If source is digital (not OCR), factor = 1.00\n\n  Cross_Validation_Factor = 1.00 if no cross-validation rule applies or all rules pass\n                          = 0.90 if warning-level discrepancy\n                          = 0.70 if fail-level discrepancy\n\n  Extraction_Confidence_Factor = Extraction model's confidence for this specific field\n                                 Range: 0.50 - 1.00\n                                 From extraction_results.field_confidences_jsonb\n```\n\n### 6.3 Cross-Validation Confidence\n\nMeasures how well multiple sources agree:\n\n```\nCross_Validation_Confidence = (Number of Rules Passed + 0.5 * Number of Warnings)\n                            / Total Rules Evaluated\n\nRange: 0.00 - 1.00\n```\n\n### 6.4 Overall Extraction Confidence\n\nThe overall confidence for a normalized financial period:\n\n```\nOverall_Confidence = WEIGHTED_AVERAGE(All Field Confidences)\n\nWhere weights are:\n  IS_GROSS_REVENUE:    weight 3 (high importance)\n  IS_NET_INCOME:       weight 3\n  IS_ADJUSTED_CF:      weight 5 (highest importance -- the DSCR driver)\n  BS_TOTAL_ASSETS:     weight 2\n  BS_TOTAL_LIABILITIES: weight 2\n  All other fields:    weight 1\n```\n\n### 6.5 Confidence Thresholds and Actions\n\n| Confidence Range | Status | Action |\n|-----------------|--------|--------|\n| >= 0.90 | `auto_validated` | Field is accepted without manual review. Displayed with green indicator. |\n| 0.70 - 0.89 | `flagged_for_review` | Field is highlighted for underwriter review. Displayed with yellow indicator. Underwriter must either confirm or correct. |\n| < 0.70 | `manual_required` | Field cannot be used without manual entry or correction. Displayed with red indicator. Underwriter must provide a value and source justification. |\n\n### 6.6 Confidence Display\n\nThe underwriter UI shows:\n- A color-coded confidence indicator next to each normalized field (green/yellow/red)\n- Hover tooltip showing: source document, source field, source confidence, cross-validation status\n- A summary bar showing overall confidence percentage for the normalization\n- A list of all flagged and manual-required fields with direct links to source documents\n\n---\n\n## 7. Entity-Specific Normalization Rules\n\nThis section provides the concrete mapping from each tax form's line items to the standardized output buckets defined in Section 4. Each table shows the source field, the normalized bucket it maps to, and whether it receives add-back treatment for DSCR calculation.\n\n### 7.1 Sole Proprietor -- Schedule C (Form 1040)\n\n| Schedule C Line | Description | Normalized Bucket | Add-Back? |\n|----------------|-------------|-------------------|-----------|\n| Line 1 | Gross receipts or sales | `IS_GROSS_REVENUE` | No |\n| Line 2 | Returns and allowances | Subtracted from `IS_GROSS_REVENUE` | No |\n| Line 4 | Cost of goods sold (from Line 42) | `IS_COGS` | No |\n| Line 5 | Gross profit | `IS_GROSS_PROFIT` (verify = Line 1 - Line 2 - Line 4) | No |\n| Line 6 | Other income | `IS_NON_OP_INCOME` | No |\n| Line 8 | Advertising | `IS_OPEX_MARKETING` | No |\n| Line 9 | Car and truck expenses | `IS_OPEX_OTHER` | No |\n| Line 10 | Commissions and fees | `IS_OPEX_OTHER` | No |\n| Line 11 | Contract labor | `IS_OPEX_PAYROLL` | No |\n| Line 12 | Depletion | `IS_OPEX_OTHER` | Yes (`AB_ONE_TIME` if non-recurring) |\n| Line 13 | Depreciation and Section 179 | `IS_OPEX_DEPRECIATION` | Yes (`AB_DEPRECIATION`) |\n| Line 14 | Employee benefit programs | `IS_OPEX_PAYROLL` | No |\n| Line 15 | Insurance (other than health) | `IS_OPEX_INSURANCE` | No |\n| Line 16a | Mortgage interest (paid to banks) | `IS_NON_OP_EXPENSE` | No |\n| Line 16b | Other interest | `IS_NON_OP_EXPENSE` | No |\n| Line 17 | Legal and professional services | `IS_OPEX_PROFESSIONAL` | No |\n| Line 18 | Office expense | `IS_OPEX_OTHER` | No |\n| Line 19 | Pension and profit-sharing plans | `IS_OPEX_PAYROLL` | No |\n| Line 20a | Rent -- vehicles, machinery, equipment | `IS_OPEX_RENT` | No |\n| Line 20b | Rent -- other business property | `IS_OPEX_RENT` | No |\n| Line 21 | Repairs and maintenance | `IS_OPEX_OTHER` | No |\n| Line 22 | Supplies | `IS_OPEX_OTHER` | No |\n| Line 23 | Taxes and licenses | `IS_OPEX_OTHER` | No |\n| Line 24a | Travel | `IS_OPEX_OTHER` | No |\n| Line 24b | Deductible meals | `IS_OPEX_OTHER` | No |\n| Line 25 | Utilities | `IS_OPEX_RENT` (combined with occupancy) | No |\n| Line 26 | Wages | `IS_OPEX_PAYROLL` | No |\n| Line 27a | Other expenses (from Line 48) | `IS_OPEX_OTHER` (review for amortization) | Amortization portion: Yes (`AB_AMORTIZATION`) |\n| Line 30 | Business use of home (Form 8829) | `IS_OPEX_RENT` | Conditionally: Yes if owner owns the home (`AB_ONE_TIME`), no if renting |\n| Line 31 | Net profit or (loss) | `IS_NET_INCOME` | No (this is the starting point) |\n| *Implied* | Owner compensation = Line 31 (entire net profit) | `IS_OWNER_COMP` (memo line) | Yes (`AB_OWNER_COMP` = Line 31). See Section 9 for how personal living expenses offset this. |\n\n**Sole Proprietor Adjusted Cash Flow:**\n```\nAdjusted Cash Flow = Line 31 (Net Profit)\n                   + Line 13 (Depreciation/179)\n                   + Amortization (from Line 27a detail)\n                   + One-time items (underwriter-identified)\n                   + Related-party rent adjustment (if applicable)\n                   + Home office deduction (if owner-occupied property)\n```\n\nNote: For Sole Proprietors, the \"owner compensation add-back\" is handled differently. Since Line 31 IS the owner's income, adding it back would double-count. Instead, Line 31 is the starting point, and add-backs are only the non-cash and non-recurring items. The personal living expenses are handled in Global Cash Flow (Section 9).\n\n### 7.2 S-Corporation -- Form 1120-S\n\n| Form 1120-S Line | Description | Normalized Bucket | Add-Back? |\n|------------------|-------------|-------------------|-----------|\n| Line 1a | Gross receipts or sales | `IS_GROSS_REVENUE` | No |\n| Line 1b | Returns and allowances | Subtracted from `IS_GROSS_REVENUE` | No |\n| Line 2 | Cost of goods sold (from Schedule A) | `IS_COGS` | No |\n| Line 3 | Gross profit | `IS_GROSS_PROFIT` | No |\n| Line 4 | Net gain (loss) from Form 4797 | `IS_NON_OP_INCOME` (if gain) or `IS_NON_OP_EXPENSE` (if loss) | No |\n| Line 5 | Other income (loss) | `IS_NON_OP_INCOME` or `IS_NON_OP_EXPENSE` | No |\n| Line 7 | Compensation of officers | `IS_OPEX_PAYROLL` + `IS_OWNER_COMP` (memo) | Yes (`AB_OWNER_COMP`) |\n| Line 8 | Salaries and wages (less employment credits) | `IS_OPEX_PAYROLL` | No |\n| Line 9 | Repairs and maintenance | `IS_OPEX_OTHER` | No |\n| Line 10 | Bad debts | `IS_OPEX_OTHER` | Review for one-time add-back |\n| Line 11 | Rents | `IS_OPEX_RENT` | Review for related-party (`AB_RELATED_RENT`) |\n| Line 12 | Taxes and licenses | `IS_OPEX_OTHER` | No |\n| Line 13 | Interest | `IS_NON_OP_EXPENSE` | No |\n| Line 14 | Depreciation (from Form 4562, not on Line 8 of Sch A) | `IS_OPEX_DEPRECIATION` | Yes (`AB_DEPRECIATION`) |\n| Line 15 | Depletion | `IS_OPEX_OTHER` | No |\n| Line 16 | Advertising | `IS_OPEX_MARKETING` | No |\n| Line 17 | Pension, profit-sharing, etc. | `IS_OPEX_PAYROLL` | No |\n| Line 18 | Employee benefit programs | `IS_OPEX_PAYROLL` | No |\n| Line 19 | Other deductions (from statement) | `IS_OPEX_OTHER` (parse for insurance, professional fees, amortization) | Amortization portion: Yes (`AB_AMORTIZATION`) |\n| Line 21 | Ordinary business income (loss) | `IS_NET_INCOME` (entity-level, before shareholder allocation) | No |\n| Schedule K, Line 16d | Distributions (property and cash) | Not on income statement. Tracked as `IS_OWNER_COMP` supplemental. | Yes (added to `AB_OWNER_COMP`) |\n| Schedule M-2 | Distributions from accumulated adjustments account | Cross-reference with K Line 16d | Verification only |\n\n**S-Corp Adjusted Cash Flow:**\n```\nAdjusted Cash Flow = Line 21 (Ordinary Business Income)\n                   + Line 7 (Officer Compensation)\n                   + Line 14 (Depreciation)\n                   + Amortization (from Line 19 detail)\n                   + Distributions to Shareholders (Schedule K, Line 16d)\n                   + One-time items (underwriter-identified)\n                   + Related-party rent adjustment (if applicable)\n```\n\n### 7.3 C-Corporation -- Form 1120\n\n| Form 1120 Line | Description | Normalized Bucket | Add-Back? |\n|----------------|-------------|-------------------|-----------|\n| Line 1a | Gross receipts or sales | `IS_GROSS_REVENUE` | No |\n| Line 1b | Returns and allowances | Subtracted from `IS_GROSS_REVENUE` | No |\n| Line 2 | Cost of goods sold (from Schedule A) | `IS_COGS` | No |\n| Line 3 | Gross profit | `IS_GROSS_PROFIT` | No |\n| Line 4 | Dividends (from Schedule C) | `IS_NON_OP_INCOME` | No |\n| Line 5 | Interest | `IS_NON_OP_INCOME` | No |\n| Line 6 | Gross rents | `IS_NON_OP_INCOME` (unless core business) | No |\n| Line 7 | Gross royalties | `IS_NON_OP_INCOME` | No |\n| Line 8 | Capital gain (loss) from Schedule D | `IS_NON_OP_INCOME` or `IS_NON_OP_EXPENSE` | No |\n| Line 9 | Net gain (loss) from Form 4797 | `IS_NON_OP_INCOME` or `IS_NON_OP_EXPENSE` | No |\n| Line 10 | Other income | `IS_NON_OP_INCOME` | No |\n| Line 12 | Compensation of officers | `IS_OPEX_PAYROLL` + `IS_OWNER_COMP` (memo) | Yes (`AB_OWNER_COMP`) |\n| Line 13 | Salaries and wages | `IS_OPEX_PAYROLL` | No |\n| Line 14 | Repairs and maintenance | `IS_OPEX_OTHER` | No |\n| Line 15 | Bad debts | `IS_OPEX_OTHER` | Review for one-time |\n| Line 16 | Rents | `IS_OPEX_RENT` | Review for related-party (`AB_RELATED_RENT`) |\n| Line 17 | Taxes and licenses | `IS_OPEX_OTHER` | No |\n| Line 18 | Interest | `IS_NON_OP_EXPENSE` | No |\n| Line 19 | Charitable contributions | `IS_OPEX_OTHER` | Yes (`AB_ONE_TIME` -- discretionary) |\n| Line 20 | Depreciation (from Form 4562) | `IS_OPEX_DEPRECIATION` | Yes (`AB_DEPRECIATION`) |\n| Line 21 | Depletion | `IS_OPEX_OTHER` | No |\n| Line 22 | Advertising | `IS_OPEX_MARKETING` | No |\n| Line 23 | Pension, profit-sharing, etc. | `IS_OPEX_PAYROLL` | No |\n| Line 24 | Employee benefit programs | `IS_OPEX_PAYROLL` | No |\n| Line 26 | Other deductions (from statement) | `IS_OPEX_OTHER` (parse for insurance, professional, amortization) | Amortization portion: Yes (`AB_AMORTIZATION`) |\n| Line 28 | Taxable income before NOL | Intermediate calculation | No |\n| Line 30 | Taxable income | `IS_NET_INCOME` (pre-tax) | No |\n| Line 31 | Total tax | Tracked separately | Yes (`AB_FIT`) |\n| *Computed* | Net income after tax = Line 30 - Line 31 | `IS_NET_INCOME` (after tax) | No (starting point) |\n\n**C-Corp Adjusted Cash Flow:**\n```\nAdjusted Cash Flow = Net Income After Tax (Line 30 - Line 31)\n                   + Line 12 (Officer Compensation)\n                   + Line 20 (Depreciation)\n                   + Amortization (from Line 26 detail)\n                   + Line 31 (Federal Income Tax)\n                   + Line 19 (Charitable Contributions)\n                   + One-time items (underwriter-identified)\n                   + Related-party rent adjustment (if applicable)\n```\n\n### 7.4 Partnership -- Form 1065\n\n| Form 1065 Line | Description | Normalized Bucket | Add-Back? |\n|----------------|-------------|-------------------|-----------|\n| Line 1a | Gross receipts or sales | `IS_GROSS_REVENUE` | No |\n| Line 1b | Returns and allowances | Subtracted from `IS_GROSS_REVENUE` | No |\n| Line 2 | Cost of goods sold (from Schedule A) | `IS_COGS` | No |\n| Line 3 | Gross profit | `IS_GROSS_PROFIT` | No |\n| Line 4 | Ordinary income (loss) from other partnerships/estates | `IS_NON_OP_INCOME` | No |\n| Line 5 | Net farm profit (loss) | `IS_NON_OP_INCOME` | No |\n| Line 6 | Net gain (loss) from Form 4797 | `IS_NON_OP_INCOME` or `IS_NON_OP_EXPENSE` | No |\n| Line 7 | Other income (loss) | `IS_NON_OP_INCOME` | No |\n| Line 9 | Salaries and wages | `IS_OPEX_PAYROLL` | No |\n| Line 10 | Guaranteed payments to partners | `IS_OPEX_PAYROLL` + `IS_OWNER_COMP` (memo) | Yes (`AB_OWNER_COMP`) |\n| Line 11 | Repairs and maintenance | `IS_OPEX_OTHER` | No |\n| Line 12 | Bad debts | `IS_OPEX_OTHER` | Review for one-time |\n| Line 13 | Rent | `IS_OPEX_RENT` | Review for related-party (`AB_RELATED_RENT`) |\n| Line 14 | Taxes and licenses | `IS_OPEX_OTHER` | No |\n| Line 15 | Interest | `IS_NON_OP_EXPENSE` | No |\n| Line 16a | Depreciation (from Form 4562) | `IS_OPEX_DEPRECIATION` | Yes (`AB_DEPRECIATION`) |\n| Line 16b | Less depreciation in COGS | Subtracted from `AB_DEPRECIATION` | Adjustment |\n| Line 17 | Depletion | `IS_OPEX_OTHER` | No |\n| Line 18 | Retirement plans, etc. | `IS_OPEX_PAYROLL` | No |\n| Line 19 | Employee benefit programs | `IS_OPEX_PAYROLL` | No |\n| Line 20 | Other deductions (from statement) | `IS_OPEX_OTHER` (parse for insurance, professional, amortization, advertising) | Amortization portion: Yes (`AB_AMORTIZATION`). Advertising portion mapped to `IS_OPEX_MARKETING`. |\n| Line 22 | Ordinary business income (loss) | `IS_NET_INCOME` | No |\n| Schedule K, Line 1 | Ordinary business income | Verify matches Line 22 | No |\n| Schedule K, Line 4 | Guaranteed payments | Verify matches Line 10 | No |\n| Schedule K, Line 14 | Section 179 deduction | `IS_OPEX_DEPRECIATION` supplemental | Yes (`AB_DEPRECIATION`) |\n| Schedule K, Line 19a | Distributions (cash and marketable securities) | Not on income statement. Tracked as `IS_OWNER_COMP` supplemental. | Yes (added to `AB_OWNER_COMP`) |\n| Analysis of Partners' Capital (Schedule M-2 equivalent) | Partner contributions and withdrawals | Cross-reference with distributions | Verification only |\n\n**Partnership Adjusted Cash Flow:**\n```\nAdjusted Cash Flow = Line 22 (Ordinary Business Income)\n                   + Line 10 (Guaranteed Payments to Partners)\n                   + Line 16a (Depreciation, net of 16b)\n                   + Schedule K Line 14 (Section 179)\n                   + Amortization (from Line 20 detail)\n                   + Distributions to Partners (Schedule K, Line 19a)\n                   + One-time items (underwriter-identified)\n                   + Related-party rent adjustment (if applicable)\n```\n\n### 7.5 Nonprofit -- Form 990\n\n| Form 990 Part/Line | Description | Normalized Bucket | Add-Back? |\n|--------------------|-------------|-------------------|-----------|\n| Part VIII, Line 1 | Contributions, gifts, grants | `IS_GROSS_REVENUE` (subcategory: contributions) | No |\n| Part VIII, Line 2 | Program service revenue | `IS_GROSS_REVENUE` (subcategory: earned revenue) | No |\n| Part VIII, Line 3 | Investment income | `IS_NON_OP_INCOME` | No |\n| Part VIII, Line 4 | Income from investment of tax-exempt bond proceeds | `IS_NON_OP_INCOME` | No |\n| Part VIII, Line 5 | Royalties | `IS_NON_OP_INCOME` | No |\n| Part VIII, Line 6-7 | Net rental income, net gain from sales | `IS_NON_OP_INCOME` | No |\n| Part VIII, Line 8 | Net income from fundraising events | `IS_GROSS_REVENUE` (subcategory: fundraising) | No |\n| Part VIII, Line 9 | Net income from gaming activities | `IS_GROSS_REVENUE` (subcategory: other) | No |\n| Part VIII, Line 10 | Net gain/loss from sales of inventory | `IS_NON_OP_INCOME` | No |\n| Part VIII, Line 11 | Other revenue | `IS_GROSS_REVENUE` (subcategory: other) | No |\n| Part VIII, Line 12 | Total revenue | `IS_GROSS_REVENUE` (verify = sum of above) | No |\n| Part IX, Line 5 | Compensation of current officers, directors, etc. | `IS_OPEX_PAYROLL` + `IS_OWNER_COMP` (memo -- ED/CEO only) | No (see Section 3.6 for exceptions) |\n| Part IX, Line 6 | Compensation not included above | `IS_OPEX_PAYROLL` | No |\n| Part IX, Line 7 | Other salaries and wages | `IS_OPEX_PAYROLL` | No |\n| Part IX, Line 8 | Pension plan accruals and contributions | `IS_OPEX_PAYROLL` | No |\n| Part IX, Line 9 | Other employee benefits | `IS_OPEX_PAYROLL` | No |\n| Part IX, Line 10 | Payroll taxes | `IS_OPEX_PAYROLL` | No |\n| Part IX, Line 11 | Fees for services (legal, accounting, lobbying, professional, investment mgmt, other) | `IS_OPEX_PROFESSIONAL` | No |\n| Part IX, Line 12 | Advertising and promotion | `IS_OPEX_MARKETING` | No |\n| Part IX, Line 13 | Office expenses | `IS_OPEX_OTHER` | No |\n| Part IX, Line 14 | Information technology | `IS_OPEX_OTHER` | No |\n| Part IX, Line 15 | Royalties | `IS_OPEX_OTHER` | No |\n| Part IX, Line 16 | Occupancy | `IS_OPEX_RENT` | No |\n| Part IX, Line 17 | Travel | `IS_OPEX_OTHER` | No |\n| Part IX, Line 18 | Payments of travel for officials | `IS_OPEX_OTHER` | No |\n| Part IX, Line 19 | Conferences, conventions, meetings | `IS_OPEX_OTHER` | No |\n| Part IX, Line 20 | Interest | `IS_NON_OP_EXPENSE` | No |\n| Part IX, Line 21 | Payments to affiliates | `IS_OPEX_OTHER` | Review for related-party |\n| Part IX, Line 22 | Depreciation, depletion, and amortization | `IS_OPEX_DEPRECIATION` + `IS_OPEX_AMORTIZATION` | Yes (`AB_DEPRECIATION` + `AB_AMORTIZATION`) |\n| Part IX, Line 23 | Insurance | `IS_OPEX_INSURANCE` | No |\n| Part IX, Line 24 | Other expenses (from Schedule O) | `IS_OPEX_OTHER` | Review for one-time items |\n| Part IX, Line 25 | Total functional expenses | `IS_TOTAL_OPEX` (verify = sum of Lines 5-24) | No |\n| Part I, Line 19 | Revenue less expenses (net) | `IS_NET_INCOME` (called \"Change in Net Assets\" for nonprofits) | No |\n| Part X, Line 16 | Total assets | `BS_TOTAL_ASSETS` | No |\n| Part X, Line 26 | Total liabilities | `BS_TOTAL_LIABILITIES` | No |\n| Part X, Line 27-29 | Net assets (unrestricted, temporarily restricted, permanently restricted) | `BS_EQUITY` (combined) | No |\n| Part X, Line 33 | Total liabilities and net assets | `BS_TOTAL_LIAB_EQUITY` | No |\n\n**Nonprofit COGS Note:** Form 990 does not have a COGS line. If the nonprofit has program service costs that are analogous to COGS (e.g., cost of goods sold in a social enterprise), these appear in Part IX functional expenses. The FNE sets `IS_COGS = 0` for nonprofits unless the underwriter manually identifies and reclassifies program costs as COGS.\n\n**Nonprofit Adjusted Cash Flow:**\n```\nAdjusted Cash Flow = Change in Net Assets (Part I, Line 19)\n                   + Depreciation & Amortization (Part IX, Line 22)\n                   + One-time capital campaign expenses (underwriter-identified)\n                   - In-kind revenue offset (if in-kind revenue is included in\n                     total revenue, and corresponding in-kind expense is in\n                     expenses, both sides net to zero -- but if only one side\n                     is recorded, adjust)\n```\n\n**Nonprofit Revenue Quality Flag:**\nThe FNE computes a revenue concentration metric:\n```\nRevenue Concentration = MAX(Single Source Revenue) / Total Revenue\n\nIf Revenue Concentration > 0.50:\n  Flag: \"Single-source revenue concentration of {X}%. Evaluate sustainability.\"\n\nRevenue Mix:\n  Earned Revenue Ratio = Program Service Revenue / Total Revenue\n  Contributed Revenue Ratio = Contributions / Total Revenue\n\nIf Contributed Revenue Ratio > 0.70:\n  Flag: \"High dependency on contributions ({X}%). Evaluate funding reliability.\"\n```\n\n### 7.6 LLC -- Routing Logic\n\nThe FNE does not have a separate mapping table for LLCs. Instead, it routes LLC borrowers to the appropriate entity mapping based on tax election:\n\n```\nfunction determineLLCTreatment(application, taxFormFiled):\n    if taxFormFiled == \"Schedule C\":\n        return \"sole_proprietor\"    // Single-member LLC, disregarded entity\n    elif taxFormFiled == \"Form 1065\":\n        return \"partnership\"         // Multi-member LLC, default\n    elif taxFormFiled == \"Form 1120-S\":\n        return \"s_corp\"             // LLC with S-Corp election\n    elif taxFormFiled == \"Form 1120\":\n        return \"c_corp\"             // LLC with C-Corp election\n    else:\n        // Flag for manual classification\n        return \"unresolved\"\n```\n\nThe `normalization_audit` table records the detected LLC treatment with the rule: `\"LLC routed to {entity_treatment} based on tax form {form_type}\"`.\n\n---\n\n## 8. Multi-Period Handling\n\nThe FNE normalizes up to three years of historical financial data and supports interim (year-to-date) periods.\n\n### 8.1 Period Structure\n\nEach normalized financial record is tagged with:\n- `fiscal_year`: The fiscal year (e.g., 2024)\n- `period_type`: One of `annual`, `interim`, `trailing_twelve_months`\n- `period_start`: Start date of the period\n- `period_end`: End date of the period\n- `months_covered`: Number of months in the period (12 for annual, varies for interim)\n\n### 8.2 Year-Over-Year Trend Calculation\n\nFor each normalized bucket, the FNE computes:\n\n```\nYoY_Change_Pct = (Current_Year_Value - Prior_Year_Value) / |Prior_Year_Value| * 100\n\nIf Prior_Year_Value == 0 and Current_Year_Value != 0:\n  YoY_Change_Pct = NULL (flag as \"new line item\")\n\nIf Prior_Year_Value == 0 and Current_Year_Value == 0:\n  YoY_Change_Pct = 0\n\nThree-Year CAGR (if 3 years available):\n  CAGR = (Year3_Value / Year1_Value)^(1/2) - 1\n```\n\nThe following trend flags are generated automatically:\n\n| Condition | Flag |\n|-----------|------|\n| Revenue declined >10% YoY | `TREND_REVENUE_DECLINE` |\n| Revenue declined >10% for 2 consecutive years | `TREND_REVENUE_SUSTAINED_DECLINE` |\n| Net income turned negative from positive | `TREND_PROFITABILITY_LOSS` |\n| Total debt increased >25% YoY | `TREND_DEBT_INCREASE` |\n| DSCR declined below 1.25 | `TREND_DSCR_DETERIORATION` |\n| Operating expenses grew faster than revenue for 2+ years | `TREND_MARGIN_COMPRESSION` |\n\n### 8.3 Interim Period Handling (YTD Annualization)\n\nWhen the borrower provides year-to-date (YTD) financial statements (e.g., January through September), the FNE annualizes the data for comparison purposes:\n\n```\nAnnualized_Value = (YTD_Value / Months_Covered) * 12\n\nExample:\n  YTD Revenue (Jan-Sep, 9 months) = $675,000\n  Annualized Revenue = ($675,000 / 9) * 12 = $900,000\n```\n\n**Seasonal Adjustment:** If bank statement data or Plaid data reveals significant seasonality (standard deviation of monthly revenue > 30% of monthly average), the FNE flags the annualized figure:\n```\nFlag: \"Annualized from {months_covered} months. Seasonal patterns detected.\n       Annualized figure may overstate/understate actual annual performance.\n       Prior full-year actuals should be weighted more heavily.\"\n```\n\n**Annualization is stored as a separate `period_type = 'annualized_interim'`** -- the raw YTD values are also preserved as `period_type = 'interim'`.\n\n### 8.4 Fiscal Year vs. Calendar Year Alignment\n\nMost tax returns are filed on a calendar year (January-December). Some businesses use a fiscal year (e.g., July-June for nonprofits). The FNE handles this as follows:\n\n- All normalized data retains its original fiscal year dates (`period_start`, `period_end`).\n- For trend analysis, periods are compared by fiscal year sequence (Year 1, Year 2, Year 3) regardless of the actual dates.\n- If comparing two entities (e.g., guarantor personal + business), and one is calendar year and the other is fiscal year, the FNE flags the mismatch:\n  ```\n  Flag: \"Fiscal year mismatch: Business FY ends {month}/{day},\n         personal tax return is calendar year. Revenue/expense timing\n         differences may affect cross-validation accuracy.\"\n  ```\n- For Global Cash Flow, the FNE uses the most recent 12-month period available from each source, with a tolerance of up to 3 months' offset between business and personal periods.\n\n### 8.5 Multi-Period Data Display\n\nThe underwriter UI presents normalized data in a multi-column spreadsheet format:\n\n```\n                          FY 2022     FY 2023     FY 2024     YTD 2025    Trend\n                          --------    --------    --------    --------    -----\nGross Revenue             $1,200,000  $1,350,000  $1,485,000  $1,100,000  +11.2% CAGR\nCOGS                       ($480,000)  ($540,000)  ($594,000)  ($440,000)\nGross Profit                $720,000    $810,000    $891,000    $660,000\n  Gross Margin                 60.0%       60.0%       60.0%       60.0%   Stable\n...\nAdjusted Cash Flow          $285,000    $330,000    $375,000    $290,000   +14.7% CAGR\nDSCR                           1.58x       1.83x       2.08x       2.15x* Rising\n                                                                 *annualized\n```\n\n---\n\n## 9. Global Cash Flow (Personal + Business Combined)\n\nGlobal Cash Flow combines the borrower's business Adjusted Cash Flow with the guarantor's personal income and obligations to produce a Global DSCR -- the single most important metric for underwriting decisions at CDFIs.\n\n### 9.1 Personal Income Sources\n\nExtracted from the guarantor's Form 1040 and supporting schedules:\n\n| Source | 1040 Line | Treatment |\n|--------|-----------|-----------|\n| Wages and salaries (W-2) | Line 1a | Include. If the guarantor is the business owner AND receives a W-2 from the subject business (S-Corp/C-Corp), this is ALREADY captured in the business financials as officer compensation. Do NOT double-count. |\n| Business income (Schedule C) | Line 8, Schedule 1 | **Exclude if this IS the subject business.** Include if from a separate business. |\n| Rental income (Schedule E) | Line 5, Schedule 1 | Include net rental income. If rental properties have associated debt, ensure both income and debt are captured. |\n| Partnership/S-Corp income (Schedule E, K-1) | Schedule E Part II | **Exclude if this IS the subject business.** Include if from other partnerships/S-Corps. |\n| Interest and dividends (Schedule B) | Lines 2b, 3b | Include. Typically small for CDFI borrowers. |\n| Capital gains (Schedule D) | Line 7, Schedule 1 | **Exclude for DSCR** -- capital gains are non-recurring. Flag if material and recurring. |\n| Social Security / Pension | Lines 5a, 6a | Include. Reliable recurring income. |\n| Other income | Line 8, Schedule 1 | Include with review. Flag non-recurring items. |\n\n### 9.2 Personal Debt Obligations\n\nExtracted from the Personal Financial Statement (PFS), credit report, or 1040:\n\n| Obligation | Source | Treatment |\n|-----------|--------|-----------|\n| Primary mortgage (P&I) | PFS / Credit Report | Include annual P&I. |\n| Home equity loan / HELOC | PFS / Credit Report | Include annual payment. |\n| Auto loans | PFS / Credit Report | Include annual payments (all vehicles). |\n| Student loans | PFS / Credit Report | Include annual payment. Use actual payment if in repayment; use IBR estimated payment if in deferment. |\n| Credit card minimum payments | Credit Report | Include sum of minimum monthly payments * 12. |\n| Personal loans | PFS / Credit Report | Include annual P&I. |\n| Alimony / child support | 1040 Schedule 1 or PFS | Include annual obligation. |\n| Other recurring personal debt | PFS | Include if verifiable. |\n\n### 9.3 Double-Count Prevention\n\nThe most critical aspect of Global Cash Flow is avoiding double-counting income that appears in both the business and personal financials.\n\n**Rules:**\n\n1. **S-Corp/C-Corp Owner Salary:** The officer compensation on Form 1120-S Line 7 or Form 1120 Line 12 IS the same as the W-2 wages on the guarantor's Form 1040 Line 1a (or a portion thereof). The FNE must identify this overlap and exclude the W-2 income attributable to the subject business from personal income.\n   ```\n   Personal W-2 Income for Global CF = Total W-2 Income - W-2 from Subject Business\n   ```\n\n2. **Partnership/S-Corp K-1 Income:** The guarantor's K-1 income from the subject partnership or S-Corp is the same income already captured in the business Adjusted Cash Flow. Exclude it from personal income.\n   ```\n   Personal K-1 Income for Global CF = Total K-1 Income - K-1 from Subject Business\n   ```\n\n3. **Sole Proprietor Schedule C:** The Schedule C net profit IS the business income. It should not appear in both business and personal cash flow. In the FNE, the Schedule C is treated entirely as the business. The guarantor's personal income excludes Schedule C from the subject business.\n\n4. **Distributions:** S-Corp and Partnership distributions to the guarantor are already included in business Adjusted Cash Flow as an add-back. Do NOT also include them as personal income.\n\n### 9.4 Global DSCR Calculation\n\n```\nGLOBAL DSCR = Global Cash Flow Available / Total Debt Service\n\nWhere:\n\nGlobal Cash Flow Available =\n    Business Adjusted Cash Flow (from FNE, Section 4.1)\n  + Personal Income (W-2 from OTHER employers, if any)\n  + Rental Income (net, from properties NOT collateralizing the subject loan)\n  + Other K-1 Income (from OTHER businesses)\n  + Social Security / Pension Income\n  + Other Recurring Personal Income\n  - Personal Living Expenses (estimated or actual)\n  - Personal Income Tax (actual from 1040, adjusted for business pass-through)\n\nTotal Debt Service =\n    Annual P&I on ALL existing business debt (from debt schedule)\n  + Annual P&I on proposed new loan\n  + Annual personal mortgage P&I\n  + Annual auto loan payments\n  + Annual student loan payments\n  + Annual credit card minimum payments * 12\n  + Annual personal loan payments\n  + Annual alimony/child support\n\nGLOBAL DSCR = Global Cash Flow Available / Total Debt Service\n```\n\n**Personal Living Expense Estimation (if actual not available):**\n```\nEstimated Personal Living Expenses =\n    Annual mortgage/rent payment (already in debt service, do NOT double-count)\n  + Estimated taxes (from 1040, net of business pass-through taxes)\n  + Health insurance (if not covered by business)\n  + Basic living allowance: use regional cost-of-living data or\n    default to $3,000/month ($36,000/year) per guarantor household\n\nNote: This is the most subjective part of Global Cash Flow.\n      The underwriter should review and override if needed.\n```\n\n### 9.5 Global Cash Flow Output Format\n\n```\n=== GLOBAL CASH FLOW ANALYSIS ===\n\nBUSINESS CASH FLOW\n  Business Adjusted Cash Flow (FNE)              $375,000\n  - Business Debt Service (existing)             ($120,000)\n  = Business Cash Flow After Debt Service         $255,000\n\n  Business-Only DSCR (existing debt):             3.13x\n  Business-Only DSCR (existing + proposed):       1.88x\n\nPERSONAL INCOME (Guarantor: John Smith)\n  W-2 Income (other employers)                    $45,000\n  Rental Income (net)                             $18,000\n  Other Income                                     $5,000\n  = Total Personal Income                         $68,000\n\nPERSONAL OBLIGATIONS (Guarantor: John Smith)\n  Mortgage P&I                                   ($24,000)\n  Auto Loan                                       ($6,000)\n  Student Loans                                   ($3,600)\n  Credit Cards (minimums)                         ($2,400)\n  Estimated Taxes & Living                       ($48,000)\n  = Total Personal Obligations                   ($84,000)\n\n  Personal Surplus / (Deficit)                   ($16,000)\n\nGLOBAL CASH FLOW\n  Business Adjusted Cash Flow                    $375,000\n  + Personal Income                               $68,000\n  - Personal Obligations                         ($84,000)\n  = Global Cash Flow Available                   $359,000\n\n  Total Debt Service (all business + personal)   $236,000\n    Existing business debt                        $120,000\n    Proposed new loan                              $80,000\n    Personal debt                                  $36,000\n\n  GLOBAL DSCR:                                     1.52x\n```\n\n---\n\n## 10. Database Schema\n\nThe following tables extend the existing CremoLogix schema (architecture.md Section 6, specification.md Section 3) to support the Financial Normalization Engine.\n\n### 10.1 Table: `normalized_financials`\n\nStores the normalized output per entity per period. One row per case per fiscal period.\n\n```sql\nCREATE TABLE normalized_financials (\n  id                          UUID PRIMARY KEY DEFAULT uuid_generate_v7(),\n  tenant_id                   UUID NOT NULL REFERENCES tenants(id),\n  case_id                     UUID NOT NULL REFERENCES cases(id),\n  entity_type                 VARCHAR(20) NOT NULL,\n      -- 'sole_proprietor', 'llc', 's_corp', 'c_corp', 'partnership', 'nonprofit'\n  entity_treatment            VARCHAR(20) NOT NULL,\n      -- For LLCs, the actual treatment applied: 'sole_proprietor', 'partnership', 's_corp', 'c_corp'\n      -- For non-LLCs, same as entity_type\n  fiscal_year                 INTEGER NOT NULL,\n  period_type                 VARCHAR(30) NOT NULL,\n      -- 'annual', 'interim', 'annualized_interim', 'trailing_twelve_months'\n  period_start                DATE NOT NULL,\n  period_end                  DATE NOT NULL,\n  months_covered              INTEGER NOT NULL,\n\n  -- Income Statement Buckets\n  is_gross_revenue            DECIMAL(15,2),\n  is_cogs                     DECIMAL(15,2),\n  is_gross_profit             DECIMAL(15,2),\n  is_opex_payroll             DECIMAL(15,2),\n  is_opex_rent                DECIMAL(15,2),\n  is_opex_marketing           DECIMAL(15,2),\n  is_opex_insurance           DECIMAL(15,2),\n  is_opex_professional        DECIMAL(15,2),\n  is_opex_depreciation        DECIMAL(15,2),\n  is_opex_amortization        DECIMAL(15,2),\n  is_opex_other               DECIMAL(15,2),\n  is_total_opex               DECIMAL(15,2),\n  is_owner_comp               DECIMAL(15,2),\n  is_noi                      DECIMAL(15,2),\n  is_non_op_income            DECIMAL(15,2),\n  is_non_op_expense           DECIMAL(15,2),\n  is_net_income               DECIMAL(15,2),\n\n  -- Add-Backs\n  ab_owner_comp               DECIMAL(15,2),\n  ab_depreciation             DECIMAL(15,2),\n  ab_amortization             DECIMAL(15,2),\n  ab_one_time                 DECIMAL(15,2),\n  ab_related_rent             DECIMAL(15,2),\n  ab_fit                      DECIMAL(15,2),\n  ab_total                    DECIMAL(15,2),\n\n  -- Key Derived Metric\n  is_adjusted_cf              DECIMAL(15,2),\n\n  -- Balance Sheet Buckets\n  bs_cash                     DECIMAL(15,2),\n  bs_ar                       DECIMAL(15,2),\n  bs_inventory                DECIMAL(15,2),\n  bs_other_current_assets     DECIMAL(15,2),\n  bs_total_current            DECIMAL(15,2),\n  bs_ppe_net                  DECIMAL(15,2),\n  bs_real_estate              DECIMAL(15,2),\n  bs_intangibles              DECIMAL(15,2),\n  bs_other_lt_assets          DECIMAL(15,2),\n  bs_total_assets             DECIMAL(15,2),\n  bs_ap                       DECIMAL(15,2),\n  bs_cpltd                    DECIMAL(15,2),\n  bs_accrued                  DECIMAL(15,2),\n  bs_other_current_liab       DECIMAL(15,2),\n  bs_total_current_liab       DECIMAL(15,2),\n  bs_notes_lt                 DECIMAL(15,2),\n  bs_mortgages                DECIMAL(15,2),\n  bs_other_lt_liab            DECIMAL(15,2),\n  bs_total_liabilities        DECIMAL(15,2),\n  bs_equity                   DECIMAL(15,2),\n  bs_total_liab_equity        DECIMAL(15,2),\n\n  -- Cash Flow Buckets\n  cf_operating                DECIMAL(15,2),\n  cf_investing                DECIMAL(15,2),\n  cf_financing                DECIMAL(15,2),\n  cf_net_change               DECIMAL(15,2),\n  cf_free                     DECIMAL(15,2),\n\n  -- Trend Metrics (computed, NULL for first year)\n  yoy_revenue_change_pct      DECIMAL(10,4),\n  yoy_net_income_change_pct   DECIMAL(10,4),\n  yoy_adjusted_cf_change_pct  DECIMAL(10,4),\n  yoy_total_assets_change_pct DECIMAL(10,4),\n  yoy_total_debt_change_pct   DECIMAL(10,4),\n  revenue_cagr_3yr            DECIMAL(10,4),\n\n  -- Confidence\n  overall_confidence          DECIMAL(5,4) NOT NULL,\n  validation_status           VARCHAR(20) NOT NULL DEFAULT 'pending',\n      -- 'pending', 'auto_validated', 'flagged_for_review', 'manual_required',\n      -- 'underwriter_reviewed', 'confirmed'\n  field_confidences_jsonb     JSONB NOT NULL DEFAULT '{}',\n      -- Per-field confidence: {\"is_gross_revenue\": 0.95, \"is_net_income\": 0.88, ...}\n\n  -- Cross-Validation\n  cross_validation_score      DECIMAL(5,4),\n  cross_validation_results_jsonb JSONB DEFAULT '{}',\n      -- {\"XV-001\": {\"status\": \"pass\", \"variance\": 0.02}, ...}\n\n  -- Trend Flags\n  trend_flags_jsonb           JSONB DEFAULT '[]',\n      -- [{\"flag\": \"TREND_REVENUE_DECLINE\", \"detail\": \"Revenue declined 12% YoY\"}, ...]\n\n  -- Source Tracking\n  primary_source_document_id  UUID REFERENCES documents(id),\n  source_documents_jsonb      JSONB NOT NULL DEFAULT '[]',\n      -- [{\"document_id\": \"uuid\", \"document_type\": \"tax_return_business\", \"fields_sourced\": [\"is_gross_revenue\", ...]}]\n\n  -- Add-Back Detail\n  add_back_details_jsonb      JSONB NOT NULL DEFAULT '[]',\n      -- [{\"type\": \"AB_OWNER_COMP\", \"amount\": 85000, \"source_field\": \"Line 7\", \"description\": \"Officer compensation\", \"auto_identified\": true}]\n\n  -- Global Cash Flow (NULL if personal data not available)\n  global_personal_income      DECIMAL(15,2),\n  global_personal_obligations DECIMAL(15,2),\n  global_cash_flow_available  DECIMAL(15,2),\n  global_total_debt_service   DECIMAL(15,2),\n  global_dscr                 DECIMAL(10,4),\n  global_cf_details_jsonb     JSONB DEFAULT '{}',\n\n  -- Metadata\n  normalization_version       VARCHAR(20) NOT NULL DEFAULT '1.0',\n  normalized_by               VARCHAR(50) NOT NULL DEFAULT 'system',\n      -- 'system' or user UUID if manually normalized\n  created_at                  TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at                  TIMESTAMPTZ NOT NULL DEFAULT now(),\n  deleted_at                  TIMESTAMPTZ NULL\n);\n\nCREATE INDEX idx_norm_fin_case ON normalized_financials(tenant_id, case_id);\nCREATE INDEX idx_norm_fin_year ON normalized_financials(tenant_id, case_id, fiscal_year);\nCREATE INDEX idx_norm_fin_status ON normalized_financials(tenant_id, validation_status);\nCREATE UNIQUE INDEX idx_norm_fin_unique_period\n  ON normalized_financials(tenant_id, case_id, fiscal_year, period_type)\n  WHERE deleted_at IS NULL;\n```\n\n### 10.2 Table: `normalization_mappings`\n\nStores the source-to-bucket mapping rules per entity type. These are the configurable rules that the FNE applies. Pre-seeded with the mappings defined in Section 7.\n\n```sql\nCREATE TABLE normalization_mappings (\n  id                          UUID PRIMARY KEY DEFAULT uuid_generate_v7(),\n  tenant_id                   UUID REFERENCES tenants(id),\n      -- NULL for system-default mappings; tenant-specific overrides have tenant_id set\n  entity_type                 VARCHAR(20) NOT NULL,\n      -- 'sole_proprietor', 's_corp', 'c_corp', 'partnership', 'nonprofit'\n  tax_form                    VARCHAR(20) NOT NULL,\n      -- 'schedule_c', '1120_s', '1120', '1065', '990'\n  source_field_code           VARCHAR(50) NOT NULL,\n      -- e.g., 'line_1a', 'line_7', 'part_viii_line_2'\n  source_field_label          VARCHAR(255) NOT NULL,\n      -- e.g., 'Gross receipts or sales', 'Compensation of officers'\n  normalized_bucket           VARCHAR(50) NOT NULL,\n      -- e.g., 'IS_GROSS_REVENUE', 'IS_OPEX_PAYROLL'\n  is_add_back                 BOOLEAN NOT NULL DEFAULT false,\n  add_back_type               VARCHAR(30),\n      -- 'AB_OWNER_COMP', 'AB_DEPRECIATION', 'AB_AMORTIZATION', 'AB_ONE_TIME',\n      -- 'AB_RELATED_RENT', 'AB_FIT', NULL if not an add-back\n  add_back_auto_apply         BOOLEAN NOT NULL DEFAULT false,\n      -- true = automatically applied; false = suggested, underwriter must confirm\n  mapping_notes               TEXT,\n      -- Explanation of any special handling\n  priority                    INTEGER NOT NULL DEFAULT 100,\n      -- Lower = higher priority. Used when multiple mappings could apply.\n  is_active                   BOOLEAN NOT NULL DEFAULT true,\n  created_at                  TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at                  TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_norm_map_entity ON normalization_mappings(entity_type, tax_form);\nCREATE INDEX idx_norm_map_tenant ON normalization_mappings(tenant_id)\n  WHERE tenant_id IS NOT NULL;\nCREATE UNIQUE INDEX idx_norm_map_unique\n  ON normalization_mappings(COALESCE(tenant_id, '00000000-0000-0000-0000-000000000000'),\n                            entity_type, tax_form, source_field_code)\n  WHERE is_active = true;\n```\n\n### 10.3 Table: `normalization_audit`\n\nTracks which rules were applied, which fields were add-backed, confidence per field, cross-validation results, and all underwriter overrides. Append-only.\n\n```sql\nCREATE TABLE normalization_audit (\n  id                          UUID PRIMARY KEY DEFAULT uuid_generate_v7(),\n  tenant_id                   UUID NOT NULL REFERENCES tenants(id),\n  case_id                     UUID NOT NULL REFERENCES cases(id),\n  normalized_financial_id     UUID NOT NULL REFERENCES normalized_financials(id),\n  event_type                  VARCHAR(50) NOT NULL,\n      -- 'normalization_started', 'mapping_applied', 'add_back_applied',\n      -- 'add_back_suggested', 'add_back_rejected', 'cross_validation_run',\n      -- 'confidence_computed', 'field_overridden', 'normalization_completed',\n      -- 'underwriter_confirmed', 'llc_routing_applied'\n  field_code                  VARCHAR(50),\n      -- The normalized bucket code, e.g., 'IS_GROSS_REVENUE'. NULL for non-field events.\n  mapping_id                  UUID REFERENCES normalization_mappings(id),\n      -- The mapping rule that was applied. NULL for non-mapping events.\n  source_document_id          UUID REFERENCES documents(id),\n  source_field_code           VARCHAR(50),\n      -- The original source field, e.g., 'line_1a'\n  original_value              DECIMAL(15,2),\n      -- The value before any override\n  applied_value               DECIMAL(15,2),\n      -- The value that was actually used\n  override_value              DECIMAL(15,2),\n      -- The value the underwriter entered (NULL if no override)\n  confidence                  DECIMAL(5,4),\n      -- Confidence score for this field at this point in time\n  override_reason             TEXT,\n      -- Required when event_type = 'field_overridden'\n  cross_validation_rule_id    VARCHAR(10),\n      -- e.g., 'XV-001'. NULL for non-cross-validation events.\n  cross_validation_status     VARCHAR(10),\n      -- 'pass', 'warning', 'fail'. NULL for non-cross-validation events.\n  cross_validation_variance   DECIMAL(10,4),\n  details_jsonb               JSONB DEFAULT '{}',\n      -- Flexible field for additional context\n  performed_by                UUID REFERENCES users(id),\n      -- NULL for system-performed events\n  performed_at                TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\n-- Append-only: no UPDATE or DELETE permissions for the application role\nCREATE INDEX idx_norm_audit_case ON normalization_audit(tenant_id, case_id);\nCREATE INDEX idx_norm_audit_financial ON normalization_audit(normalized_financial_id);\nCREATE INDEX idx_norm_audit_event ON normalization_audit(event_type);\nCREATE INDEX idx_norm_audit_time ON normalization_audit(performed_at DESC);\n```\n\n### 10.4 Table: `normalized_financial_overrides`\n\nTracks individual field overrides by underwriters with full audit trail. This is a working table (not append-only) that stores the current state of overrides.\n\n```sql\nCREATE TABLE normalized_financial_overrides (\n  id                          UUID PRIMARY KEY DEFAULT uuid_generate_v7(),\n  tenant_id                   UUID NOT NULL REFERENCES tenants(id),\n  normalized_financial_id     UUID NOT NULL REFERENCES normalized_financials(id),\n  field_code                  VARCHAR(50) NOT NULL,\n      -- The normalized bucket code being overridden\n  original_value              DECIMAL(15,2),\n  override_value              DECIMAL(15,2) NOT NULL,\n  override_reason             TEXT NOT NULL,\n      -- Required justification\n  override_source             VARCHAR(50),\n      -- e.g., 'bank_statement', 'client_conversation', 'recalculation', 'other'\n  overridden_by               UUID NOT NULL REFERENCES users(id),\n  overridden_at               TIMESTAMPTZ NOT NULL DEFAULT now(),\n  is_active                   BOOLEAN NOT NULL DEFAULT true,\n      -- false if the override was reverted\n  reverted_by                 UUID REFERENCES users(id),\n  reverted_at                 TIMESTAMPTZ,\n  revert_reason               TEXT,\n  created_at                  TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at                  TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_norm_override_financial\n  ON normalized_financial_overrides(normalized_financial_id);\nCREATE UNIQUE INDEX idx_norm_override_unique\n  ON normalized_financial_overrides(normalized_financial_id, field_code)\n  WHERE is_active = true;\n```\n\n---\n\n## 11. API Endpoints\n\nAll endpoints are under the Core API Server (NestJS) and require JWT authentication. Tenant context is derived from the JWT. These endpoints extend the existing API contract (specification.md Section 4).\n\n### 11.1 POST `/api/v1/financial/normalize`\n\n**Purpose:** Trigger normalization for a case. Reads extraction results, applies entity-specific mapping rules, computes add-backs, runs cross-validation, computes confidence, and stores normalized output.\n\n**Authorization:** `underwriter`, `credit_manager`, `admin`\n\n**Request Body:**\n```json\n{\n  \"case_id\": \"uuid\",\n  \"fiscal_years\": [2022, 2023, 2024],\n  \"include_interim\": true,\n  \"force_renormalize\": false\n}\n```\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `case_id` | UUID | Yes | The case to normalize |\n| `fiscal_years` | integer[] | No | Specific years to normalize. If omitted, normalizes all available years. |\n| `include_interim` | boolean | No | Whether to include YTD interim periods. Default: true. |\n| `force_renormalize` | boolean | No | If true, deletes existing normalization and re-runs. Default: false. |\n\n**Response (202 Accepted):**\n```json\n{\n  \"job_id\": \"uuid\",\n  \"status\": \"queued\",\n  \"case_id\": \"uuid\",\n  \"estimated_duration_seconds\": 15,\n  \"message\": \"Normalization job queued. Poll GET /api/v1/financial/normalize/status/{job_id} or await webhook.\"\n}\n```\n\n**Response (409 Conflict):**\n```json\n{\n  \"error\": \"NORMALIZATION_EXISTS\",\n  \"message\": \"Normalized financials already exist for this case. Set force_renormalize=true to re-run.\",\n  \"existing_periods\": [\n    {\"fiscal_year\": 2023, \"period_type\": \"annual\", \"normalized_at\": \"2026-02-01T...\"}\n  ]\n}\n```\n\n**Error Conditions:**\n- `404`: Case not found or not accessible\n- `422`: No extraction results available for the case (documents not yet processed)\n- `409`: Normalization already exists and `force_renormalize` is false\n\n### 11.2 GET `/api/v1/financial/normalized/{caseId}`\n\n**Purpose:** Retrieve the normalized financial output for a case, across all available periods.\n\n**Authorization:** `underwriter` (assigned to case), `credit_manager`, `admin`\n\n**Query Parameters:**\n\n| Parameter | Type | Required | Description |\n|-----------|------|----------|-------------|\n| `fiscal_year` | integer | No | Filter to a specific year |\n| `period_type` | string | No | Filter: `annual`, `interim`, `annualized_interim` |\n| `include_global_cf` | boolean | No | Include Global Cash Flow analysis. Default: true. |\n| `include_trends` | boolean | No | Include YoY trend calculations. Default: true. |\n\n**Response (200 OK):**\n```json\n{\n  \"case_id\": \"uuid\",\n  \"entity_type\": \"s_corp\",\n  \"entity_treatment\": \"s_corp\",\n  \"overall_confidence\": 0.91,\n  \"validation_status\": \"auto_validated\",\n  \"cross_validation_score\": 0.88,\n  \"periods\": [\n    {\n      \"id\": \"uuid\",\n      \"fiscal_year\": 2024,\n      \"period_type\": \"annual\",\n      \"period_start\": \"2024-01-01\",\n      \"period_end\": \"2024-12-31\",\n      \"months_covered\": 12,\n      \"income_statement\": {\n        \"is_gross_revenue\": {\"value\": 1485000.00, \"confidence\": 0.95, \"status\": \"auto_validated\"},\n        \"is_cogs\": {\"value\": 594000.00, \"confidence\": 0.93, \"status\": \"auto_validated\"},\n        \"is_gross_profit\": {\"value\": 891000.00, \"confidence\": 0.93, \"status\": \"auto_validated\"},\n        \"is_opex_payroll\": {\"value\": 285000.00, \"confidence\": 0.90, \"status\": \"auto_validated\"},\n        \"is_opex_rent\": {\"value\": 72000.00, \"confidence\": 0.92, \"status\": \"auto_validated\"},\n        \"is_opex_marketing\": {\"value\": 24000.00, \"confidence\": 0.88, \"status\": \"flagged_for_review\"},\n        \"is_opex_insurance\": {\"value\": 18000.00, \"confidence\": 0.91, \"status\": \"auto_validated\"},\n        \"is_opex_professional\": {\"value\": 15000.00, \"confidence\": 0.85, \"status\": \"flagged_for_review\"},\n        \"is_opex_depreciation\": {\"value\": 45000.00, \"confidence\": 0.97, \"status\": \"auto_validated\"},\n        \"is_opex_amortization\": {\"value\": 5000.00, \"confidence\": 0.80, \"status\": \"flagged_for_review\"},\n        \"is_opex_other\": {\"value\": 52000.00, \"confidence\": 0.78, \"status\": \"flagged_for_review\"},\n        \"is_total_opex\": {\"value\": 516000.00, \"confidence\": 0.88, \"status\": \"flagged_for_review\"},\n        \"is_owner_comp\": {\"value\": 120000.00, \"confidence\": 0.95, \"status\": \"auto_validated\"},\n        \"is_noi\": {\"value\": 375000.00, \"confidence\": 0.88, \"status\": \"flagged_for_review\"},\n        \"is_non_op_income\": {\"value\": 2000.00, \"confidence\": 0.85, \"status\": \"flagged_for_review\"},\n        \"is_non_op_expense\": {\"value\": 18000.00, \"confidence\": 0.90, \"status\": \"auto_validated\"},\n        \"is_net_income\": {\"value\": 359000.00, \"confidence\": 0.92, \"status\": \"auto_validated\"}\n      },\n      \"add_backs\": {\n        \"ab_owner_comp\": {\"value\": 120000.00, \"description\": \"Officer compensation (1120-S Line 7)\", \"auto_identified\": true},\n        \"ab_depreciation\": {\"value\": 45000.00, \"description\": \"Depreciation (1120-S Line 14)\", \"auto_identified\": true},\n        \"ab_amortization\": {\"value\": 5000.00, \"description\": \"Amortization (from Other Deductions)\", \"auto_identified\": true},\n        \"ab_one_time\": {\"value\": 15000.00, \"description\": \"Lawsuit settlement - non-recurring\", \"auto_identified\": false},\n        \"ab_related_rent\": {\"value\": 0.00, \"description\": null, \"auto_identified\": false},\n        \"ab_fit\": {\"value\": 0.00, \"description\": \"N/A - pass-through entity\", \"auto_identified\": true},\n        \"ab_total\": {\"value\": 185000.00}\n      },\n      \"adjusted_cash_flow\": {\"value\": 544000.00, \"confidence\": 0.91},\n      \"balance_sheet\": {\n        \"bs_cash\": {\"value\": 125000.00, \"confidence\": 0.95},\n        \"bs_ar\": {\"value\": 180000.00, \"confidence\": 0.88},\n        \"bs_inventory\": {\"value\": 95000.00, \"confidence\": 0.85},\n        \"bs_total_assets\": {\"value\": 850000.00, \"confidence\": 0.90}\n      },\n      \"cash_flow\": {\n        \"cf_operating\": {\"value\": 380000.00, \"confidence\": 0.82},\n        \"cf_investing\": {\"value\": -65000.00, \"confidence\": 0.80},\n        \"cf_financing\": {\"value\": -95000.00, \"confidence\": 0.85},\n        \"cf_net_change\": {\"value\": 220000.00, \"confidence\": 0.82},\n        \"cf_free\": {\"value\": 315000.00, \"confidence\": 0.80}\n      },\n      \"trends\": {\n        \"yoy_revenue_change_pct\": 10.00,\n        \"yoy_net_income_change_pct\": 12.50,\n        \"yoy_adjusted_cf_change_pct\": 13.64,\n        \"revenue_cagr_3yr\": 11.24\n      },\n      \"trend_flags\": []\n    }\n  ],\n  \"global_cash_flow\": {\n    \"business_adjusted_cf\": 544000.00,\n    \"personal_income\": 68000.00,\n    \"personal_obligations\": 84000.00,\n    \"global_cf_available\": 528000.00,\n    \"total_debt_service\": 316000.00,\n    \"global_dscr\": 1.67,\n    \"double_count_adjustments\": [\n      {\"type\": \"w2_from_subject_business\", \"amount\": 120000.00, \"excluded_from\": \"personal_income\"}\n    ]\n  },\n  \"cross_validation\": {\n    \"score\": 0.88,\n    \"rules_evaluated\": 7,\n    \"passed\": 5,\n    \"warnings\": 2,\n    \"failed\": 0,\n    \"results\": [\n      {\"rule_id\": \"XV-001\", \"status\": \"pass\", \"variance\": 0.03, \"description\": \"Tax vs. P&L net income: 3% variance (within 5% tolerance)\"},\n      {\"rule_id\": \"XV-002\", \"status\": \"warning\", \"variance\": 0.18, \"description\": \"Bank deposits vs. revenue: 18% variance (within 25% warning threshold). May include loan proceeds or inter-account transfers.\"}\n    ]\n  },\n  \"source_documents\": [\n    {\"document_id\": \"uuid\", \"document_type\": \"tax_return_business\", \"tax_year\": 2024, \"fields_sourced\": 22},\n    {\"document_id\": \"uuid\", \"document_type\": \"financial_statement\", \"period\": \"FY2024\", \"fields_sourced\": 15},\n    {\"document_id\": \"uuid\", \"document_type\": \"bank_statement\", \"period\": \"Jan-Dec 2024\", \"fields_sourced\": 3}\n  ]\n}\n```\n\n### 11.3 PUT `/api/v1/financial/normalized/{caseId}/override`\n\n**Purpose:** Allow an underwriter to correct a normalized field with justification. Creates an audit trail entry and updates the normalized output.\n\n**Authorization:** `underwriter` (assigned to case), `credit_manager`, `admin`\n\n**Request Body:**\n```json\n{\n  \"normalized_financial_id\": \"uuid\",\n  \"overrides\": [\n    {\n      \"field_code\": \"is_opex_other\",\n      \"new_value\": 42000.00,\n      \"reason\": \"Reclassified $10,000 from Other Operating to Marketing based on GL detail review. Remaining $42,000 confirmed.\",\n      \"source\": \"accounting_software\"\n    },\n    {\n      \"field_code\": \"ab_one_time\",\n      \"new_value\": 25000.00,\n      \"reason\": \"Added $10,000 moving expense as one-time item per borrower explanation. Total one-time add-backs now $25,000.\",\n      \"source\": \"client_conversation\"\n    }\n  ]\n}\n```\n\n**Response (200 OK):**\n```json\n{\n  \"normalized_financial_id\": \"uuid\",\n  \"overrides_applied\": 2,\n  \"recalculated_fields\": {\n    \"is_total_opex\": {\"old\": 516000.00, \"new\": 506000.00},\n    \"is_noi\": {\"old\": 375000.00, \"new\": 385000.00},\n    \"ab_total\": {\"old\": 185000.00, \"new\": 195000.00},\n    \"is_adjusted_cf\": {\"old\": 544000.00, \"new\": 564000.00},\n    \"global_dscr\": {\"old\": 1.67, \"new\": 1.73}\n  },\n  \"audit_entries_created\": 2\n}\n```\n\n**Validation Rules:**\n- `reason` is required and must be at least 20 characters.\n- `source` must be one of: `tax_return`, `financial_statement`, `bank_statement`, `accounting_software`, `client_conversation`, `recalculation`, `credit_report`, `other`.\n- Overriding a field triggers automatic recalculation of all dependent fields (totals, ratios, DSCR, Global DSCR).\n- Each override is recorded in both `normalized_financial_overrides` and `normalization_audit`.\n\n### 11.4 GET `/api/v1/financial/normalized/{caseId}/audit`\n\n**Purpose:** Retrieve the complete normalization audit trail for a case. Shows every mapping applied, every add-back identified, every cross-validation result, and every underwriter override.\n\n**Authorization:** `underwriter` (assigned to case), `credit_manager`, `admin`\n\n**Query Parameters:**\n\n| Parameter | Type | Required | Description |\n|-----------|------|----------|-------------|\n| `event_type` | string | No | Filter by event type |\n| `field_code` | string | No | Filter by specific field |\n| `fiscal_year` | integer | No | Filter by fiscal year |\n| `page` | integer | No | Pagination. Default: 1. |\n| `per_page` | integer | No | Items per page. Default: 50. Max: 200. |\n\n**Response (200 OK):**\n```json\n{\n  \"case_id\": \"uuid\",\n  \"total_events\": 156,\n  \"page\": 1,\n  \"per_page\": 50,\n  \"events\": [\n    {\n      \"id\": \"uuid\",\n      \"event_type\": \"normalization_started\",\n      \"performed_at\": \"2026-02-01T14:30:00Z\",\n      \"performed_by\": null,\n      \"details\": {\"entity_type\": \"s_corp\", \"fiscal_years\": [2022, 2023, 2024], \"normalization_version\": \"1.0\"}\n    },\n    {\n      \"id\": \"uuid\",\n      \"event_type\": \"llc_routing_applied\",\n      \"performed_at\": \"2026-02-01T14:30:01Z\",\n      \"performed_by\": null,\n      \"details\": {\"declared_type\": \"llc\", \"tax_form_detected\": \"1120_s\", \"treatment_applied\": \"s_corp\"}\n    },\n    {\n      \"id\": \"uuid\",\n      \"event_type\": \"mapping_applied\",\n      \"field_code\": \"is_gross_revenue\",\n      \"source_field_code\": \"line_1a\",\n      \"source_document_id\": \"uuid\",\n      \"original_value\": 1485000.00,\n      \"applied_value\": 1485000.00,\n      \"confidence\": 0.95,\n      \"performed_at\": \"2026-02-01T14:30:02Z\",\n      \"performed_by\": null,\n      \"details\": {\"mapping_id\": \"uuid\", \"mapping_rule\": \"1120-S Line 1a -> IS_GROSS_REVENUE\"}\n    },\n    {\n      \"id\": \"uuid\",\n      \"event_type\": \"add_back_applied\",\n      \"field_code\": \"ab_owner_comp\",\n      \"source_field_code\": \"line_7\",\n      \"source_document_id\": \"uuid\",\n      \"applied_value\": 120000.00,\n      \"confidence\": 0.95,\n      \"performed_at\": \"2026-02-01T14:30:03Z\",\n      \"performed_by\": null,\n      \"details\": {\"add_back_type\": \"AB_OWNER_COMP\", \"description\": \"Officer compensation (1120-S Line 7)\", \"auto_applied\": true}\n    },\n    {\n      \"id\": \"uuid\",\n      \"event_type\": \"cross_validation_run\",\n      \"cross_validation_rule_id\": \"XV-001\",\n      \"cross_validation_status\": \"pass\",\n      \"cross_validation_variance\": 0.03,\n      \"performed_at\": \"2026-02-01T14:30:10Z\",\n      \"performed_by\": null,\n      \"details\": {\"value_a\": 359000.00, \"value_a_source\": \"tax_return\", \"value_b\": 348730.00, \"value_b_source\": \"financial_statement\"}\n    },\n    {\n      \"id\": \"uuid\",\n      \"event_type\": \"field_overridden\",\n      \"field_code\": \"is_opex_other\",\n      \"original_value\": 52000.00,\n      \"override_value\": 42000.00,\n      \"performed_at\": \"2026-02-03T09:15:00Z\",\n      \"performed_by\": \"uuid-of-underwriter\",\n      \"details\": {\"reason\": \"Reclassified $10,000 from Other Operating to Marketing based on GL detail review.\", \"source\": \"accounting_software\"}\n    }\n  ]\n}\n```\n\n### 11.5 GET `/api/v1/financial/normalize/status/{jobId}`\n\n**Purpose:** Poll the status of an asynchronous normalization job.\n\n**Authorization:** `underwriter`, `credit_manager`, `admin`\n\n**Response (200 OK):**\n```json\n{\n  \"job_id\": \"uuid\",\n  \"case_id\": \"uuid\",\n  \"status\": \"completed\",\n  \"progress_pct\": 100,\n  \"started_at\": \"2026-02-01T14:30:00Z\",\n  \"completed_at\": \"2026-02-01T14:30:12Z\",\n  \"duration_seconds\": 12,\n  \"result\": {\n    \"periods_normalized\": 3,\n    \"overall_confidence\": 0.91,\n    \"cross_validation_score\": 0.88,\n    \"warnings\": 2,\n    \"errors\": 0\n  }\n}\n```\n\n**Status values:** `queued`, `processing`, `completed`, `failed`\n\n---\n\n## 12. Phasing\n\n### Phase 1: MVP (Rule-Based)\n\n**Timeline:** Included in MVP build (Phase 1 of overall CremoLogix roadmap)\n\n**Scope:**\n- Hard-coded normalization rules per entity type as defined in Section 7 of this document.\n- Tax form line-to-bucket mappings seeded in the `normalization_mappings` table.\n- Automatic add-back identification for: depreciation, amortization, officer compensation / guaranteed payments, federal income tax (C-Corp).\n- AI-suggested add-back identification for: one-time items, related-party rent adjustments. The AI (Claude) reviews the extracted data and suggests potential add-backs with explanations. The underwriter confirms or rejects each suggestion.\n- Cross-validation rules (Section 5) implemented as deterministic checks.\n- Confidence scoring (Section 6) with source hierarchy.\n- All six entity types supported.\n- Multi-period support (1-3 years).\n- Global Cash Flow computation.\n- Underwriter override capability with full audit trail.\n- All four API endpoints operational.\n\n**What is NOT in MVP:**\n- ML-based add-back identification (suggestions only, not auto-apply for non-obvious items).\n- Automated learning from underwriter corrections.\n- Plaid transaction-level categorization matching (Plaid data used for bank balance cross-validation only).\n- QuickBooks direct API integration (export file import only).\n- Seasonal adjustment models for interim annualization.\n\n### Phase 2: ML-Enhanced\n\n**Timeline:** Post-MVP, after sufficient portfolio data is accumulated (~100+ normalized cases)\n\n**Scope:**\n- ML models trained on underwriter-corrected normalization data to improve mapping accuracy.\n- Auto-identification of add-backs based on patterns in historical corrections. Example: if underwriters consistently add back a specific expense type for a specific industry, the model learns to suggest it automatically.\n- Confidence scores calibrated against actual correction rates (predicted confidence should match actual accuracy).\n- Plaid transaction-level categorization matching against reported expense categories.\n- QuickBooks direct API integration via Plaid for real-time accounting data.\n- Industry-specific normalization adjustments (e.g., construction: percentage-of-completion revenue recognition; restaurants: tip income handling; real estate: depreciation treatment for investment properties).\n- Seasonal adjustment models using historical cash flow patterns to produce more accurate interim annualization.\n- Anomaly detection: ML model flags unusual patterns (sudden expense category changes, revenue spikes without corresponding COGS increases, unexplained balance sheet movements).\n\n**Training Data Requirements:**\n- Minimum 100 normalized and underwriter-reviewed cases across at least 3 entity types.\n- Each case must have: original normalization, underwriter overrides (if any), final confirmed values.\n- Training runs quarterly with new data.\n- Model versioning with A/B testing against rule-based baseline.\n\n---\n\n## 13. Acceptance Criteria\n\nEach criterion includes a concrete test scenario and expected outcome.\n\n### AC-1: Normalize a Sole Proprietor (Schedule C)\n\n**Scenario:** A sole proprietor barbershop files Schedule C. Gross receipts: $185,000. COGS: $12,000. Depreciation (Line 13): $8,500. Wages (Line 26): $45,000. Rent (Line 20b): $24,000. Net profit (Line 31): $62,300. No balance sheet (sole prop).\n\n**Expected Output:**\n- `IS_GROSS_REVENUE` = $185,000\n- `IS_COGS` = $12,000\n- `IS_GROSS_PROFIT` = $173,000\n- `IS_OPEX_PAYROLL` = $45,000\n- `IS_OPEX_RENT` = $24,000\n- `IS_OPEX_DEPRECIATION` = $8,500\n- `IS_NET_INCOME` = $62,300\n- `AB_DEPRECIATION` = $8,500\n- `IS_ADJUSTED_CF` = $62,300 + $8,500 = $70,800\n- `IS_OWNER_COMP` (memo) = $62,300 (entire net profit)\n- Entity treatment = `sole_proprietor`\n\n**Verification:** Adjusted Cash Flow of $70,800 is the correct number to use for business DSCR.\n\n### AC-2: Normalize an S-Corp (Form 1120-S)\n\n**Scenario:** An S-Corp consulting firm. Gross receipts (Line 1a): $950,000. COGS: $0 (service business). Officer compensation (Line 7): $150,000. Salaries/wages (Line 8): $280,000. Rent (Line 11): $48,000. Depreciation (Line 14): $22,000. Other deductions (Line 19): $85,000 (includes $5,000 amortization). Ordinary business income (Line 21): $365,000. Shareholder distributions (Schedule K Line 16d): $200,000.\n\n**Expected Output:**\n- `IS_GROSS_REVENUE` = $950,000\n- `IS_COGS` = $0\n- `IS_GROSS_PROFIT` = $950,000\n- `IS_OPEX_PAYROLL` = $280,000 + $150,000 = $430,000 (wages + officer comp)\n- `IS_OPEX_RENT` = $48,000\n- `IS_OPEX_DEPRECIATION` = $22,000\n- `IS_OPEX_AMORTIZATION` = $5,000\n- `IS_OPEX_OTHER` = $80,000 (Other deductions minus amortization)\n- `IS_NET_INCOME` = $365,000\n- `IS_OWNER_COMP` = $150,000 (officer comp only for memo line)\n- `AB_OWNER_COMP` = $150,000 + $200,000 = $350,000 (officer comp + distributions)\n- `AB_DEPRECIATION` = $22,000\n- `AB_AMORTIZATION` = $5,000\n- `IS_ADJUSTED_CF` = $365,000 + $350,000 + $22,000 + $5,000 = $742,000\n\n**Verification:** Adjusted Cash Flow of $742,000 correctly captures all cash available to the owner(s) including compensation, distributions, and non-cash expenses.\n\n### AC-3: Normalize a C-Corp (Form 1120)\n\n**Scenario:** A C-Corp manufacturing company. Gross receipts (Line 1a): $2,400,000. COGS (Line 2): $1,440,000. Officer compensation (Line 12): $200,000. Salaries (Line 13): $380,000. Rent (Line 16): $96,000. Depreciation (Line 20): $65,000. Charitable contributions (Line 19): $10,000. Other deductions (Line 26): $120,000. Taxable income (Line 30): $89,000. Total tax (Line 31): $18,690.\n\n**Expected Output:**\n- `IS_GROSS_REVENUE` = $2,400,000\n- `IS_COGS` = $1,440,000\n- `IS_GROSS_PROFIT` = $960,000\n- `IS_NET_INCOME` = $89,000 - $18,690 = $70,310 (after tax)\n- `AB_OWNER_COMP` = $200,000\n- `AB_DEPRECIATION` = $65,000\n- `AB_FIT` = $18,690\n- `AB_ONE_TIME` = $10,000 (charitable, discretionary)\n- `IS_ADJUSTED_CF` = $70,310 + $200,000 + $65,000 + $18,690 + $10,000 = $364,000\n\n**Verification:** Adjusted Cash Flow of $364,000 includes the C-Corp-specific add-back of federal income tax ($18,690) to normalize against pass-through entities.\n\n### AC-4: Cross-Validate Tax Return Against Bank Deposits\n\n**Scenario:** S-Corp reports gross receipts of $950,000 on Form 1120-S. Bank statements for the same 12-month period show total deposits of $1,185,000 (includes $100,000 loan proceeds and $50,000 inter-account transfer).\n\n**Expected Behavior:**\n- Raw bank deposits: $1,185,000\n- Adjustments: -$100,000 (loan proceeds), -$50,000 (transfers) = $1,035,000 adjusted deposits\n- Reported revenue: $950,000\n- Variance: |$1,035,000 - $950,000| / $1,035,000 = 8.2%\n- Rule XV-002 tolerance: 15%\n- **Result:** PASS (8.2% < 15%)\n- If adjusted deposits were $1,200,000: variance = 20.8%, **Result:** WARNING (between 15% and 25%)\n\n### AC-5: Produce Global DSCR from Combined Personal + Business Data\n\n**Scenario:** S-Corp owner (from AC-2) with personal data: W-2 from subject business: $150,000 (exclude -- already in business), W-2 from spouse's employer: $55,000, rental income: $12,000/yr. Personal obligations: mortgage $2,400/mo, auto $450/mo, student loans $300/mo. Proposed new business loan: $500,000 at 7.5% for 10 years (annual P&I ~$71,676). Existing business debt service: $48,000/yr.\n\n**Expected Computation:**\n```\nBusiness Adjusted Cash Flow:               $742,000\nPersonal Income (non-subject-business):      $67,000  ($55,000 + $12,000)\nPersonal Obligations:                       ($37,800) ($2,400*12 + $450*12 + $300*12)\nEstimated Personal Taxes & Living:          ($48,000) (default estimate)\n\nGlobal Cash Flow Available =\n  $742,000 + $67,000 - $37,800 - $48,000 = $723,200\n\nTotal Debt Service:\n  Existing business:   $48,000\n  Proposed new loan:   $71,676\n  Personal mortgage:   $28,800\n  Personal auto:        $5,400\n  Personal student:     $3,600\n  Total:              $157,476\n\nGlobal DSCR = $723,200 / $157,476 = 4.59x\n```\n\n### AC-6: Underwriter Override with Audit Trail\n\n**Scenario:** Underwriter reviews the normalized S-Corp data (AC-2) and determines that $30,000 of the \"Other deductions\" was actually a one-time relocation expense. Underwriter overrides `ab_one_time` from $0 to $30,000.\n\n**Expected Behavior:**\n1. PUT `/api/v1/financial/normalized/{caseId}/override` succeeds with field_code `ab_one_time`, new_value $30,000, reason \"One-time office relocation expense per borrower documentation.\"\n2. `ab_total` recalculates: $350,000 + $22,000 + $5,000 + $30,000 = $407,000\n3. `is_adjusted_cf` recalculates: $365,000 + $407,000 = $772,000\n4. `global_dscr` recalculates accordingly.\n5. `normalization_audit` contains a `field_overridden` event with the underwriter's user ID, timestamp, original value ($0), override value ($30,000), and reason.\n6. `normalized_financial_overrides` contains an active override record.\n7. GET `/api/v1/financial/normalized/{caseId}/audit` returns the override event in the trail.\n8. The underwriter UI shows the overridden field with a visual indicator and tooltip showing the override history.\n\n---\n\n## Appendix A: Glossary\n\n| Term | Definition |\n|------|------------|\n| **Add-Back** | A non-cash or discretionary expense added back to net income to arrive at Adjusted Cash Flow. Used to normalize for entity type differences and arrive at true cash available for debt service. |\n| **Adjusted Cash Flow** | Net Income + Add-Backs. The key number for DSCR calculation. Represents the actual cash available to service debt. |\n| **DSCR (Debt Service Coverage Ratio)** | Adjusted Cash Flow / Annual Debt Service. The primary metric for loan repayment ability. Minimum typically 1.25x for CDFIs. |\n| **Global DSCR** | DSCR computed using combined business + personal cash flows and all business + personal debt obligations. Provides a complete picture of the guarantor's repayment ability. |\n| **Normalization** | The process of converting diverse financial data formats into a single standardized structure that enables comparison regardless of entity type or source format. |\n| **Pass-Through Entity** | An entity type (S-Corp, Partnership, Sole Prop) where business income \"passes through\" to the owner's personal tax return and is taxed at the individual level rather than the entity level. |\n| **Common-Sizing** | Expressing financial statement line items as percentages of a base (typically revenue for income statement, total assets for balance sheet) to enable comparison across different-sized businesses. |\n\n## Appendix B: Normalization Mapping Seed Data Count\n\n| Entity Type | Tax Form | Number of Mapping Rules |\n|------------|----------|------------------------|\n| Sole Proprietor | Schedule C | 28 line items |\n| S-Corporation | Form 1120-S | 22 line items + 4 Schedule K items |\n| C-Corporation | Form 1120 | 24 line items |\n| Partnership | Form 1065 | 22 line items + 5 Schedule K items |\n| Nonprofit | Form 990 | 30 line items (Part VIII + Part IX + Part X) |\n| LLC | *Routed* | Uses mapping of elected entity type |\n\n**Total mapping rules to seed:** ~135 rules across all entity types.\n\n---\n\n*End of Financial Normalization Engine Specification Addendum*\n","cremologix/specification":"# CremoLogix -- Technical & Prototype Specification\n\n**Crucible Document Type:** Specification\n**Status:** Implementation-Ready\n**Sources:**\n- `C:/projects/CremoLogix_Technical_Spec.md` (Technical Specification v1.0.0-MVP)\n- `C:/projects/CremoLogix_Prototype_Spec_v2.md` (Prototype Specification v2)\n\n---\n\n## Table of Contents\n\n1. [Executive Summary](#1-executive-summary)\n2. [System Architecture Overview](#2-system-architecture-overview)\n3. [Data Models & Database Schema](#3-data-models--database-schema)\n4. [API Contract Specification](#4-api-contract-specification)\n5. [AI/ML Pipeline Specification](#5-aiml-pipeline-specification)\n6. [Integration Specifications](#6-integration-specifications)\n7. [Security Architecture](#7-security-architecture)\n8. [Workflow Engine Design](#8-workflow-engine-design)\n9. [Audit Trail Architecture](#9-audit-trail-architecture)\n10. [Non-Functional Requirements](#10-non-functional-requirements)\n11. [MVP Scope Boundaries](#11-mvp-scope-boundaries)\n12. [Dependency Matrix](#12-dependency-matrix)\n13. [Prototype Design System](#13-prototype-design-system)\n14. [Prototype Screen Inventory](#14-prototype-screen-inventory)\n15. [Screen Navigation Map](#15-screen-navigation-map)\n\n---\n\n## 1. Executive Summary\n\n### Purpose\n\nThis specification consolidates the full technical blueprint and UI prototype definition for CremoLogix MVP. It translates validated business analysis outputs into an implementable engineering plan covering every data model, API contract, AI pipeline, integration point, infrastructure requirement, and screen design.\n\n### What CremoLogix Is\n\nCremoLogix is an AI-assisted underwriting sidecar platform for Community Development Financial Institutions (CDFIs). It automates document processing, financial analysis, risk assessment, scoring, and credit memo generation while keeping a human underwriter in the decision loop at every critical juncture. CremoLogix does NOT approve or decline loans -- it produces a scored, evidence-backed underwriting package that a Credit Manager reviews and decides upon.\n\n### MVP Scope\n\n- **Single tenant:** Siura Capital (pilot CDFI)\n- **Four user roles:** Borrower, Underwriter, Credit Manager, Administrator\n- **13-phase underwriting workflow** from intake through closeout\n- **84 screens** across 9 portals (Borrower, Denied Applicant, Broker, Intake Agent, Underwriter, Credit Manager, External Funding, FinOps, Administrator) plus 9 SPA demo shells\n- **Salesforce integration** for TOS referral channel\n- **Basic LOS export** via sidecar API pattern\n- **AI pipelines** for OCR, extraction, financial analysis, risk assessment, scoring, and credit memo generation\n\n---\n\n## 2. System Architecture Overview\n\n### 2.1 High-Level Architecture\n\n```\n+------------------------------------------------------------------+\n|                        CLIENTS                                    |\n|  +------------+  +-------------+  +------------+  +------------+ |\n|  | Borrower   |  | Underwriter |  | Credit Mgr |  | Admin      | |\n|  | Portal     |  | Portal      |  | Portal     |  | Portal     | |\n|  | (React SPA)|  | (React SPA) |  | (React SPA)|  | (React SPA)| |\n|  +------+-----+  +------+------+  +------+-----+  +------+-----+ |\n+---------|----------------|----------------|----------------|------+\n          |                |                |                |\n          v                v                v                v\n+------------------------------------------------------------------+\n|                     API GATEWAY / LOAD BALANCER                   |\n|              (Rate Limiting, CORS, Auth Routing)                  |\n+----------------------------------+-------------------------------+\n                                   |\n          +------------------------+------------------------+\n          |                                                 |\n+---------v-----------+                       +-------------v--------+\n|   AUTH SERVICE      |                       |   NOTIFICATION SVC   |\n| - JWT issuance      |                       | - Email dispatch     |\n| - Token refresh     |                       | - In-app notices     |\n| - Password reset    |                       | - Template engine    |\n| - Email verify      |                       +----------------------+\n+---------------------+\n          |\n+---------v------------------------------------------------------------+\n|                        CORE API SERVER (Node.js / NestJS)            |\n|                                                                      |\n|  +------------------+ +------------------+ +----------------------+  |\n|  | Case Management  | | Financial Engine | | Scoring Engine       |  |\n|  | - CRUD           | | - Spread compute | | - Factor evaluation  |  |\n|  | - Phase workflow  | | - Ratio calc     | | - Weight application |  |\n|  | - Assignments    | | - Trend analysis | | - Recommendation     |  |\n|  +------------------+ +------------------+ +----------------------+  |\n|                                                                      |\n|  +------------------+ +------------------+ +----------------------+  |\n|  | Document Mgmt    | | Risk Assessment  | | Packet Assembly      |  |\n|  | - Upload/store   | | - Rule engine    | | - Memo generation    |  |\n|  | - Status track   | | - Narrative gen  | | - PDF/Word export    |  |\n|  +------------------+ +------------------+ +----------------------+  |\n|                                                                      |\n|  +------------------+ +------------------+ +----------------------+  |\n|  | Admin Config     | | Audit Service    | | Integration Layer    |  |\n|  | - Products       | | - Event capture  | | - Salesforce         |  |\n|  | - Scoring models | | - Immutable log  | | - LOS sidecar       |  |\n|  | - Workflows      | | - Query/export   | | - Email service      |  |\n|  +------------------+ +------------------+ +----------------------+  |\n+-------------------+--------------------------------------------------+\n                    |\n     +--------------+--------------+\n     |              |              |\n+----v-----+  +----v-----+  +----v-----------+\n| PostgreSQL|  | Redis    |  | Object Storage |\n| (Primary  |  | (Cache,  |  | (S3-compatible)|\n|  Database)|  |  Queues) |  | - Documents    |\n+-----------+  +----------+  | - Exports      |\n                              +----------------+\n                    |\n     +--------------+--------------+\n     |                             |\n+----v-----------------+   +------v-----------------+\n| AI/ML PIPELINE       |   | ASYNC WORKER CLUSTER   |\n| (Python/FastAPI)     |   | (Bull/BullMQ on Redis) |\n| - OCR Service        |   | - Doc processing jobs  |\n| - Classification     |   | - Analysis jobs        |\n| - Extraction Engine  |   | - Notification jobs    |\n| - NLP / LLM Gateway |   | - Export jobs           |\n+----------------------+   +--------------------------+\n```\n\n### 2.2 Component Breakdown\n\n| Component | Technology | Responsibility |\n|-----------|-----------|---------------|\n| **Frontend SPA** | React 18 + TypeScript, Vite, TailwindCSS | All screens across all portals |\n| **API Gateway** | Azure Front Door + WAF | Rate limiting, routing, CORS, TLS termination |\n| **Core API Server** | Node.js 20 + NestJS + TypeScript | Business logic, REST endpoints, workflow engine |\n| **Auth Service** | NestJS module (internal) | JWT issuance, RBAC enforcement, session management |\n| **AI/ML Pipeline** | Python 3.11 + FastAPI | OCR, classification, extraction, NLP, LLM orchestration |\n| **Async Workers** | BullMQ on Redis | Document processing, analysis jobs, export generation |\n| **Primary Database** | PostgreSQL 16 | All relational data, row-level security |\n| **Cache / Queue** | Redis 7 | Session cache, job queues, rate limit counters |\n| **Object Storage** | Azure Blob Storage (or Azurite for dev) | Document files, generated exports |\n| **Notification Service** | NestJS module + SendGrid/SES | Email dispatch, in-app notification persistence |\n\n### 2.3 Multi-Tenant Architecture\n\nFor MVP (single tenant), multi-tenancy is implemented at the data layer with `tenant_id` foreign keys on all tenant-scoped tables. Row-Level Security (RLS) policies in PostgreSQL enforce isolation.\n\n**Approach:** Shared database, shared schema, row-level tenant isolation.\n\n- Every tenant-scoped table includes a `tenant_id UUID NOT NULL` column.\n- PostgreSQL RLS policies set `current_setting('app.current_tenant_id')` at connection time.\n- The API middleware extracts tenant context from the authenticated JWT and sets the session variable before each request.\n- Indexes include `tenant_id` as a prefix for all multi-tenant queries.\n\n**Post-MVP evolution:** If tenant count exceeds ~50 or data isolation requirements increase, migrate to schema-per-tenant.\n\n### 2.4 Deployment Model\n\n- **Cloud Provider:** Azure (primary), with Terraform for infrastructure-as-code\n- **Container Orchestration:** Azure Container Apps (MVP) -- AKS (post-MVP)\n- **CI/CD:** GitHub Actions with staging and production environments\n- **Infrastructure as Code:** Terraform\n- **Environments:** Development, Staging, Production\n- **Region:** East US (MVP), multi-region post-MVP\n\n---\n\n## 3. Data Models & Database Schema\n\nAll tables use UUID v7 primary keys (time-sortable). Timestamps are `TIMESTAMPTZ` stored in UTC. Soft deletes use `deleted_at TIMESTAMPTZ NULL`. All tenant-scoped tables enforce RLS via `tenant_id`.\n\n### Conventions\n\n- `id` -- UUID v7 primary key\n- `created_at` / `updated_at` -- automatic timestamps\n- `deleted_at` -- soft delete marker (NULL = active)\n- `tenant_id` -- foreign key to `tenants.id`, present on all tenant-scoped entities\n- `_jsonb` suffix -- JSONB columns for flexible/nested data\n- Enum types defined as PostgreSQL ENUMs\n\n### 3.1 Tenant\n\nRepresents a CDFI organization. Top-level entity for multi-tenant isolation.\n\n```\nTABLE: tenants\n---------------------------------------------------------------\nColumn              | Type         | Constraints\n---------------------------------------------------------------\nid                  | UUID         | PK, DEFAULT uuid_generate_v7()\nname                | VARCHAR(255) | NOT NULL\nslug                | VARCHAR(100) | NOT NULL, UNIQUE\ndomain              | VARCHAR(255) | NULL (custom domain)\nlogo_url            | VARCHAR(512) | NULL\nprimary_contact_email| VARCHAR(255)| NOT NULL\nsettings_jsonb      | JSONB        | NOT NULL DEFAULT '{}'\nstatus              | ENUM('active','suspended','onboarding') | NOT NULL DEFAULT 'onboarding'\ncreated_at          | TIMESTAMPTZ  | NOT NULL DEFAULT now()\nupdated_at          | TIMESTAMPTZ  | NOT NULL DEFAULT now()\ndeleted_at          | TIMESTAMPTZ  | NULL\n---------------------------------------------------------------\nINDEXES:\n  - UNIQUE(slug) WHERE deleted_at IS NULL\n  - idx_tenants_status(status)\n\nsettings_jsonb schema:\n{\n  \"timezone\": \"America/New_York\",\n  \"default_currency\": \"USD\",\n  \"branding\": { \"primary_color\": \"#hex\", \"secondary_color\": \"#hex\" },\n  \"notifications\": { \"digest_frequency\": \"daily\" | \"realtime\" },\n  \"retention_days\": 2555\n}\n```\n\n### 3.2 User\n\nAll human users across all roles. A user belongs to exactly one tenant.\n\n```\nTABLE: users\n---------------------------------------------------------------\nColumn              | Type         | Constraints\n---------------------------------------------------------------\nid                  | UUID         | PK\ntenant_id           | UUID         | FK tenants(id), NOT NULL\nemail               | VARCHAR(255) | NOT NULL\npassword_hash       | VARCHAR(255) | NOT NULL\nfirst_name          | VARCHAR(100) | NOT NULL\nlast_name           | VARCHAR(100) | NOT NULL\nphone               | VARCHAR(20)  | NULL\navatar_url          | VARCHAR(512) | NULL\nemail_verified      | BOOLEAN      | NOT NULL DEFAULT false\nemail_verified_at   | TIMESTAMPTZ  | NULL\nverification_token  | VARCHAR(255) | NULL\nreset_token         | VARCHAR(255) | NULL\nreset_token_expires | TIMESTAMPTZ  | NULL\nstatus              | ENUM('active','inactive','pending_verification','locked') | NOT NULL DEFAULT 'pending_verification'\nlast_login_at       | TIMESTAMPTZ  | NULL\nfailed_login_count  | INTEGER      | NOT NULL DEFAULT 0\nlocked_until        | TIMESTAMPTZ  | NULL\npreferences_jsonb   | JSONB        | NOT NULL DEFAULT '{}'\ncreated_at          | TIMESTAMPTZ  | NOT NULL DEFAULT now()\nupdated_at          | TIMESTAMPTZ  | NOT NULL DEFAULT now()\ndeleted_at          | TIMESTAMPTZ  | NULL\n---------------------------------------------------------------\nINDEXES:\n  - UNIQUE(tenant_id, email) WHERE deleted_at IS NULL\n  - idx_users_tenant(tenant_id)\n  - idx_users_status(tenant_id, status)\n  - idx_users_verification_token(verification_token) WHERE verification_token IS NOT NULL\n  - idx_users_reset_token(reset_token) WHERE reset_token IS NOT NULL\n```\n\n### 3.3 UserRole (Join Table)\n\nMaps users to roles. A user may hold multiple roles within the same tenant.\n\n```\nTABLE: user_roles\n---------------------------------------------------------------\nColumn              | Type         | Constraints\n---------------------------------------------------------------\nid                  | UUID         | PK\nuser_id             | UUID         | FK users(id), NOT NULL\ntenant_id           | UUID         | FK tenants(id), NOT NULL\nrole                | ENUM('borrower','underwriter','credit_manager','admin') | NOT NULL\ngranted_by          | UUID         | FK users(id), NULL\ngranted_at          | TIMESTAMPTZ  | NOT NULL DEFAULT now()\nrevoked_at          | TIMESTAMPTZ  | NULL\n---------------------------------------------------------------\nINDEXES:\n  - UNIQUE(user_id, tenant_id, role) WHERE revoked_at IS NULL\n  - idx_user_roles_tenant_role(tenant_id, role)\n```\n\n### 3.4 LoanProduct\n\nConfigurable loan product definitions per tenant.\n\n```\nTABLE: loan_products\n---------------------------------------------------------------\nColumn              | Type           | Constraints\n---------------------------------------------------------------\nid                  | UUID           | PK\ntenant_id           | UUID           | FK tenants(id), NOT NULL\nname                | VARCHAR(255)   | NOT NULL\ncode                | VARCHAR(50)    | NOT NULL\ndescription         | TEXT           | NULL\nloan_type           | ENUM('term','line_of_credit','sba_7a','sba_504','micro','real_estate','equipment','working_capital') | NOT NULL\nmin_amount          | DECIMAL(15,2)  | NOT NULL\nmax_amount          | DECIMAL(15,2)  | NOT NULL\nmin_term_months     | INTEGER        | NOT NULL\nmax_term_months     | INTEGER        | NOT NULL\ninterest_rate_type  | ENUM('fixed','variable','blended') | NOT NULL\ndefault_rate_floor  | DECIMAL(5,4)   | NULL\ndefault_rate_ceiling| DECIMAL(5,4)   | NULL\nrequired_documents_jsonb | JSONB     | NOT NULL DEFAULT '[]'\neligibility_criteria_jsonb | JSONB   | NOT NULL DEFAULT '{}'\nunderwriting_checklist_jsonb | JSONB | NOT NULL DEFAULT '[]'\nscoring_model_id    | UUID           | FK scoring_models(id), NULL\nworkflow_config_id  | UUID           | FK workflow_configs(id), NULL\nstatus              | ENUM('active','inactive','draft') | NOT NULL DEFAULT 'draft'\ncreated_at          | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at          | TIMESTAMPTZ    | NOT NULL DEFAULT now()\ndeleted_at          | TIMESTAMPTZ    | NULL\n---------------------------------------------------------------\nINDEXES:\n  - UNIQUE(tenant_id, code) WHERE deleted_at IS NULL\n  - idx_loan_products_tenant_status(tenant_id, status)\n```\n\n### 3.5 Application\n\nA borrower's loan application submission. One application produces one case.\n\n```\nTABLE: applications\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\nborrower_user_id        | UUID           | FK users(id), NOT NULL\nloan_product_id         | UUID           | FK loan_products(id), NOT NULL\nintake_channel          | ENUM('direct','salesforce_referral','external_referral') | NOT NULL\nreferral_source         | VARCHAR(255)   | NULL\nsalesforce_referral_id  | VARCHAR(100)   | NULL\nexternal_referrer_user_id| UUID          | FK users(id), NULL\nbusiness_name           | VARCHAR(255)   | NOT NULL\nbusiness_ein            | VARCHAR(20)    | NULL\nbusiness_type           | ENUM('sole_prop','llc','s_corp','c_corp','partnership','nonprofit') | NOT NULL\nbusiness_state          | VARCHAR(2)     | NOT NULL\nbusiness_address_jsonb  | JSONB          | NOT NULL\nbusiness_start_date     | DATE           | NULL\nnaics_code              | VARCHAR(10)    | NULL\nindustry_description    | VARCHAR(255)   | NULL\nrequested_amount        | DECIMAL(15,2)  | NOT NULL\nrequested_term_months   | INTEGER        | NULL\nloan_purpose            | TEXT           | NOT NULL\nuse_of_funds_jsonb      | JSONB          | NOT NULL DEFAULT '[]'\nguarantors_jsonb        | JSONB          | NOT NULL DEFAULT '[]'\nannual_revenue          | DECIMAL(15,2)  | NULL\nemployee_count          | INTEGER        | NULL\nyears_in_business       | DECIMAL(4,1)   | NULL\nexisting_debt_amount    | DECIMAL(15,2)  | NULL\nstatus                  | ENUM('draft','submitted','in_review','case_created','withdrawn') | NOT NULL DEFAULT 'draft'\nsubmitted_at            | TIMESTAMPTZ    | NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\ndeleted_at              | TIMESTAMPTZ    | NULL\n---------------------------------------------------------------\nINDEXES:\n  - idx_applications_tenant_status(tenant_id, status)\n  - idx_applications_borrower(tenant_id, borrower_user_id)\n  - idx_applications_submitted(tenant_id, submitted_at DESC)\n  - idx_applications_salesforce(salesforce_referral_id) WHERE salesforce_referral_id IS NOT NULL\n```\n\n### 3.6 Case\n\nThe core underwriting case entity. Created from an application, tracks the 13-phase workflow.\n\n```\nTABLE: cases\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\napplication_id          | UUID           | FK applications(id), NOT NULL, UNIQUE\ncase_number             | VARCHAR(30)    | NOT NULL\nloan_product_id         | UUID           | FK loan_products(id), NOT NULL\nborrower_user_id        | UUID           | FK users(id), NOT NULL\nassigned_underwriter_id | UUID           | FK users(id), NULL\nassigned_reviewer_id    | UUID           | FK users(id), NULL\ncurrent_phase           | ENUM('configuration','intake','document_collection','data_extraction','financial_analysis','risk_assessment','follow_up_questions','response_collection','override_management','scoring','packet_assembly','credit_review','export_closeout') | NOT NULL DEFAULT 'intake'\nstatus                  | ENUM('open','in_progress','pending_borrower','pending_review','approved','declined','returned','withdrawn','archived') | NOT NULL DEFAULT 'open'\npriority                | ENUM('low','normal','high','urgent') | NOT NULL DEFAULT 'normal'\nrequested_amount        | DECIMAL(15,2)  | NOT NULL\nrecommended_amount      | DECIMAL(15,2)  | NULL\napproved_amount         | DECIMAL(15,2)  | NULL\nsla_due_date            | TIMESTAMPTZ    | NULL\nrisk_tier               | ENUM('low','moderate','elevated','high') | NULL\noverall_score           | DECIMAL(5,2)   | NULL\nai_recommendation       | ENUM('approve','approve_with_conditions','decline','insufficient_data') | NULL\nunderwriter_confirmed   | BOOLEAN        | NOT NULL DEFAULT false\nconfirmed_at            | TIMESTAMPTZ    | NULL\ncase_metadata_jsonb     | JSONB          | NOT NULL DEFAULT '{}'\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nclosed_at               | TIMESTAMPTZ    | NULL\ndeleted_at              | TIMESTAMPTZ    | NULL\n---------------------------------------------------------------\nINDEXES:\n  - UNIQUE(tenant_id, case_number) WHERE deleted_at IS NULL\n  - idx_cases_tenant_status(tenant_id, status)\n  - idx_cases_underwriter(tenant_id, assigned_underwriter_id, status)\n  - idx_cases_reviewer(tenant_id, assigned_reviewer_id, status)\n  - idx_cases_phase(tenant_id, current_phase)\n  - idx_cases_sla(tenant_id, sla_due_date) WHERE status IN ('open','in_progress','pending_borrower')\n  - idx_cases_application(application_id)\n```\n\n### 3.7 CasePhase\n\nTracks each phase's state and timing for a case. One row per phase per case.\n\n```\nTABLE: case_phases\n---------------------------------------------------------------\nColumn              | Type           | Constraints\n---------------------------------------------------------------\nid                  | UUID           | PK\ntenant_id           | UUID           | FK tenants(id), NOT NULL\ncase_id             | UUID           | FK cases(id), NOT NULL\nphase               | ENUM(same as cases.current_phase) | NOT NULL\nstatus              | ENUM('pending','active','completed','skipped','blocked') | NOT NULL DEFAULT 'pending'\nentered_at          | TIMESTAMPTZ    | NULL\ncompleted_at        | TIMESTAMPTZ    | NULL\ncompleted_by        | UUID           | FK users(id), NULL\nsla_target_at       | TIMESTAMPTZ    | NULL\nsla_warning_sent    | BOOLEAN        | NOT NULL DEFAULT false\nsla_breached        | BOOLEAN        | NOT NULL DEFAULT false\nentry_conditions_met_jsonb | JSONB   | NOT NULL DEFAULT '{}'\nexit_conditions_met_jsonb  | JSONB   | NOT NULL DEFAULT '{}'\nnotes               | TEXT           | NULL\ncreated_at          | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at          | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - UNIQUE(case_id, phase)\n  - idx_case_phases_tenant_case(tenant_id, case_id)\n  - idx_case_phases_active(tenant_id, status) WHERE status = 'active'\n```\n\n### 3.8 Document\n\nUploaded documents with processing metadata.\n\n```\nTABLE: documents\n---------------------------------------------------------------\nColumn                | Type           | Constraints\n---------------------------------------------------------------\nid                    | UUID           | PK\ntenant_id             | UUID           | FK tenants(id), NOT NULL\ncase_id               | UUID           | FK cases(id), NOT NULL\nuploaded_by           | UUID           | FK users(id), NOT NULL\noriginal_filename     | VARCHAR(500)   | NOT NULL\nstorage_key           | VARCHAR(1000)  | NOT NULL\nmime_type             | VARCHAR(100)   | NOT NULL\nfile_size_bytes       | BIGINT         | NOT NULL\ndocument_type         | ENUM('tax_return_business','tax_return_personal','bank_statement','financial_statement','articles_of_incorporation','business_license','insurance_certificate','appraisal','environmental_report','personal_financial_statement','debt_schedule','accounts_receivable_aging','accounts_payable_aging','lease_agreement','purchase_agreement','business_plan','other') | NOT NULL DEFAULT 'other'\ndocument_label        | VARCHAR(255)   | NULL\ntax_year              | INTEGER        | NULL\nperiod_start          | DATE           | NULL\nperiod_end            | DATE           | NULL\nprocessing_status     | ENUM('uploaded','queued','ocr_processing','ocr_complete','classifying','classified','extracting','extracted','validation_pending','validated','failed') | NOT NULL DEFAULT 'uploaded'\nocr_confidence        | DECIMAL(5,4)   | NULL\nclassification_confidence | DECIMAL(5,4) | NULL\npage_count            | INTEGER        | NULL\nocr_text_storage_key  | VARCHAR(1000)  | NULL\nvirus_scan_status     | ENUM('pending','clean','infected','error') | NOT NULL DEFAULT 'pending'\nvirus_scan_at         | TIMESTAMPTZ    | NULL\nencryption_key_id     | VARCHAR(255)   | NOT NULL\nis_superseded         | BOOLEAN        | NOT NULL DEFAULT false\nsuperseded_by         | UUID           | FK documents(id), NULL\nnotes                 | TEXT           | NULL\ncreated_at            | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at            | TIMESTAMPTZ    | NOT NULL DEFAULT now()\ndeleted_at            | TIMESTAMPTZ    | NULL\n---------------------------------------------------------------\nINDEXES:\n  - idx_documents_case(tenant_id, case_id)\n  - idx_documents_type(tenant_id, case_id, document_type)\n  - idx_documents_processing(tenant_id, processing_status)\n  - idx_documents_storage(storage_key)\n```\n\n### 3.9 ExtractionResult\n\nAI-extracted structured data from a document, with per-field confidence scores.\n\n```\nTABLE: extraction_results\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\ndocument_id             | UUID           | FK documents(id), NOT NULL\ncase_id                 | UUID           | FK cases(id), NOT NULL\nextraction_model_version| VARCHAR(50)    | NOT NULL\nextraction_type         | ENUM('tax_return','bank_statement','financial_statement','pfs','debt_schedule','ar_aging','ap_aging','other') | NOT NULL\nfiscal_year             | INTEGER        | NULL\nperiod_label            | VARCHAR(50)    | NULL\nraw_extraction_jsonb    | JSONB          | NOT NULL\nstructured_data_jsonb   | JSONB          | NOT NULL\nfield_confidences_jsonb | JSONB          | NOT NULL DEFAULT '{}'\noverall_confidence      | DECIMAL(5,4)   | NOT NULL\nlow_confidence_fields   | TEXT[]         | NOT NULL DEFAULT '{}'\nvalidation_status       | ENUM('pending','auto_validated','manual_review_needed','manually_validated','rejected') | NOT NULL DEFAULT 'pending'\nvalidated_by            | UUID           | FK users(id), NULL\nvalidated_at            | TIMESTAMPTZ    | NULL\noverride_data_jsonb     | JSONB          | NULL\nprocessing_time_ms      | INTEGER        | NULL\nerror_message           | TEXT           | NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_extraction_document(document_id)\n  - idx_extraction_case(tenant_id, case_id)\n  - idx_extraction_validation(tenant_id, validation_status)\n  - idx_extraction_type_year(tenant_id, case_id, extraction_type, fiscal_year)\n```\n\n### 3.10 FinancialSpread\n\nComputed financial analysis data. One row per analysis type per case, potentially per fiscal year.\n\n```\nTABLE: financial_spreads\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\ncase_id                 | UUID           | FK cases(id), NOT NULL\nanalysis_type           | ENUM('business_cash_flow','personal_debt_income','global_cash_flow','balance_sheet','income_statement','operating_cycle','ratio_analysis','collateral_coverage','business_debt_schedule') | NOT NULL\nfiscal_year             | INTEGER        | NULL\nperiod_label            | VARCHAR(50)    | NULL\nguarantor_index         | INTEGER        | NULL\nsource_extraction_ids   | UUID[]         | NOT NULL DEFAULT '{}'\ncomputed_data_jsonb     | JSONB          | NOT NULL\nsummary_metrics_jsonb   | JSONB          | NOT NULL DEFAULT '{}'\nbenchmark_comparisons_jsonb | JSONB      | NULL\ntrend_data_jsonb        | JSONB          | NULL\noverride_data_jsonb     | JSONB          | NULL\ncomputation_version     | VARCHAR(20)    | NOT NULL\ncomputation_notes       | TEXT           | NULL\nstatus                  | ENUM('computed','reviewed','overridden','stale') | NOT NULL DEFAULT 'computed'\nreviewed_by             | UUID           | FK users(id), NULL\nreviewed_at             | TIMESTAMPTZ    | NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_spreads_case_type(tenant_id, case_id, analysis_type)\n  - idx_spreads_case_type_year(tenant_id, case_id, analysis_type, fiscal_year)\n```\n\n### 3.11 RiskItem\n\nIdentified risk factors and policy exceptions per case.\n\n```\nTABLE: risk_items\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\ncase_id                 | UUID           | FK cases(id), NOT NULL\nrisk_source             | ENUM('ai_identified','policy_rule','underwriter_added') | NOT NULL\nrisk_category           | ENUM('financial','operational','market','management','collateral','regulatory','concentration','character') | NOT NULL\nseverity                | ENUM('low','moderate','elevated','high','critical') | NOT NULL\ntitle                   | VARCHAR(255)   | NOT NULL\ndescription             | TEXT           | NOT NULL\nevidence_jsonb          | JSONB          | NOT NULL DEFAULT '[]'\nrelated_analysis_type   | VARCHAR(50)    | NULL\nrelated_spread_id       | UUID           | FK financial_spreads(id), NULL\npolicy_rule_reference   | VARCHAR(100)   | NULL\nis_policy_exception     | BOOLEAN        | NOT NULL DEFAULT false\nexception_justification | TEXT           | NULL\nmitigation_strategy     | TEXT           | NULL\nai_narrative            | TEXT           | NULL\nstatus                  | ENUM('open','acknowledged','mitigated','accepted','dismissed') | NOT NULL DEFAULT 'open'\nresolved_by             | UUID           | FK users(id), NULL\nresolved_at             | TIMESTAMPTZ    | NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_risk_items_case(tenant_id, case_id)\n  - idx_risk_items_severity(tenant_id, case_id, severity)\n  - idx_risk_items_exceptions(tenant_id, case_id) WHERE is_policy_exception = true\n  - idx_risk_items_status(tenant_id, status)\n```\n\n### 3.12 FollowUpQuestion\n\nAI-generated or underwriter-created follow-up questions for the borrower.\n\n```\nTABLE: follow_up_questions\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\ncase_id                 | UUID           | FK cases(id), NOT NULL\ngenerated_by            | ENUM('ai','underwriter') | NOT NULL\ncreated_by_user_id      | UUID           | FK users(id), NULL\nmemo_section_mapping    | VARCHAR(100)   | NULL\nquestion_text           | TEXT           | NOT NULL\ncontext_description     | TEXT           | NULL\npriority                | ENUM('required','important','optional') | NOT NULL DEFAULT 'important'\ncategory                | ENUM('financial','operational','collateral','management','use_of_funds','projections','other') | NOT NULL\nsort_order              | INTEGER        | NOT NULL DEFAULT 0\nstatus                  | ENUM('draft','approved','sent','answered','withdrawn') | NOT NULL DEFAULT 'draft'\napproved_by             | UUID           | FK users(id), NULL\napproved_at             | TIMESTAMPTZ    | NULL\nsent_at                 | TIMESTAMPTZ    | NULL\nresponse_deadline       | TIMESTAMPTZ    | NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_followup_case(tenant_id, case_id)\n  - idx_followup_status(tenant_id, case_id, status)\n  - idx_followup_priority(tenant_id, case_id, priority)\n```\n\n### 3.13 BorrowerResponse\n\nBorrower's response to a follow-up question, with AI narrative conversion.\n\n```\nTABLE: borrower_responses\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\ncase_id                 | UUID           | FK cases(id), NOT NULL\nquestion_id             | UUID           | FK follow_up_questions(id), NOT NULL\nresponse_channel        | ENUM('web_form','email','phone_transcription') | NOT NULL DEFAULT 'web_form'\nraw_response_text       | TEXT           | NOT NULL\nconverted_narrative     | TEXT           | NULL\nnarrative_conversion_status | ENUM('pending','converted','reviewed','edited') | NOT NULL DEFAULT 'pending'\nedited_narrative        | TEXT           | NULL\nedited_by               | UUID           | FK users(id), NULL\nattachments_jsonb       | JSONB          | NOT NULL DEFAULT '[]'\nreviewed_by             | UUID           | FK users(id), NULL\nreviewed_at             | TIMESTAMPTZ    | NULL\nreview_status           | ENUM('pending','satisfactory','needs_followup','insufficient') | NOT NULL DEFAULT 'pending'\nreview_notes            | TEXT           | NULL\nsubmitted_at            | TIMESTAMPTZ    | NOT NULL DEFAULT now()\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_responses_case(tenant_id, case_id)\n  - idx_responses_question(question_id)\n  - idx_responses_review(tenant_id, review_status)\n```\n\n### 3.14 Override\n\nAll manual adjustments to AI-produced data, with mandatory rationale.\n\n```\nTABLE: overrides\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\ncase_id                 | UUID           | FK cases(id), NOT NULL\noverride_type           | ENUM('extraction_field','spread_value','risk_severity','risk_status','score_factor','document_classification','question_edit','narrative_edit') | NOT NULL\ntarget_entity_type      | VARCHAR(50)    | NOT NULL\ntarget_entity_id        | UUID           | NOT NULL\nfield_path              | VARCHAR(255)   | NOT NULL\noriginal_value_jsonb    | JSONB          | NOT NULL\nnew_value_jsonb         | JSONB          | NOT NULL\nrationale               | TEXT           | NOT NULL\nsupporting_document_id  | UUID           | FK documents(id), NULL\ncreated_by              | UUID           | FK users(id), NOT NULL\napproved_by             | UUID           | FK users(id), NULL\napproved_at             | TIMESTAMPTZ    | NULL\nstatus                  | ENUM('pending','applied','rejected','reverted') | NOT NULL DEFAULT 'applied'\nreverted_at             | TIMESTAMPTZ    | NULL\nreverted_by             | UUID           | FK users(id), NULL\nrevert_reason           | TEXT           | NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_overrides_case(tenant_id, case_id)\n  - idx_overrides_target(target_entity_type, target_entity_id)\n  - idx_overrides_type(tenant_id, case_id, override_type)\n  - idx_overrides_user(tenant_id, created_by)\n```\n\n### 3.15 ScoringModel\n\nConfigurable scoring algorithm definition. Versioned for audit trail.\n\n```\nTABLE: scoring_models\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\nname                    | VARCHAR(255)   | NOT NULL\nversion                 | INTEGER        | NOT NULL DEFAULT 1\ndescription             | TEXT           | NULL\ntotal_max_score         | DECIMAL(7,2)   | NOT NULL DEFAULT 100.00\npassing_score           | DECIMAL(7,2)   | NOT NULL\nconditional_floor       | DECIMAL(7,2)   | NULL\nscore_ranges_jsonb      | JSONB          | NOT NULL\nstatus                  | ENUM('draft','active','archived') | NOT NULL DEFAULT 'draft'\neffective_from          | TIMESTAMPTZ    | NULL\neffective_until         | TIMESTAMPTZ    | NULL\ncreated_by              | UUID           | FK users(id), NOT NULL\napproved_by             | UUID           | FK users(id), NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_scoring_models_tenant(tenant_id)\n  - idx_scoring_models_active(tenant_id, status) WHERE status = 'active'\n  - UNIQUE(tenant_id, name, version)\n\nscore_ranges_jsonb schema:\n{\n  \"approve\": { \"min\": 75, \"max\": 100, \"label\": \"Approve\" },\n  \"approve_with_conditions\": { \"min\": 60, \"max\": 74.99, \"label\": \"Approve with Conditions\" },\n  \"decline\": { \"min\": 0, \"max\": 59.99, \"label\": \"Decline\" }\n}\n```\n\n### 3.16 ScoringCategory\n\nCategories within a scoring model (e.g., Financial Strength, Management, Collateral).\n\n```\nTABLE: scoring_categories\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\nscoring_model_id        | UUID           | FK scoring_models(id), NOT NULL\nname                    | VARCHAR(255)   | NOT NULL\ndescription             | TEXT           | NULL\nweight_pct              | DECIMAL(5,2)   | NOT NULL\nmax_points              | DECIMAL(7,2)   | NOT NULL\nsort_order              | INTEGER        | NOT NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_scoring_cat_model(scoring_model_id)\n  - UNIQUE(scoring_model_id, name)\n\nCONSTRAINT: SUM(weight_pct) for all categories in a model = 100.00\n```\n\n### 3.17 ScoringFactor\n\nIndividual factors within a scoring category.\n\n```\nTABLE: scoring_factors\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\nscoring_category_id     | UUID           | FK scoring_categories(id), NOT NULL\nname                    | VARCHAR(255)   | NOT NULL\ndescription             | TEXT           | NULL\nmax_points              | DECIMAL(7,2)   | NOT NULL\ndata_source             | VARCHAR(100)   | NOT NULL\nevaluation_rule_jsonb   | JSONB          | NOT NULL\nsort_order              | INTEGER        | NOT NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_scoring_factor_cat(scoring_category_id)\n  - UNIQUE(scoring_category_id, name)\n\nevaluation_rule_jsonb schema:\n{\n  \"type\": \"range_lookup\",\n  \"source_field\": \"summary_metrics_jsonb.debt_service_coverage\",\n  \"ranges\": [\n    { \"min\": 1.50, \"max\": null, \"points\": 10.0, \"label\": \"Strong\" },\n    { \"min\": 1.25, \"max\": 1.49, \"points\": 7.5, \"label\": \"Adequate\" },\n    { \"min\": 1.00, \"max\": 1.24, \"points\": 5.0, \"label\": \"Marginal\" },\n    { \"min\": null, \"max\": 0.99, \"points\": 2.0, \"label\": \"Weak\" }\n  ]\n}\n```\n\n### 3.18 ScoringResult\n\nComputed scores per case. One row per case, with per-category and per-factor breakdowns.\n\n```\nTABLE: scoring_results\n---------------------------------------------------------------\nColumn                      | Type           | Constraints\n---------------------------------------------------------------\nid                          | UUID           | PK\ntenant_id                   | UUID           | FK tenants(id), NOT NULL\ncase_id                     | UUID           | FK cases(id), NOT NULL, UNIQUE\nscoring_model_id            | UUID           | FK scoring_models(id), NOT NULL\nscoring_model_version       | INTEGER        | NOT NULL\ntotal_score                 | DECIMAL(7,2)   | NOT NULL\nmax_possible_score          | DECIMAL(7,2)   | NOT NULL\nscore_pct                   | DECIMAL(5,2)   | NOT NULL\nrecommendation              | ENUM('approve','approve_with_conditions','decline','insufficient_data') | NOT NULL\ncategory_scores_jsonb       | JSONB          | NOT NULL\nfactor_scores_jsonb         | JSONB          | NOT NULL\ndata_completeness_pct       | DECIMAL(5,2)   | NOT NULL\ninsufficient_data_factors   | TEXT[]         | NOT NULL DEFAULT '{}'\nunderwriter_confirmed       | BOOLEAN        | NOT NULL DEFAULT false\nconfirmed_by                | UUID           | FK users(id), NULL\nconfirmed_at                | TIMESTAMPTZ    | NULL\nconfirmation_notes          | TEXT           | NULL\noverride_adjustments_jsonb  | JSONB          | NOT NULL DEFAULT '[]'\ncomputed_at                 | TIMESTAMPTZ    | NOT NULL\ncreated_at                  | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at                  | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - UNIQUE(case_id)\n  - idx_scoring_results_tenant(tenant_id)\n  - idx_scoring_results_confirmed(tenant_id, underwriter_confirmed)\n```\n\n### 3.19 CreditMemoPacket\n\nAssembled credit memo with 17 sections.\n\n```\nTABLE: credit_memo_packets\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\ncase_id                 | UUID           | FK cases(id), NOT NULL, UNIQUE\npacket_version          | INTEGER        | NOT NULL DEFAULT 1\nsections_jsonb          | JSONB          | NOT NULL\nassembly_status         | ENUM('pending','assembling','assembled','reviewed','finalized','exported') | NOT NULL DEFAULT 'pending'\nquality_check_jsonb     | JSONB          | NULL\nassembled_at            | TIMESTAMPTZ    | NULL\nreviewed_by             | UUID           | FK users(id), NULL\nreviewed_at             | TIMESTAMPTZ    | NULL\nfinalized_by            | UUID           | FK users(id), NULL\nfinalized_at            | TIMESTAMPTZ    | NULL\nexport_formats          | TEXT[]         | NOT NULL DEFAULT '{}'\npdf_storage_key         | VARCHAR(1000)  | NULL\nword_storage_key        | VARCHAR(1000)  | NULL\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\n17 sections:\n1. Executive Summary\n2. Borrower Overview\n3. Business Description & History\n4. Management & Ownership\n5. Use of Funds\n6. Loan Structure & Terms\n7. Financial Analysis -- Income Statement\n8. Financial Analysis -- Balance Sheet\n9. Financial Analysis -- Cash Flow Coverage\n10. Financial Analysis -- Ratio Analysis\n11. Personal Financial Analysis (Guarantors)\n12. Collateral Analysis\n13. Business Debt Schedule\n14. Risk Assessment & Policy Exceptions\n15. Follow-Up Questions & Responses\n16. Scoring Summary\n17. Recommendation & Conditions\n```\n\n### 3.20 ReviewDecision\n\nCredit Manager decisions on completed underwriting packages.\n\n```\nTABLE: review_decisions\n---------------------------------------------------------------\nColumn                  | Type           | Constraints\n---------------------------------------------------------------\nid                      | UUID           | PK\ntenant_id               | UUID           | FK tenants(id), NOT NULL\ncase_id                 | UUID           | FK cases(id), NOT NULL\nreviewer_id             | UUID           | FK users(id), NOT NULL\ndecision                | ENUM('approved','approved_with_conditions','returned','declined') | NOT NULL\nconditions_jsonb        | JSONB          | NOT NULL DEFAULT '[]'\nreturn_reasons_jsonb    | JSONB          | NOT NULL DEFAULT '[]'\ndecline_reasons_jsonb   | JSONB          | NOT NULL DEFAULT '[]'\napproved_amount         | DECIMAL(15,2)  | NULL\napproved_rate           | DECIMAL(5,4)   | NULL\napproved_term_months    | INTEGER        | NULL\ninternal_notes          | TEXT           | NULL\ndecision_narrative      | TEXT           | NULL\ndecided_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\ncreated_at              | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_review_decisions_case(tenant_id, case_id)\n  - idx_review_decisions_reviewer(tenant_id, reviewer_id)\n  - idx_review_decisions_decision(tenant_id, decision)\n```\n\n### 3.21-3.24 Supporting Tables\n\nAdditional tables include:\n\n- **AuditEntry** (`audit_entries`) -- Comprehensive, immutable audit trail. Append-only with monthly range partitioning on `created_at`. No UPDATE/DELETE permissions.\n- **Notification** (`notifications`) -- In-app and email notifications per user with read tracking and email delivery status.\n- **IntegrationConfig** (`integration_configs`) -- Per-tenant integration credentials and settings (Salesforce, LOS, email, document storage). Credentials stored in encrypted BYTEA column.\n- **WorkflowConfig** (`workflow_configs`) -- Configurable workflow phase definitions with SLA targets, entry/exit conditions, notification rules, and role-based access per phase.\n\n### 3.25 Entity-Relationship Summary\n\n```\ntenants 1:N users\ntenants 1:N loan_products\ntenants 1:N applications\ntenants 1:N cases\ntenants 1:N scoring_models\ntenants 1:N workflow_configs\ntenants 1:N integration_configs\n\nusers  1:N user_roles\nusers  1:N applications (as borrower)\nusers  1:N cases (as underwriter, reviewer)\n\napplications 1:1 cases\nloan_products 1:N applications\nloan_products N:1 scoring_models\nloan_products N:1 workflow_configs\n\ncases  1:N case_phases\ncases  1:N documents\ncases  1:N extraction_results (via documents)\ncases  1:N financial_spreads\ncases  1:N risk_items\ncases  1:N follow_up_questions\ncases  1:N borrower_responses\ncases  1:N overrides\ncases  1:1 scoring_results\ncases  1:1 credit_memo_packets\ncases  1:N review_decisions\ncases  1:N audit_entries\ncases  1:N notifications\n\ndocuments 1:N extraction_results\nfollow_up_questions 1:1 borrower_responses\nscoring_models 1:N scoring_categories\nscoring_categories 1:N scoring_factors\n```\n\n---\n\n## 4. API Contract Specification\n\n**Base URL:** `https://api.cremologix.com/v1`\n**Content-Type:** `application/json` (except file uploads: `multipart/form-data`)\n**Authentication:** Bearer JWT token in `Authorization` header\n**Tenant Context:** Derived from authenticated user's JWT\n\n### Common Response Envelope\n\n```json\n{\n  \"success\": true,\n  \"data\": { },\n  \"meta\": { \"request_id\": \"req_abc123\", \"timestamp\": \"2026-02-08T14:30:00Z\" }\n}\n```\n\nError responses include `error.code`, `error.message`, and `error.details` array with per-field validation errors.\n\n### Pagination\n\nList endpoints accept `page`, `per_page` (default 25, max 100), `sort_by`, `sort_order`. Response includes `pagination` object with `total_items` and `total_pages`.\n\n### Rate Limits\n\n| Role | Limit |\n|------|-------|\n| Borrower | 60 req/min |\n| Underwriter | 120 req/min |\n| Credit Manager | 120 req/min |\n| Admin | 200 req/min |\n| Unauthenticated | 20 req/min |\n\nRate limit headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`.\n\n### 4.1 Auth API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| POST | `/auth/register` | None | Register new borrower (direct channel) |\n| POST | `/auth/register/referral` | None | Register from Salesforce referral token |\n| POST | `/auth/register/external` | Bearer (employee) | Register borrower via external referral |\n| POST | `/auth/verify-email` | None | Verify email with token |\n| POST | `/auth/resend-verification` | None | Resend verification email |\n| POST | `/auth/login` | None | Authenticate and get tokens |\n| POST | `/auth/refresh` | Refresh token | Refresh access token |\n| POST | `/auth/forgot-password` | None | Request password reset |\n| POST | `/auth/reset-password` | None | Reset password with token |\n| POST | `/auth/logout` | Bearer | Invalidate current session |\n\n### 4.2 Borrower API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/borrower/profile` | Borrower | Get current borrower profile |\n| PUT | `/borrower/profile` | Borrower | Update borrower profile |\n| GET | `/borrower/applications` | Borrower | List borrower's applications |\n| POST | `/borrower/applications` | Borrower | Create new application (draft) |\n| GET | `/borrower/applications/:id` | Borrower | Get application details |\n| PUT | `/borrower/applications/:id` | Borrower | Update draft application |\n| POST | `/borrower/applications/:id/submit` | Borrower | Submit application |\n| GET | `/borrower/applications/:id/status` | Borrower | Get application status & timeline |\n| GET | `/borrower/applications/:id/documents` | Borrower | List application documents |\n| POST | `/borrower/applications/:id/documents` | Borrower | Upload document (multipart/form-data) |\n| DELETE | `/borrower/applications/:id/documents/:docId` | Borrower | Remove uploaded document |\n| GET | `/borrower/applications/:id/questions` | Borrower | Get pending follow-up questions |\n| POST | `/borrower/applications/:id/questions/:qId/respond` | Borrower | Submit response to question |\n| GET | `/borrower/notifications` | Borrower | List notifications |\n\n### 4.3 Case API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/cases` | UW, CM | List cases (filtered, paginated) |\n| GET | `/cases/unassigned` | UW | List unassigned cases |\n| POST | `/cases` | UW | Create case from application |\n| GET | `/cases/:id` | UW, CM | Get case details with current phase |\n| PUT | `/cases/:id` | UW | Update case metadata |\n| POST | `/cases/:id/assign` | UW, Admin | Assign underwriter/reviewer |\n| POST | `/cases/:id/advance-phase` | UW | Advance to next phase |\n| POST | `/cases/:id/return-phase` | UW, CM | Return to previous phase |\n| GET | `/cases/:id/timeline` | UW, CM | Get phase transition history |\n| GET | `/cases/:id/activity` | UW, CM | Get activity feed |\n| POST | `/cases/:id/withdraw` | UW, Admin | Withdraw/cancel case |\n| POST | `/cases/:id/archive` | UW, Admin | Archive closed case |\n\n### 4.4 Document API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/cases/:id/documents` | UW, CM | List case documents |\n| GET | `/cases/:id/documents/:docId` | UW, CM | Get document details & extraction |\n| POST | `/cases/:id/documents` | UW | Upload additional document |\n| PUT | `/cases/:id/documents/:docId` | UW | Update document metadata |\n| POST | `/cases/:id/documents/:docId/reprocess` | UW | Trigger re-OCR/extraction |\n| GET | `/cases/:id/documents/:docId/extraction` | UW, CM | Get extraction results |\n| PUT | `/cases/:id/documents/:docId/extraction` | UW | Override extraction fields |\n| POST | `/cases/:id/documents/:docId/validate` | UW | Mark extraction as validated |\n| GET | `/cases/:id/documents/:docId/download` | UW, CM | Generate signed download URL |\n| DELETE | `/cases/:id/documents/:docId` | UW | Soft-delete document |\n\n### 4.5 Financial Analysis API\n\n9 sub-analysis endpoints plus recompute and override:\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/cases/:id/financial/summary` | UW, CM | Summary of all 9 analyses |\n| GET | `/cases/:id/financial/cash-flow` | UW, CM | Business cash flow coverage |\n| GET | `/cases/:id/financial/personal-di` | UW, CM | Personal D/I per guarantor |\n| GET | `/cases/:id/financial/global-cash-flow` | UW, CM | Global cash flow coverage |\n| GET | `/cases/:id/financial/balance-sheet` | UW, CM | Balance sheet analysis |\n| GET | `/cases/:id/financial/income-statement` | UW, CM | Income statement analysis |\n| GET | `/cases/:id/financial/operating-cycle` | UW, CM | Operating cycle metrics |\n| GET | `/cases/:id/financial/ratios` | UW, CM | Ratio analysis |\n| GET | `/cases/:id/financial/collateral` | UW, CM | Collateral coverage |\n| GET | `/cases/:id/financial/debt-schedule` | UW, CM | Business debt schedule |\n| POST | `/cases/:id/financial/recompute` | UW | Recompute all analyses |\n| PUT | `/cases/:id/financial/:analysisType/override` | UW | Override a spread value |\n\n### 4.6 Risk API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/cases/:id/risks` | UW, CM | List all risk items |\n| POST | `/cases/:id/risks` | UW | Add manual risk item |\n| PUT | `/cases/:id/risks/:riskId` | UW | Update risk item |\n| PUT | `/cases/:id/risks/:riskId/status` | UW | Change risk status |\n| GET | `/cases/:id/risks/narrative` | UW, CM | Get AI-generated risk narrative |\n| POST | `/cases/:id/risks/narrative/regenerate` | UW | Regenerate risk narrative |\n| GET | `/cases/:id/risks/policy-exceptions` | UW, CM | List policy exceptions |\n| PUT | `/cases/:id/risks/:riskId/exception` | UW | Add exception justification |\n\n### 4.7 Follow-Up API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/cases/:id/follow-ups` | UW, CM | List all follow-up questions |\n| POST | `/cases/:id/follow-ups/generate` | UW | Trigger AI question generation |\n| POST | `/cases/:id/follow-ups` | UW | Add custom question |\n| PUT | `/cases/:id/follow-ups/:qId` | UW | Edit question before sending |\n| POST | `/cases/:id/follow-ups/:qId/approve` | UW | Approve question for sending |\n| POST | `/cases/:id/follow-ups/send-batch` | UW | Send approved questions to borrower |\n| GET | `/cases/:id/follow-ups/:qId/response` | UW, CM | Get response with narrative |\n| PUT | `/cases/:id/follow-ups/:qId/response/review` | UW | Review response (status + notes) |\n| PUT | `/cases/:id/follow-ups/:qId/response/narrative` | UW | Edit converted narrative |\n\n### 4.8 Scoring API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/cases/:id/scoring` | UW, CM | Get scoring results |\n| POST | `/cases/:id/scoring/compute` | UW | Trigger score computation |\n| GET | `/cases/:id/scoring/categories` | UW, CM | Get per-category breakdown |\n| GET | `/cases/:id/scoring/factors` | UW, CM | Get per-factor detail with evidence |\n| POST | `/cases/:id/scoring/confirm` | UW | Confirm scoring (mandatory) |\n| GET | `/cases/:id/overrides` | UW, CM | List all overrides on this case |\n| POST | `/cases/:id/overrides` | UW | Create an override |\n| PUT | `/cases/:id/overrides/:oId` | UW | Update override |\n| DELETE | `/cases/:id/overrides/:oId` | UW | Revert an override |\n\n### 4.9 Packet API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/cases/:id/packet` | UW, CM | Get credit memo packet |\n| POST | `/cases/:id/packet/assemble` | UW | Trigger packet assembly |\n| GET | `/cases/:id/packet/sections` | UW, CM | List all 17 sections |\n| GET | `/cases/:id/packet/sections/:key` | UW, CM | Get single section content |\n| PUT | `/cases/:id/packet/sections/:key` | UW | Edit section content |\n| POST | `/cases/:id/packet/finalize` | UW | Mark packet as finalized |\n| POST | `/cases/:id/packet/export` | UW, CM | Generate PDF or Word export |\n| GET | `/cases/:id/packet/export/:format` | UW, CM | Download exported file |\n| POST | `/cases/:id/packet/push-to-los` | UW | Push packet to LOS |\n| GET | `/cases/:id/packet/quality-check` | UW | Get quality check results |\n\n### 4.10 Review API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/review/queue` | CM | List cases pending review |\n| GET | `/review/cases/:id` | CM | Get full case for review (read-only) |\n| GET | `/review/cases/:id/summary` | CM | Executive summary for review |\n| GET | `/review/cases/:id/financials` | CM | All financial analyses (read-only) |\n| GET | `/review/cases/:id/risks` | CM | Risk assessment (read-only) |\n| GET | `/review/cases/:id/scoring` | CM | Scoring detail (read-only) |\n| GET | `/review/cases/:id/packet` | CM | Full credit memo (read-only) |\n| GET | `/review/cases/:id/documents` | CM | Document list (read-only) |\n| GET | `/review/cases/:id/audit-trail` | CM | Case audit trail |\n| POST | `/review/cases/:id/decision` | CM | Submit review decision |\n\n### 4.11 Admin API\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| **Loan Products** | | | |\n| GET | `/admin/products` | Admin | List loan products |\n| POST | `/admin/products` | Admin | Create loan product |\n| GET/PUT | `/admin/products/:id` | Admin | Get/update product |\n| PUT | `/admin/products/:id/status` | Admin | Activate/deactivate product |\n| **Scoring Config** | | | |\n| GET | `/admin/scoring-models` | Admin | List scoring models |\n| POST | `/admin/scoring-models` | Admin | Create scoring model |\n| GET/PUT | `/admin/scoring-models/:id` | Admin | Get/update model |\n| POST | `/admin/scoring-models/:id/publish` | Admin | Publish model version |\n| POST/PUT/DELETE | `/admin/scoring-models/:id/categories/*` | Admin | CRUD categories |\n| POST/PUT/DELETE | `/admin/scoring-models/:id/categories/:cId/factors/*` | Admin | CRUD factors |\n| **Workflow Config** | | | |\n| GET/POST | `/admin/workflows` | Admin | List/create workflows |\n| GET/PUT | `/admin/workflows/:id` | Admin | Get/update workflow |\n| POST | `/admin/workflows/:id/publish` | Admin | Publish workflow version |\n| **Users & Permissions** | | | |\n| GET/POST | `/admin/users` | Admin | List/create users |\n| GET/PUT | `/admin/users/:id` | Admin | Get/update user |\n| PUT | `/admin/users/:id/status` | Admin | Activate/deactivate user |\n| POST/DELETE | `/admin/users/:id/roles/:role` | Admin | Assign/revoke roles |\n| **Audit & Integrations** | | | |\n| GET | `/admin/audit-log` | Admin | Query audit entries (filtered) |\n| GET | `/admin/audit-log/export` | Admin | Export audit log (CSV) |\n| GET | `/admin/integrations` | Admin | List integration configs |\n| PUT | `/admin/integrations/:type` | Admin | Update integration config |\n| POST | `/admin/integrations/:type/test` | Admin | Test connection |\n| POST | `/admin/integrations/:type/sync` | Admin | Trigger manual sync |\n\n### 4.12 Financial Normalization API\n\nEndpoints for the Financial Normalization Engine (FNE). Full specification in `fne-specification.md`.\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| POST | `/cases/:id/normalization/run` | UW | Trigger normalization for all validated extractions |\n| GET | `/cases/:id/normalization/results` | UW, CM | Get normalized financials (all periods) |\n| GET | `/cases/:id/normalization/results/:period` | UW, CM | Get normalized financials for specific period |\n| GET | `/cases/:id/normalization/audit` | UW, CM | Get normalization audit trail (mapping decisions) |\n| PUT | `/cases/:id/normalization/override` | UW | Override a normalized value (with rationale) |\n| GET | `/cases/:id/normalization/confidence` | UW, CM | Get confidence scores per field |\n\n**Note:** The Financial Analysis Engine (Section 5.2) reads from `normalized_financials` (produced by FNE) rather than raw `extraction_results`. FNE must complete before financial analysis can run.\n\n### 4.13 Deal Health API\n\nEndpoints for the Deal Health Score engine. Full specification in `deal-health-specification.md`.\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/cases/:id/deal-health` | UW, CM | Get current Deal Health Score with factor breakdown |\n| POST | `/cases/:id/deal-health/compute` | UW | Trigger Deal Health Score (re)computation |\n| GET | `/cases/:id/deal-health/history` | UW, CM | Get score progression over time |\n| GET | `/cases/:id/deal-health/factors` | UW, CM | Get per-factor detail with evidence |\n| GET | `/admin/deal-health/config` | Admin | Get Deal Health Score configuration |\n| PUT | `/admin/deal-health/config` | Admin | Update weights and ranges (via AD-03) |\n\n### 4.14 Pre-Qualification API\n\nEndpoints for the pre-qualification pipeline (before case creation). See Section 8.1.1 for workflow.\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| POST | `/prequalification/:appId/credit-check` | System | Trigger credit bureau soft pull |\n| POST | `/prequalification/:appId/kyc/initiate` | None | Generate KYC verification session |\n| POST | `/prequalification/:appId/kyc/callback` | Webhook | KYC provider result callback |\n| POST | `/prequalification/:appId/background/initiate` | System | Trigger background check |\n| POST | `/prequalification/:appId/background/callback` | Webhook | Background check result callback |\n| GET | `/prequalification/:appId/status` | Borrower, UW | Get all gate statuses |\n| POST | `/prequalification/:appId/background/review` | Intake Agent | Approve/reject background results |\n\n### 4.15 Notification & Webhook APIs\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| GET | `/notifications` | Any auth | List user notifications |\n| GET | `/notifications/unread-count` | Any auth | Get unread count |\n| PUT | `/notifications/:id/read` | Any auth | Mark as read |\n| PUT | `/notifications/read-all` | Any auth | Mark all as read |\n| PUT | `/notifications/preferences` | Any auth | Update preferences |\n| POST | `/webhooks/salesforce` | Webhook secret | Receive Salesforce referral events |\n| POST | `/webhooks/email-status` | Webhook secret | Email delivery status callbacks |\n\n---\n\n## 5. AI/ML Pipeline Specification\n\nAll AI pipelines are implemented as Python microservices behind FastAPI, invoked by the Core API via internal HTTP calls and/or async job queues.\n\n### 5.1 Document Processing Pipeline\n\n```\n[Upload] -> [Virus Scan] -> [Queue] -> [OCR] -> [Classification] -> [Extraction] -> [Validation] -> [Ready]\n```\n\n**Step 1 -- Virus Scan:** ClamAV scan. Infected files quarantined.\n\n**Step 2 -- OCR:** Text-based PDFs use PyPDF2/pdfplumber. Scanned/image PDFs use Tesseract OCR or Azure Document Intelligence. Complex layouts (tax returns) use Textract AnalyzeDocument with FORMS and TABLES features. Confidence < 0.60 flags for manual review.\n\n**Step 3 -- Classification:** Fine-tuned DistilBERT classifier. Thresholds: >= 0.85 auto-accept, 0.60-0.84 flag for review, < 0.60 require manual classification.\n\n**Step 4 -- Extraction:** Document-type-specific LLM prompts (GPT-4 or Claude) with structured output via function calling. Tax returns extract ~40 line items per return type. Per-field confidence scoring based on OCR clarity, cross-field consistency, and cross-document validation. Thresholds: >= 0.90 auto-validated, 0.70-0.89 flagged, < 0.70 manual review needed.\n\n**Step 5 -- Validation:** Internal consistency checks, cross-document reconciliation, year-over-year reasonableness checks, missing field detection.\n\n### 5.2 Financial Analysis Engine\n\n> **Dependency:** The Financial Analysis Engine reads from `normalized_financials` (produced by the FNE — see `fne-specification.md`), NOT from raw `extraction_results`. The FNE must complete normalization before financial analysis can run. This ensures apples-to-apples comparison across entity types.\n\n```\n[Validated Extractions] -> [FNE Normalization] -> [Spread Computation] -> [Ratio Calculation] -> [Trend Analysis] -> [Benchmark Comparison] -> [Complete]\n```\n\nNine sub-analyses:\n\n1. **Business Cash Flow Coverage** -- Net income + addbacks - deductions = Cash Flow Available / Annual Debt Service = CFC Ratio (multi-year)\n2. **Personal Debt/Income** -- Gross personal income less personal debt obligations per guarantor\n3. **Global Cash Flow Coverage** -- Combined business + personal available cash flow / total debt service\n4. **Balance Sheet** -- Common-size analysis (% of total assets), year-over-year change\n5. **Income Statement** -- Common-size (% of revenue), gross/operating/net margins, YoY change\n6. **Operating Cycle** -- DSO, DIO, DPO, Cash Conversion Cycle\n7. **Ratio Analysis** -- 7 ratios (Current, Quick, D/E, DSCR, ROA, ROE, Working Capital) with benchmarks\n8. **Collateral Coverage** -- Collateral value x advance rate / loan amount. Advance rates: Real estate 80%, equipment 70%, inventory 50%, AR 80%\n9. **Business Debt Schedule** -- Consolidated debts with creditor, balance, payment, rate, maturity, collateral\n\n### 5.3 Risk Assessment Engine\n\n```\n[Financial Data] + [Policy Rules] -> [Risk Identification] -> [Severity Scoring] -> [Narrative Generation]\n```\n\nRule-based identification: DSCR below policy minimum, collateral below 100%, declining revenue > 10%, negative working capital, D/E above policy max, concentration risk, management tenure < 2 years, business age < 3 years, industry-specific risks.\n\nAI-augmented identification: LLM reviews all data for risks not caught by rules (unusual related-party transactions, contingent liabilities, litigation).\n\nSeverity scale: critical, high, elevated, moderate, low.\n\nNarrative generation: LLM synthesizes all risks into cohesive professional narrative with evidence references.\n\n### 5.4 Question Generation Engine\n\nIdentifies information gaps per credit memo section. Generates context-aware open-ended questions with specific data references. Assigns priority (required/important/optional). Maps each question to target memo section.\n\n### 5.5 Narrative Conversion Engine\n\nConverts first-person borrower responses to professional third-person credit memo narrative. Quality checks: no first-person pronouns, cross-reference factual claims with financial data, professional tone.\n\n**Example:**\n- **Input:** \"We had a big order from Home Depot that bumped up our COGS.\"\n- **Output:** \"Management attributes the year-over-year increase in cost of goods sold primarily to a large-volume order from a national retail client.\"\n\n### 5.6 Credit Memo Assembly Engine\n\nGenerates all 17 sections from their respective data sources:\n\n| # | Section | Primary Data Sources |\n|---|---------|---------------------|\n| 1 | Executive Summary | Application, scoring result, recommendation |\n| 2 | Borrower Overview | Application, user profile |\n| 3 | Business Description & History | Application, borrower Q&A responses |\n| 4 | Management & Ownership | Application (guarantors), Q&A |\n| 5 | Use of Funds | Application (use_of_funds) |\n| 6 | Loan Structure & Terms | Loan product, recommended terms |\n| 7 | Financial Analysis -- Income Statement | Income statement spread |\n| 8 | Financial Analysis -- Balance Sheet | Balance sheet spread |\n| 9 | Financial Analysis -- Cash Flow Coverage | CFC + Global CFC spreads |\n| 10 | Financial Analysis -- Ratio Analysis | Ratio analysis spread |\n| 11 | Personal Financial Analysis | Personal D/I spread, PFS data |\n| 12 | Collateral Analysis | Collateral coverage spread |\n| 13 | Business Debt Schedule | Debt schedule spread |\n| 14 | Risk Assessment & Policy Exceptions | Risk items, exception justifications |\n| 15 | Follow-Up Questions & Responses | Q&A pairs with converted narratives |\n| 16 | Scoring Summary | Scoring result, category/factor breakdown |\n| 17 | Recommendation & Conditions | AI recommendation, underwriter notes |\n\nPacket-level quality check: all 17 sections present, financial figures match spread data, no placeholder text, consistent names/amounts, all overrides reflected.\n\n### 5.7 Scoring Engine\n\n```\n[Scoring Model Config] -> [Factor Data Collection] -> [Factor Evaluation] -> [Score Computation] -> [Recommendation]\n```\n\nPer factor: resolve data source, apply evaluation rule (range lookup, boolean, or custom formula), compute points, check for overrides. Per category: sum factors, apply weight. Total = sum of weighted categories. Map to recommendation via score ranges. If data completeness < 70%, override to `insufficient_data`.\n\n---\n\n## 6. Integration Specifications\n\n### 6.1 Salesforce Integration\n\n**Authentication:** OAuth 2.0 Web Server Flow with stored refresh token.\n\n**Inbound:** Salesforce outbound message triggers `POST /webhooks/salesforce` with HMAC-SHA256 validation. Creates/matches borrower user, creates application with `intake_channel = 'salesforce_referral'`.\n\n**Outbound:** Status sync on key events (application submitted, case created, documents complete, analysis complete, approved, declined, exported). Uses `PATCH /sobjects/Opportunity/{id}` with 3-retry exponential backoff.\n\n**Field Mappings:** Configurable per tenant. Covers application ID, case number, status, amount, borrower contact info, approved amount.\n\n### 6.2 LOS Integration (Sidecar API)\n\nRESTful API push from CremoLogix to LOS on export. Payload includes borrower info, loan details, scoring summary, conditions, key metrics, and base64-encoded PDF/Word documents. 3-retry with backoff. Optional webhook from LOS for loan booked/funded events.\n\n### 6.3 Email Service\n\nSendGrid (primary) or Azure Communication Services (fallback). 15+ templates covering borrower lifecycle, underwriter notifications, reviewer alerts, and admin error notifications. All templates use `{{variable}}` merge fields. Delivery tracking via SendGrid webhook events.\n\n### 6.4 Credit Bureau Integration\n\n**Purpose:** Soft pull for pre-qualification Gate 1 (B-01 Easy Apply flow).\n\n**Provider:** Configurable per tenant. Default: Experian (soft pull). Alternative: TransUnion, Equifax.\n\n**Authentication:** OAuth 2.0 client credentials or API key (provider-dependent). Credentials stored in `integration_configs` table (encrypted).\n\n**Flow:**\n1. Borrower submits Easy Apply (B-01) with SSN and consent checkbox\n2. System calls credit bureau API for soft pull (no hard inquiry)\n3. Response includes: credit score, trade lines summary, derogatory marks, public records\n4. Score compared to tenant-configurable threshold (default 580, set in AD-04)\n5. Pass: proceed to KYC gate. Fail: B-03 holding message + ECOA-compliant adverse action notice\n\n**Data Captured:**\n```json\n{\n  \"provider\": \"experian\",\n  \"pull_type\": \"soft\",\n  \"score\": 720,\n  \"score_model\": \"FICO 8\",\n  \"trade_lines_count\": 12,\n  \"derogatory_count\": 0,\n  \"public_records_count\": 0,\n  \"total_revolving_balance\": 4500,\n  \"total_installment_balance\": 125000,\n  \"oldest_trade_line_months\": 96,\n  \"inquiries_last_12_months\": 2,\n  \"pull_date\": \"2026-02-09T10:30:00Z\",\n  \"report_reference_id\": \"EXP-12345\"\n}\n```\n\n**Manual Entry Fallback:** If API is unavailable or borrower provides a recent credit report, underwriter can manually enter credit score and key metrics via the case detail screen. Manual entries are flagged with `extraction_method = 'manual'` in the audit trail.\n\n**Retry:** 3 attempts with exponential backoff (1s, 5s, 15s). On persistent failure, application is held for manual processing.\n\n**Compliance:** Soft pull only (no FCRA permissible purpose inquiry at this stage). Hard pull may be added post-MVP for final underwriting. Adverse action notices generated per ECOA/FCRA requirements.\n\n### 6.5 KYC Identity Verification\n\n**Purpose:** Identity verification for pre-qualification Gate 2 (B-04 screen).\n\n**Provider:** Configurable per tenant. Options: Persona, Jumio, Onfido, Socure.\n\n**Authentication:** API key with webhook secret for callbacks.\n\n**Flow:**\n1. After credit check passes, borrower receives SMS/email link to B-04\n2. System creates verification session via provider API\n3. Borrower completes: photo ID (front + back) + selfie with liveness detection\n4. Provider processes and sends result via webhook callback\n5. Pass (confidence >= 0.85): proceed to background check. Fail: B-03 holding + manual review queue\n\n**Data Captured:**\n```json\n{\n  \"provider\": \"persona\",\n  \"verification_id\": \"inq_abc123\",\n  \"status\": \"passed\",\n  \"confidence\": 0.95,\n  \"document_type\": \"drivers_license\",\n  \"document_country\": \"US\",\n  \"document_state\": \"TX\",\n  \"name_match\": true,\n  \"dob_match\": true,\n  \"address_match\": true,\n  \"liveness_check\": \"passed\",\n  \"fraud_signals\": [],\n  \"verified_at\": \"2026-02-09T11:00:00Z\"\n}\n```\n\n**Retry:** Borrower may retry up to 3 times. After 3 failures, flagged for manual review by Intake Agent.\n\n**Expiry:** KYC verification expires after 90 days (configurable). Re-verification required if expired before case creation.\n\n### 6.6 Background Check Integration\n\n**Purpose:** Criminal, civil, bankruptcy, and regulatory screening for pre-qualification Gate 3.\n\n**Provider:** Configurable per tenant. Options: Checkr, Sterling, GoodHire.\n\n**Authentication:** API key with webhook for async results.\n\n**Flow:**\n1. After KYC passes, system triggers background check via provider API\n2. Provider runs checks asynchronously (typical turnaround: 1-3 business days)\n3. Results delivered via webhook to `/prequalification/:appId/background/callback`\n4. Results displayed on IA-02 (Intake Agent review screen) with AI business intelligence\n5. Intake Agent reviews and decides: Approve to Proceed / Reject (with mandatory reason)\n\n**Checks Performed:**\n- Criminal records (federal + state)\n- Civil litigation history\n- Bankruptcy filings\n- Regulatory sanctions (OFAC, SAM, state debarment)\n- Business entity verification\n\n**Data Captured:**\n```json\n{\n  \"provider\": \"checkr\",\n  \"report_id\": \"rpt_xyz789\",\n  \"status\": \"complete\",\n  \"criminal_records\": [],\n  \"civil_records\": [],\n  \"bankruptcy_records\": [],\n  \"regulatory_flags\": [],\n  \"business_verification\": {\n    \"entity_confirmed\": true,\n    \"registration_state\": \"TX\",\n    \"registration_status\": \"active\",\n    \"registered_agent\": \"Jane Doe\"\n  },\n  \"overall_assessment\": \"clear\",\n  \"completed_at\": \"2026-02-10T14:00:00Z\"\n}\n```\n\n**Manual Override:** Intake Agent can approve despite flagged findings with mandatory rationale (logged in audit trail). Requires Intake Agent role permission.\n\n### 6.7 Document Storage\n\nAzure Blob Storage (production), Azurite (development). Container structure: `{tenant_id}/{case_id}/uploads|ocr|exports/`. Upload via SAS URLs (5 min expiry, 50MB max). Server-side AES-256 encryption. Virus scanning via Azure Function + ClamAV. Retention: 7 years post-closeout for active, 3 years for declined.\n\n---\n\n## 7. Security Architecture\n\n### 7.1 Authentication\n\n- **Access Token:** RS256-signed JWT, 15-minute expiry with `sub`, `tenant_id`, `roles`, `email`, `jti`\n- **Refresh Token:** Opaque token in Redis, 7-day expiry\n- **Max 5 concurrent sessions per user**\n- **Failed login lockout:** 5 attempts -> 15-minute lock\n\n### 7.2 Authorization (RBAC)\n\n**Screen Access:**\n\n| Screen Group | Borrower | Underwriter | Credit Manager | Admin |\n|-------------|----------|-------------|----------------|-------|\n| Borrower screens (B-*) | Yes | -- | -- | -- |\n| Underwriter screens (U-*) | -- | Yes | Read-only (select) | Yes |\n| Review screens (C-*) | -- | -- | Yes | Yes |\n| Admin screens (D-*) | -- | -- | -- | Yes |\n\n**Key Action Permissions:** Borrowers create applications and submit responses. Underwriters manage cases, override AI data, confirm scoring, finalize packets. Credit Managers submit review decisions. Admins configure products, scoring models, users, and integrations.\n\n**Enforcement:** API middleware checks JWT roles. Case-level authorization restricts underwriters to assigned cases. Row-Level Security as defense-in-depth.\n\n### 7.3 Multi-Tenant Data Isolation\n\nPostgreSQL RLS with `tenant_id = current_setting('app.current_tenant_id')`. NestJS middleware sets session variable from JWT. Application code includes `WHERE tenant_id = ?` as defense-in-depth.\n\n### 7.4 Encryption\n\n- **At rest:** Azure Blob SSE (AES-256), PostgreSQL Flexible Server encryption, integration secrets encrypted with AES-256-GCM via Azure Key Vault\n- **In transit:** TLS 1.3 (minimum 1.2) for all communication\n\n### 7.5 PII Handling\n\nSSN encrypted at application level, masked in UI (last 4 only), never logged. Email masked in audit logs. Right to deletion with PII anonymization while retaining financial data for regulatory compliance.\n\n### 7.6 API Security\n\nRate limiting, JSON Schema validation, parameterized queries (no raw SQL), Content-Security-Policy headers, CORS whitelist, 10MB JSON / 50MB file upload limits, MIME type validation, automated dependency scanning in CI.\n\n### 7.7 Compliance\n\n**ECOA:** No protected-class data in scoring. All scoring factors have documented business justification. **Fair Lending:** Complete audit trail of every scoring factor evaluation. Override rationale mandatory. **CDFI Fund:** Case data structured for annual reporting requirements.\n\n---\n\n## 8. Workflow Engine Design\n\n### 8.1 Phase State Machine\n\n13-phase linear workflow with controlled return paths:\n\n```\nconfiguration -> intake -> document_collection -> data_extraction -> financial_analysis\n-> risk_assessment -> follow_up_questions -> response_collection -> override_management\n-> scoring -> packet_assembly -> credit_review -> export_closeout\n\ncredit_review -> override_management (return -- revision cycle)\ncredit_review -> follow_up_questions (return -- additional info)\nAny phase -> withdrawn (case withdrawal)\nexport_closeout -> archived\n```\n\n### 8.1.1 Pre-Qualification Pipeline (Before Phase 1)\n\nThe pre-qualification pipeline runs BEFORE case creation. It operates on the `applications` table (not `cases`) and governs the B-01 through B-06 borrower flow.\n\n```\n[B-01 Easy Apply]\n      |\n      v\n+---------------------+\n| GATE 1: Credit Check |  (credit bureau soft pull — automated)\n| Soft pull via API    |\n| Pass: score >= threshold (configurable via AD-04, default 580)\n| Fail: -> B-03 Holding Message + compliant denial email\n+---------------------+\n      |  PASS\n      v\n+---------------------+\n| GATE 2: KYC          |  (identity verification — borrower action)\n| B-04: Photo ID + selfie with liveness\n| Provider: configurable (e.g., Persona, Jumio, Onfido)\n| Pass: identity confirmed with acceptable confidence\n| Fail: -> B-03 Holding Message (manual review option)\n+---------------------+\n      |  PASS\n      v\n+---------------------+\n| GATE 3: Background   |  (background check — automated)\n| Provider: configurable (e.g., Checkr, Sterling)\n| Checks: criminal, civil, bankruptcy, regulatory\n| Result: -> IA-02 for Intake Agent review\n| Intake Agent decides: Approve to Proceed / Reject\n+---------------------+\n      |  APPROVED\n      v\n+---------------------+\n| GATE 4: Deal Health   |  (initial score — automated)\n| Compute initial Deal Health Score from available data\n| (credit score, KYC pass/fail, background pass/fail)\n| Score < auto-exit threshold (configurable, default 20) -> flag for review\n| Score >= threshold -> proceed\n+---------------------+\n      |  PASS\n      v\n[Case Created -> Phase 1: Configuration]\n```\n\n**Pre-qualification data model:**\n\n```\nTABLE: prequalification_checks\n---------------------------------------------------------------\nColumn                | Type           | Constraints\n---------------------------------------------------------------\nid                    | UUID           | PK\ntenant_id             | UUID           | FK tenants(id), NOT NULL\napplication_id        | UUID           | FK applications(id), NOT NULL\ncheck_type            | ENUM('credit_bureau','kyc','background') | NOT NULL\nprovider              | VARCHAR(100)   | NOT NULL\nprovider_reference_id | VARCHAR(255)   | NULL\nstatus                | ENUM('pending','in_progress','passed','failed','manual_review','expired') | NOT NULL DEFAULT 'pending'\nresult_data_jsonb     | JSONB          | NOT NULL DEFAULT '{}'\nconfidence_score      | DECIMAL(5,4)   | NULL\nfailure_reason        | TEXT           | NULL\nreviewed_by           | UUID           | FK users(id), NULL\nreviewed_at           | TIMESTAMPTZ    | NULL\nexpires_at            | TIMESTAMPTZ    | NULL\ncreated_at            | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at            | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - idx_preq_application(tenant_id, application_id)\n  - idx_preq_type_status(tenant_id, check_type, status)\n```\n\n**Pre-qualification API endpoints:**\n\n| Method | Path | Auth | Description |\n|--------|------|------|-------------|\n| POST | `/prequalification/:appId/credit-check` | System | Trigger credit bureau soft pull |\n| POST | `/prequalification/:appId/kyc/initiate` | None | Generate KYC verification session |\n| POST | `/prequalification/:appId/kyc/callback` | Webhook | KYC provider result callback |\n| POST | `/prequalification/:appId/background/initiate` | System | Trigger background check |\n| POST | `/prequalification/:appId/background/callback` | Webhook | Background check result callback |\n| GET | `/prequalification/:appId/status` | Borrower, UW | Get all gate statuses |\n| POST | `/prequalification/:appId/background/review` | Intake Agent | Approve/reject background results |\n\n### 8.2 Entry and Exit Conditions\n\n| Phase | Entry Conditions | Exit Conditions |\n|-------|-----------------|-----------------|\n| configuration | Tenant setup complete | Active loan product and scoring model |\n| intake | Application exists | Application submitted, minimum docs uploaded |\n| document_collection | Case created | All required document types present |\n| data_extraction | Documents ready | All documents have extraction results |\n| financial_analysis | Extractions validated | All 9 sub-analyses computed |\n| risk_assessment | Analysis complete | Risk items generated, narrative present |\n| follow_up_questions | Risks identified | Questions reviewed (approved/sent/withdrawn) |\n| response_collection | Questions sent | All required questions answered |\n| override_management | Responses collected | No pending overrides |\n| scoring | Overrides resolved | Score computed, underwriter confirmed |\n| packet_assembly | Scoring confirmed | All 17 sections generated, quality check passed |\n| credit_review | Packet finalized | Review decision submitted |\n| export_closeout | Decision recorded | Export generated, case archived or LOS push confirmed |\n\n### 8.3 SLA Timer Management\n\nDefault SLA targets (configurable per phase):\n\n| Phase | Default SLA (hours) |\n|-------|-------------------|\n| intake | 24 |\n| document_collection | 72 |\n| data_extraction | 4 (automated) |\n| financial_analysis | 4 (automated) |\n| risk_assessment | 4 (automated) |\n| follow_up_questions | 8 |\n| response_collection | 120 (borrower dependent) |\n| override_management | 8 |\n| scoring | 4 |\n| packet_assembly | 4 (automated) |\n| credit_review | 48 |\n| export_closeout | 8 |\n\nWarning at 80% of SLA duration. Breach triggers notification to underwriter AND admin.\n\n### 8.4 Auto-Advance Rules\n\nAutomated transitions (no human review required):\n- document_collection -> data_extraction (all docs uploaded + OCR complete)\n- data_extraction -> financial_analysis (all extractions validated)\n- financial_analysis -> risk_assessment (all analyses computed)\n\nHuman-required phases (no auto-advance): follow_up_questions, override_management, scoring, packet_assembly, credit_review.\n\n---\n\n## 9. Audit Trail Architecture\n\n### What Gets Logged\n\nSix categories: (1) Data changes (INSERT/UPDATE/DELETE with old/new values), (2) User actions (login/logout, screen navigation, downloads, exports, decisions), (3) Phase transitions with timestamps and SLA events, (4) AI pipeline events (OCR, classification, extraction, analysis, scoring, memo generation -- all with confidence scores), (5) Override events (created/approved/rejected/reverted with rationale), (6) Integration events (Salesforce webhooks, LOS pushes, email delivery).\n\n### Immutability Guarantees\n\n- Append-only table: no UPDATE or DELETE permissions for application role\n- Monthly range partitioning on `created_at`\n- Application role has INSERT-only access; table owner is separate admin role\n- Optional hash chain post-MVP for tamper detection\n\n### Retention\n\nActive retention: 2 years in primary database. Archive: years 2-7 in S3 as Parquet. Deletion: after 7 years (configurable per tenant).\n\n---\n\n## 10. Non-Functional Requirements\n\n### 10.1 Performance\n\n| Metric | Target |\n|--------|--------|\n| Page load (SPA initial) | < 2.0s |\n| Page navigation (SPA route) | < 500ms |\n| API response (simple reads) | < 200ms p95 |\n| API response (complex queries) | < 500ms p95 |\n| Document upload (50MB) | < 10s |\n| OCR processing (single doc) | < 60s |\n| AI extraction (single doc) | < 30s |\n| Financial analysis (full case) | < 45s |\n| Score computation | < 5s |\n| Credit memo assembly (17 sections) | < 120s |\n| PDF export generation | < 30s |\n\n### 10.2 Scalability\n\n| Dimension | MVP Target | Year 2 Target |\n|-----------|-----------|--------------|\n| Concurrent users | 50 | 500 |\n| Active cases | 200 | 5,000 |\n| API requests/second | 50 | 500 |\n| Document storage | 50 GB | 5 TB |\n\n### 10.3 Availability\n\n| Metric | Target |\n|--------|--------|\n| Uptime | 99.9% |\n| RTO | 1 hour |\n| RPO | 5 minutes |\n| Maintenance window | Sundays 02:00-06:00 ET |\n\n### 10.4 Monitoring\n\nInfrastructure (Azure Monitor): CPU, memory, disk, PostgreSQL metrics, Redis metrics, Container Apps health. Application (Application Insights): API response times per endpoint, error rates, queue depth, AI pipeline times. Business: cases/day, cycle time, SLA breach rate, extraction confidence distribution.\n\n---\n\n## 11. MVP Scope Boundaries\n\n### Human Decision Mandate\n\n> **All credit decisions require explicit Credit Manager action. The system generates recommendations and scores but never approves, denies, or commits to terms without human authorization.**\n\nThis is a non-negotiable architectural constraint. No automated decisioning logic may be implemented without explicit regulatory review and client authorization. Every workflow path that results in a loan approval, denial, or term commitment must pass through a human gate.\n\n### In MVP\n\n| Feature | Detail |\n|---------|--------|\n| Single tenant | Siura Capital pilot |\n| 4 core user roles | Borrower, Underwriter, Credit Manager, Admin |\n| 60 MVP + 1 MVP-LITE screens | See Section 14 for build scope tags (84 total in prototype) |\n| 13-phase workflow | Complete with all transitions |\n| 3 intake channels | Direct, Salesforce referral, external referral |\n| Document processing | OCR, classification, extraction with confidence |\n| 9 financial analyses | Full spread computation suite |\n| Risk assessment | Rule-based + AI-augmented |\n| Follow-up Q&A | AI generation, narrative conversion |\n| Configurable scoring | Weighted multi-factor with categories |\n| Credit memo (17 sections) | AI-assembled with manual editing |\n| PDF/Word export | Credit memo package |\n| Salesforce integration | Inbound referrals + outbound status |\n| Basic LOS export | API push of underwriting package |\n| Credit bureau integration | Soft pull for pre-qualification gate + manual entry fallback |\n| Full notification suite | 15+ email templates + in-app |\n| Comprehensive audit trail | Immutable, append-only |\n| RBAC | Role-based with screen and action permissions |\n| Multi-tenant data layer | tenant_id isolation (ready for multi-tenant) |\n| CDFI reporting (AD-11) | TLR, Impact Metrics, Section 1071 — tenant-configurable (all enabled for Siura Capital) |\n\n### Section 1071 Data Collection Fields\n\nPer CFPB Section 1071 (Small Business Lending Data Collection), the following data points must be captured during the application process and stored for reporting via AD-11:\n\n**Application-Level (auto-populated from application data):**\n\n| Field | Source | Type |\n|-------|--------|------|\n| Unique loan/application ID | `applications.id` | Auto |\n| Application date | `applications.submitted_at` | Auto |\n| Loan/credit type | `loan_products.loan_type` | Auto |\n| Loan/credit purpose | `applications.loan_purpose` | Auto |\n| Amount applied for | `applications.requested_amount` | Auto |\n| Amount approved | `review_decisions.approved_amount` | Auto |\n| Action taken | `cases.status` (mapped) | Auto |\n| Action taken date | `review_decisions.decided_at` | Auto |\n| Denial reasons (up to 4) | `review_decisions.decline_reasons_jsonb` | Auto |\n| Pricing (interest rate) | `review_decisions.approved_rate` | Auto |\n| Census tract (borrower address) | Derived from `applications.business_address_jsonb` | Computed |\n| NAICS code | `applications.naics_code` | Auto |\n| Gross annual revenue | `applications.annual_revenue` | Auto |\n| Number of employees | `applications.employee_count` | Auto |\n| Time in business | `applications.years_in_business` | Auto |\n\n**Demographic (collected via optional borrower self-report — separate from credit decision):**\n\n```\nTABLE: section_1071_demographics\n---------------------------------------------------------------\nColumn                    | Type           | Constraints\n---------------------------------------------------------------\nid                        | UUID           | PK\ntenant_id                 | UUID           | FK tenants(id), NOT NULL\napplication_id            | UUID           | FK applications(id), NOT NULL, UNIQUE\nminority_owned_status     | ENUM('yes','no','not_provided') | NOT NULL DEFAULT 'not_provided'\nminority_ethnicity        | TEXT[]         | NOT NULL DEFAULT '{}'\nwomen_owned_status        | ENUM('yes','no','not_provided') | NOT NULL DEFAULT 'not_provided'\nlgbtqi_owned_status       | ENUM('yes','no','not_provided') | NOT NULL DEFAULT 'not_provided'\nveteran_owned_status      | ENUM('yes','no','not_provided') | NOT NULL DEFAULT 'not_provided'\nprincipal_owner_count     | INTEGER        | NULL\nprincipal_owners_jsonb    | JSONB          | NOT NULL DEFAULT '[]'\ncollection_method         | ENUM('web_form','verbal','paper','not_collected') | NOT NULL\ncollected_at              | TIMESTAMPTZ    | NULL\ncreated_at                | TIMESTAMPTZ    | NOT NULL DEFAULT now()\nupdated_at                | TIMESTAMPTZ    | NOT NULL DEFAULT now()\n---------------------------------------------------------------\nINDEXES:\n  - UNIQUE(application_id)\n  - idx_1071_tenant(tenant_id)\n\nprincipal_owners_jsonb schema (per owner):\n{\n  \"ethnicity\": [\"hispanic_or_latino\"] | [\"not_hispanic_or_latino\"] | [\"not_provided\"],\n  \"race\": [\"american_indian\",\"asian\",\"black\",\"hawaiian_pacific\",\"white\",\"not_provided\"],\n  \"sex\": \"male\" | \"female\" | \"not_provided\"\n}\n```\n\n**Collection Rules:**\n- Demographic data MUST be collected on a separate screen from the loan application (firewall)\n- Borrower may select \"I do not wish to provide this information\" for any field\n- Demographic data is NEVER used in credit decisions, scoring, or underwriting\n- Demographic data is NEVER visible on underwriter or credit manager screens\n- Data is stored in a separate table with restricted access (Admin + reporting only)\n- Fair Lending Analytics (AD-12) uses this data for disparate impact monitoring\n\n### NOT in MVP (Deferred)\n\n| Feature | Target Release |\n|---------|----------------|\n| Vendor Marketplace (B-14) | Phase 2 — in prototype for demos |\n| Denied Applicant Nurture (D-01–D-05) | Phase 2 — pending legal opinion on FCRA re-qualification |\n| External Funding Portal (EF-01–EF-04) | Phase 2 — PDF packet approach for MVP |\n| FinOps Resource Portal (FO-01–FO-08) | Phase 2 — Borrower Success Ecosystem |\n| Cross-tenant intelligence | v2.0 |\n| Mobile application | v2.0 |\n| Advanced analytics/reporting | v1.5 |\n| SSO / SAML | v1.5 |\n| Real-time collaboration | v2.0 |\n| Chat-based borrower responses | v1.5 |\n| Phone transcription | v2.0 |\n| Batch document upload (ZIP) | v1.5 |\n| Custom report builder | v2.0 |\n| Multi-language support | v2.0 |\n| Automated decisioning | Regulatory review required — see Human Decision Mandate |\n| Third-party data enrichment | v2.0 |\n\n---\n\n## 12. Dependency Matrix\n\n### External Services\n\n| Service | Purpose | Criticality | Fallback |\n|---------|---------|-------------|----------|\n| Azure PostgreSQL Flexible Server | Primary database | Critical | Zone-redundant HA |\n| Azure Blob Storage | Document/export storage | Critical | GRS replication |\n| Azure Cache for Redis 7 | Cache, queues, sessions | High | Zone-redundant |\n| Azure Container Apps | Container orchestration | Critical | Multi-zone replicas |\n| Azure Key Vault | Encryption keys + secrets | Critical | Managed service SLA |\n| Azure Document Intelligence | OCR for complex documents | High | Tesseract (self-hosted) |\n| OpenAI/Anthropic API | LLM for extraction, analysis, generation | Critical | Secondary provider |\n| Salesforce API | TOS integration | Medium | Manual referral entry |\n| SendGrid / Azure Comm Services | Email delivery | High | Azure Comm Services as fallback |\n| ClamAV | Virus scanning | High | Self-hosted container |\n\n### Estimated Monthly Infrastructure Cost (MVP)\n\n| Resource | Cost |\n|----------|------|\n| Azure infrastructure (Container Apps, PostgreSQL, Redis, Blob, Front Door, etc.) | ~$615/month |\n| LLM API (OpenAI/Anthropic, ~2000 docs/month) | ~$500/month |\n| SendGrid (5000 emails/month) | $90/month |\n| GitHub Team | $44/month |\n| **Total** | **~$1,485/month** |\n\n### Screen-to-API Mapping (Appendix)\n\n| Screen ID | Screen Name | Primary API Endpoints |\n|-----------|-------------|----------------------|\n| B-1 | Landing Page | (Static) |\n| B-2/3/4 | Register variants | `POST /auth/register*` |\n| B-5 | Verify Email | `POST /auth/verify-email` |\n| B-6 | Login | `POST /auth/login` |\n| B-7 | Borrower Dashboard | `GET /borrower/applications`, `GET /notifications` |\n| B-8 | Application Intake | `POST /borrower/applications`, documents |\n| B-9 | Application Status | `GET .../applications/:id/status` |\n| B-10 | Clarification Q&A | `GET/POST .../questions` |\n| U-1 | Underwriter Dashboard | `GET /cases`, `GET /notifications` |\n| U-2 | Unassigned Queue | `GET /cases/unassigned` |\n| U-3 | Case Creation | `POST /cases` |\n| U-4 | Case Overview | `GET /cases/:id`, timeline |\n| U-5 | Documents | `GET /cases/:id/documents` |\n| U-6a-i | Financial Analysis (9 tabs) | `GET /cases/:id/financial/*` |\n| U-7 | Risk & Exceptions | `GET /cases/:id/risks` |\n| U-8/9 | Follow-Up / Response Review | `GET/POST /cases/:id/follow-ups` |\n| U-10 | Override Mgmt | `GET/POST /cases/:id/overrides` |\n| U-11 | Scoring Review | `GET/POST /cases/:id/scoring` |\n| U-12 | Packet Preview | `GET /cases/:id/packet` |\n| U-14 | Closeout | `POST .../export`, `POST .../push-to-los` |\n| C-1 | Review Dashboard | `GET /review/queue` |\n| C-2a-g | Case Review (7 tabs) | `GET /review/cases/:id/*` |\n| D-1 through D-7 | Admin screens | `/admin/*` endpoints |\n\n---\n\n## 13. Prototype Design System\n\n> Source: `C:/projects/CremoLogix_Prototype_Spec_v2.md`\n\n### Brand\n\n- **Product Name:** CremoLogix\n- **Tagline:** \"Intelligent Lending. Lasting Impact.\"\n- **Primary Color:** #1B4D7A (deep blue)\n- **Secondary Color:** #2E8B57 (sea green -- success/growth)\n- **Accent Color:** #E8943A (warm amber -- alerts/CTAs)\n- **Error/Danger:** #DC3545\n- **Warning:** #FFC107\n- **Background:** #F5F7FA (light gray)\n- **Card Background:** #FFFFFF\n- **Text Primary:** #1A1A2E\n- **Text Secondary:** #6C757D\n- **Font:** Inter (headings), system sans-serif fallback\n\n### Layout Patterns\n\n- **Public Pages** (landing, KYC): Full-width, centered content, no sidebar\n- **Portal Pages** (all authenticated): Left sidebar navigation (240px) + main content area\n- **Mobile Screens** (KYC): Responsive, single-column, large touch targets\n\n### Common Components\n\n- **Sidebar:** Logo, user name/role, navigation links, logout. Color-coded by role (blue=borrower, green=staff, orange=broker, purple=finops)\n- **Top Bar:** Page title, breadcrumbs, notification bell, user avatar\n- **Cards:** White background, subtle shadow, 8px border-radius, 24px padding\n- **Status Badges:** Green=Active/Complete, Yellow=Pending/Warning, Red=Denied/Overdue, Blue=In Progress, Gray=Not Started\n- **Tables:** Striped rows, sortable columns, pagination\n- **Modals:** Centered overlay, dark backdrop, max-width 600px\n- **Deal Health Indicator:** Circular gauge (0-100) with color gradient (red -> yellow -> green)\n- **Three-Layer Commentary:** Tabbed panel with Borrower Footnotes | System Observations | Staff Notes\n\n---\n\n## 14. Prototype Screen Inventory\n\n### Build Scope vs. Demo Scope\n\nThe prototype contains **84 total screens** representing the full product vision. Not all screens are built in MVP. Each screen is tagged with a build scope:\n\n- **MVP** — Built and functional in the first release\n- **POST-MVP** — Designed in prototype for client demos and vision alignment; built in a later phase\n- **MVP-LITE** — Included in MVP with reduced scope (e.g., curated content instead of full CMS)\n\nThe prototype is a **sales and alignment tool** — it tells the full story. The build plan only includes MVP and MVP-LITE screens.\n\n### Screen Count Summary\n\n| User Type | Total Screens | MVP | MVP-LITE | POST-MVP | Prefix |\n|---|---|---|---|---|---|\n| Borrower (Direct + Broker-Referred) | 17 | 14 | 1 | 2 | B- |\n| Denied Applicant (Borrower State) | 5 | 0 | 0 | 5 | D- |\n| Broker | 7 | 7 | 0 | 0 | BK- |\n| Intake Agent | 4 | 4 | 0 | 0 | IA- |\n| Underwriter | 10 | 10 | 0 | 0 | UW- |\n| Credit Manager | 6 | 6 | 0 | 0 | CM- |\n| External Funding Stakeholder | 4 | 0 | 0 | 4 | EF- |\n| FinOps Resource | 8 | 0 | 0 | 8 | FO- |\n| Administrator | 14 | 14 | 0 | 0 | AD- |\n| SPA Demo Shells | 9 | 5 | 0 | 4 | demo- |\n| **TOTAL** | **84** | **60** | **1** | **23** | |\n\n### Per-Screen Build Scope Tags\n\n---\n\n### Section 1: Borrower Screens (B-01 through B-17)\n\n**B-01: Landing Page & Easy Apply**\n- **Purpose:** Public-facing entry point. Hero section + Easy Apply form.\n- **Key Components:** Full-width hero with headline, Easy Apply form (name, DOB, SSN, addresses, loan amount, use of funds, consent checkbox), 3-step \"How It Works\" strip, footer.\n- **Navigation:** Submit -> B-02 (success) or B-03 (holding message if denied)\n\n**B-02: Application Confirmation / Processing**\n- **Purpose:** Shown immediately after form submission during credit check.\n- **Key Components:** Processing spinner (3-5 seconds), then success state with green checkmark and \"check your phone\" message for KYC link.\n- **Navigation:** Credit PASS -> This screen; Credit FAIL -> B-03\n\n**B-03: Generic Holding Message**\n- **Purpose:** Neutral message for denied applicants. Denial notification comes separately via compliant email.\n- **Key Components:** Neutral icon (NOT a warning), \"Thank You\" headline, \"team member is reviewing\" message.\n- **Design Principle:** Must feel neutral and professional, NOT negative. No red colors, no warning icons.\n\n**B-04: KYC Identity Verification**\n- **Purpose:** Mobile-optimized identity verification (photo ID front/back + selfie with liveness).\n- **Key Components:** Step 1 (photo ID front/back), Step 2 (selfie with liveness), submission button.\n- **Navigation:** KYC PASS -> B-05; KYC FAIL -> B-03\n- **Broker-Referred Variation:** Welcome message explaining who submitted the application.\n\n**B-05: KYC Confirmation**\n- **Purpose:** Confirms identity verification success with \"What happens next\" steps.\n- **Navigation:** -> B-06 (login/account creation)\n\n**B-06: Borrower Login**\n- **Purpose:** Authenticated entry point. Login card + first-time account creation flow.\n- **Navigation:** -> B-07 (dashboard)\n\n**B-07: Borrower Dashboard**\n- **Purpose:** Central hub showing application status, documents, timeline, and next steps.\n- **Key Components:** Application status pipeline banner, Next Steps card with CTA to B-09, Document Status card with progress bar, Timeline card, Messages preview.\n- **State Variations:** Pre-Background, During Due Diligence, Under Review, Approved, Post-Closing.\n- **Sidebar:** Dashboard, My Application, Documents, Messages, Term Sheet (after Stage 4), My Loan (post-closing), Education, Marketplace, Settings.\n\n**B-08: Preliminary Term Sheet**\n- **Purpose:** Estimated loan terms shown after entering Stage 4 (Due Diligence).\n- **Key Components:** Disclaimer banner (amber), term details (amount, rate range, term, fees, repayment type).\n\n**B-09: Conversational Document Collection**\n- **Purpose:** Primary interaction screen during Stage 4. Chat-style guided document submission and Q&A.\n- **Key Components:** Chat container with system/borrower bubbles, document upload zones within chat flow, integration connection prompts (Plaid, QuickBooks, IRS), conditional collateral request, progress indicator, fixed chat input area.\n\n**B-10: Final Term Sheet & Closing Review**\n- **Purpose:** Final approved terms and closing documents for e-signature.\n- **Key Components:** Congratulations banner, final term details, closing documents list with view/sign status, e-signature CTA.\n\n**B-11: E-Signature**\n- **Purpose:** Embedded DocuSign (or similar) flow for closing documents.\n- **Key Components:** Document viewer with signature fields, progress tracking, completion confirmation.\n\n**B-12: Post-Closing Borrower Dashboard**\n- **Purpose:** Replaces B-07 after loan closing. Loan management hub.\n- **Key Components:** Loan summary card, covenant calendar, integration status, AI financial insights feed, quick access grid (Education, Marketplace, Messages, Loan Documents).\n- **Updated Sidebar:** Dashboard, Loan Details, Covenant Calendar, Financial Insights, Messages, Education Portal, Vendor Marketplace, Settings.\n\n**B-13: Education Portal** `MVP-LITE`\n- **Purpose:** Financial literacy courses and content library.\n- **Key Components:** Course catalog with category filters, featured course card, course grid (3-column), My Courses section with progress tracking.\n- **MVP-LITE Scope:** Launch with curated external links and partner content only. No original content creation. No CMS. Upgrade to full CMS in Phase 2.\n\n**B-14: Vendor Marketplace** `POST-MVP`\n- **Purpose:** Partner discounts and business services.\n- **Key Components:** Category-filtered vendor grid (3-column), featured partners carousel, offer detail modals.\n- **Deferred:** Phase 2. Requires vendor onboarding, curation, and commission model. Retained in prototype for client vision demos.\n\n**B-15: Messaging Interface**\n- **Purpose:** In-platform communication with FinOps Resource or support.\n- **Key Components:** Conversation list panel (left), chat panel (right), optional context panel.\n\n**B-16: Profile & Settings**\n- **Purpose:** Account management.\n- **Key Components:** Personal info, business info, notification preferences, integration management, security (password, 2FA), data & privacy.\n\n**B-17: Broker-Referred Welcome Screen**\n- **Purpose:** First screen for broker-referred borrowers before KYC.\n- **Key Components:** Welcome card explaining who submitted their application, company introduction, \"Verify My Identity\" CTA -> B-04.\n\n---\n\n### Section 2: Denied Applicant Screens (D-01 through D-05) `ALL POST-MVP`\n\n> **All 5 screens are POST-MVP.** Retained in prototype for client vision demos. Build deferred pending legal opinion on FCRA-compliant re-qualification monitoring (Discovery Condition 4). Re-qualification mechanism must be specified and legally validated before development begins.\n\n**D-01: Denied Applicant Dashboard** `POST-MVP`\n- **Purpose:** Central hub showing denial reason, resources, and re-qualification progress.\n- **Key Components:** Denial summary card (consumer-friendly reason), recommended resources (path-specific: credit denial vs. financial performance vs. background), re-qualification progress card (if on nurture path with visual progress bars per metric), reapply card.\n- **Sidebar:** Dashboard, My Resources, Progress Tracker, Education Portal, Vendor Marketplace, Messages, Subscription, Settings.\n\n**D-02: Subscription Management** `POST-MVP`\n- **Purpose:** Paid advisory services for denied applicants on financial performance nurture path.\n- **Key Components:** Current plan card, plan comparison table (Basic free / Growth $XX/mo / Premium $XX/mo), billing history.\n\n**D-03: Credit Repair Resources** `POST-MVP`\n- **Purpose:** Curated credit improvement resources for credit-denied applicants.\n- **Key Components:** Step-by-step improvement guide, partner referrals, credit building tools.\n\n**D-04: Re-Qualification Progress & Soft Term Sheet** `POST-MVP`\n- **Purpose:** Detailed progress toward re-qualification with soft term sheet when criteria met.\n- **Key Components:** Progress metrics cards with visual bars per metric, data source status, soft term sheet (shown only when ALL thresholds met) with celebration banner and \"Apply Now\" CTA.\n\n**D-05: Reapply Call-to-Action** `POST-MVP`\n- **Purpose:** Simple reapplication encouragement page.\n- **Key Components:** \"Ready for Another Look?\" card with \"Start New Application\" CTA -> B-01.\n\n---\n\n### Section 3: Broker Screens (BK-01 through BK-07)\n\n**BK-01: Broker Login** -- Orange/amber accent theme. Standard login card.\n\n**BK-02: Broker Dashboard** -- Summary stats bar (total deals, active, approved, denied, pending action), deals table (sortable/filterable), action required banner.\n\n**BK-03: New Submission -- Packet Upload** -- Borrower information form (required fields) + packet upload zone (drag-and-drop, multi-file). Auto-processes and begins credit check.\n\n**BK-04: Packet Incomplete -- Missing Items** -- Alert banner, missing items list with per-item upload zones, submit supplement button.\n\n**BK-05: Deal Detail View** -- Deal header with status badge, vertical status timeline with stage-by-stage progress, current stage details card, outcome card (when decided).\n\n**BK-06: Notification Center** -- Notification list with type icons (status change, incomplete, approval, denial, stall alert), notification preferences toggles.\n\n**BK-07: Broker Profile & Settings** -- Company info, personal info, notification preferences, security, submission history.\n\n---\n\n### Section 4: Intake Agent Screens (IA-01 through IA-04)\n\n**IA-01: Review Queue Dashboard** -- Queue stats (pending, avg time, completed today), review queue table sorted by priority.\n\n**IA-02: Deal Review Screen** -- Two-column layout. Left: Clear Report results (criminal, civil, bankruptcy, regulatory findings with flags). Right: AI business intelligence (website validation, online reviews, public profile, business registration, news/media). Bottom: System recommendation card (PROCEED green or CONCERN amber/red). Action buttons: \"Approve to Proceed\" / \"Reject\" (with mandatory reason modal).\n\n**IA-03: Completed Reviews History** -- Filterable table of past reviews with date, outcome, and reason.\n\n**IA-04: Settings** -- Notification and security preferences.\n\n---\n\n### Section 5: Underwriter Screens (UW-01 through UW-10)\n\n**UW-01: Underwriter Dashboard** -- Summary stats (active cases, escalations, ready for review, avg deal health), active cases table with deal health gauge per case, escalation alerts banner.\n\n**UW-02: Deal Detail -- Real-Time Feed** -- Deal header with health gauge, chronological activity feed (documents received, analyses complete, borrower footnotes, health score changes, integration events), document tracker panel, deal health history mini chart. Navigation to UW-03 through UW-09.\n\n**UW-03: Financial Analysis Workspace** -- 4-tab interface. Tab 1: Financial Spreading (multi-year income statement, balance sheet, cash flow with editable override fields). Tab 2: Ratio Analysis (key ratios in cards with trends, benchmarks, pass/fail, three-layer commentary). Tab 3: Trend Analysis (multi-year charts with system narrative). Tab 4: Manual Analysis (structured forms for collateral, lien search, UCC filings, industry analysis).\n\n**UW-04: Manual Analysis Input Form** -- Analysis type selector (Collateral, Lien Search, UCC, Industry, Site Visit, Other), type-specific form fields with impact/severity assessment and document upload.\n\n**UW-05: Escalation -- Create** -- Escalation form (component dropdown, item being escalated, context/question, urgency), active escalations list below.\n\n**UW-06: Escalation -- View Response** -- Escalation thread (original + manager response + back-and-forth), action buttons (Mark Resolved, Reply, Return to Deal).\n\n**UW-07: Credit Memo Review** -- Two-column layout. Left: system-generated credit memo (read-only, professional format with sections: Executive Summary, Borrower Profile, Financial Analysis, Risk Assessment, Collateral, Recommendation). Right: Three-Layer Commentary (Borrower Footnotes | System Observations | Staff Notes). Bottom: Underwriter's Assessment (rich text), Recommendation (Approve/Deny), \"Advance to Credit Manager\" CTA.\n\n**UW-08: Route Borrower Questions** -- Question form (context, question text, priority), pending questions list with borrower responses.\n\n**UW-09: Virtual Workpapers Viewer** -- Filterable chronological timeline of all notes, comments, escalations, reviews, and decisions. Immutable audit trail with expandable entries.\n\n**UW-10: Case History** -- Archive of completed cases with outcome, recommendation, and date filters.\n\n---\n\n### Section 6: Credit Manager Screens (CM-01 through CM-06)\n\nThe Credit Manager has access to ALL underwriter screens (UW-01 through UW-10) plus:\n\n**CM-01: Manager Dashboard** -- Key metrics bar (active deals, unassigned, escalations, pending reviews, avg pipeline days), team workload grid (cards per underwriter with caseload and health gauge), urgent items panel, pipeline funnel chart.\n\n**CM-02: Case Assignment Interface** -- Left: unassigned cases list with system suggestion (\"Suggested: [name] -- lowest caseload\"). Right: underwriter workload panel with capacity indicators. Assignment history below.\n\n**CM-03: Escalation Review & Response** -- Left: pending escalations list. Right: escalation detail with supporting data and response section (rich text + submit).\n\n**CM-04: Final Review Screen** -- Deal summary header with health score history, credit memo (left column), underwriter recommendation panel (right), three-layer commentary, workpapers access, decision panel: Approve (green), Deny (red with mandatory reason), Flag Concerns (amber -- routes back to underwriter).\n\n**CM-05: All Deals View** -- Advanced filter bar (stage, underwriter, health range, date, status, source, amount range), all-deals table with full columns.\n\n**CM-06: Team Performance** -- Performance metrics grid per underwriter (cases completed, avg cycle time, escalation rate, approval/denial ratio), trend charts, escalation analytics.\n\n---\n\n### Section 7: External Funding Stakeholder Screens (EF-01 through EF-04) `ALL POST-MVP`\n\n> **All 4 screens are POST-MVP.** Near-term approach uses PDF credit packet via email + manual decision logging by Credit Manager. Self-service external portal built in Phase 2. Retained in prototype for client vision demos.\n\n**EF-01: External Reviewer Login** `POST-MVP` -- Standard login card with \"External Review Portal\" subtitle.\n\n**EF-02: Review Dashboard** `POST-MVP` -- Pending reviews table (borrower, business, amount, CDFI approval date, days pending), completed reviews history.\n\n**EF-03: Deal Review Screen** `POST-MVP` -- Deal summary header with internal approval status, full credit memo, supporting analysis panel (tabbed: Financial, Ratios, Risk, Collateral), supporting documents list, internal notes summary.\n\n**EF-04: Decision Actions** `POST-MVP` -- Approve (green), Conditional Approval (amber with conditions form), Deny (red with mandatory reason), comments field, submit button.\n\n---\n\n### Section 8: FinOps Resource Screens (FO-01 through FO-08) `ALL POST-MVP`\n\n> **All 8 screens are POST-MVP.** The FinOps Resource portal is a Phase 2 feature within the Borrower Success Ecosystem. Retained in prototype for client vision demos to show the full post-closing support model.\n\n**FO-01: FinOps Login** `POST-MVP` -- Purple accent theme with \"Financial Advisor Portal\" subtitle.\n\n**FO-02: FinOps Dashboard** `POST-MVP` -- Summary stats (active cases, active borrowers, denied applicants, unread messages), cases table with case type badges (Active Borrower green / Denied Applicant amber), recent activity feed.\n\n**FO-03: Case Detail -- Client Profile** `POST-MVP` -- Tabbed interface. Profile tab: client info, case type, loan details or denial reason. Links to FO-04 through FO-08.\n\n**FO-04: Financial Data Viewer** `POST-MVP` -- Read-only financial summary cards, historical trend charts, system observations feed, AI Financial Advisor recommendations.\n\n**FO-05: Covenant Compliance (Active Borrowers)** `POST-MVP` -- Covenant status grid with compliance badges, compliance timeline, data source status.\n\n**FO-06: Qualification Gap Analysis (Denied Applicants)** `POST-MVP` -- Gap analysis cards per metric (current value vs. required threshold with progress bar and trend), recommended actions, progress history chart.\n\n**FO-07: Messaging Interface** `POST-MVP` -- Threaded communication with data reference tool (insert live data points into messages), file sharing.\n\n**FO-08: Internal Notes & Recommendations Log** `POST-MVP` -- Chronological notes timeline, formal recommendations log with status tracking and \"Share with Client\" option.\n\n---\n\n### Section 9: Administrator Screens (AD-01 through AD-14)\n\n**AD-01: Admin Dashboard** -- System health cards, pipeline funnel with conversion rates, KPIs (avg cycle time, approval rate, denial rate by reason, integration adoption), recent activity log.\n**Sidebar:** Dashboard, Loan Products, Scoring Configuration, Workflow Configuration, Document Checklists, Notification Templates, User Management, Integration Management, System Parameters, Credit Memo Templates, CDFI Reporting, Fair Lending Analytics, Audit Trail, Settings.\n\n**AD-02: Loan Product Configuration** -- Products table, product detail/edit form (name, type, amount/rate/term ranges, fee structure, collateral requirements, eligible entities, required documents, covenant template, status).\n\n**AD-03: Scoring Configuration** -- Deal Health Score: factors and weights with sliders, threshold configuration (green/yellow/red/auto-exit). Custom Scoring Models: factors, point ranges, passing threshold.\n\n**AD-04: Workflow & Approval Gate Configuration** -- Visual pipeline editor with drag-and-drop, per-gate configuration (credit threshold, KYC, background, deal health, inactivity timeout), external funding trigger rules.\n\n**AD-05: Document Checklist Configuration** -- Master checklist table (type, stage, priority, required/conditional, trigger condition, formats, source options), drag-and-drop sequencing, document edit form with rule builder for conditional triggers.\n\n**AD-06: Notification Template Management** -- Templates table by type, template editor with channel toggles (email/text/in-app), rich text with merge fields, preview, timing configuration.\n\n**AD-07: User & Role Management** -- Users table with role/status, invite user flow, user detail/edit with permissions and activity history.\n\n**AD-08: Integration Management** -- Integration cards grid (Credit Bureau, KYC, CLEAR, Plaid, QuickBooks, IRS, DocuSign, SMS, Email, Salesforce), per-service configuration with credentials, environment toggle, connection logs, error history, fallback configuration. All integrations optional.\n\n**AD-09: System Parameters Configuration** -- Parameters grouped by category (Intake, Due Diligence, Servicing, Assignment, Incentives, Re-qualification, Inactivity) with current values, edit fields, defaults, and descriptions.\n\n**AD-10: Credit Memo Template Configuration** -- Reorderable section list with include toggles, per-section configuration (title, content sources, formatting, AI generation instructions), live preview.\n\n**AD-11: CDFI Reporting** -- 3 tabs. TLR Report Generator (date range, generate, preview, download). Impact Metrics Dashboard (loans, jobs, businesses, geography map, target market activity). Section 1071 Data (collection status, quality indicators, export).\n\n**AD-12: Fair Lending Analytics Dashboard** -- Approval rate analysis by protected class, per-gate pass/fail rates by demographic, pricing analysis by demographic group, model performance metrics with drift detection.\n\n**AD-13: Audit Trail & System Logs** -- Filter bar (date, user, action type, entity type, search), audit log table with expandable rows, export button.\n\n**AD-14: Admin Settings** -- Company information, branding, security policies (password requirements, session timeout, 2FA enforcement), data retention policies, backup settings.\n\n---\n\n## 15. Screen Navigation Map\n\n```\nPUBLIC ENTRY POINTS\n+-- B-01 Landing Page -> B-02 Confirmation -> (wait for KYC link)\n|                     -> B-03 Holding Message (if denied)\n+-- BK-01 Broker Login -> BK-02 Dashboard\n+-- B-17 Broker-Referred Welcome -> B-04 KYC\n\nBORROWER FLOW\n+-- B-04 KYC -> B-05 KYC Confirmation -> B-06 Login -> B-07 Dashboard\n+-- B-07 Dashboard -> B-09 Conversational Collection\n|                  -> B-08 Preliminary Term Sheet\n|                  -> B-15 Messages\n|                  -> B-16 Settings\n+-- B-09 Conversational -> (completes) -> B-07 Dashboard (waiting state)\n+-- B-10 Final Term Sheet -> B-11 E-Signature -> B-12 Post-Closing Dashboard\n+-- B-12 Post-Closing -> B-13 Education\n|                     -> B-14 Marketplace\n|                     -> B-15 Messages\n|                     -> B-16 Settings\n\nDENIED APPLICANT FLOW (borrower state)\n+-- B-07 Dashboard -> D-01 Denied Dashboard\n+-- D-01 -> D-02 Subscription Management\n|        -> D-03 Credit Repair Resources\n|        -> D-04 Re-Qualification Progress\n|        -> D-05 Reapply CTA -> B-01\n|        -> B-13 Education\n|        -> B-14 Marketplace\n|        -> B-15 Messages (if subscribed)\n\nBROKER FLOW\n+-- BK-02 Dashboard -> BK-03 New Submission -> BK-04 Incomplete -> BK-02\n|                   -> BK-05 Deal Detail\n|                   -> BK-06 Notifications\n|                   -> BK-07 Settings\n\nINTAKE AGENT FLOW\n+-- IA-01 Queue -> IA-02 Deal Review -> IA-01 (approved/rejected)\n+-- IA-03 Completed Reviews\n+-- IA-04 Settings\n\nUNDERWRITER FLOW\n+-- UW-01 Dashboard -> UW-02 Deal Detail -> UW-03 Financial Analysis\n|                                        -> UW-04 Manual Analysis\n|                                        -> UW-05 Escalation Create\n|                                        -> UW-06 Escalation Response\n|                                        -> UW-07 Credit Memo Review -> (advance to CM)\n|                                        -> UW-08 Route Questions\n|                                        -> UW-09 Workpapers\n+-- UW-10 Case History\n\nCREDIT MANAGER FLOW\n+-- CM-01 Dashboard -> CM-02 Case Assignment\n|                   -> CM-03 Escalation Response\n|                   -> CM-04 Final Review -> (approve/deny/flag)\n|                   -> CM-05 All Deals\n|                   -> CM-06 Team Performance\n|                   -> (All UW screens for direct deal work)\n\nEXTERNAL STAKEHOLDER FLOW\n+-- EF-01 Login -> EF-02 Dashboard -> EF-03 Deal Review -> EF-04 Decision\n\nFINOPS FLOW\n+-- FO-01 Login -> FO-02 Dashboard -> FO-03 Client Profile\n|                                   -> FO-04 Financial Data\n|                                   -> FO-05 Covenant Compliance\n|                                   -> FO-06 Gap Analysis\n|                                   -> FO-07 Messaging\n|                                   -> FO-08 Notes\n\nADMIN FLOW\n+-- AD-01 Dashboard -> AD-02 through AD-14 (all accessible from sidebar)\n```\n\n---\n\n## Glossary\n\n| Term | Definition |\n|------|-----------|\n| **CDFI** | Community Development Financial Institution -- mission-driven lender |\n| **TOS** | Top of Stack -- the CDFI's primary CRM (Salesforce for Siura Capital) |\n| **LOS** | Loan Origination System -- system of record for loan lifecycle |\n| **Sidecar** | Architecture pattern where CremoLogix operates alongside (not inside) the LOS |\n| **CFC** | Cash Flow Coverage -- ratio of available cash flow to debt service |\n| **DSCR** | Debt Service Coverage Ratio -- synonym for CFC in many contexts |\n| **D/I** | Debt-to-Income ratio -- personal obligation measure |\n| **PFS** | Personal Financial Statement -- individual net worth disclosure |\n| **DSO** | Days Sales Outstanding -- AR collection speed |\n| **DIO** | Days Inventory Outstanding -- inventory turnover speed |\n| **DPO** | Days Payable Outstanding -- AP payment speed |\n| **NAICS** | North American Industry Classification System -- industry code |\n| **ECOA** | Equal Credit Opportunity Act -- federal fair lending law |\n| **RLS** | Row-Level Security -- PostgreSQL feature for tenant isolation |\n| **SLA** | Service Level Agreement -- time target for phase completion |\n\n---\n\n*End of Specification*\n","cremologix/technology":"# CremoLogix -- Technology Document\n\n> **SUPERSEDED — Sub-project breakdown requires rewrite.**\n> The 12 sub-projects below were authored against the legacy architecture.md model and cover\n> only ~40% of the actual MVP scope defined in **`specification.md`** (approved Phase 2).\n>\n> **What's missing from the sub-project breakdown:**\n> - Financial Normalization Engine (FNE) — see `fne-specification.md`\n> - Deal Health Score engine — see `deal-health-specification.md`\n> - Pre-qualification pipeline (credit bureau, KYC, background check)\n> - Broker Portal (BK-01 through BK-07)\n> - Intake Agent Portal (IA-01 through IA-04)\n> - CDFI Reporting (TLR, Impact Metrics, Section 1071)\n> - Case-centric workflow (13 phases, not 16 stages)\n> - Configurable scoring engine (scoring models, categories, factors)\n> - Salesforce integration (inbound referrals + outbound status sync)\n> - Fair Lending Analytics (AD-12)\n>\n> The implementation roadmap, environment setup, dev practices, deployment, and security\n> sections (Sections 2-9) remain **directionally valid** but should reference specification.md\n> for authoritative technology choices (NestJS, not Express.js; PostgreSQL 16, not 15).\n>\n> A rewritten sub-project breakdown aligned with specification.md will be produced during\n> the Phase 3 Architecture review.\n\n**Version:** 1.0 (SUPERSEDED — sub-projects need rewrite)\n**Date:** February 2025\n**Source Files:**\n- `C:/projects/Ideas/CremoLogix/Implementation FIles/03-cremologix-sub-projects.md`\n- `C:/projects/Ideas/CremoLogix/Implementation FIles/04-cremologix-implementation-guide.md`\n\n---\n\n## 1. Sub-Project Breakdown (18 Projects)\n\n> **Updated to align with specification.md (approved Phase 2).** Replaces the legacy 12-project breakdown.\n\n### Overview\n\nThe CremoLogix MVP is divided into **18 self-contained sub-projects** covering all 60 MVP + 1 MVP-LITE screens across 7 portals, the 13-phase workflow, pre-qualification pipeline, and all supporting engines.\n\n- **Stack:** NestJS (Core API) + Python/FastAPI (AI/ML Pipeline) + React 18 + PostgreSQL 16\n- **Sprint Cycle:** 2-week sprints\n- **Each Sub-Project:** 1-4 weeks for 1-2 developers\n\n### Sub-Project Catalog\n\n| ID | Name | Type | Est. Weeks | Dependencies |\n|----|------|------|------------|--------------|\n| SUB-01 | Foundation: Auth, Users & Multi-Tenant | Backend + Frontend | 3 | None |\n| SUB-02 | Database Schema & Migrations | Backend | 2 | None |\n| SUB-03 | Pre-Qualification Pipeline | Backend + Frontend | 3 | SUB-01, SUB-02 |\n| SUB-04 | Borrower Portal | Frontend + Backend | 4 | SUB-01, SUB-03 |\n| SUB-05 | Broker Portal | Frontend + Backend | 2 | SUB-01, SUB-03 |\n| SUB-06 | Intake Agent Portal | Frontend + Backend | 2 | SUB-01, SUB-03 |\n| SUB-07 | Document Management & Storage | Backend + Frontend | 2 | SUB-01, SUB-02 |\n| SUB-08 | AI/ML Pipeline: OCR, Classification & Extraction | Python + Backend | 4 | SUB-07 |\n| SUB-09 | Financial Normalization Engine (FNE) | Backend | 3 | SUB-08 |\n| SUB-10 | Financial Analysis Engine | Backend | 3 | SUB-09 |\n| SUB-11 | Risk Assessment Engine | Backend | 2 | SUB-10 |\n| SUB-12 | Deal Health Score Engine | Backend | 2 | SUB-03, SUB-10 |\n| SUB-13 | Workflow Engine (13-Phase) | Backend | 3 | SUB-01, SUB-02 |\n| SUB-14 | Underwriter Portal | Frontend + Backend | 4 | SUB-10, SUB-11, SUB-12, SUB-13 |\n| SUB-15 | Scoring Engine & Credit Memo Assembly | Backend + Frontend | 4 | SUB-11, SUB-14 |\n| SUB-16 | Credit Manager Portal & Review | Frontend + Backend | 3 | SUB-14, SUB-15 |\n| SUB-17 | Admin Portal & Configuration | Frontend + Backend | 4 | SUB-01, SUB-12, SUB-13 |\n| SUB-18 | Integrations, Reporting & Audit | Backend + Frontend | 3 | SUB-13, SUB-15 |\n\n---\n\n### SUB-01: Foundation: Auth, Users & Multi-Tenant\n\n**Objective:** NestJS application scaffold with RS256 JWT auth, RBAC, multi-tenant data isolation, and user management.\n\n**Scope:**\n- NestJS project setup with TypeScript strict mode\n- RS256 JWT with 15-minute access token + 7-day opaque refresh token (Redis)\n- User registration (3 channels: direct, Salesforce referral, external referral)\n- Email verification flow, password reset, account lockout (5 attempts)\n- RBAC: borrower, underwriter, credit_manager, admin roles with `user_roles` join table\n- Multi-tenant middleware: extract `tenant_id` from JWT, set PostgreSQL `app.current_tenant_id`\n- RLS policies on all tenant-scoped tables\n- Login UI for all portals (B-06, BK-01, FO-01, EF-01, staff login)\n\n**Database:** `tenants`, `users`, `user_roles` tables\n\n**Acceptance Criteria:**\n1. RS256 JWT issued on login, validated on all protected routes\n2. Refresh token rotation works correctly\n3. RLS prevents cross-tenant data access\n4. Failed login lockout triggers after 5 attempts (15-min lock)\n5. Max 5 concurrent sessions per user enforced\n6. Admin can create users, assign/revoke roles\n7. Password reset flow works end-to-end via SendGrid\n\n**Effort:** 3 weeks\n\n---\n\n### SUB-02: Database Schema & Migrations\n\n**Objective:** PostgreSQL 16 database with complete schema per specification.md Section 3.\n\n**Scope:**\n- All 26+ tables from specification.md (tenants, users, user_roles, loan_products, applications, cases, case_phases, documents, extraction_results, financial_spreads, risk_items, follow_up_questions, borrower_responses, overrides, scoring_models, scoring_categories, scoring_factors, scoring_results, credit_memo_packets, review_decisions, audit_entries, notifications, integration_configs, workflow_configs, prequalification_checks, section_1071_demographics)\n- FNE tables: normalized_financials, normalization_mappings, normalization_audit, normalized_financial_overrides\n- Deal Health tables: deal_health_scores, deal_health_config\n- UUID v7 primary keys, TIMESTAMPTZ, soft deletes\n- RLS policies on all tenant-scoped tables\n- Seed data: default tenant (Siura Capital), admin user, default scoring model, default workflow config\n\n**Dependencies:** None (parallel with SUB-01)\n\n**Effort:** 2 weeks\n\n---\n\n### SUB-03: Pre-Qualification Pipeline\n\n**Objective:** Implement the 4-gate pre-qualification funnel (credit check → KYC → background → Deal Health gate).\n\n**Scope:**\n- Credit bureau integration (soft pull API, configurable provider)\n- KYC identity verification integration (provider webhook callbacks)\n- Background check integration (async results via webhook)\n- Pre-qualification data model (`prequalification_checks` table)\n- Pre-qualification API endpoints (7 endpoints per spec Section 4.14)\n- Gate threshold configuration (AD-04)\n- Manual entry fallback for credit score\n- B-01 Easy Apply form, B-02 confirmation, B-03 holding message, B-04 KYC screen, B-05 KYC confirmation\n- IA-02 background review screen (Intake Agent)\n\n**Dependencies:** SUB-01 (Auth), SUB-02 (Database)\n\n**Effort:** 3 weeks\n\n---\n\n### SUB-04: Borrower Portal\n\n**Objective:** Complete borrower-facing experience (B-06 through B-17, excluding POST-MVP screens).\n\n**Scope:**\n- B-07 Borrower Dashboard (5 state variations)\n- B-08 Preliminary Term Sheet\n- B-09 Conversational Document Collection (chat-style guided upload)\n- B-10 Final Term Sheet & Closing Review\n- B-11 E-Signature (DocuSign embed)\n- B-12 Post-Closing Dashboard\n- B-13 Education Portal (MVP-LITE: curated links only)\n- B-15 Messaging Interface\n- B-16 Profile & Settings\n- B-17 Broker-Referred Welcome\n- Borrower API endpoints (spec Section 4.2)\n- Section 1071 demographic collection (separate screen, firewall from credit decision)\n\n**Dependencies:** SUB-01 (Auth), SUB-03 (Pre-qualification for onboarding flow)\n\n**Effort:** 4 weeks\n\n---\n\n### SUB-05: Broker Portal\n\n**Objective:** Broker-facing submission and tracking portal (BK-01 through BK-07).\n\n**Scope:**\n- BK-01 Login (orange/amber theme)\n- BK-02 Dashboard (deals table, stats bar)\n- BK-03 New Submission (packet upload + auto credit check trigger)\n- BK-04 Packet Incomplete (missing items)\n- BK-05 Deal Detail View (status timeline)\n- BK-06 Notification Center\n- BK-07 Profile & Settings\n\n**Dependencies:** SUB-01 (Auth), SUB-03 (Pre-qualification triggers)\n\n**Effort:** 2 weeks\n\n---\n\n### SUB-06: Intake Agent Portal\n\n**Objective:** Intake Agent review queue and decision screens (IA-01 through IA-04).\n\n**Scope:**\n- IA-01 Review Queue Dashboard\n- IA-02 Deal Review Screen (background check results + AI business intelligence + approve/reject)\n- IA-03 Completed Reviews History\n- IA-04 Settings\n\n**Dependencies:** SUB-01 (Auth), SUB-03 (Background check results feed into IA-02)\n\n**Effort:** 2 weeks\n\n---\n\n### SUB-07: Document Management & Storage\n\n**Objective:** Document upload, storage, virus scanning, and metadata tracking.\n\n**Scope:**\n- File upload API (multipart/form-data, max 50MB)\n- Azure Blob Storage (Azurite for dev) with server-side AES-256 encryption\n- Pre-signed URLs for upload and download (5-min / 24-hr expiry)\n- Virus scanning via ClamAV (Azure Function or container)\n- Document metadata tracking (`documents` table per spec Section 3.8)\n- Document type classification (17 types defined in spec)\n- Document checklist management (AD-05 drives required docs per product)\n- Document supersession tracking\n\n**Dependencies:** SUB-01 (Auth), SUB-02 (Database)\n\n**Effort:** 2 weeks\n\n---\n\n### SUB-08: AI/ML Pipeline: OCR, Classification & Extraction\n\n**Objective:** Python/FastAPI microservice for document processing pipeline.\n\n**Scope:**\n- OCR service (Azure Document Intelligence for complex layouts, PyPDF2/pdfplumber for text PDFs)\n- Document classification (DistilBERT fine-tuned classifier)\n- Financial data extraction (LLM with document-type-specific prompts)\n- Per-field confidence scoring (OCR clarity + cross-field consistency)\n- Bounding box coordinate capture for source highlighting\n- Async job processing via BullMQ\n- 5-step pipeline: Virus Scan → OCR → Classification → Extraction → Validation\n- `extraction_results` table population (spec Section 3.9)\n\n**Dependencies:** SUB-07 (Document storage provides files to process)\n\n**Effort:** 4 weeks (highest technical complexity)\n\n---\n\n### SUB-09: Financial Normalization Engine (FNE)\n\n**Objective:** Rule-based engine normalizing extracted financial data from 6 entity types into standardized output buckets.\n\n**Scope:** Full specification in `fne-specification.md`:\n- 6 entity types: Sole Prop, LLC, S-Corp, C-Corp, Partnership, Nonprofit\n- 9 document sources with line-by-line tax form mappings\n- 3 output statement types: Income Statement (20+ buckets), Balance Sheet (21 buckets), Cash Flow (5 buckets)\n- 10 cross-validation rules (XV-001 through XV-010)\n- 15-level confidence scoring hierarchy\n- Normalization API endpoints (spec Section 4.12)\n- `normalized_financials`, `normalization_mappings`, `normalization_audit`, `normalized_financial_overrides` tables\n\n**Dependencies:** SUB-08 (Extraction results feed into normalization)\n\n**Effort:** 3 weeks\n\n---\n\n### SUB-10: Financial Analysis Engine\n\n**Objective:** Compute 9 financial analyses from normalized data.\n\n**Scope:**\n- 9 sub-analyses: Business Cash Flow, Personal D/I, Global Cash Flow, Balance Sheet, Income Statement, Operating Cycle, Ratio Analysis, Collateral Coverage, Business Debt Schedule\n- Reads from `normalized_financials` (FNE output), not raw extractions\n- Multi-period trend analysis (YoY, QoQ)\n- Benchmark comparisons\n- `financial_spreads` table population (spec Section 3.10)\n- Financial Analysis API endpoints (spec Section 4.5)\n\n**Dependencies:** SUB-09 (FNE must normalize data before analysis)\n\n**Effort:** 3 weeks\n\n---\n\n### SUB-11: Risk Assessment Engine\n\n**Objective:** Rule-based and AI-augmented risk identification with narrative generation.\n\n**Scope:**\n- Rule-based risk identification (DSCR below minimum, declining revenue, etc.)\n- AI-augmented risk identification (LLM review for non-obvious risks)\n- Risk severity scoring (5 levels)\n- Risk narrative generation (AI-synthesized cohesive narrative)\n- Policy exception tracking\n- `risk_items` table population (spec Section 3.11)\n- Risk API endpoints (spec Section 4.6)\n\n**Dependencies:** SUB-10 (Financial analysis provides data for risk identification)\n\n**Effort:** 2 weeks\n\n---\n\n### SUB-12: Deal Health Score Engine\n\n**Objective:** Progressive composite scoring with configurable weights and ranges.\n\n**Scope:** Full specification in `deal-health-specification.md`:\n- 11 weighted factors with configurable weights and ranges\n- Progressive scoring (re-normalizes as data arrives)\n- 4 zones: Healthy (70-100), Watch (50-69), At Risk (30-49), Critical (0-29)\n- Auto-exit threshold (suggestion only per Human Decision Mandate)\n- Score history tracking for timeline visualization\n- Admin configuration UI support (AD-03)\n- Deal Health API endpoints (spec Section 4.13)\n- `deal_health_scores`, `deal_health_config` tables\n\n**Dependencies:** SUB-03 (pre-qual data for initial factors), SUB-10 (financial data for remaining factors)\n\n**Effort:** 2 weeks\n\n---\n\n### SUB-13: Workflow Engine (13-Phase)\n\n**Objective:** Case-centric 13-phase state machine with SLA management.\n\n**Scope:**\n- 13-phase linear workflow with controlled return paths (spec Section 8.1)\n- Entry/exit conditions per phase (spec Section 8.2)\n- SLA timer management with warnings at 80% and breach notifications (spec Section 8.3)\n- Auto-advance rules for automated phases (spec Section 8.4)\n- Case creation from approved application\n- Underwriter auto-assignment (workload balancing)\n- Notification triggers on phase transitions\n- `cases`, `case_phases` tables (spec Sections 3.6, 3.7)\n- Case API endpoints (spec Section 4.3)\n\n**Dependencies:** SUB-01 (Auth), SUB-02 (Database)\n\n**Effort:** 3 weeks\n\n---\n\n### SUB-14: Underwriter Portal\n\n**Objective:** Full underwriter workspace (UW-01 through UW-10).\n\n**Scope:**\n- UW-01 Dashboard (active cases, escalations, deal health gauges)\n- UW-02 Deal Detail with real-time activity feed\n- UW-03 Financial Analysis Workspace (4-tab: spreading, ratios, trends, manual)\n- UW-04 Manual Analysis Input Forms\n- UW-05/06 Escalation create and response\n- UW-07 Credit Memo Review (two-column with three-layer commentary)\n- UW-08 Route Borrower Questions\n- UW-09 Virtual Workpapers Viewer\n- UW-10 Case History\n- Override management (extraction, spread, risk, score overrides with mandatory rationale)\n- Follow-up question generation (AI) and manual creation\n- Narrative conversion engine (borrower response → third-person narrative)\n\n**Dependencies:** SUB-10, SUB-11, SUB-12, SUB-13\n\n**Effort:** 4 weeks\n\n---\n\n### SUB-15: Scoring Engine & Credit Memo Assembly\n\n**Objective:** Configurable scoring engine and 17-section credit memo generation.\n\n**Scope:**\n- Scoring engine: model → categories → factors with weighted evaluation\n- Factor evaluation rules (range lookup, boolean, custom formula)\n- Data completeness check (< 70% → insufficient_data)\n- Underwriter confirmation requirement\n- 17-section credit memo assembly via LLM\n- TipTap WYSIWYG memo editor with 3-second auto-save\n- PDF and Word export (via Puppeteer)\n- Packet quality check (all sections present, figures consistent)\n- `scoring_models`, `scoring_categories`, `scoring_factors`, `scoring_results`, `credit_memo_packets` tables\n- Scoring API (spec Section 4.8), Packet API (spec Section 4.9)\n\n**Dependencies:** SUB-11 (risk data for memo), SUB-14 (underwriter UI triggers scoring)\n\n**Effort:** 4 weeks\n\n---\n\n### SUB-16: Credit Manager Portal & Review\n\n**Objective:** Credit Manager review workflow and decision recording (CM-01 through CM-06).\n\n**Scope:**\n- CM-01 Manager Dashboard (metrics, team workload, pipeline funnel)\n- CM-02 Case Assignment Interface (with AI-suggested assignment)\n- CM-03 Escalation Review & Response\n- CM-04 Final Review Screen (read-only case + decision panel)\n- CM-05 All Deals View (advanced filters)\n- CM-06 Team Performance\n- Review decision recording (approve / approve with conditions / return / decline)\n- Human Decision Mandate enforcement (all decisions require explicit CM action)\n- Review API endpoints (spec Section 4.10)\n- `review_decisions` table (spec Section 3.20)\n\n**Dependencies:** SUB-14 (underwriter workflow feeds cases to review), SUB-15 (completed packets)\n\n**Effort:** 3 weeks\n\n---\n\n### SUB-17: Admin Portal & Configuration\n\n**Objective:** Full admin configuration and management portal (AD-01 through AD-14).\n\n**Scope:**\n- AD-01 Dashboard (system health, pipeline funnel, KPIs)\n- AD-02 Loan Product Configuration\n- AD-03 Scoring Configuration (Deal Health weights + ranges, custom scoring models)\n- AD-04 Workflow & Approval Gate Configuration (pre-qual thresholds, phase rules)\n- AD-05 Document Checklist Configuration\n- AD-06 Notification Template Management\n- AD-07 User & Role Management\n- AD-08 Integration Management (credit bureau, KYC, CLEAR, Plaid, etc.)\n- AD-09 System Parameters Configuration\n- AD-10 Credit Memo Template Configuration\n- AD-11 CDFI Reporting (TLR, Impact Metrics, Section 1071 — all enabled for Siura)\n- AD-12 Fair Lending Analytics (approval rates by demographic, pricing analysis, drift detection)\n- AD-13 Audit Trail & System Logs\n- AD-14 Admin Settings (branding, security policies, retention)\n- Admin API endpoints (spec Section 4.11)\n\n**Dependencies:** SUB-01 (Auth), SUB-12 (Deal Health config), SUB-13 (Workflow config)\n\n**Effort:** 4 weeks\n\n---\n\n### SUB-18: Integrations, Reporting & Audit\n\n**Objective:** External integrations, notification system, and comprehensive audit trail.\n\n**Scope:**\n- Salesforce integration: OAuth 2.0, inbound referral webhooks, outbound status sync\n- LOS integration: sidecar API push with PDF/Word attachments\n- Email service: SendGrid (primary) / SES (fallback), 15+ templates\n- Notification system: in-app + email with delivery tracking\n- Audit trail: append-only `audit_entries` table with monthly partitioning\n- 6 audit categories: data changes, user actions, phase transitions, AI events, overrides, integrations\n- Audit log querying, filtering, and CSV export\n- Notification & Webhook API endpoints (spec Section 4.15)\n\n**Dependencies:** SUB-13 (Workflow events trigger integrations), SUB-15 (Packet export for LOS push)\n\n---\n\n## 2. Implementation Roadmap\n\n> **Updated to align with 18 sub-projects per specification.md.**\n\n### Timeline Overview\n\n```\nPhase A: Foundation (Weeks 1-5)\n  Week 1-2: SUB-01 (Auth + Multi-Tenant) + SUB-02 (Database) — parallel\n  Week 3-5: SUB-03 (Pre-Qualification Pipeline) + SUB-13 (Workflow Engine) — parallel\n\nPhase B: Portals & Document Processing (Weeks 6-13)\n  Week 6-9:  SUB-04 (Borrower Portal) + SUB-07 (Document Mgmt) — parallel\n  Week 8-9:  SUB-05 (Broker Portal) + SUB-06 (Intake Agent Portal) — parallel\n  Week 10-13: SUB-08 (AI/ML Pipeline: OCR + Extraction)\n\nPhase C: Financial Engines (Weeks 14-21)\n  Week 14-16: SUB-09 (FNE)\n  Week 17-19: SUB-10 (Financial Analysis Engine)\n  Week 20-21: SUB-11 (Risk Assessment) + SUB-12 (Deal Health Score) — parallel\n\nPhase D: Underwriting Workflow (Weeks 22-32)\n  Week 22-25: SUB-14 (Underwriter Portal)\n  Week 26-29: SUB-15 (Scoring Engine + Credit Memo)\n  Week 30-32: SUB-16 (Credit Manager Portal)\n\nPhase E: Admin & Integration (Weeks 28-35)\n  Week 28-31: SUB-17 (Admin Portal) — overlaps with Phase D\n  Week 32-34: SUB-18 (Integrations, Reporting & Audit)\n\nPhase F: Integration Testing & Launch (Weeks 35-40)\n  Week 35-37: End-to-end testing across all portals\n  Week 38-39: Bug fixes, performance optimization, security audit\n  Week 40:    Staging deployment + pilot onboarding (Siura Capital)\n```\n\n### Critical Path\n\n```\nSUB-02 (Schema) ─┐\n                  ├─> SUB-03 (Pre-Qual) ─┐\nSUB-01 (Auth)  ───┘                      ├─> SUB-07 (Docs) ─> SUB-08 (AI/ML)\n                                         │     ─> SUB-09 (FNE) ─> SUB-10 (Analysis)\n                                         │       ─> SUB-11 (Risk) ─> SUB-14 (UW Portal)\n                                         │         ─> SUB-15 (Scoring + Memo) ─> SUB-16 (CM Portal)\n                                         │\n                                         └─> SUB-12 (Deal Health) ─> SUB-14 (UW Portal)\n```\n\nLongest path: SUB-01/02 → SUB-03 → SUB-07 → SUB-08 → SUB-09 → SUB-10 → SUB-11 → SUB-14 → SUB-15 → SUB-16 (~32 weeks sequential)\n\n### Parallel Work Streams\n\n**Stream A (Backend — NestJS Core):**\n- Weeks 1-5: SUB-01 (Auth), SUB-02 (Schema), SUB-13 (Workflow)\n- Weeks 6-9: SUB-03 (Pre-Qual), SUB-07 (Documents)\n- Weeks 14-21: SUB-09 (FNE), SUB-10 (Financial Analysis)\n- Weeks 22-29: SUB-15 (Scoring + Memo), SUB-18 (Integrations)\n\n**Stream B (Backend — Python AI/ML):**\n- Weeks 1-5: ML pipeline scaffold, model training (classification)\n- Weeks 10-13: SUB-08 (OCR + Extraction pipeline)\n- Weeks 14-21: SUB-11 (Risk Assessment — AI components), SUB-12 (Deal Health)\n- Weeks 22-29: AI narrative generation, question generation, memo assembly\n\n**Stream C (Frontend):**\n- Weeks 1-5: Design system, component library, login UIs\n- Weeks 6-13: SUB-04 (Borrower Portal), SUB-05 (Broker), SUB-06 (Intake Agent)\n- Weeks 14-25: SUB-14 (Underwriter Portal), SUB-15 (Memo Editor)\n- Weeks 26-34: SUB-16 (CM Portal), SUB-17 (Admin Portal)\n\n---\n\n## 3. Environment Setup\n\n### Prerequisites\n\n- Node.js 20+ (LTS)\n- PostgreSQL 16+\n- Redis 7+\n- Python 3.11+ (for AI/ML pipeline)\n- Git\n- Docker & Docker Compose\n- VS Code or similar IDE\n\n### Initial Setup\n\n```bash\n# 1. Clone repository\ngit clone https://github.com/your-org/cremologix.git\ncd cremologix\n\n# 2. Install dependencies\ncd backend && npm install\ncd ../frontend && npm install\n\n# 3. Set up environment variables\ncp backend/.env.example backend/.env\ncp frontend/.env.example frontend/.env\n\n# 4. Start database (Docker)\ndocker-compose up -d postgres redis\n\n# 5. Run migrations\ncd backend && npm run migrate\n\n# 6. Seed database\nnpm run seed\n\n# 7. Start development servers\n# Terminal 1: cd backend && npm run dev\n# Terminal 2: cd frontend && npm run dev\n# Access: http://localhost:3000\n```\n\n### Project Structure\n\n```\ncremologix/\n  api/                        # NestJS Core API\n    src/\n      modules/\n        auth/                 # Auth module (JWT, RBAC)\n        users/                # User management\n        tenants/              # Multi-tenant config\n        cases/                # Case management + workflow\n        applications/         # Application intake\n        documents/            # Document management\n        financial/            # Analysis + FNE + normalization\n        scoring/              # Scoring engine + Deal Health\n        risk/                 # Risk assessment\n        memo/                 # Credit memo assembly\n        review/               # Credit Manager review\n        admin/                # Admin configuration\n        notifications/        # Notification service\n        integrations/         # Salesforce, LOS, email\n        audit/                # Audit trail\n        prequalification/     # Pre-qual pipeline\n      common/\n        guards/               # Auth + RBAC guards\n        interceptors/         # Audit, tenant context\n        pipes/                # Validation (Zod)\n        decorators/           # Custom decorators\n      main.ts                 # Entry point\n    migrations/               # Database migrations\n    seeds/                    # Seed data\n    test/\n    package.json\n    tsconfig.json\n  ml/                         # Python AI/ML Pipeline\n    app/\n      routers/                # FastAPI routes\n      services/\n        ocr/                  # OCR service\n        classification/       # Document classification\n        extraction/           # Financial data extraction\n        risk_narrative/       # AI risk narratives\n        question_gen/         # Follow-up question generation\n        narrative_convert/    # Borrower response → narrative\n        memo_assembly/        # 17-section memo generation\n      models/                 # ML models (classification)\n      prompts/                # LLM prompt templates (versioned)\n    main.py                   # FastAPI entry point\n    requirements.txt\n    Dockerfile\n  web/                        # React 18 Frontend\n    src/\n      portals/\n        borrower/             # B-01 through B-17\n        broker/               # BK-01 through BK-07\n        intake-agent/         # IA-01 through IA-04\n        underwriter/          # UW-01 through UW-10\n        credit-manager/       # CM-01 through CM-06\n        admin/                # AD-01 through AD-14\n      components/             # Shared components\n      hooks/                  # Custom hooks\n      services/               # API clients\n      contexts/               # React contexts\n      App.tsx\n    public/\n    package.json\n    tsconfig.json\n  infra/                      # Terraform IaC\n  docker-compose.yml\n  .github/\n    workflows/                # CI/CD pipelines\n  README.md\n```\n\n---\n\n## 4. Development Best Practices\n\n### Code Standards\n\n**TypeScript (strict mode):**\n```typescript\n\"strict\": true,\n\"noImplicitAny\": true,\n\"strictNullChecks\": true\n```\n- Prefer interfaces over types\n- Use async/await over raw promises\n\n**Error Handling:**\n- Custom error classes (ValidationError, etc.)\n- Centralized error handler middleware\n- Standard error response format\n\n**API Response Format:**\n```json\n// Success\n{ \"success\": true, \"data\": { ... }, \"meta\": { \"timestamp\": \"...\", \"request_id\": \"...\" } }\n\n// Error\n{ \"success\": false, \"error\": { \"code\": \"...\", \"message\": \"...\", \"details\": {...} }, \"meta\": { ... } }\n```\n\n### Git Workflow\n\n**Branching Strategy (Git Flow):**\n```\nmain              (production-ready code)\n  -> develop       (integration branch)\n     -> feature/*  (new features)\n     -> fix/*      (bug fixes)\n     -> release/*  (release candidates)\n```\n\n**Commit Messages:**\n```\nfeat(auth): add password reset flow\nfix(documents): handle large file uploads\ndocs(api): update authentication endpoints\ntest(analysis): add unit tests for DSCR calculation\nrefactor(workflow): simplify stage transition logic\n```\n\n**Pull Request Process:**\n1. Create feature branch from `develop`\n2. Make changes and commit\n3. Push to origin, create PR\n4. Request review from team\n5. Address review comments\n6. Merge after approval (squash commits)\n\n### Testing Requirements\n\n**Minimum Coverage:**\n- Unit tests: 70% coverage\n- Integration tests: Critical paths covered\n- E2E tests: Happy path for each user role\n\n---\n\n## 5. Deployment Strategy\n\n### Environments\n\n| Environment | Purpose | Deployment |\n|---|---|---|\n| Development | Local machine (Docker Compose), hot reload, verbose logging, test data | Manual |\n| Staging | Azure (mirrors production), real third-party services (sandbox mode) | Auto from `develop` branch |\n| Production | Azure (production config), real services, monitoring enabled | Manual from `main` branch |\n\n### CI/CD Pipeline (GitHub Actions)\n\n```yaml\nname: CI/CD\non:\n  pull_request:\n    branches: [develop, main]\n  push:\n    branches: [develop, main]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    steps:\n      - Install dependencies (npm ci)\n      - Run linter (npm run lint)\n      - Run tests with coverage (npm run test:coverage)\n      - Upload coverage (codecov)\n\n  deploy-staging:\n    needs: test\n    if: github.ref == 'refs/heads/develop'\n    # Deploy to staging environment\n\n  deploy-production:\n    needs: test\n    if: github.ref == 'refs/heads/main'\n    # Deploy to production environment\n```\n\n### Production Deployment Checklist\n\n**Pre-Deployment:**\n- [ ] All tests passing\n- [ ] Code reviewed and approved\n- [ ] Database migrations tested in staging\n- [ ] Third-party API keys configured\n- [ ] Environment variables set\n- [ ] SSL certificates valid\n- [ ] Monitoring configured\n- [ ] Backup strategy in place\n\n**Deployment:**\n- [ ] Run database migrations\n- [ ] Deploy backend\n- [ ] Deploy frontend\n- [ ] Verify health checks\n- [ ] Run smoke tests\n- [ ] Monitor error rates\n\n**Post-Deployment:**\n- [ ] Verify all services running\n- [ ] Test critical user flows\n- [ ] Monitor logs for errors\n- [ ] Check performance metrics\n- [ ] Notify team of deployment\n\n---\n\n## 6. Monitoring & Operations\n\n### Application Performance Monitoring (Application Insights)\n- Response times (p50, p95, p99)\n- Error rates\n- Request volume\n- Database query performance\n\n### Error Tracking (Application Insights)\n- Unhandled exceptions\n- Failed API requests\n- Frontend errors\n- Error grouping and trends\n\n### Logging (Azure Log Analytics)\n- Application logs (info, warn, error)\n- Audit trail\n- Security events\n- API request/response logs\n\n### Alert Thresholds\n- Error rate >1% for 5 minutes\n- Response time >500ms for 10 minutes\n- Database connection failures\n- Third-party API failures\n\n### Health Check Endpoint\n```typescript\nGET /health\nResponse:\n{\n  \"status\": \"healthy\",\n  \"checks\": {\n    \"database\": \"healthy\",\n    \"redis\": \"healthy\",\n    \"s3\": \"healthy\"\n  },\n  \"version\": \"1.0.0\",\n  \"uptime\": 86400\n}\n```\n\n### Backup Strategy\n\n**Database:**\n- Automated daily backups (Azure PostgreSQL Flexible Server)\n- 30-day retention\n- Weekly full backups stored in separate region\n- Monthly backups archived for 1 year\n\n**File Storage:**\n- Blob Storage versioning enabled\n- GRS (Geo-Redundant Storage) replication\n- Lifecycle policy: Cool tier after 90 days, Archive tier after 1 year\n\n**Disaster Recovery:**\n- RTO (Recovery Time Objective): 4 hours\n- RPO (Recovery Point Objective): 24 hours\n- Regular disaster recovery drills (quarterly)\n\n---\n\n## 7. Security Checklist\n\n### Authentication & Authorization\n- [x] JWT tokens with 24-hour expiry\n- [x] Passwords hashed with bcrypt (cost factor 10)\n- [x] Role-based access control\n- [ ] Multi-factor authentication (future)\n- [x] Session management and logout\n\n### Data Protection\n- [x] HTTPS/TLS 1.3 in production\n- [x] Database encryption at rest\n- [x] Sensitive data in environment variables\n- [x] API keys rotated quarterly\n- [ ] Field-level encryption for SSN/EIN (future)\n\n### API Security\n- [x] Rate limiting (100 req/min per user)\n- [x] Input validation (Zod schemas)\n- [x] SQL injection prevention (ORM)\n- [x] XSS prevention (Content Security Policy)\n- [x] CSRF protection\n\n### File Security\n- [x] File type validation\n- [x] File size limits (25MB)\n- [ ] Virus scanning (future: ClamAV)\n- [x] Pre-signed URLs (24-hour expiry)\n\n### Audit & Compliance\n- [x] Complete audit trail\n- [x] Immutable audit log (append-only)\n- [x] Access logging\n- [x] GDPR compliance (data export, deletion)\n\n### Security Scanning\n- **Dependency Scanning:** npm audit\n- **Code Scanning:** GitHub Advanced Security (SAST), SonarQube, ESLint security rules\n- **Penetration Testing:** Schedule before launch, annual pen tests thereafter\n\n---\n\n## 8. Performance Optimization\n\n### Backend\n- Index all foreign keys and frequently queried fields\n- Connection pooling (max 20 connections)\n- Optimize N+1 queries (use eager loading)\n- Cache frequently accessed data (Redis, 1-hour TTL)\n- Response compression (gzip)\n- Pagination for large lists (limit 50 items per page)\n\n### Frontend\n- Code splitting / lazy loading routes\n- Image optimization (WebP, compress before sending)\n- Target: <500KB initial bundle\n- Tree-shake unused code, production builds\n\n---\n\n## 9. Risk Management\n\n### Technical Risks\n\n| Risk | Probability | Impact | Mitigation |\n|------|-------------|--------|------------|\n| AI extraction accuracy low | Medium | High | Human review required, fallback to manual entry |\n| Third-party API downtime | Low | Medium | Retry logic, fallback providers |\n| Performance issues at scale | Medium | High | Load testing, horizontal scaling, caching |\n| Security breach | Low | Critical | Pen testing, security audits, monitoring |\n| Database corruption | Low | Critical | Automated backups, replication, disaster recovery |\n\n### Project Risks\n\n| Risk | Probability | Impact | Mitigation |\n|------|-------------|--------|------------|\n| Scope creep | High | Medium | Strict MVP definition, change control process |\n| Key developer leaving | Medium | High | Knowledge sharing, documentation, backup roles |\n| Third-party integration delays | Medium | Medium | Start integrations early, have alternatives |\n| Regulatory changes | Low | High | Legal review, compliance monitoring |\n| Budget overrun | Medium | Medium | Track spending, prioritize ruthlessly |\n\n---\n\n## 10. Post-MVP Roadmap\n\n### Phase 2: Multi-Tenant (Months 10-14)\n- Tenant isolation and data partitioning\n- Admin configuration portal per tenant\n- Custom covenant rules per tenant\n- Workflow customization per tenant\n- White-labeling support\n\n### Phase 3: Advanced Features (Months 15-20)\n- Cash flow projections and sensitivity analysis\n- ML-based anomaly detection\n- Collaborative editing for credit memos\n- Pre-built LOS connectors (nCino, Salesforce)\n- Analytics and reporting dashboard\n- Mobile-responsive UI\n\n### Phase 4: Enterprise & Scale (Months 21-24)\n- SOC 2 Type II certification\n- Advanced RBAC with ABAC\n- Disaster recovery and backup\n- API marketplace and developer portal\n- Professional services toolkit\n- Support for 50+ tenants\n\n---\n\n## 11. Success Metrics & KPIs\n\n### Development Metrics\n- **Velocity:** Story points per sprint, cycle time\n- **Quality:** Test coverage (>70%), bug escape rate, time to fix\n- **Performance:** API response time (<500ms p95), frontend load time (<2s), uptime (99.9%)\n\n### Business Metrics (Post-Launch)\n- **Adoption:** CDFIs onboarded, active users/week, applications processed/month\n- **Efficiency:** Underwriting cycle time (target: 2-3 days from 5-7), applications per underwriter (target: 2x improvement)\n- **Quality:** AI extraction accuracy (>95%), memo revisions per application (<2), user satisfaction (NPS >40)\n\n---\n\n*End of Technology Document*\n","drill-or-drop/discovery":"# Drill or Drop -- Discovery Document\n\n**Project:** Drill or Drop\n**Type:** AI-Powered Well Investment Decision Platform\n**Document Version:** 2.1\n**Date:** February 9, 2026\n**Prepared by:** Business Analyst, Crucible Product Development\n**Status:** Discovery Phase -- BA Optimization Decisions, State Regulatory Data Strategy\n\n---\n\n## Table of Contents\n\n1. [Executive Summary](#1-executive-summary)\n2. [Problem Statement](#2-problem-statement)\n3. [Market Context](#3-market-context)\n4. [Target Users & Personas](#4-target-users--personas)\n5. [Workflow & Process](#5-workflow--process)\n6. [Data Architecture (High Level)](#6-data-architecture-high-level)\n7. [Key Features](#7-key-features)\n8. [AI & Automation Capabilities](#8-ai--automation-capabilities)\n9. [Scenario Modeling & Live Dashboard](#9-scenario-modeling--live-dashboard)\n10. [Decision Archive & Analytics](#10-decision-archive--analytics)\n11. [Technical Considerations](#11-technical-considerations)\n12. [Risks & Assumptions](#12-risks--assumptions)\n13. [MVP Scope](#13-mvp-scope)\n14. [Open Questions](#14-open-questions)\n15. [GO/NO-GO Conditions](#15-gono-go-conditions)\n16. [BA Optimization Recommendations](#16-ba-optimization-recommendations)\n\n---\n\n## 1. Executive Summary\n\n**Drill or Drop** is an AI-powered well investment decision platform designed for non-operated working interest (NOWI) holders evaluating Authorization for Expenditure (AFE) proposals. The platform ingests AFE documents, validates land records against internal and third-party data, builds type curves from analog well performance data, auto-calculates full-cycle economics through an engine-driven model, and delivers a drill/drop recommendation through a comprehensive, interactive executive dashboard with live financial modeling, structured advisory voting, and a delegated approval chain with escalation.\n\nThe product addresses a fundamental challenge in upstream oil & gas: the AFE evaluation process for non-operators is manual, fragmented across spreadsheets and disconnected tools, and heavily dependent on institutional knowledge. Decisions that commit capital are often made without rigorous, repeatable analysis -- or the analysis takes so long that the election window closes before work is complete.\n\nDrill or Drop compresses this workflow from days or weeks into same-day automated results. It automates the mechanics (PDF parsing, land record matching, analog selection, economics calculations) while preserving expert control at every stage. Six roles define the workflow:\n\n| Role | Function |\n|------|----------|\n| **Administrator** | System configuration, user management, data source connections, DOI deck upload, approval chain setup, escalation rules |\n| **Land Analyst** | AFE ingestion (manual PDF upload or email auto-ingestion confirmation), DOI validation with confidence sign-off |\n| **Technical Analyst** | Analog well scouting, type curve construction, opex assumptions with confidence sign-off |\n| **Commercial Analyst** | Receives upstream inputs, validates engine-generated economics, applies deal structure assumptions, signs off with confidence |\n| **Commercial Advisory Group (CAG)** | Reviews comprehensive deal dashboard, adjusts inputs live, votes on each AFE (5-point scale with mandatory rationale) |\n| **Approver (CEO + Delegates)** | Sole approval authority: Drill / Drop / Send Back; delegated approval chain with time-based escalation |\n\nLand and Technical Analysts work **in parallel** after AFE ingestion, eliminating the sequential bottleneck of previous workflow designs. Once both sign off, the economics engine auto-calculates the full model. The Commercial Analyst validates and adjusts the auto-generated economics rather than building from scratch. The dashboard is a live financial model -- CAG members can change inputs and watch everything recalculate in real time before casting votes. The Approver sees the full picture: analyst confidence levels, CAG sentiment, and the complete financial analysis.\n\nIf the election deadline passes without an approval decision, the system flags the AFE as **Non-Consent** and records the outcome in the decision archive.\n\nThe platform targets a client managing non-operated interests across the Permian (Delaware and Midland sub-basins), Eagle Ford, Haynesville, and Powder River basins. The MVP handles one AFE at a time (multiple can exist but no side-by-side ranking). Well data is ingested from a multi-source strategy: free state regulatory data from Texas RRC, New Mexico OCD, and Wyoming WOGCC serve as the primary foundation, with Enverus CSV import as enrichment and fallback (especially for Louisiana/Haynesville data). API integration is a future upgrade path. The UI follows a light theme, modern, clean, professional design and is mobile-responsive from day one.\n\nThe v2.1 revision incorporates client decisions on 12 BA optimization recommendations: 8 approved for v1 (confidence auto-gating, deadline-aware prioritization, breakeven auto-calculation, asymmetric risk framing, stale evaluation detection, decision feedback loop data model, PDF template library, and export package), 1 approved for v2 (operator performance scorecards), 2 deferred, and 1 skipped. It also introduces a state regulatory data strategy that leverages free public well and production data as a primary data source, reducing dependency on Enverus CSV imports.\n\n---\n\n## 2. Problem Statement\n\n### The Non-Operator's Dilemma\n\nNon-operated working interest holders receive AFE proposals from operators and must make consequential capital allocation decisions -- often under tight election deadlines (typically 30 days, worst case 1 week) -- with limited access to the operator's subsurface data, completion design rationale, or economic assumptions. The typical evaluation process suffers from several structural weaknesses:\n\n**Fragmented Data and Tooling.** Land records live in Excel. Well data is pulled from Enverus manually via CSV exports. Economics are modeled in standalone spreadsheets. Commodity prices are looked up by hand. There is no single system that connects the evaluation pipeline end to end.\n\n**Manual, Error-Prone Workflows.** Division of Interest (DOI) validation requires cross-referencing internal records against operator statements and public data. Analog well selection is subjective and inconsistent. Type curve generation depends on who is doing the work and what wells they happen to choose. These manual steps introduce variability and risk.\n\n**Slow Turnaround.** A thorough AFE evaluation -- land validation, technical review, full economics, scenario analysis -- can take days to weeks depending on staff availability and the complexity of the prospect. When AFE election windows are tight, delays translate directly into missed opportunities or uninformed decisions.\n\n**No Institutional Memory.** Decisions are documented inconsistently. There is no structured archive of past evaluations, the assumptions that drove them, or how actual well performance compared to projections. The organization cannot learn from its own decision history.\n\n**Limited Scenario Flexibility.** Traditional spreadsheet models make it cumbersome to explore alternative structures -- farm-out percentages, financing terms, before/after payout splits, back-in provisions, sliding scale overrides, minimum royalties, promoted interest structures. Each scenario requires manual rework, discouraging thorough exploration of the decision space.\n\n**Expert Bottlenecks.** Senior technical and commercial staff are the scarce resource. They need tools that surface the analysis, not tools that require them to build the analysis from scratch every time.\n\n**No Structured Advisory Input.** Advisory group opinions are collected informally (email, hallway conversations, meetings) with no structured voting, no mandatory rationale capture, and no systematic way to aggregate sentiment for the decision-maker.\n\n**Approval Bottlenecks.** The CEO or primary decision-maker is frequently traveling or unavailable. There is no systematic delegation chain, no automated escalation, and no way to act on approvals via SMS when away from a desk. Missed deadlines result in non-consent elections with potential financial penalties.\n\n### The Opportunity\n\nAn integrated platform that automates the repeatable mechanics of AFE evaluation while preserving expert judgment at critical decision points would:\n\n- Reduce evaluation time from days to same-day automated results\n- Eliminate data transcription errors between systems\n- Standardize analog selection and type curve methodology\n- Enable rapid scenario exploration through a live interactive dashboard (with conversational AI in a future release)\n- Build an institutional decision archive that enables continuous improvement, seeded from historical spreadsheet data\n- Support complex deal structures including back-in after payout, sliding scale overrides, minimum royalties, and promoted interest provisions\n- Capture structured advisory votes with rationale for institutional memory\n- Ensure no election deadline is missed through automated escalation and delegation\n\n---\n\n## 3. Market Context\n\n### Industry Landscape\n\nThe upstream oil & gas software market is served by a handful of established platforms and a growing set of specialized analytics tools. The competitive landscape breaks down into several categories:\n\n#### Full-Stack E&P Analytics Platforms\n\n**Enverus (formerly DrillingInfo)** is the dominant data provider and increasingly a full-stack analytics platform. Enverus PRISM offers pre-generated and customizable forecasts and economics for over 5.4 million North American wells, with predictive forecasting, spacing analytics, and benchmarking workflows. Enverus positions itself as an all-in-one solution but is broadly focused on the entire E&P lifecycle -- not specifically on the non-operator AFE evaluation use case.\n\n**ComboCurve** provides forecasting, type curve analysis, economic scenario modeling, and decision support. Their platform can run up to 10 economic scenarios concurrently and integrates forecast-to-economics workflows. ComboCurve targets upstream and midstream companies, banks, advisors, and mineral/royalty owners.\n\n**Quorum Software (Val Nav)** is a long-standing reserves and economics platform used for asset evaluation, development planning, M&A analysis, and AFE economics. It is powerful but heavyweight -- designed for reserves engineers, not for rapid commercial decision-making.\n\n#### Specialized Analytics\n\n**Novi Labs** focuses on well-level data analytics, production forecasting, and investment screening. It provides proprietary research and analytics for rapid investment decisions and development planning. Novi explicitly positions against \"all-in-one solutions\" by emphasizing speed and accuracy over breadth.\n\n**TGS Well Data Analytics** integrates comprehensive well data, production data, completions data, geological attributes, and well economics in a cloud-based platform designed for faster decision-making.\n\n#### AFE Management Software\n\n**Pandell AFE** automates the AFE approval process with cost tracking, approval workflows, and reporting -- but focuses on the administrative lifecycle of the AFE document, not the underlying investment analysis.\n\n**Enertia Software** provides well production and AFE management with integrated workflows but is oriented toward operators, not non-operators.\n\n### Competitive Positioning for Drill or Drop\n\nNone of the existing platforms combine all of the following in a single workflow:\n\n1. Automated AFE PDF ingestion and field extraction (including email auto-ingestion)\n2. Land record validation with DOI cross-referencing against both internal records and Enverus\n3. AI-driven analog well selection and type curve generation\n4. Engine-driven full-cycle economic modeling (DCF, NPV, IRR, payout) with a flexible deal structure builder supporting back-in, sliding scale, promoted interest, and custom one-off structures\n5. A live interactive dashboard that serves as both a comprehensive deal summary and a real-time financial model\n6. Structured advisory voting with mandatory rationale on a 5-point scale\n7. Role-based expert review gates with confidence-level sign-offs\n8. Delegated approval chain with time-based escalation and SMS delegation\n9. Decision archiving with voting records, non-consent tracking, and future variance analysis capability\n\nThe existing tools are either too broad (Enverus, ComboCurve -- designed for operators doing full-field development planning), too narrow (Pandell -- AFE workflow only, no economics), or too technical (Val Nav -- designed for reserves engineers, steep learning curve). None offer the non-operator-specific workflow integration, the structured advisory voting model, the delegated approval chain, or the live interactive dashboard that Drill or Drop provides.\n\nDrill or Drop's differentiation lies in its focus on the non-operator's specific workflow, its end-to-end integration from AFE receipt to drill/drop decision, its AI-driven automation at every stage, its engine-driven economics, its structured governance model (confidence levels, voting, delegated approval), and its live interactive dashboard.\n\n### Market Timing\n\nThe oil & gas industry's adoption of AI and cloud-based analytics is accelerating. Companies are moving from legacy spreadsheet-based workflows to integrated platforms. Non-operators in particular are underserved by current tooling -- most platforms are designed for the operator's perspective. The market window for a purpose-built non-operator decision tool is open and growing.\n\n---\n\n## 4. Target Users & Personas\n\n### Persona 1: Administrator\n\n**Role:** System configuration, user management, data source connections, DOI deck maintenance, approval chain configuration, and escalation rules. The Administrator is the catch-all role for any system configuration activity.\n\n**Background:** Operations or IT staff responsible for maintaining the platform. Understands the company's organizational structure, data sources, and approval hierarchy. May also serve as Land or Commercial Analyst in smaller organizations.\n\n**Key Responsibilities:**\n- Configure and manage user accounts and role assignments\n- Set up and maintain data source connections (Enverus CSV import settings, pricing sources, opex API endpoints)\n- Upload and maintain the DOI deck (master land records from Excel)\n- Configure the delegated approval chain (Primary Approver, 1st Delegate, 2nd Delegate)\n- Set escalation rules and timing thresholds (X days before election deadline triggers escalation)\n- Manage notification preferences and escalation channels (in-app, email, SMS)\n- Configure system defaults (default discount rate, default price deck, basin settings)\n\n**Key Needs:**\n- Clean admin panel for user and role management\n- Intuitive data source configuration with validation feedback\n- DOI deck upload with change tracking and version history\n- Approval chain builder with drag-and-drop or simple assignment UI\n- Escalation rule configuration with preview/test capability\n- Audit log of all administrative changes\n\n**Pain Points:**\n- Currently no centralized system administration -- settings are scattered across spreadsheets, email rules, and tribal knowledge\n- Approval delegation is ad hoc (phone calls, forwarded emails)\n- No visibility into whether escalation is working or deadlines are at risk\n\n### Persona 2: Land Analyst\n\n**Role:** AFE ingestion and DOI validation. The Land Analyst either uploads AFE PDFs manually or confirms auto-ingested email AFEs. The system parses the AFE via a vision-language model and auto-validates against the DOI deck and Enverus data. The Land Analyst reviews matches, investigates discrepancies, can override values, and signs off with a confidence level.\n\n**Background:** Experienced landman or land analyst with deep knowledge of mineral ownership, title chains, and lease terms. Comfortable with Excel-based land records but would benefit from automated matching. Has access to Enverus CSV exports for cross-referencing.\n\n**Key Needs:**\n- Simple AFE upload (drag-and-drop PDF) or one-click confirmation of auto-ingested email AFEs\n- Automated extraction of key fields from AFE PDFs (API number, well name, legal description, stated interest, operator, costs)\n- Side-by-side comparison of AFE-stated interest vs. internal DOI deck vs. Enverus DOI data\n- Clear flagging of discrepancies with specific detail and severity\n- Ability to override system-matched values with explanation\n- Confidence level sign-off: High, Medium, or Low\n- Annotation capability for findings and adjustments\n\n**Pain Points:**\n- Currently cross-references AFEs against Excel spreadsheets manually\n- No systematic way to track which AFEs have been validated vs. pending\n- Discrepancies between operator-stated interest and internal records require manual investigation that is time-consuming and error-prone\n- No structured way to communicate confidence in the DOI validation to downstream consumers\n\n### Persona 3: Technical Analyst (Engineering + G&G)\n\n**Role:** Scouts Enverus for analog wells near the proposed location. Selects best-fit sample based on proximity, well type, operator, completion similarity, and historical production. Builds type curve (production profile). Provides opex assumptions based on operator history and well type. Signs off with confidence level.\n\n**Background:** Petroleum engineer or geoscientist with experience in decline curve analysis, completion design evaluation, and basin-level geology. Uses Enverus data (via CSV export) for well data. Understands type curve methodology including Arps decline models (exponential, hyperbolic, harmonic).\n\n**Key Needs:**\n- Automated analog well selection based on proximity, formation/bench, lateral length, completion design, operator track record, and well type\n- Transparent scoring algorithm for analog selection that can be reviewed and adjusted\n- Type curve generation from selected analogs with statistical confidence bounds (P10/P50/P90)\n- Ability to add/remove analogs and see the impact on the type curve in real time\n- Access to completion details, production histories, and directional surveys for selected analogs\n- Opex assumption entry based on operator history, well type, and basin benchmarks\n- Spud date determination from AFE or manual override\n- Confidence level sign-off: High, Medium, or Low\n- Ability to annotate technical assessment\n\n**Pain Points:**\n- Analog selection is currently subjective -- different analysts choose different wells and get different type curves\n- Building type curves manually in spreadsheets or standalone tools is time-consuming\n- No standardized methodology for analog scoring or weighting\n- Opex assumptions are disconnected from the technical evaluation and handed off informally\n\n### Persona 4: Commercial Analyst\n\n**Role:** Receives the type curve and opex assumptions from the Technical Analyst, the validated DOI from the Land Analyst, and capex from the AFE. Adds economic assumptions: price deck, trade terms/deal structures, discount rate. The economics engine auto-calculates the full model; the Commercial Analyst validates and adjusts the auto-generated economics rather than building from scratch. Produces output for the dashboard. Signs off with confidence level.\n\n**Background:** Financial analyst or commercial evaluator with experience in upstream oil & gas economics, deal structuring, and capital allocation. Understands DCF modeling, NPV/IRR analysis, and the nuances of non-operator deal economics (back-in provisions, promoted interest, sliding scale overrides).\n\n**Key Needs:**\n- Auto-assembled economic model from upstream inputs (type curve, DOI/NRI, capex, price deck, opex)\n- Ability to review and adjust all inputs and assumptions in the auto-generated model\n- Deal structure builder supporting standard WI/NRI, back-in after payout, sliding scale overrides, minimum royalties, promoted interest structures, and custom one-off deal terms\n- Configurable fixed price deck (user-defined flat pricing or escalation schedule)\n- Full cash flow analysis with all components: gross revenue, leasehold burdens (broken out), net revenue, fixed opex, variable opex, total opex, EBITDA, capex, free cash flow, cumulative cash flow\n- Key metrics: NPV (at configurable discount rates), IRR, payout period, ROI, Profitability Index\n- Sensitivity tables on price, production, and cost assumptions\n- Confidence level sign-off: High, Medium, or Low\n- Ability to annotate economic assessment\n\n**Pain Points:**\n- Currently builds economics in Excel, which is error-prone and not connected to the land or technical workstreams\n- Price deck updates are manual\n- No easy way to run multiple scenarios and compare side by side\n- Operating cost assumptions are hard to benchmark and often stale\n- Complex deal structures require bespoke spreadsheet formulas that are fragile and hard to audit\n\n### Persona 5: Commercial Advisory Group (CAG)\n\n**Role:** Reviews the comprehensive deal dashboard. Can change inputs (price, capex, opex, trade terms) and watch the dashboard recalculate live. Votes on each AFE using a 5-point scale: Drill / Lean Drill / Neutral / Lean Drop / Drop -- with mandatory rationale. Multiple users can be assigned this role.\n\n**Background:** Senior commercial, technical, or executive staff who serve as advisory members. May include VP-level managers, senior engineers, portfolio managers, or external advisors. They bring diverse expertise and perspectives to the evaluation.\n\n**Key Needs:**\n- Comprehensive deal dashboard showing the full analysis at a glance\n- Live interactive capability: change any input (price deck, capex, opex, trade terms) and see all charts, tables, and metrics recalculate in real time\n- Production profile chart, revenue waterfall, cash flow analysis (tabular and chart), economics summary\n- Analyst confidence indicators (High/Medium/Low from each analyst stage)\n- Clear recommendation with rationale that explains WHY the system recommends drill or drop\n- Predefined scenario controls (farm-out, price sensitivity, production case, deal structure)\n- 5-point voting interface: Drill / Lean Drill / Neutral / Lean Drop / Drop\n- Mandatory rationale field (at least one line per vote)\n- Visibility into other CAG members' votes and rationale (after voting or in real time, per configuration)\n- Voting summary showing sentiment distribution (\"4 of 6 advisors favor Drill\")\n- Mobile-responsive design for reviewing on phone or tablet\n\n**Pain Points:**\n- Currently receives analysis in disconnected formats (email, spreadsheets, slide decks)\n- Cannot easily explore alternative scenarios without asking an analyst to rebuild the model\n- Advisory input is informal and poorly documented -- no structured voting, no rationale capture\n- No way to see what other advisors think before the decision meeting\n- No mobile access to evaluations while traveling\n\n### Persona 6: Approver (CEO + Delegates)\n\n**Role:** Sole approval authority. Three actions: Approve (Drill) / Decline (Drop) / Send Back (routes to a specific analyst with questions). Delegated approval chain: Primary Approver, 1st Delegate, 2nd Delegate. Time-based escalation configurable by the Administrator. Can delegate via app or SMS.\n\n**Background:** CEO or senior executive with ultimate authority over capital allocation decisions. Frequently traveling. Needs maximum information density with minimum friction. Delegates may include COO, VP of Commercial, or other senior leaders empowered to act on behalf of the CEO.\n\n**Key Needs:**\n- Full deal dashboard with all analysis, analyst confidence levels, and CAG voting summary visible at a glance\n- Three clear action buttons: Approve (Drill) / Decline (Drop) / Send Back\n- Send Back capability that routes to a specific analyst with a written question or concern\n- Approval chain status: who is currently responsible, escalation timeline, deadline countdown\n- SMS delegation: \"Reply DELEGATE to pass to [Name]\" for quick handoff when away from desk\n- In-app, email, and SMS notifications with increasing urgency as deadline approaches\n- Mobile-optimized approval interface for quick action on phone\n- Override capability: can approve even when system or CAG recommends drop (with mandatory annotation)\n- Full decision archive visibility for pattern recognition across past decisions\n\n**Pain Points:**\n- Currently receives analysis only during scheduled meetings or via email\n- No way to act on approvals while traveling without calling the office\n- No systematic delegation when unavailable -- results in missed deadlines\n- Non-consent penalties from missed deadlines are a real financial risk\n- Cannot quickly see advisory group sentiment or analyst confidence to gauge how much review is needed\n\n---\n\n## 5. Workflow & Process\n\nThe Drill or Drop workflow is structured around a parallel processing model where Land and Technical Analysts work simultaneously after AFE ingestion, feeding into an engine-driven economics calculation that the Commercial Analyst validates. The CAG then reviews and votes on the comprehensive deal dashboard, and the Approver makes the final decision through a delegated approval chain with time-based escalation.\n\n### Workflow Diagram\n\n```\nAdmin configures system (one-time + ongoing maintenance)\n  |\n  v\nLand Analyst uploads AFE or confirms email auto-ingestion\n  |\n  v\nSystem parses AFE (vision-language model) + auto-validates against DOI deck and Enverus\n  |\n  +---------------------------+---------------------------+\n  |                           |                           |\n  v                           v                           |\n[Land Analyst validates DOI] [Technical Analyst builds    |\n Reviews matches,             type curve + opex]          |\n investigates discrepancies,  Selects analogs,            |\n overrides if needed,         builds production profile,  |\n signs off with confidence    provides opex assumptions,  |\n                              signs off with confidence    |\n  |                           |                           |\n  +---------------------------+                           |\n  |                                                       |\n  v                                                       |\nEconomics Engine auto-calculates full model                |\n(pulls: type curve from TA, DOI/NRI from Land,            |\n capex from AFE, price deck from settings,                |\n opex from TA/benchmarks)                                 |\n  |                                                       |\n  v                                                       |\nCommercial Analyst validates + adjusts auto-generated model\n Adds deal structure, trade terms, signs off with confidence\n  |\n  v\nComprehensive Deal Dashboard published with full analysis\n  |\n  v\nCAG members review dashboard, change inputs live,\n run scenarios, vote (Drill/Lean Drill/Neutral/Lean Drop/Drop)\n with mandatory rationale\n  |\n  v\nApprover reviews: full analysis + analyst confidence + CAG votes\n  |\n  +---> Approve (Drill) --> Decision archived\n  |\n  +---> Decline (Drop) --> Decision archived\n  |\n  +---> Send Back --> Routes to specific analyst with questions\n  |                   (analyst addresses, re-signs off, returns to CAG/Approver)\n  |\n  +---> No action --> Time-based escalation through delegate chain\n                      Primary Approver --> 1st Delegate --> 2nd Delegate\n                      (via in-app, email, SMS notifications)\n                      |\n                      +---> If deadline passes with no decision --> Non-Consent flag\n```\n\n**Key design change from v1.1:** Land and Technical Analysts work in **parallel** after AFE ingestion, not sequentially. This eliminates the sequential bottleneck and compresses the evaluation timeline.\n\n### Cross-Cutting Workflow Behaviors (New in v2.1)\n\n**Deadline-Aware Prioritization:** Every AFE carries its election deadline as a first-class data field. All workflow views -- analyst queues, CAG dashboard, Approver inbox -- are sorted by deadline urgency by default. Color-coded urgency indicators appear throughout the UI: green (>14 days), amber/yellow (7-14 days), red (<3 days). If an AFE is at risk of missing its deadline based on average processing time, the system proactively alerts all stakeholders.\n\n**Confidence Auto-Gating:** If any analyst (Land, Technical, or Commercial) signs off with **Low** confidence, the system auto-flags the evaluation to the Approver requiring explicit acknowledgment of the uncertainty before a final decision. This transforms confidence from a passive indicator into an active workflow gate. The Approver must annotate that they have reviewed and accepted the risk posed by the low-confidence sign-off.\n\n**Stale Evaluation Detection:** If any workflow stage has been in-progress for more than a configurable number of days without activity, the system flags it as \"stale.\" The Admin and assigned analyst are notified. If the evaluation is stale and the deadline is approaching, the system auto-escalates to the Admin with a recommendation to reassign. Stale evaluations are tracked as a metric visible in admin views.\n\n### Stage 1: AFE Ingestion & Land Validation (Land Analyst)\n\n**Trigger:** An AFE arrives via one of two paths:\n- **Email auto-ingestion:** An AI agent monitors the shared inbox, detects AFE documents, and queues them for the Land Analyst to confirm. The Land Analyst reviews the auto-detected AFE and clicks to confirm ingestion.\n- **Manual upload:** The Land Analyst uploads an AFE PDF directly via drag-and-drop.\n\nApproximately 50 operators send AFEs (3-5 AFEs/month), typically in PDF format.\n\n**Automated Steps:**\n1. The system parses the AFE PDF using a vision-language model to extract key fields:\n   - API number\n   - Well name\n   - Legal description / location (section, township, range)\n   - Proposed working interest / stated interest\n   - Operator name\n   - Proposed depth, formation, lateral length (if stated)\n   - Estimated total cost\n2. Extracted fields are auto-validated against the internal DOI deck (loaded from master Excel spreadsheet)\n3. The system confirms Division of Interest: does the stated interest match internal records?\n4. DOI is cross-referenced against Enverus records (imported via CSV) for independent validation\n5. Discrepancies are flagged with specific detail (e.g., \"AFE states 12.5% WI; internal records show 10.0% WI; Enverus shows 10.0% WI\")\n\n**Manual Review:**\n- Land Analyst reviews the automated matching results\n- Investigates any discrepancies (may require contact with the operator)\n- Can override system-matched values with explanation\n- Adds annotations explaining any adjustments\n- Signs off with confidence level: **High** (data is clean, strong match), **Medium** (some assumptions or minor discrepancies), or **Low** (significant gaps or unresolved issues)\n\n**Output:** Validated working interest, NRI, and leasehold burdens that feed into the economics engine.\n\n**Parallel Note:** This stage runs in parallel with Stage 2 (Technical Evaluation). Both must complete before economics are calculated.\n\n### Stage 2: Technical Evaluation (Technical Analyst) -- PARALLEL WITH STAGE 1\n\n**Trigger:** AFE ingestion (runs concurrently with Land Validation).\n\n**Automated Steps:**\n1. Using the well location and AFE details, the system searches pre-loaded Enverus CSV data to identify candidate analog wells\n2. Analog selection criteria include:\n   - **Proximity:** Wells within a configurable radius of the proposed location\n   - **Formation/Bench:** Same target formation and stratigraphic bench\n   - **Well type:** Matching well type (horizontal, vertical, directional)\n   - **Lateral length:** Similar to proposed (within configurable tolerance)\n   - **Completion design:** Similar proppant loading, stage count, fluid volume\n   - **Operator:** Same operator wells scored higher (configurable weighting)\n   - **Vintage:** Configurable recency weighting\n3. A smart scoring algorithm ranks candidate analogs by composite similarity\n4. Top-N analogs are selected (user-configurable N, default suggested)\n5. Production histories for selected analogs are retrieved from cached CSV data\n6. A type curve is generated:\n   - Normalize production histories to a common time-zero\n   - Apply Arps decline curve fitting (hyperbolic/harmonic/exponential) or modified hyperbolic (b-factor transition)\n   - Generate P10/P50/P90 probability bounds\n7. Spud date is extracted from AFE or set to a user-specified assumption\n8. Monthly production forecast is generated from spud date forward\n\n**Opex Assumptions (New in v2.0):**\n- Technical Analyst provides opex assumptions based on operator history, well type, and basin benchmarks\n- Fixed opex ($/well/month) and variable opex ($/BOE) inputs\n- These feed directly into the economics engine alongside public benchmark defaults\n\n**Manual Review:**\n- Technical Analyst reviews the analog selection and scoring\n- Can add/remove analogs and see real-time type curve updates\n- Reviews the decline model parameters (initial rate, b-factor, Di, terminal decline)\n- Reviews and adjusts opex assumptions\n- Adds annotations on technical risk factors, formation quality, offset well concerns\n- Signs off with confidence level: **High** (strong analogs, clean data), **Medium** (reasonable assumptions, some data gaps), or **Low** (limited data, weak analogs, high uncertainty)\n\n**Output:** Monthly oil and gas production forecast (P10/P50/P90) starting from projected spud date, plus opex assumptions.\n\n**Parallel Note:** This stage runs in parallel with Stage 1 (Land Validation). Both must complete before economics are calculated.\n\n### Stage 3: Economic Analysis (Engine-Driven + Commercial Analyst Validation)\n\n**Trigger:** Both Land Validation and Technical Evaluation sign-offs are complete.\n\n**Engine-Driven Auto-Calculation:**\n\nOnce Land and Technical provide outputs, the economics engine **auto-calculates** the full model by pulling inputs automatically:\n- Type curve (production forecast) from Technical Analyst\n- Validated DOI/NRI and leasehold burdens from Land Analyst\n- Capex from AFE\n- Price deck from system settings (Admin-configured defaults, adjustable by Commercial Analyst)\n- Opex from Technical Analyst assumptions and/or public benchmarks\n\nThe engine produces a complete first-pass economic model without any manual data entry.\n\n**Automated Calculation Steps:**\n1. **Production Forecast:** Monthly oil (bbl) and gas (Mcf) volumes from the type curve\n2. **Commodity Pricing:** User-configured fixed price deck (flat or escalation schedule) with optional basin-specific differentials\n3. **Gross Revenue:** Monthly production x applicable price\n4. **Net Revenue Interest (NRI):** Apply validated leasehold burdens\n   - NRI = WI x (1 - royalty burden - overriding royalties - other burdens)\n   - Net revenue = gross revenue x NRI\n5. **Deal Structure Application:** Apply the configured deal structure (standard WI/NRI, back-in after payout, sliding scale overrides, minimum royalty, promoted interest, or custom structure)\n6. **Operating Expenses:** Fixed opex + variable opex with escalation\n7. **EBITDA:** Net revenue - operating expenses\n8. **Capital Expenditures:** Gross capex from AFE; net capex adjusted for WI and any carry provisions\n9. **Free Cash Flow:** EBITDA - capex (applied in month 0 or spread per drilling schedule)\n10. **Cumulative Cash Flow:** Running total of free cash flow over time\n11. **Discounted Cash Flow (DCF):** Apply configurable discount rate (default 10%)\n12. **Key Metrics:** NPV, IRR, payout period, ROI, Profitability Index, undiscounted net cash flow\n\n**Commercial Analyst Role (Validate + Adjust):**\n- Reviews the auto-generated economic model\n- Adjusts price assumptions, opex, discount rate, deal structure parameters as needed\n- Configures deal structure via the deal structure builder:\n  - **Standard WI/NRI:** Fixed working interest and NRI throughout well life\n  - **Back-In After Payout:** WI increases after payout threshold\n  - **Sliding Scale Override:** Interest changes based on price, production, or date triggers\n  - **Minimum Royalty:** Floor royalty payment regardless of production\n  - **Promoted Interest:** Cost carry through a defined phase\n  - **Custom Structure:** Flexible rule builder for arbitrary splits, triggers, and overrides\n- Adds trade terms and any additional deal-specific economics\n- Reviews sensitivity to key variables\n- Adds annotations on economic risk factors and assumptions\n- Signs off with confidence level: **High** (solid economics, clean inputs), **Medium** (reasonable but some assumptions), or **Low** (high uncertainty, limited data)\n\n**Output:** Full economic model with key metrics, monthly cash flow schedule, and dashboard-ready data reflecting the configured deal structure.\n\n### Stage 4: CAG Review & Voting\n\n**Trigger:** Commercial Analyst sign-off publishes the comprehensive deal dashboard.\n\n**Dashboard (Live Interactive Financial Model):**\n\nThe dashboard is not a static report. It is a comprehensive deal dashboard AND live financial model with the following required components:\n\n- **Production Profile Chart:** Type curve with decline over time (oil + gas)\n- **Revenue Waterfall/Breakdown:** Gross revenue -> royalty burden -> ORRI -> other burdens -> net revenue\n- **Full Cash Flow Analysis** showing ALL components:\n  - Gross Revenue, Leasehold Burdens (broken out), Net Revenue, Fixed Opex, Variable Opex, Total Opex, EBITDA, Capex, Free Cash Flow, Cumulative Cash Flow\n  - Available in **both tabular AND chart formats**\n- **Economics Summary:** NPV, IRR, Payout, ROI, PI with detail\n- **Recommendation with Rationale:** Not just a banner -- explains WHY the system recommends drill or drop based on the specific economics and risk factors\n- **Analyst Confidence Indicators:** High/Medium/Low from each analyst (Land, Technical, Commercial)\n- **Voting Summary:** CAG sentiment distribution and individual votes with rationale\n- **Approval Chain Status:** Who is next to approve, escalation timeline, deadline countdown\n\n**Live Interactive Capability:**\n- CAG members can change inputs directly: capex, price deck, opex, trade terms/deal structure\n- Everything recalculates in real time -- charts, tables, metrics, recommendation\n- Recommendation can flip (DRILL to DROP or vice versa) based on changed inputs\n- Predefined scenario controls (farm-out, price sensitivity, production case, deal structure) are integrated into the live model\n\n**Voting Model:**\n- 5-point scale: **Drill / Lean Drill / Neutral / Lean Drop / Drop**\n- Mandatory rationale: at least one line explaining the vote\n- Dashboard shows sentiment summary (e.g., \"4 of 6 advisors favor Drill\")\n- All votes and rationale are visible to the Approver\n- Multiple CAG members can be assigned; all vote independently\n\n### Stage 5: Approval & Escalation\n\n**Trigger:** CAG voting complete (or Approver can act before all CAG votes are in).\n\n**Approval Actions:**\n- **Approve (Drill):** Accept the AFE and commit capital. Decision archived with full context.\n- **Decline (Drop):** Reject the AFE. Decision archived with full context.\n- **Send Back:** Route the evaluation back to a specific analyst with written questions or concerns. The analyst addresses the issues, re-signs off, and the evaluation returns to the CAG/Approver stage.\n\n**Delegated Approval Chain:**\n- Admin configures: Primary Approver -> 1st Delegate -> 2nd Delegate\n- Escalation threshold: configurable number of days before the election deadline\n- When the threshold is reached without action from the current approver, the system auto-escalates to the next person in the chain\n- Notifications increase in urgency as the deadline approaches:\n  - **In-app:** All workflow events\n  - **Email:** Sign-off requests, escalations, approaching deadlines\n  - **SMS:** Urgent escalations and quick delegation\n- Any person in the chain can manually delegate at any time via app or SMS (\"Reply DELEGATE to pass to [Name]\")\n- If nobody acts before the election deadline: system flags as **Non-Consent**\n\n**Non-Consent Handling:**\n- Non-consent penalties are captured in the land records / DOI deck\n- The system records the non-consent outcome in the decision archive\n- The app is decision support and tracking -- it does not execute real-world actions (operator communications, election filings happen outside the app for now)\n- **Future v2:** Connect agreements to assets to surface penalty implications automatically when a non-consent flag is triggered\n\n---\n\n## 6. Data Architecture (High Level)\n\n### Data Sources\n\n| Source | Data | Format | Access Method | Refresh | Role |\n|--------|------|--------|---------------|---------|------|\n| AFE Documents | Well proposals | PDF | Email auto-ingestion + manual upload | Event-driven | Primary |\n| Internal DOI Deck | DOI, WI, burdens, lease info, non-consent penalties | Excel (.xlsx) | Single master spreadsheet loaded into app database | Manual upload by Admin | Primary |\n| TX RRC (Railroad Commission) | Well data, production (monthly), drilling permits, completions, field data, digital maps | CSV/ASCII/Shapefiles | Free bulk file downloads from RRC website | Weekly to monthly | Primary (TX) |\n| NM OCD (Oil Conservation Division) | Wells, production statistics, well injection totals | JSON/CSV/GeoJSON | Free REST API (ArcGIS-based) via OCD Hub | Near real-time | Primary (NM) |\n| WY WOGCC (Oil & Gas Conservation Commission) | Well info, location, status, API numbers, permits, production | CSV/GeoJSON/JSON | Free REST API via Data Explorer | Configurable | Primary (WY) |\n| Enverus | Well headers, production, completions, DOI, surveys | CSV | CSV import from Enverus data exports | Manual upload / batch import | Enrichment / Fallback |\n| Fixed Price Deck | WTI, Henry Hub prices | User config | Admin-configurable in application | Manual update | Primary |\n| Public Opex Benchmarks | LOE per BOE by basin, operator | Curated dataset | Manual curation from public filings, 10-Ks | Quarterly/Annual | Primary |\n| Opex (TA Input) | Fixed and variable opex assumptions | User input | Technical Analyst provides per evaluation | Per AFE | Primary |\n\n**Data Source Strategy (v2.1):** Free state regulatory data serves as the primary foundation for well and production data across the target basins. Enverus CSV imports provide enrichment (completions detail, DOI cross-referencing, directional surveys) and serve as the primary fallback for Louisiana/Haynesville data where no reliable public API exists. A unified data normalization layer ingests from all sources into a common internal schema.\n\n### Data Flow (Parallel Model)\n\n```\nAFE (Email or Manual Upload)\n         |\n         v\n[Vision-Language Model Parser] --> AFE Data Store\n         |\n         +--------------------------------------------+\n         |                                            |\n         v                                            v\n[Land Validation Engine]                    [Analog Selection Engine]\n Internal DOI Deck (Excel) ---->             Enverus CSV Data ---->\n Enverus CSV (DOI cross-ref) -->             (well search, scoring)\n         |                                            |\n         v                                            v\n Validated DOI/NRI/Burdens              [Type Curve Engine] --> Production Forecast\n (Land Analyst sign-off                  Opex Assumptions\n  with confidence level)                 (Technical Analyst sign-off\n         |                                with confidence level)\n         |                                            |\n         +--------------------+-----------------------+\n                              |\n                              v\n                    [Economics Engine]  <-- Price Deck (Settings)\n                    (Auto-calculates)  <-- Capex (from AFE)\n                              |\n                              v\n                    Auto-Generated Economic Model\n                    (Commercial Analyst validates/adjusts,\n                     signs off with confidence level)\n                              |\n                              v\n                   Comprehensive Deal Dashboard\n                   (Live Interactive Financial Model)\n                              |\n                              v\n                    CAG Review + Live Scenarios\n                    (5-Point Voting with Rationale)\n                              |\n                              v\n                    Approver Decision\n                    (Drill / Drop / Send Back)\n                    Delegated Chain + Escalation\n                              |\n                              v\n                    Decision Archive\n                    (includes votes, confidence, non-consent tracking)\n```\n\n### State Regulatory Data Strategy (New in v2.1)\n\nThe client's target basins span four states. Each state's oil and gas regulatory body publishes well and production data, but availability and access methods vary significantly:\n\n**Texas (RRC -- Railroad Commission of Texas):**\n- No API, but free bulk file downloads available at https://www.rrc.texas.gov/resource-center/research/data-sets-available-for-download/\n- Datasets: Production data (monthly, CSV/ASCII), well data (weekly, ASCII), drilling permits, completion data, field data, digital map data (shapefiles)\n- Update frequency: Monthly to weekly depending on dataset\n- Coverage: Permian Basin (Midland sub-basin in West TX), Eagle Ford (South TX), and the Texas portion of the Haynesville\n- Implementation: Scheduled bulk download, parse ASCII/CSV into normalized schema, incremental updates via date-filtered downloads\n\n**New Mexico (OCD -- Oil Conservation Division):**\n- Free REST API via OCD Hub (ArcGIS-based) at https://api.emnrd.nm.gov/\n- Datasets: Oil and gas wells, production statistics (OG Statistics), well injection totals\n- Formats: JSON, CSV, GeoJSON\n- Additional resources: OCD Well Search tool (completions, formation tops, casing, perfs, production), NM Tech Octane Database (monthly production data)\n- Coverage: Permian Basin (Delaware sub-basin in SE NM)\n- Implementation: Direct API integration with pagination, scheduled sync\n\n**Wyoming (WOGCC -- Oil & Gas Conservation Commission):**\n- Free REST API via Data Explorer\n- Datasets: Well info, location, status, API numbers, permits, production data\n- Formats: CSV, GeoJSON, JSON\n- Additional resources: Wyoming Geospatial Hub (full state or user-defined area downloads)\n- Coverage: Powder River Basin\n- Implementation: Direct API integration, scheduled sync with incremental updates\n\n**Louisiana (SONRIS -- Strategic Online Natural Resources Information System):**\n- No clear public API for programmatic access\n- Web-based Interactive Data Reports available (free) but not API-accessible\n- ArcGIS MapServer exists but SSL certificate is expired and reliability is unclear\n- DODA export tool appears to be internal/government-only\n- Coverage: Haynesville (Louisiana side)\n- Implementation: **Enverus CSV import is the primary data path for Louisiana.** Alternative: contact LA DNR directly about bulk data access for future improvement\n\n**Data Ingestion Strategy:**\n- **Primary (free):** TX RRC bulk downloads, NM OCD API, WY WOGCC API\n- **Fallback/enrichment:** Enverus CSV imports for Louisiana and any data gaps across all states\n- **Future upgrade:** Enverus Developer API v3 when/if subscription includes it\n- **Architecture:** A unified data normalization layer ingests from all state formats and Enverus into a common internal schema. All downstream components (analog selection, type curve, DOI cross-reference) query the normalized layer and are agnostic to the original data source.\n\n### Data Model Provisions for Future Features (New in v2.1)\n\nThe following data model structures are included in v1 to support planned v2 features, even though the corresponding UI or analytics are deferred:\n\n**Operator Performance Scorecard Data Model (supports v2 Operator Scorecards):**\n- Operator entity with performance tracking fields: average EUR, IP-30, IP-90, completion design consistency metrics, historical DOI accuracy rate, AFE decision history\n- Relationships: Operator -> Wells (from state data + Enverus), Operator -> AFE Evaluations (from decision archive)\n- Data accumulates automatically as evaluations are processed; v2 UI will surface it as scorecards\n\n**Decision Outcome Feedback Loop Data Model (supports v2 Variance Analysis):**\n- For every \"Drill\" decision, the system creates a pending \"Outcome Record\" expecting future production data\n- Import mechanism for actual production data (same state data + Enverus CSV paths)\n- Auto-match to historical decisions by API number\n- Status tag on archived decisions: \"Awaiting Production Data\" / \"Production Data Available\" / \"Not Applicable (Dropped)\"\n- No variance analysis UI in v1 -- data collection only to eliminate the cold-start problem for v2\n\n### Storage Considerations\n\n- **AFE Documents:** Store original PDFs and parsed/extracted data. Maintain version history if re-parsed.\n- **DOI Deck:** Structured database loaded from a single master Excel spreadsheet. Support incremental updates. Track change history. Include non-consent penalty data.\n- **Well Data Cache:** Store Enverus CSV data in the application database. Refresh when new CSV exports are uploaded. Future: API integration for on-demand refresh.\n- **Economic Models:** Store all inputs and outputs for every evaluation, including deal structure configuration. Immutable once signed off. Track auto-generated vs. analyst-adjusted versions.\n- **Votes:** Store all CAG votes with rationale, timestamp, and user identity. Immutable once cast.\n- **Decisions:** Full audit trail -- who decided, when, with what recommendation, all analyst confidence levels, all CAG votes, any Send Back history, any override, annotations.\n- **Scenarios:** Store user-created scenarios for retrieval and comparison.\n- **Historical Decisions:** Import path for historical evaluations from spreadsheets to seed the decision archive.\n- **Notification Log:** Record all notifications sent (in-app, email, SMS) for audit and troubleshooting.\n\n---\n\n## 7. Key Features\n\n### MVP Features (v1)\n\n**P0 -- Must Have:**\n\n1. **AFE Ingestion (Dual-Path)**\n   - Email auto-ingestion: AI agent monitors shared inbox, queues AFEs for Land Analyst confirmation\n   - Manual upload: drag-and-drop PDF upload\n   - Vision-language model parsing to extract key fields\n   - Store parsed data in structured format\n\n2. **DOI Deck Management (Admin)**\n   - Upload single master Excel-based DOI deck / land records into the application\n   - Version history and change tracking\n   - Non-consent penalty data captured per asset/lease\n\n3. **Land Validation with Confidence Sign-Off**\n   - Match AFE wells against DOI deck by API number, legal description\n   - Cross-reference DOI/burdens against Enverus CSV records\n   - Flag discrepancies with severity and specific detail\n   - Override capability with explanation\n   - Confidence level sign-off: High / Medium / Low\n\n4. **Enverus CSV Import (Primary Data Path)**\n   - Import Enverus data via CSV export files\n   - Map CSV columns to internal schema with configurable column mapping\n   - Support for well headers, production data, completions, DOI\n   - Search for analog wells by location and attributes within imported data\n\n5. **Analog Well Selection & Type Curve**\n   - Multi-criteria scoring algorithm for analog selection (proximity, formation, well type, completion, operator, vintage)\n   - Arps decline curve fitting to generate type curve\n   - P50 production forecast (P10/P90 stretch goal for MVP)\n   - Technical Analyst provides opex assumptions alongside type curve\n\n6. **Engine-Driven Economics with Deal Structure Builder**\n   - Auto-calculation from upstream inputs (type curve, DOI/NRI, capex, price deck, opex)\n   - Commercial Analyst validates and adjusts (not build from scratch)\n   - Monthly cash flow model with full component breakdown\n   - Deal structure builder: standard WI/NRI, back-in after payout, sliding scale overrides, minimum royalties, promoted interest, custom one-off\n   - NPV, IRR, payout period, ROI, PI at configurable discount rates\n   - Fixed price deck (user-configurable flat pricing or escalation schedule)\n   - Curated opex benchmarks (basin/operator lookup with manual override)\n\n7. **Confidence Level Sign-Offs**\n   - All three analyst roles (Land, Technical, Commercial) sign off with High / Medium / Low confidence\n   - Confidence levels displayed on dashboard and visible to CAG and Approver\n\n8. **Comprehensive Deal Dashboard (Live Interactive)**\n   - Production profile chart (type curve decline, oil + gas)\n   - Revenue waterfall/breakdown (gross -> burdens -> net)\n   - Full cash flow analysis in both tabular AND chart formats\n   - Economics summary: NPV, IRR, Payout, ROI, PI\n   - Recommendation with rationale (explains WHY)\n   - Analyst confidence indicators\n   - Voting summary from CAG\n   - Approval chain status with deadline countdown\n   - Live recalculation: change inputs and watch everything update\n   - Predefined scenario controls integrated into live model\n   - Light theme, modern, clean, professional UI\n\n9. **CAG Voting System**\n   - 5-point scale: Drill / Lean Drill / Neutral / Lean Drop / Drop\n   - Mandatory rationale (at least one line per vote)\n   - Sentiment summary display (\"4 of 6 advisors favor Drill\")\n   - All votes and rationale visible to Approver\n   - Multiple users assignable to CAG role\n\n10. **Delegated Approval Chain with Escalation**\n    - Admin configures: Primary Approver -> 1st Delegate -> 2nd Delegate\n    - Three approval actions: Approve (Drill) / Decline (Drop) / Send Back\n    - Send Back routes to specific analyst with questions\n    - Time-based escalation (configurable days before election deadline)\n    - Auto-escalation with notifications\n    - Manual delegation via app or SMS (\"Reply DELEGATE to pass to [Name]\")\n\n11. **Notification System**\n    - In-app notifications for all workflow events\n    - Email notifications for sign-off requests, escalations, approaching deadlines\n    - SMS for urgent escalations and quick delegation\n    - Periodic notifications increasing in urgency as deadline approaches\n\n12. **Non-Consent Handling**\n    - If election deadline passes with no approval decision -> system flags as Non-Consent\n    - Non-consent penalties captured in DOI deck / land records\n    - Non-consent outcome recorded in decision archive\n\n13. **Role-Based Access and User Management (Admin)**\n    - Six roles: Administrator, Land Analyst, Technical Analyst, Commercial Analyst, CAG, Approver\n    - Admin manages user accounts and role assignments\n    - Multiple users per role (especially CAG)\n    - Data source connection configuration\n    - Approval chain and escalation rule configuration\n\n14. **Decision Logging & Archive**\n    - Record decisions with timestamp, user, recommendation, override, annotations\n    - Include all CAG votes and rationale\n    - Include all analyst confidence levels\n    - Include Send Back history\n    - Include non-consent records\n    - Decision archive with search and filter\n\n15. **Mobile-Responsive Design**\n    - Responsive layout for phone and tablet\n    - All dashboard features accessible on mobile browsers\n    - Optimized for executive review and approval on the go\n    - SMS delegation and approval actions from mobile\n\n16. **Historical Decision Data Import**\n    - Import path for historical AFE evaluations from spreadsheets\n    - Map spreadsheet columns to decision archive schema\n    - Seed the decision archive with past decisions for institutional memory\n\n17. **Confidence Auto-Gating** (New in v2.1)\n    - If any analyst signs off with Low confidence, system auto-flags the evaluation to the Approver requiring acknowledgment\n    - Approver must annotate acceptance of the uncertainty before making a final decision\n    - Transforms confidence from passive indicator into active workflow gate\n\n18. **Deadline-Aware Prioritization** (New in v2.1)\n    - All queues and views sorted by election deadline urgency by default\n    - Color-coded urgency indicators: green (>14 days), amber (7-14 days), red (<3 days)\n    - Proactive alerts when processing time estimates suggest a deadline is at risk\n\n19. **Breakeven Auto-Calculation** (New in v2.1)\n    - Auto-compute breakeven oil price, gas price, capex, opex, and minimum WI for every deal (NPV = 0)\n    - Display breakeven metrics on the dashboard alongside the economics summary\n    - Include \"margin of safety\" framing in recommendation rationale\n\n20. **Asymmetric Risk Framing** (New in v2.1)\n    - P10 upside vs P90 downside with regret analysis displayed on the dashboard\n    - 2x2 table: Drill vs. Drop outcomes at P10 vs. P90\n    - Maximum loss (dry hole capex exposure) prominently displayed\n    - Shifts decision frame from \"is this a good well?\" to \"is the risk-reward acceptable?\"\n\n21. **Stale Evaluation Detection** (New in v2.1)\n    - Flag evaluations with no activity for a configurable period\n    - Notify Admin and assigned analyst; auto-escalate if deadline is approaching\n    - Track stale evaluation metrics in admin views\n\n22. **Decision Outcome Data Model** (New in v2.1)\n    - For every \"Drill\" decision, create pending Outcome Record for future production data\n    - Auto-match actual production data to historical decisions by API number\n    - Data model only -- no variance analysis UI in v1; seeds v2 analytics\n\n23. **PDF Template Library** (New in v2.1)\n    - Cache extraction mappings for known operators after successful parses\n    - Template-based extraction for repeat operators (fast, cheap, deterministic)\n    - Fall back to vision-language model only for new operators or template mismatches\n    - Reduces AI API costs over time as template library grows\n\n24. **Export Package** (New in v2.1)\n    - One-click PDF report with all dashboard components (charts, tables, economics, recommendation, confidence, votes)\n    - Excel workbook with the full economic model for audit\n    - Executive summary slide (single-page format for board presentation)\n    - Reflects current dashboard state including any scenario adjustments\n\n25. **State Regulatory Data Integration** (New in v2.1)\n    - Ingest well and production data from TX RRC (bulk download), NM OCD (API), WY WOGCC (API)\n    - Unified data normalization layer mapping multiple state formats into common schema\n    - Enverus CSV as enrichment and Louisiana fallback\n    - Scheduled sync with incremental updates\n\n**P1 -- Should Have (MVP if time permits):**\n\n26. **Enverus API Integration (Upgrade Path)**\n    - Query Enverus Developer API for real-time well headers, production data, completions\n    - Dynamic analog well search via API\n    - Supplement CSV and state data with on-demand API queries\n\n### Future Features (v2+)\n\n27. **Conversational AI for Scenarios**\n    - Natural language chat interface\n    - Interpret user requests and execute dynamic calculations\n    - Display results inline in the dashboard\n\n28. **Live Commodity Pricing**\n    - EIA API integration for daily WTI and Henry Hub prices\n    - CME futures strip pricing\n    - Toggle between fixed price deck and live pricing\n\n29. **Portfolio View & Comparison**\n    - Side-by-side ranking of active AFEs\n    - Summary metrics across the portfolio\n\n30. **Post-Drill Variance Analysis**\n    - Compare projected production/economics vs. actual\n    - Identify systematic biases in the model\n    - Leverages Decision Outcome Data Model (v1 feature #22)\n\n31. **Operator Performance Scorecards**\n    - Auto-generated from state data, Enverus data, and decision archive\n    - Average well performance (EUR, IP-30, IP-90), completion design consistency, historical DOI accuracy, past AFE decisions\n    - Displayed alongside AFE on dashboard\n    - Leverages Operator Performance data model built in v1\n\n32. **Portfolio-Level Capital Allocation**\n    - Rank AFEs by risk-adjusted return\n    - Capital allocation optimizer across the portfolio\n\n33. **Advanced Opex Modeling**\n    - Operator-specific opex from 10-K filings\n    - Machine learning model trained on public data\n\n34. **Automated Operator Communication**\n    - Generate reconciliation requests when DOI discrepancies are found\n    - Track communication history\n\n35. **Agreement-to-Asset Linking for Non-Consent Penalties**\n    - Connect agreements to assets to surface penalty implications automatically when non-consent is flagged\n\n---\n\n## 8. AI & Automation Capabilities\n\nAI and automation are embedded throughout the Drill or Drop workflow. The system is designed to automate the repeatable, data-intensive mechanics while preserving human expert judgment at critical decision points. The v2.0 architecture emphasizes engine-driven economics and parallel processing.\n\n### AFE Ingestion & Parsing\n\n**AI Capability:** Document intelligence / structured extraction + email monitoring\n\n- **Email Auto-Ingestion Agent:** Monitors the shared inbox for incoming AFE documents. Uses classification to identify AFE-related emails and attachments. Queues detected AFEs for Land Analyst confirmation.\n- **PDF Parsing:** Vision-language model (e.g., GPT-4 Vision, Claude) interprets the AFE document and extracts structured fields based on a prompt template. Handles layout variability across ~50 operator formats without training custom models.\n- **Field Matching:** Fuzzy matching algorithms to match extracted well names, API numbers, and legal descriptions against the DOI deck. Handle common variations (abbreviations, formatting differences, typos).\n- **Auto-Validation:** Automated comparison logic flags mismatches between AFE-stated interest, DOI deck, and Enverus data. Categorize discrepancies by severity.\n\n### Parallel Analyst Workstreams\n\n**AI Capability:** Intelligent search, similarity scoring, statistical modeling\n\n- **Analog Scoring Engine:** Multi-dimensional similarity scoring that weights proximity, formation match, well type, lateral length, completion design, operator, and vintage. Transparent and tunable scoring.\n- **Smart Filtering:** Exclude wells with anomalous production profiles (mechanical failures, curtailments, data quality issues).\n- **Type Curve Generation:** Automated decline curve fitting using Arps models with best-fit parameter selection. P10/P50/P90 from the analog set.\n- **Adaptive Learning (Future):** As the system accumulates decision history and post-drill performance data, analog scoring weights can be refined.\n\n### PDF Template Library (New in v2.1)\n\n**AI Capability:** Adaptive extraction with template caching\n\n- **Template Learning:** After the Land Analyst confirms a successful parse, the system stores the extraction mapping as a \"template\" for that operator.\n- **Template-First Extraction:** For future AFEs from the same operator, the system first attempts template-based extraction (fast, cheap, deterministic).\n- **Vision-Language Model Fallback:** Falls back to the full vision-language model only for new operators or template mismatches.\n- **Cost Reduction:** Over time, the template library covers most incoming AFEs (~50 operators), reducing AI API costs per AFE and improving processing speed.\n- **Template Maintenance:** Templates are versioned. If an operator changes their AFE format, the mismatch is detected and the vision-language model re-processes, generating an updated template.\n\n### Engine-Driven Economics\n\n**AI Capability:** Automated model assembly, calculation engine, deal structure modeling\n\n- **Auto-Calculation:** The economics engine assembles the complete model automatically from upstream inputs once Land and Technical sign off. No manual data entry required for the first pass.\n- **Input Sourcing:** Type curve from Technical Analyst, DOI/NRI from Land Analyst, capex from AFE, price deck from system settings, opex from Technical Analyst/benchmarks -- all pulled automatically.\n- **Deal Structure Engine:** Applies complex deal structures including back-in provisions, sliding scale overrides, minimum royalties, promoted interest calculations, and custom user-defined structures.\n- **Sensitivity Engine:** Automated sensitivity analysis across key variables with tornado chart generation.\n- **Breakeven Auto-Calculation (New in v2.1):** Automatically computes breakeven oil price, gas price, capex, opex, and minimum working interest for every deal (the value at which NPV = 0). Breakeven metrics are displayed on the dashboard alongside the economics summary. The recommendation rationale references breakeven margins (e.g., \"Current oil price of $70/bbl is $18/bbl above the breakeven price of $52/bbl, providing a 35% margin of safety\").\n- **Commercial Analyst as Validator:** The Commercial Analyst's role shifts from building the model to validating and adjusting the auto-generated model, significantly reducing turnaround time and error potential.\n\n### Live Interactive Dashboard\n\n**Capability:** Real-time parameterized recalculation\n\n- **Live Recalculation:** When any user (CAG or Approver) changes an input on the dashboard, the entire model recalculates instantly -- charts, tables, metrics, and recommendation all update.\n- **Recommendation Engine:** Synthesizes land validation confidence, technical risk assessment, economic returns, and analyst confidence levels into a composite drill/drop recommendation with explanatory rationale.\n- **Scenario Controls:** Integrated sliders, toggles, and inputs for farm-out %, price sensitivity, production case, deal structure, opex, and financing terms.\n- **Scenario Comparison:** Users can save named scenarios for side-by-side comparison.\n\n### Notification & Escalation Engine\n\n**Capability:** Multi-channel notification with urgency escalation\n\n- **Workflow Notifications:** In-app notifications triggered by all workflow state changes (AFE ingested, sign-off complete, vote cast, decision made).\n- **Escalation Notifications:** Email and SMS notifications triggered by approaching deadlines and approval chain escalation.\n- **Urgency Gradient:** Notification frequency and channel intensity increase as the election deadline approaches.\n- **SMS Delegation:** Quick-response SMS capability for delegation without opening the app.\n\n### Cross-Cutting AI\n\n- **Inbox Monitoring Agent:** Watches the shared inbox for incoming AFE documents and auto-triggers the ingestion pipeline.\n- **Confidence Aggregation:** Synthesizes individual analyst confidence levels into an overall assessment displayed prominently on the dashboard.\n\n---\n\n## 9. Scenario Modeling & Live Dashboard\n\nScenario modeling in v2.0 is no longer a separate stage -- it is embedded directly into the comprehensive deal dashboard as a live interactive capability. CAG members and the Approver interact with the same live financial model.\n\n### Live Interactive Dashboard (Primary Interface)\n\nThe dashboard serves dual purposes: it is the comprehensive deal summary AND the live scenario modeling tool. When any input changes, everything recalculates:\n\n| Input | Control Type | Range | What Recalculates |\n|-------|-------------|-------|-------------------|\n| Farm-Out | Slider | 0-100% | WI, capex share, revenue share, all economics |\n| Oil Price | Slider / Input | +/- 50% from base | Revenue, cash flow, NPV, IRR, payout, recommendation |\n| Gas Price | Slider / Input | +/- 50% from base | Revenue, cash flow, NPV, IRR, payout, recommendation |\n| Production Case | Toggle | P10 / P50 / P90 | Production forecast, revenue, all economics |\n| Discount Rate | Input | 0-25% | NPV, PI |\n| Opex (Fixed) | Input | $/well/month | Cash flow, EBITDA, NPV, IRR, payout |\n| Opex (Variable) | Input | $/BOE | Cash flow, EBITDA, NPV, IRR, payout |\n| Capex | Input | $ | Cash flow, NPV, IRR, payout, ROI |\n| Deal Structure | Dropdown + Config | Presets + Custom | NRI schedule, cash flow splits, all economics |\n| Before/After Payout | Toggle + Config | On/Off + Split % | WI schedule, cash flow splits, all economics |\n| Financing Terms | Input | Custom | Net capex, cash flow, all return metrics |\n\n**Dashboard Components (all update live):**\n\n1. **Production Profile Chart** -- Type curve showing oil and gas production decline over time\n2. **Revenue Waterfall** -- Visual breakdown: gross revenue -> royalty burden -> ORRI -> other burdens -> net revenue\n3. **Cash Flow Table** -- Monthly/annual with columns for: Gross Revenue, each Leasehold Burden, Net Revenue, Fixed Opex, Variable Opex, Total Opex, EBITDA, Capex, Free Cash Flow, Cumulative Cash Flow\n4. **Cash Flow Chart** -- Visual representation of the cash flow table (stacked bar or area chart)\n5. **Economics Summary Panel** -- NPV, IRR, Payout (months), ROI, PI -- prominently displayed\n6. **Recommendation Banner with Rationale** -- DRILL or DROP with a paragraph explaining WHY based on the current inputs\n7. **Analyst Confidence Indicators** -- Three badges showing High/Medium/Low from Land, Technical, and Commercial Analysts\n8. **CAG Voting Summary** -- Sentiment distribution chart + individual votes with rationale\n9. **Approval Chain Status** -- Current approver, escalation timeline, deadline countdown\n\n### Breakeven Sensitivity Display (New in v2.1)\n\nThe dashboard prominently displays auto-calculated breakeven points alongside the economics summary:\n\n| Breakeven Metric | Description | Display |\n|-----------------|-------------|---------|\n| Breakeven Oil Price | WTI price at which NPV = 0 | $/bbl with margin vs. current price |\n| Breakeven Gas Price | HH price at which NPV = 0 | $/Mcf with margin vs. current price |\n| Breakeven Capex | Maximum capex at which well still works | $ with margin vs. AFE capex |\n| Breakeven Opex | Maximum opex at which well still works | $/BOE with margin vs. assumed opex |\n| Breakeven WI | Minimum working interest worth participating | % with margin vs. stated WI |\n\nThese breakeven values update live when any dashboard input changes.\n\n### Asymmetric Risk Framing (New in v2.1)\n\nThe recommendation section of the dashboard includes an asymmetric risk analysis panel:\n\n- **Upside case (P10):** NPV, IRR, and payout if the well outperforms\n- **Base case (P50):** Expected scenario economics\n- **Downside case (P90):** NPV, IRR, and payout if the well underperforms\n- **Maximum loss:** Capex exposure if the well is a total dry hole\n- **Regret analysis:** Presented as a 2x2 decision matrix:\n\n| | Well Performs (P10-P50) | Well Underperforms (P90) |\n|---|---|---|\n| **Drill** | Upside captured (NPV at P10) | Downside realized (NPV at P90) |\n| **Drop** | Opportunity cost forfeited | Loss avoided |\n\nThis framing shifts the decision from \"is this a good well?\" to \"is the risk-reward profile acceptable given our portfolio and capital position?\" -- how sophisticated capital allocators actually think. The regret analysis values update live with all other dashboard components.\n\n**Scenario Comparison:**\n- Users can save the current state as a named scenario\n- Side-by-side comparison view shows key metrics across saved scenarios\n- Scenario history is stored as part of the evaluation record\n\n### Future: Conversational AI Scenarios (v2+)\n\nA conversational AI interface is planned for a post-MVP release. This will accept natural language requests and dynamically execute them:\n\n**Example interactions (planned for v2):**\n\n> **User:** \"What happens if we farm out 50% and oil drops to $55?\"\n> **System:** Adjusts the live model to 50% farm-out and $55/bbl WTI. Dashboard recalculates instantly.\n\n> **User:** \"What price does oil need to be for this well to break even?\"\n> **System:** Runs a goal-seek analysis to find the oil price at which NPV = 0.\n\n---\n\n## 10. Decision Archive & Analytics\n\n### Decision Archive\n\nEvery AFE evaluation produces a decision record that is stored immutably in the system:\n\n**Record Contents:**\n- AFE identifier (API number, well name, operator)\n- Evaluation date range (received to decision)\n- Land validation results, confidence level, and sign-off timestamp\n- Analog wells selected, type curve parameters, opex assumptions, technical confidence level, and sign-off timestamp\n- Economic model inputs and outputs (including deal structure configuration), commercial confidence level, and sign-off timestamp\n- Auto-generated economic model (before Commercial Analyst adjustments) -- preserved for audit\n- System-generated recommendation (drill/drop with rationale)\n- Expert-validated recommendation (after all sign-offs)\n- **CAG votes:** Each member's vote (5-point scale), rationale, and timestamp\n- **CAG sentiment summary:** Aggregated vote distribution\n- Final decision: Approve (Drill) / Decline (Drop) / Non-Consent\n- Send Back history: any questions sent to analysts, responses, and re-sign-off records\n- Override annotation (if Approver overrode recommendation)\n- Approval chain activity: who was notified, who escalated, who acted, delegation history\n- All scenarios explored during the evaluation\n- **Non-consent record:** If deadline passed without decision, record the non-consent flag, associated penalties from DOI deck, and contributing factors (e.g., approval chain exhausted, no CAG votes, etc.)\n\n**Search & Filter:**\n- By operator, basin, formation, date range, decision outcome\n- By economic metrics (e.g., \"show all wells where NPV > $1M\")\n- By override status (e.g., \"show all overrides\")\n- By analyst confidence level (e.g., \"show all evaluations where any analyst flagged Low confidence\")\n- By CAG sentiment (e.g., \"show all evaluations where majority voted Lean Drop or Drop\")\n- By non-consent status\n- By approval chain activity (e.g., \"show all evaluations that escalated to 2nd Delegate\")\n\n### Historical Decision Data Import\n\nThe system provides a spreadsheet import path for seeding the decision archive with historical AFE evaluations. This allows the organization to build institutional memory from day one, even for decisions made before Drill or Drop was deployed.\n\n**Import Capabilities:**\n- Upload historical evaluation spreadsheets (Excel format)\n- Configurable column mapping to map spreadsheet fields to the decision archive schema\n- Support for partial records (not all fields may be available for historical decisions)\n- Validation and error reporting for imported records\n- Historical records are clearly tagged as \"imported\" vs. \"native\" in the archive\n\n### Future: Post-Drill Variance Analysis (v2)\n\nOnce a well is drilled and production data becomes available, the system can compare:\n\n- **Projected vs. Actual Production:** How did the type curve compare to actual production? Was the well a P10, P50, or P90 outcome?\n- **Projected vs. Actual Economics:** Given actual production and realized prices, how did actual returns compare to projections?\n- **Systematic Bias Detection:** Across multiple wells, are projections consistently optimistic or pessimistic? By basin? By operator? By formation?\n- **Analog Quality Analysis:** Which analog wells most accurately predicted the outcome? Can analog selection weights be improved?\n- **Confidence Calibration:** Are analysts who sign off with \"High\" confidence actually more accurate than \"Medium\" or \"Low\"? Calibrate confidence levels against outcomes.\n- **CAG Vote Accuracy:** Which advisory members' votes most accurately predicted well outcomes? Surface patterns in advisory quality.\n\n### Future: Portfolio Comparison & Capital Allocation (v2)\n\n- **Portfolio Ranking:** Rank all active AFEs by risk-adjusted return metrics\n- **Capital Allocation:** Given a capital budget, which combination of AFEs maximizes portfolio NPV?\n- **Diversification Analysis:** Portfolio exposure by basin, operator, formation -- avoid concentration risk\n- **Timeline View:** Expected cash flow timing across the portfolio for liquidity planning\n\n---\n\n## 11. Technical Considerations\n\n### 11.1 Enverus Integration\n\n**Enrichment & Fallback Data Path: CSV Import**\n\nWith state regulatory data as the primary foundation (see 11.2), Enverus CSV import serves as enrichment for data not available from state sources (completions detail, DOI cross-referencing, directional surveys) and as the primary data path for Louisiana/Haynesville. The import system handles:\n\n- **Column Mapping:** Configurable mapping from Enverus CSV column headers to the internal data schema. Supports multiple export formats as Enverus export layouts may vary.\n- **Data Validation:** On import, the system validates required fields, data types, and referential integrity. Invalid rows are flagged for review.\n- **Incremental Import:** Support for incremental data loads -- new wells and updated production data are merged with existing records. Duplicate detection by API number.\n- **Batch Import:** Support for bulk initial load as well as periodic refresh uploads.\n\n**Key Datasets (via CSV):**\n- Well headers (location, operator, status, formation)\n- Monthly/daily production (oil, gas, water)\n- Completion details (lateral length, proppant, stages, fluid)\n- Division of Interest / leasehold data\n- Directional surveys\n\n**Future Upgrade Path: Enverus Developer API**\n\nThe Enverus Developer API v3 provides real-time access to the same datasets via the `enverus-developer-api` Python client library. API integration is planned as a post-MVP upgrade that would supplement both state data and CSV imports by enabling:\n- On-demand analog well search without pre-loading data\n- Real-time production data refresh\n- Automated data synchronization on a configurable schedule\n\n**Considerations for API Upgrade:**\n- **Subscription Verification Required:** The client's Enverus subscription level must support Developer API (Direct Access), which may require an add-on.\n- **Rate Limiting:** The API has rate limits. The application must handle rate limiting with exponential backoff.\n- **Cost:** Enverus API access may carry additional costs beyond the base subscription.\n\n### 11.2 State Regulatory Data Integration (New in v2.1)\n\nFree state regulatory data serves as the primary foundation for well and production data. Each state requires a different integration approach:\n\n**Texas RRC (Railroad Commission) -- Bulk Download:**\n- **Approach:** Scheduled download of bulk data files from RRC website. Parse ASCII and CSV formats into the normalized internal schema.\n- **Key Datasets:** Monthly production data (oil, gas, casinghead gas, condensate by lease), well data (API number, location, status, operator, field), drilling permits, completion data, field rules.\n- **Update Cadence:** Weekly well data refresh; monthly production data refresh.\n- **Technical Details:** RRC bulk files use fixed-width ASCII for some datasets. Build a robust parser that handles format variations. Incremental updates via date-filtered downloads (RRC provides \"changed since\" date ranges on some datasets). Store raw files for audit trail.\n- **Coverage:** Permian (Midland sub-basin), Eagle Ford, TX-side Haynesville.\n\n**New Mexico OCD -- REST API:**\n- **Approach:** Direct API integration with the OCD Hub (ArcGIS REST API).\n- **Endpoint:** https://api.emnrd.nm.gov/\n- **Key Datasets:** Oil and gas wells (location, status, API number, operator), OG Statistics (monthly production by well), well injection totals.\n- **Formats:** JSON (primary), CSV, GeoJSON for spatial queries.\n- **Technical Details:** Paginated API responses. Implement cursor-based pagination for large result sets. Rate limiting is unspecified -- implement conservative polling with exponential backoff. GeoJSON support enables spatial queries for analog well search by radius.\n- **Supplemental Sources:** OCD Well Search tool for completions, formation tops, casing, perfs. NM Tech Octane Database for additional production data cross-reference.\n- **Coverage:** Permian (Delaware sub-basin in SE NM).\n\n**Wyoming WOGCC -- REST API:**\n- **Approach:** Direct API integration with the WOGCC Data Explorer.\n- **Key Datasets:** Well info (API number, location, status, operator, formation), permits, monthly production data.\n- **Formats:** CSV, GeoJSON, JSON.\n- **Technical Details:** Similar pagination and rate-limiting considerations as NM OCD. Wyoming Geospatial Hub provides bulk download as a fallback if API is unavailable. Implement dual-path: API for incremental updates, bulk download for initial load or recovery.\n- **Coverage:** Powder River Basin.\n\n**Louisiana SONRIS -- Fallback to Enverus:**\n- **Approach:** Enverus CSV import is the primary data path for Louisiana data. SONRIS does not offer a reliable programmatic API.\n- **Known Issues:** ArcGIS MapServer endpoint exists but SSL certificate is expired. Web-based Interactive Data Reports are available but not API-accessible. DODA export tool appears internal/government-only.\n- **Mitigation:** Contact LA DNR directly about bulk data access as a future improvement. Monitor SONRIS for API availability. In the interim, Enverus CSV provides complete coverage for Haynesville wells.\n- **Coverage:** Haynesville (Louisiana side).\n\n**Unified Data Normalization Layer:**\n- All state data and Enverus CSV imports are ingested into a common normalized schema.\n- Downstream components (analog selection, type curve engine, DOI cross-reference, breakeven calculations) query the normalized layer and are agnostic to the original data source.\n- Each record in the normalized layer carries a source provenance tag (e.g., \"TX_RRC\", \"NM_OCD\", \"WY_WOGCC\", \"ENVERUS_CSV\") for data quality tracking.\n- Deduplication by API number across sources. When the same well appears in both state data and Enverus, the system retains both records and flags conflicts for analyst review. State data is treated as authoritative for regulatory fields (status, permits, production); Enverus is authoritative for enriched fields (completions detail, directional surveys).\n\n**Data Sync Scheduling:**\n- TX RRC: Weekly automated download (well data), monthly (production)\n- NM OCD: Daily API sync (configurable)\n- WY WOGCC: Daily API sync (configurable)\n- Enverus CSV: Manual upload / batch import (unchanged)\n- Admin dashboard shows last-sync timestamp and record counts per source\n\n### 11.3 PDF Parsing for AFE Documents\n\n**Challenge:** AFE documents are semi-structured PDFs that vary by operator. The client receives AFEs from approximately 50 operators in PDF format. Some are digitally generated (text-selectable), others may be scanned images.\n\n**Approach (Hybrid -- recommended for MVP):**\n- Use a vision-language model (e.g., GPT-4 Vision, Claude) to interpret the AFE document\n- The model extracts fields based on a prompt template describing expected fields\n- Handles layout variability without training custom models\n- Falls back to manual entry if confidence is low\n\n**Key Fields to Extract:**\n- API number, well name, operator\n- Legal description (section, township, range, survey)\n- Formation/target zone\n- Proposed total depth, lateral length\n- Working interest percentage\n- Estimated total cost (intangible, tangible, total)\n- Estimated spud date, completion date\n\n### 11.4 Email Auto-Ingestion (New in v2.0)\n\n**Challenge:** AFEs arrive via email to a shared inbox. The system must monitor this inbox, identify AFE-related messages, extract PDF attachments, and queue them for processing.\n\n**Approach:**\n- **Email Integration:** Connect to the shared inbox via IMAP, Microsoft Graph API (for Outlook/M365), or Google Workspace API\n- **Classification:** Simple rule-based classification (sender domain matches known operator domains, subject line keywords, PDF attachment present) supplemented by AI classification for edge cases\n- **Queuing:** Detected AFEs are queued in a \"pending confirmation\" state. The Land Analyst sees them in their inbox within the app and clicks to confirm ingestion, triggering the parsing pipeline.\n- **False Positive Handling:** Non-AFE emails that are incorrectly classified can be dismissed by the Land Analyst. The system learns from dismissals over time (future ML enhancement).\n\n### 11.5 Commodity Pricing\n\n**MVP Approach: Fixed Price Deck (User-Configurable)**\n\nFor MVP, commodity pricing uses a fixed price deck configured by the Admin (with adjustments by the Commercial Analyst per evaluation):\n\n- User sets flat prices for WTI crude oil ($/bbl) and Henry Hub natural gas ($/Mcf)\n- Optionally configure an escalation schedule (e.g., 2% annual price increase)\n- Apply basin-specific differentials (e.g., Permian basis differential to WTI)\n- Price deck is stored per evaluation and can be updated at any time before sign-off\n\n**Future: Live Pricing Feeds (v2+)**\n\nLive pricing from EIA and CME is planned as a post-MVP enhancement:\n- **EIA Open Data API:** Free with registration, provides daily WTI and Henry Hub spot prices with 1 business day lag.\n- **CME Group:** Daily settlement prices for WTI and Henry Hub futures. Suitable for futures strip pricing.\n\n### 11.6 Public Opex Benchmarking\n\n**Challenge:** Operating expense data for specific operators and basins is not freely available in a structured, API-accessible format.\n\n**Approach for MVP:**\n- Curate a baseline opex dataset from public filings for major operators and basins\n- Store as a lookup table: operator + basin + year --> LOE/BOE\n- Technical Analyst provides well-specific opex assumptions that may override or supplement benchmarks\n- Allow manual override for any well\n- Future: automated extraction from 10-K filings using NLP\n\n**Typical Opex Ranges (for reference -- target basins):**\n- Permian Basin (Delaware/SE NM + Midland/West TX): $6-12/BOE\n- Eagle Ford (South TX): $7-13/BOE\n- Haynesville (LA/East TX): $5-10/BOE (primarily gas)\n- Powder River Basin (WY): $8-14/BOE\n\n### 11.7 Type Curve Methodology\n\n**Standard Approach:**\n1. Select analog wells based on multi-criteria similarity scoring\n2. Normalize production histories to a common time-zero (first production month)\n3. Fit Arps decline curves to the normalized data (exponential, hyperbolic, harmonic, or modified hyperbolic)\n4. Generate P10/P50/P90 from the distribution of analog well outcomes\n5. Extend forecast to economic limit or specified time horizon (typically 30-50 years for unconventional wells)\n\n**Implementation Considerations:**\n- Robust curve fitting (scipy.optimize or equivalent)\n- Multi-phase production (oil + gas + water) -- type curve for each phase\n- Account for shut-in periods, rate restrictions, and data quality issues\n- Allow for manual adjustment of decline parameters\n\n### 11.8 SMS Integration (New in v2.0)\n\n**Capability:** SMS-based delegation and notification for the approval chain.\n\n**Approach:**\n- Use a cloud SMS gateway (Twilio, AWS SNS, or equivalent) for outbound notifications and inbound delegation commands\n- **Outbound:** Escalation alerts, deadline warnings, approval reminders\n- **Inbound:** Simple command parsing -- \"DELEGATE\" to pass approval to next delegate, \"APPROVE\" / \"DECLINE\" for quick action (with confirmation step)\n- **Security:** SMS actions require a confirmation step (e.g., \"Reply YES to confirm APPROVE for [Well Name]\")\n- **Audit:** All SMS interactions are logged in the notification/decision audit trail\n\n### 11.9 Notification System Architecture (New in v2.0)\n\n**Multi-Channel Notifications:**\n\n| Event | In-App | Email | SMS |\n|-------|--------|-------|-----|\n| AFE auto-detected in inbox | Land Analyst | Land Analyst | -- |\n| AFE ingested, ready for analysis | Land + Technical | Land + Technical | -- |\n| Analyst sign-off completed | Next stage analyst, CAG | Next stage analyst | -- |\n| Dashboard published (all analysts signed off) | CAG, Approver | CAG, Approver | Approver |\n| CAG vote cast | CAG members, Approver | -- | -- |\n| Approval needed (initial) | Approver | Approver | -- |\n| Escalation triggered (deadline approaching) | Next delegate | Next delegate | Next delegate |\n| Urgent escalation (close to deadline) | All in chain | All in chain | All in chain |\n| Decision made (Drill/Drop) | All roles | All roles | -- |\n| Non-Consent flagged | All roles | All roles | Approver + delegates |\n| Send Back from Approver | Target analyst | Target analyst | Target analyst |\n\n**Urgency Gradient:**\n- Normal cadence: single notification per event\n- Approaching deadline (configurable threshold, e.g., 7 days): daily reminders\n- Urgent (configurable threshold, e.g., 3 days): twice-daily reminders + SMS\n- Critical (configurable threshold, e.g., 1 day): hourly reminders + SMS\n\n### 11.10 Deployment\n\n**Cloud-hosted deployment confirmed.** No data sensitivity constraints. The application will be deployed as a cloud-hosted web application accessible via browser.\n\n**UI Design:** Light theme, modern, clean, professional design. Mobile-responsive from day one to support executive use on phones and tablets.\n\n---\n\n## 12. Risks & Assumptions\n\n### Risks\n\n| # | Risk | Likelihood | Impact | Mitigation |\n|---|------|-----------|--------|------------|\n| R1 | Enverus CSV export format changes or is inconsistent across data types | Medium | Medium | Build flexible column mapping with validation. Document expected formats. Test with sample exports early. |\n| R2 | AFE PDF formats vary too widely for reliable automated extraction (~50 operators) | Medium-High | Medium | Start with the most common operator formats. Allow manual correction. Use vision-language model approach for flexibility. |\n| R3 | Analog well selection produces poor type curves in data-sparse areas | Medium | High | Allow analyst override of analogs. Show confidence metrics. Support manual type curve entry as fallback. |\n| R4 | Opex benchmarking data is stale or inaccurate for specific operators | High | Medium | Provide clear sourcing for all opex data. Technical Analyst provides per-well assumptions. Manual override. Plan for future automated extraction. |\n| R5 | Economics engine complexity (deal structure builder + auto-calc) exceeds estimated development time | High | High | Prioritize standard WI/NRI and back-in after payout first. Build remaining deal structures incrementally. Design the engine for extensibility from the start. |\n| R6 | User adoption resistance (analysts prefer existing Excel workflows) | Medium | High | Design for augmentation, not replacement. Allow export to Excel. Phase rollout by role. |\n| R7 | Scope creep from post-drill variance analysis and portfolio optimization | Medium | Medium | Clear MVP boundary. Contractual phase separation. |\n| R8 | Election window timing pressure -- system must deliver same-day results | Medium | High | Parallel workflow reduces elapsed time. Target same-day automated evaluation. Analyst review is the bottleneck, not the system. |\n| R9 | Mobile-responsive design adds UI development time | Medium | Medium | Use a responsive CSS framework from the start. Test on mobile devices throughout development. |\n| R10 | Custom one-off deal structures are too varied to generalize into a builder UI | Medium | High | Start with the most common patterns. Provide a flexible \"custom\" mode. Gather real examples from the client early. |\n| R11 | Email auto-ingestion produces false positives/negatives in AFE detection | Medium | Medium | Start with rule-based classification (sender, subject, attachment). Land Analyst confirms all auto-detected AFEs before processing. Manual upload as fallback. |\n| R12 | SMS integration introduces security risks (unauthorized delegation/approval) | Low | High | Require confirmation step for all SMS actions. Log all interactions. Consider two-factor confirmation for approval actions. |\n| R13 | CAG voting adoption is low or perfunctory (one-word rationale) | Medium | Medium | Enforce minimum rationale length. Make the voting interface frictionless. Show CAG members that their input influences decisions. |\n| R14 | Approval chain escalation annoys senior executives with too many notifications | Medium | Medium | Configurable notification preferences per user. Respect \"quiet hours\" settings. Allow snooze. Clearly communicate urgency thresholds. |\n| R15 | Live dashboard recalculation performance is slow with complex deal structures | Medium | High | Optimize economics engine for sub-second recalculation. Pre-compute sensitivity ranges. Use WebSocket for real-time updates. |\n| R16 | Non-consent tracking creates legal/compliance concerns | Low | Medium | App is decision support only -- does not execute elections or operator communications. Clear disclaimers. Legal review of non-consent flagging language. |\n| R17 | State regulatory data formats change without notice (TX RRC ASCII, NM/WY API schemas) | Medium | Medium | Version parsers per state. Monitor state agency release notes. Automated format-change detection on import. Enverus CSV as fallback. |\n| R18 | State API rate limits or availability issues (NM OCD, WY WOGCC) | Medium | Medium | Implement exponential backoff. Cache data locally. Fall back to Enverus CSV if API is down. Bulk download as secondary path. |\n| R19 | Data quality inconsistency across multiple state sources and Enverus | Medium | High | Unified normalization layer with source provenance tags. Deduplication by API number. Conflict flagging for analyst review. Automated data quality metrics per source. |\n| R20 | Louisiana SONRIS never provides programmatic access | High | Medium | Enverus CSV is the confirmed fallback for LA/Haynesville. Monitor SONRIS. Contact LA DNR periodically. Low impact since Enverus covers the gap. |\n\n### Assumptions\n\n| # | Assumption | Impact if Wrong |\n|---|-----------|-----------------|\n| A1 | Client has an active Enverus subscription that allows CSV data export | No well data available without Enverus; must identify alternative data source |\n| A2 | AFE PDFs are primarily digitally generated (text-selectable), not handwritten or poor-quality scans | OCR accuracy drops significantly for scanned documents; may need different parsing strategy |\n| A3 | The client's DOI deck (master land records) is maintained in a single master Excel spreadsheet that is reasonably clean and structured | Significant data cleaning effort or multi-source reconciliation may be required |\n| A4 | The client evaluates primarily US onshore unconventional wells in the Permian, Eagle Ford, Haynesville, and Powder River basins | Type curve methodology and opex benchmarks are calibrated for these basins. Other basins require additional data curation |\n| A5 | Users are comfortable with web-based, cloud-hosted applications accessed via browser | If they require desktop or on-premise only, architecture changes significantly |\n| A6 | The deal structures encountered in practice can be modeled with the predefined templates plus a custom builder | If every deal is truly unique with no patterns, the builder becomes impractical |\n| A7 | The shared inbox for AFE receipt is an email system accessible via API (M365, Google Workspace, or IMAP) | If the inbox is not API-accessible, email auto-ingestion falls back to manual upload only |\n| A8 | SMS-capable phone numbers are available for all users in the approval chain | If not, escalation relies on in-app and email only; SMS delegation is not available |\n| A9 | The client's approval hierarchy has at most 3 levels (primary + 2 delegates) | More levels would require extending the approval chain configuration |\n| A10 | CAG membership is stable enough that votes are meaningful (not constantly changing personnel) | Frequent CAG turnover would reduce the value of voting trend analysis |\n| A11 | The client is willing to start with a curated opex dataset and refine over time | If they demand highly accurate opex from day one, significant data curation effort is front-loaded |\n| A12 | Free state regulatory data (TX RRC, NM OCD, WY WOGCC) remains freely available and the formats remain reasonably stable | If states restrict access or change formats significantly, fall back to Enverus CSV for affected states |\n| A13 | NM OCD and WY WOGCC REST APIs have sufficient uptime and rate limits for production use | If APIs are unreliable, bulk download fallback paths are available for both states |\n\n---\n\n## 13. MVP Scope\n\n### In Scope (v1)\n\n| Category | Feature | Notes |\n|----------|---------|-------|\n| Ingestion | AFE PDF parsing and field extraction | Vision-language model, semi-automated with manual correction |\n| Ingestion | Email auto-ingestion | AI agent monitors inbox; Land Analyst confirms |\n| Ingestion | Manual AFE upload | Drag-and-drop PDF upload |\n| Admin | User and role management | 6 roles; multiple users per role (especially CAG) |\n| Admin | DOI deck upload and maintenance | Single master Excel; version history; non-consent penalty data |\n| Admin | Approval chain configuration | Primary -> 1st Delegate -> 2nd Delegate |\n| Admin | Escalation rule configuration | Configurable thresholds relative to election deadline |\n| Admin | Data source connection configuration | Enverus CSV, pricing, opex settings |\n| Land | DOI deck matching and validation | By API number, legal description; auto-validation |\n| Land | Enverus DOI cross-reference | Via CSV import |\n| Land | Discrepancy flagging and resolution | Severity-based flagging; override with explanation |\n| Land | Confidence level sign-off | High / Medium / Low |\n| Data | Enverus CSV import | Primary data path with column mapping |\n| Technical | Analog well search from CSV data | Multi-criteria with scoring; well type matching |\n| Technical | Type curve generation (Arps decline) | P50 minimum; P10/P90 stretch |\n| Technical | Opex assumption input | Per-evaluation, basin/operator benchmarked |\n| Technical | Confidence level sign-off | High / Medium / Low |\n| Economics | Engine-driven auto-calculation | Full model from upstream inputs |\n| Economics | Commercial Analyst validation and adjustment | Review and modify auto-generated model |\n| Economics | Deal structure builder | Back-in, sliding scale, min royalty, promoted, custom |\n| Economics | Fixed price deck | User-configurable (flat or escalation) |\n| Economics | Curated opex benchmarks | Basin/operator lookup with manual override |\n| Economics | Full cash flow analysis | All components; tabular + chart |\n| Economics | Confidence level sign-off | High / Medium / Low |\n| Dashboard | Comprehensive deal dashboard | Live interactive financial model |\n| Dashboard | Production profile chart | Type curve with oil + gas decline |\n| Dashboard | Revenue waterfall | Gross -> burdens -> net |\n| Dashboard | Cash flow (table + chart) | Full component breakdown |\n| Dashboard | Economics summary | NPV, IRR, Payout, ROI, PI |\n| Dashboard | Recommendation with rationale | Explains WHY, flips with input changes |\n| Dashboard | Analyst confidence indicators | Three badges: Land, Technical, Commercial |\n| Dashboard | Approval chain status | Current approver, deadline countdown |\n| Dashboard | Predefined scenario controls | Farm-out, price, production, deal structure, opex |\n| Dashboard | Live recalculation | All components update in real time |\n| Voting | CAG 5-point voting system | Drill / Lean Drill / Neutral / Lean Drop / Drop |\n| Voting | Mandatory rationale | At least one line per vote |\n| Voting | Sentiment summary | Distribution chart + individual votes |\n| Approval | Delegated approval chain | 3-level chain with escalation |\n| Approval | Approve / Decline / Send Back | Three actions; Send Back routes to specific analyst |\n| Approval | SMS delegation | \"Reply DELEGATE to pass to [Name]\" |\n| Notifications | In-app notifications | All workflow events |\n| Notifications | Email notifications | Sign-off requests, escalations, deadlines |\n| Notifications | SMS notifications | Urgent escalations, delegation |\n| Notifications | Urgency gradient | Increasing frequency as deadline approaches |\n| Non-Consent | Deadline tracking and flagging | Auto-flag as Non-Consent if deadline passes |\n| Non-Consent | Penalty recording | Non-consent penalties from DOI deck |\n| UI | Mobile-responsive design | Phone and tablet; light, modern, clean, professional |\n| Workflow | Parallel analyst processing | Land + Technical run concurrently |\n| Archive | Decision logging with full context | Votes, confidence, escalation, non-consent |\n| Archive | Historical decision import | Spreadsheet import path |\n| Auth | User authentication and role management | Standard auth with 6-role assignment |\n| Deploy | Cloud-hosted web application | No data sensitivity constraints |\n| Workflow | Confidence auto-gating | Low-confidence sign-off auto-flags to Approver for acknowledgment |\n| Workflow | Deadline-aware prioritization | All views sorted by urgency; red/amber/green color coding |\n| Workflow | Stale evaluation detection | Configurable inactivity threshold; auto-escalate to Admin |\n| Economics | Breakeven auto-calculation | Breakeven oil, gas, capex, opex, WI; displayed on dashboard |\n| Dashboard | Asymmetric risk framing | P10 upside vs P90 downside; regret analysis; 2x2 decision matrix |\n| Data | State regulatory data integration | TX RRC bulk, NM OCD API, WY WOGCC API; normalization layer |\n| Data | Decision outcome data model | Outcome records for Drill decisions; seeds v2 variance analysis |\n| Ingestion | PDF template library | Cache operator extraction mappings; reduce AI costs |\n| Export | One-click export package | PDF report, Excel workbook, executive summary slide |\n\n### Out of Scope (v1) -- Deferred to v2+\n\n| Category | Feature | Rationale |\n|----------|---------|-----------|\n| AI Chat | Conversational scenario modeling | Complex NLU + dynamic calc engine; deferred post-MVP |\n| Pricing | Live EIA/CME pricing feed | Fixed price deck sufficient for MVP |\n| Pricing | CME futures strip pricing | Requires paid data access |\n| Portfolio | Portfolio view and side-by-side ranking | Single-AFE workflow is MVP |\n| Analytics | Post-drill variance analysis | Requires actual production data; long-term |\n| Analytics | Portfolio capital allocation optimizer | Requires portfolio view |\n| Analytics | Confidence calibration analytics | Requires sufficient decision history |\n| Analytics | CAG vote accuracy tracking | Requires post-drill outcomes |\n| Opex | Automated 10-K opex extraction (NLP) | Curated dataset for MVP |\n| Comms | Automated operator communication | Manual process for MVP |\n| Data | Enverus API integration | CSV is primary; API is upgrade path |\n| Technical | Machine learning analog scoring | Start with rule-based scoring; ML in v2 |\n| Non-Consent | Agreement-to-asset linking for penalty surfacing | Future v2 feature |\n| Analytics | Operator performance scorecards (UI) | v2 feature; data model built in v1 to support it |\n| Workflow | Analyst workload balancing dashboard | Deferred -- analyst roles may change with integrations |\n| Voting | CAG vote weighting | Deferred -- equal votes in MVP; Approver uses judgment |\n\n### MVP Delivery Strategy\n\nThe MVP should be delivered iteratively within the following rough phases:\n\n1. **Foundation (Weeks 1-4):** Data model (including operator scorecard and decision outcome data models), auth, 6-role management, DOI deck upload, state regulatory data integration (TX RRC parser, NM OCD API client, WY WOGCC API client), unified data normalization layer, Enverus CSV import engine, basic UI shell with responsive framework, notification infrastructure\n2. **Land + Technical (Weeks 4-8):** AFE parsing with PDF template library (including email auto-ingestion), land matching, DOI cross-reference (from normalized data layer), discrepancy workflow, confidence sign-off with auto-gating; analog search (from normalized data), scoring algorithm, type curve engine, opex input, technical review UI, confidence sign-off. **These two workstreams can be developed in parallel.**\n3. **Economics Engine (Weeks 8-12):** Engine-driven auto-calculation with breakeven auto-calculation, Commercial Analyst validation UI, deal structure builder (standard WI/NRI, back-in, sliding scale, min royalty, promoted, custom), pricing, opex integration, key metrics, full cash flow analysis\n4. **Dashboard + Voting (Weeks 12-15):** Comprehensive deal dashboard (live interactive), all chart/table components, breakeven display, asymmetric risk framing panel, recommendation engine with rationale, CAG voting system with rationale, scenario controls, live recalculation, deadline-aware prioritization (color coding, urgency sorting)\n5. **Approval Chain + Notifications (Weeks 15-17):** Delegated approval chain, Send Back workflow, SMS integration, notification system (in-app, email, SMS), urgency escalation, non-consent handling, stale evaluation detection, confidence auto-gating workflow\n6. **Export + Integration & Polish (Weeks 17-20):** Export package (PDF, Excel, slide), end-to-end testing, mobile responsiveness testing, performance optimization (dashboard recalculation speed), historical import, decision archive, state data sync verification, user acceptance testing\n\n*Total estimated timeline: 20 weeks (expanded from 18 weeks due to state regulatory data integration, PDF template library, breakeven auto-calculation, asymmetric risk framing, stale evaluation detection, confidence auto-gating, export package, and decision outcome data model). Timeline is indicative and will be refined during planning.*\n\n### Non-Functional Requirements\n\n| Requirement | Target |\n|-------------|--------|\n| Automated evaluation time (land + technical + economics) | Same-day results (< 4 hours for automated stages); parallel processing reduces wall-clock time |\n| Dashboard recalculation speed | < 2 seconds for full model recalculation when inputs change |\n| Analyst review turnaround | Supported by clear notifications and streamlined review UI |\n| Notification delivery | In-app: real-time; Email: < 5 minutes; SMS: < 1 minute |\n| Deployment model | Cloud-hosted, browser-based |\n| Device support | Desktop, tablet, and mobile phone (responsive) |\n| User scale | Multiple users per role (especially CAG); architecture supports growth |\n| Data refresh | Automated sync for state data (daily/weekly); manual CSV upload for Enverus; event-driven for AFE PDFs |\n| UI design | Light theme, modern, clean, professional |\n| SMS reliability | 99.9% delivery via cloud SMS gateway |\n\n---\n\n## 14. Open Questions\n\n### Critical (Must Resolve Before Development)\n\n1. **Enverus CSV Export Access:** **RESOLVED** -- Enverus CSV import is the primary data path for v1. API is the upgrade path. Client can export CSV data from their Enverus subscription.\n\n2. **Land Record Format:** **RESOLVED** -- Single master Excel spreadsheet (DOI deck) for land records, confirmed.\n\n3. **AFE Volume:** **RESOLVED** -- 3-5 AFEs per month from approximately 50 operators, PDF format.\n\n4. **AFE Format Variability:** **RESOLVED** -- ~50 operators, AFEs arrive in PDF format. Vision-language model approach will handle variability.\n\n5. **Deployment Preference:** **RESOLVED** -- Cloud-hosted deployment confirmed. No data sensitivity constraints.\n\n6. **Data Sensitivity:** **RESOLVED** -- No data sensitivity constraints. Cloud-hosted with standard cloud AI services is acceptable.\n\n### Important (Should Resolve During Early Development)\n\n7. **Internal Opex Data:** Does the client have internal opex data for wells they have participated in historically? This would supplement public benchmarks and Technical Analyst assumptions.\n\n8. **Type Curve Methodology Preferences:** Does the client's technical team have specific preferences for decline curve models, b-factor constraints, or terminal decline rates?\n\n9. **Economic Model Complexity:** **RESOLVED** -- Must support back-in after payout, sliding scale overrides, minimum royalties, promoted interest structures, and custom one-off deal structures. Engine-driven auto-calculation with Commercial Analyst validation.\n\n10. **User Count:** **RESOLVED (Updated)** -- Multiple users per role, especially for CAG (advisory group). Architecture must support concurrent CAG access to the live dashboard and voting.\n\n11. **Existing Tool Integration:** **RESOLVED** -- No existing tool integrations required.\n\n12. **Historical Decision Data:** **RESOLVED** -- Build a spreadsheet import path for seeding the decision archive.\n\n13. **Email System for Auto-Ingestion (New):** What email system does the client use for the shared AFE inbox? Microsoft 365, Google Workspace, or other? This determines the email integration API. Is API access to the inbox available?\n\n14. **Approval Chain Depth (New):** Is a 3-level chain (Primary + 2 Delegates) sufficient? Are there scenarios requiring more levels?\n\n15. **CAG Composition (New):** How many members are typically in the Commercial Advisory Group? Is membership fixed or does it vary by AFE? Are external advisors included?\n\n16. **SMS Provider Preference (New):** Does the client have an existing SMS gateway or corporate messaging platform? Twilio is the recommended default.\n\n17. **Non-Consent Penalty Data (New):** Are non-consent penalties currently tracked in the DOI deck / land records? If not, is the client willing to add this data? What does the penalty structure look like?\n\n18. **Election Deadline Source (New):** Where is the election deadline for each AFE recorded? Is it in the AFE document itself, or does the Land Analyst determine it from the operating agreement?\n\n### Nice to Know\n\n19. **Basin Focus:** **RESOLVED** -- Permian (Delaware/SE NM + Midland/West TX), Eagle Ford (South TX), Haynesville (LA/East TX), Powder River Basin (WY).\n\n20. **Election Window Timing:** **RESOLVED** -- 30 days typical, 1 week worst case. Target same-day automated results.\n\n21. **Chat Interface Expectations:** **RESOLVED** -- Conversational AI deferred to post-MVP. Predefined scenario controls only for v1.\n\n---\n\n## 15. GO/NO-GO Conditions\n\n### GO Conditions (All Must Be True)\n\n| # | Condition | Verification Method | Status |\n|---|-----------|-------------------|--------|\n| G1 | Enverus CSV export access confirmed | Client confirms CSV export capability | **Confirmed** |\n| G2 | Client provides sample AFE documents (minimum 3 different operator formats) for parsing validation | Document delivery | Pending |\n| G3 | Client provides sample DOI deck (single master Excel) for schema mapping | Document delivery | Pending |\n| G4 | Client agrees to web-based (browser) delivery for MVP | Written confirmation | **Confirmed** |\n| G5 | Client identifies users for each of the 6 roles for UAT | Named users confirmed | Pending |\n| G6 | Cloud-hosted deployment model agreed | Written confirmation | **Confirmed** |\n| G7 | Client confirms the parallel workflow with 6 roles accurately represents their evaluation process | Workshop sign-off | Pending |\n| G8 | MVP scope boundary is agreed upon (in-scope vs. deferred features) including voting, approval chain, and live dashboard | Written sign-off | Pending |\n| G9 | Budget and timeline are approved for MVP delivery (20-week estimate) | Contract execution | Pending |\n| G10 | Client provides sample deal structure examples for economics engine validation | Document delivery | Pending |\n| G11 | Client confirms email system and API access for shared inbox (auto-ingestion) | Technical validation | Pending |\n| G12 | Client confirms approval chain structure and delegate assignments | Workshop documentation | Pending |\n| G13 | Client confirms CAG membership list and voting process alignment | Workshop documentation | Pending |\n\n### NO-GO Conditions (Any One Kills the Project)\n\n| # | Condition | Why It Kills |\n|---|-----------|-------------|\n| N1 | Client's Enverus subscription does not include well production data AND they cannot provide CSV exports | No production data = no type curves = no economics = no value |\n| N2 | Client's AFE volume is < 5/year | The tool's value proposition requires sufficient volume to justify the investment; at < 5 AFEs/year, manual evaluation is adequate |\n| N3 | Client requires international well evaluation (non-US) in v1 | Type curve methodology, opex benchmarks, and data sources are all calibrated for US onshore; international would require fundamental re-architecture |\n| N4 | Client cannot provide land records in any structured format | No land records = no DOI validation = the entire pipeline breaks at Stage 1 |\n\n### Conditional GO (Proceed with Adjusted Scope)\n\n| # | Condition | Scope Adjustment |\n|---|-----------|-----------------|\n| C1 | Deal structure examples reveal complexity beyond what the builder can handle | Add custom calculation scripting capability; extend economics phase by 2-3 weeks |\n| C2 | AFE formats are highly variable across all 50 operators | Add 2-3 weeks for parser training/tuning; build a manual correction UI as primary fallback |\n| C3 | Client wants Enverus API integration in v1 (not just CSV) | Extend timeline by 2-3 weeks; verify API subscription and costs |\n| C4 | Client wants conversational AI in v1 | Extend timeline by 4-5 weeks; increase budget for NLU development |\n| C5 | Email inbox is not API-accessible (cannot auto-ingest) | Drop email auto-ingestion; manual upload only. Reduces scope by ~1 week. |\n| C6 | Client has no SMS infrastructure or phone numbers for executives | Drop SMS delegation/notification; rely on in-app + email escalation only. Reduces scope by ~1 week. |\n| C7 | CAG membership exceeds 10 people per AFE | May require pagination/filtering in the voting summary; add ~1 week for voting UI scaling. |\n\n---\n\n## 16. BA Optimization Recommendations -- Client Decisions\n\nThis section documents 12 expert recommendations proposed during discovery, along with the client's decisions on each. Items approved for v1 have been integrated into the relevant sections of this document (Sections 5, 7, 8, 9, 13). Items approved for v2 have corresponding data model provisions in v1 (Section 6). Deferred and skipped items are retained for future reference.\n\n### Decision Summary\n\n| # | Recommendation | Client Decision | Integration |\n|---|---------------|----------------|-------------|\n| 1 | Weighted Confidence Auto-Gating | **Approved v1** | Sections 5, 7, 13 |\n| 2 | Deadline-Aware Prioritization | **Approved v1** | Sections 5, 7, 13 |\n| 3 | Quick Take Pre-Screen | **Skipped** | Not implemented -- every AFE runs the full process |\n| 4 | Breakeven Auto-Calculation | **Approved v1** | Sections 7, 8, 9, 13 |\n| 5 | Operator Performance Scorecards | **Approved v2** | Data model in v1 (Section 6); UI deferred to v2 |\n| 6 | Asymmetric Risk Framing | **Approved v1** | Sections 7, 9, 13 |\n| 7 | Analyst Workload Dashboard | **Deferred** | Analyst roles may change as integrations become seamless |\n| 8 | CAG Vote Weighting | **Deferred** | Equal votes in MVP; Approver uses judgment |\n| 9 | Stale Evaluation Detection | **Approved v1** | Sections 5, 7, 13 |\n| 10 | Decision Feedback Loop | **Approved v1** (data model only) | Data model in Section 6; no UI in v1 |\n| 11 | PDF Template Library | **Approved v1** | Sections 7, 8, 13 |\n| 12 | Export Package | **Approved v1** | Sections 7, 13 |\n\n### 16.1 Weighted Confidence Auto-Gating -- APPROVED v1\n\nIf any analyst (Land, Technical, or Commercial) signs off with **Low** confidence, the system auto-flags the evaluation to the Approver requiring explicit acknowledgment of the uncertainty. The Approver must annotate that they have reviewed and accepted the risk before making a final decision. This transforms confidence from a passive indicator into an active workflow gate that forces scrutiny on uncertain evaluations while allowing clear-cut decisions to proceed efficiently.\n\n### 16.2 Deadline-Aware Prioritization -- APPROVED v1\n\nAll workflow views (analyst queues, CAG dashboard, Approver inbox) are sorted by election deadline urgency by default. Color-coded urgency indicators throughout the UI: green (>14 days), amber (7-14 days), red (<3 days). Proactive alerts when processing time estimates suggest a deadline is at risk. The system becomes deadline-aware rather than FIFO, preventing the scenario where harder AFEs miss deadlines while easier ones are processed first.\n\n### 16.3 Quick Take Pre-Screen -- SKIPPED\n\nClient decision: every AFE runs the full evaluation process. No fast-track or pre-screening. This ensures consistent rigor across all evaluations regardless of apparent complexity.\n\n### 16.4 Breakeven Auto-Calculation -- APPROVED v1\n\nAuto-compute breakeven oil price, gas price, capex, opex, and minimum WI for every deal (NPV = 0). Display on the dashboard alongside the economics summary. Include \"margin of safety\" framing in the recommendation rationale (e.g., \"Current oil price of $70/bbl is $18/bbl above the breakeven price of $52/bbl, providing a 35% margin of safety\"). Answers the most common executive question without manual scenario iteration.\n\n### 16.5 Operator Performance Scorecards -- APPROVED v2\n\nClient wants the full scorecard UI in v2 but recognizes the data model must be designed in v1 to accumulate operator performance data from day one. The v1 data model includes: operator entity with performance tracking fields (average EUR, IP-30, IP-90, completion consistency, DOI accuracy), relationships to wells and AFE evaluations. Data accumulates automatically; the v2 UI will surface it as scorecards alongside AFE evaluations.\n\n### 16.6 Asymmetric Risk Framing -- APPROVED v1\n\nP10 upside vs P90 downside with regret analysis displayed on the dashboard. Presented as a 2x2 decision matrix (Drill vs. Drop at P10 vs. P90) with maximum loss (dry hole capex exposure). Shifts the decision frame to \"is the risk-reward acceptable?\" -- how sophisticated capital allocators think. All values update live with other dashboard components.\n\n### 16.7 Analyst Workload Dashboard -- DEFERRED\n\nClient notes that analyst roles may evolve or be reduced as state data integrations and automation become more seamless. Revisit when role structure stabilizes post-MVP.\n\n### 16.8 CAG Vote Weighting -- DEFERRED\n\nEqual votes in MVP. The Approver uses their own judgment to weight advisory input by expertise. May revisit in v2 if the CAG grows large enough to warrant formal weighting.\n\n### 16.9 Stale Evaluation Detection -- APPROVED v1\n\nFlag evaluations with no activity for a configurable period. Notify the Admin and assigned analyst. If the evaluation is stale and the deadline is approaching, auto-escalate to the Admin with a recommendation to reassign. Track stale evaluations as a metric in admin views. Complements deadline-aware prioritization by catching evaluations that fall through the cracks.\n\n### 16.10 Decision Outcome Feedback Loop -- APPROVED v1 (Data Model Only)\n\nBuild the data plumbing in v1: for every \"Drill\" decision, create a pending Outcome Record expecting future production data. Import mechanism for actual data (same state data + Enverus CSV paths). Auto-match to historical decisions by API number. Status tags on archived decisions: \"Awaiting Production Data\" / \"Production Data Available\" / \"Not Applicable (Dropped).\" No variance analysis UI in v1 -- data collection only to eliminate the cold-start problem for v2 analytics.\n\n### 16.11 PDF Template Library -- APPROVED v1\n\nAfter a successful parse, store the extraction mapping as a template for that operator. Future AFEs from the same operator use template-based extraction first (fast, cheap, deterministic). Fall back to the vision-language model only for new operators or template mismatches. Over time, the library covers most incoming AFEs (~50 operators), reducing AI API costs and improving processing speed.\n\n### 16.12 Export Package -- APPROVED v1\n\nOne-click export generating: PDF report with all dashboard components (charts, tables, economics, recommendation, confidence levels, voting summary), Excel workbook with the full economic model (for audit), and executive summary slide (single-page for board presentation). Reflects the current dashboard state including any scenario adjustments. Replaces ad hoc email and slide deck creation for JV partner and board communication.\n\n---\n\n## Appendix A: Glossary\n\n| Term | Definition |\n|------|-----------|\n| AFE | Authorization for Expenditure -- a formal document from an operator proposing a well and requesting capital commitment from working interest partners |\n| API Number | American Petroleum Institute well identification number -- a unique numeric identifier for every well drilled in the US |\n| Arps Decline | A set of empirical decline curve models (exponential, hyperbolic, harmonic) developed by J.J. Arps for forecasting well production |\n| Back-In | A contractual provision where a party's working interest increases after a specified payout threshold is reached |\n| BOE | Barrel of Oil Equivalent -- a unit that converts gas volumes to oil equivalent (typically 6 Mcf = 1 BOE) |\n| CAG | Commercial Advisory Group -- the team of senior advisors who review evaluations and vote on recommendations |\n| DCF | Discounted Cash Flow -- a valuation method that discounts future cash flows to present value |\n| DOI | Division of Interest -- the contractual allocation of revenue and costs among working interest owners, royalty owners, and other interest holders |\n| IRR | Internal Rate of Return -- the discount rate at which NPV equals zero |\n| LOE | Lease Operating Expenses -- the recurring costs to operate a producing well |\n| NRI | Net Revenue Interest -- the share of production revenue an interest holder receives after deducting all burdens (royalties, overriding royalties, etc.) |\n| NPV | Net Present Value -- the sum of discounted future cash flows minus initial investment |\n| Non-Consent | The decision (or default outcome) to not participate in a proposed well, often carrying contractual penalties |\n| NOWI | Non-Operated Working Interest -- a working interest held by a party that is not the operator of the well |\n| P10/P50/P90 | Probability percentiles -- P50 is the median estimate; P10 is the high case (10% probability of exceeding); P90 is the low case (90% probability of exceeding) |\n| Promoted Interest | An arrangement where one party carries another's costs through a defined phase in exchange for a disproportionate share of revenue or interest |\n| Sliding Scale | A royalty or override rate that changes based on a trigger variable (price, production volume, or calendar date) |\n| Type Curve | A representative production profile derived from analog wells, used to forecast the production of a proposed well |\n| WI | Working Interest -- the percentage of ownership in an oil and gas lease that gives the holder the right to explore, drill, and produce, and obligates them to pay their share of costs |\n| WTI | West Texas Intermediate -- the benchmark price for US crude oil, quoted at Cushing, Oklahoma |\n| HH | Henry Hub -- the benchmark price for US natural gas, quoted at the Henry Hub pipeline interconnection in Louisiana |\n\n---\n\n## Appendix B: Research Sources\n\n**Data Providers & APIs:**\n- Enverus Developer API documentation and Python client: https://github.com/enverus-ea/enverus-developer-api\n- EIA Open Data API: https://www.eia.gov/opendata/\n- CME Group Daily Settlements: https://www.cmegroup.com/market-data/daily-settlements.html\n\n**State Regulatory Data Sources:**\n- Texas RRC Data Sets Available for Download: https://www.rrc.texas.gov/resource-center/research/data-sets-available-for-download/\n- New Mexico OCD Hub (ArcGIS REST API): https://api.emnrd.nm.gov/\n- New Mexico OCD Well Search: https://wwwapps.emnrd.nm.gov/ocd/ocdpermitting/\n- Wyoming WOGCC Data Explorer: https://pipeline.wyo.gov/\n- Wyoming Geospatial Hub: https://geospatialhub.wyo.gov/\n- Louisiana SONRIS: https://sonris.com/\n\n**Industry Research & Benchmarking:**\n- EIA Production Decline Curve Analysis: https://www.eia.gov/analysis/drilling/curve_analysis/\n- Omnira Software -- Type Curves and Analogue Selection: https://omnirasoftware.com/\n- ComboCurve Forecasting: https://combocurve.com/solutions/combocore-forecast/\n- Novi Labs Energy Analytics: https://novilabs.com/\n- Quorum Software Val Nav: https://www.quorumsoftware.com/solutions/planning-economics-reserves/val-nav/\n- SPE Operating Excellence Through Benchmarking: https://pubs.spe.org/en/ogf/ogf-article-detail/?art=5898\n- Solomon Associates Upstream Benchmarking: https://www.solomoninsight.com/industries/upstream/benchmarking/\n\n---\n\n## Appendix C: Client Review Decisions Log\n\n### v1.1 Decisions (Post Client Review)\n\n| # | Decision | Impact |\n|---|----------|--------|\n| D1 | Chat AI deferred to post-MVP | Predefined scenario controls only for v1. |\n| D2 | Portfolio view deferred to post-MVP | MVP handles one AFE at a time. |\n| D3 | Live commodity pricing deferred | Fixed price deck (user-configurable) for v1. |\n| D4 | Enverus CSV import is primary data path | API is upgrade path, not v1. |\n| D5 | Cloud-hosted deployment, no data sensitivity | No constraints on cloud AI services. |\n| D6 | Mobile-responsive design is P0 for v1 | Moved up from v2/Future. |\n| D7 | Economics engine significantly expanded | Back-in, sliding scale, min royalty, promoted, custom structures. |\n| D8 | Same-day automated results target | 30 days typical, 1 week worst case. |\n| D9 | Historical decision data import | Spreadsheet import for seeding decision archive. |\n| D10 | Single master Excel for land records | Confirmed as DOI deck format. |\n| D11 | 50 operators, 3-5 AFEs/month, PDF format | Resolved volume and format questions. |\n| D12 | Target basins: Permian, Eagle Ford, Haynesville, Powder River | Calibrated opex benchmarks and type curve methodology. |\n| D13 | 1 user per role MVP, scalable to 5 | Initial user scale assumption. |\n| D14 | No existing tool integrations | Resolved integration question. |\n| D15 | Light theme, modern, clean, professional UI | Design direction confirmed. |\n| D16 | Opex from public benchmarks with manual override | Confirmed approach. |\n\n### v2.0 Decisions (Major Revision)\n\n| # | Decision | Impact |\n|---|----------|--------|\n| D17 | Expanded from 4 roles to 6 roles | Added Administrator and CAG as distinct roles; split Commercial Advisory from Approver; killed \"Intake\" concept |\n| D18 | Parallel workflow replaces sequential model | Land and Technical work concurrently after AFE ingestion |\n| D19 | Confidence levels on analyst sign-offs | High/Medium/Low confidence required from Land, Technical, and Commercial Analysts |\n| D20 | 5-point CAG voting model with mandatory rationale | Drill / Lean Drill / Neutral / Lean Drop / Drop with sentiment summary |\n| D21 | Delegated approval chain with escalation | Primary -> 1st Delegate -> 2nd Delegate; time-based escalation; SMS delegation |\n| D22 | Comprehensive deal dashboard as live financial model | Not a static report; live recalculation; production chart, revenue waterfall, full cash flow, economics summary |\n| D23 | Engine-driven economics | Auto-calculation from upstream inputs; Commercial Analyst validates/adjusts, not builds from scratch |\n| D24 | Non-consent handling | Deadline tracking; auto-flag; penalty recording; future agreement-to-asset linking |\n| D25 | Multi-channel notification system | In-app, email, SMS; urgency gradient; deadline-aware |\n| D26 | Email auto-ingestion for AFEs | AI agent monitors inbox; Land Analyst confirms |\n| D27 | Multiple users per role (especially CAG) | Updated from \"1 user/role, scalable to 5\" to \"multiple users per role\" |\n| D28 | Timeline extended to 18 weeks | Reflects expanded scope: voting, approval chain, live dashboard, notifications |\n\n### v2.1 Decisions (BA Optimization Review + State Data Strategy)\n\n| # | Decision | Impact |\n|---|----------|--------|\n| D29 | Confidence auto-gating approved for v1 | Low-confidence sign-offs auto-flag to Approver; active workflow gate |\n| D30 | Deadline-aware prioritization approved for v1 | All views sorted by urgency; red/amber/green color coding throughout UI |\n| D31 | Quick Take pre-screen skipped | Every AFE runs full process; no fast-tracking |\n| D32 | Breakeven auto-calculation approved for v1 | Breakeven oil, gas, capex, opex, WI displayed on dashboard with margin-of-safety framing |\n| D33 | Operator scorecards approved for v2, data model in v1 | Data accumulates from day one; UI surfaces in v2 |\n| D34 | Asymmetric risk framing approved for v1 | P10/P90 upside/downside with regret analysis on dashboard |\n| D35 | Analyst workload dashboard deferred | Analyst roles may change with automation improvements |\n| D36 | CAG vote weighting deferred | Equal votes in MVP; Approver uses judgment |\n| D37 | Stale evaluation detection approved for v1 | Configurable inactivity threshold; auto-escalate to Admin |\n| D38 | Decision feedback loop approved for v1 (data model only) | Outcome records for Drill decisions; seeds v2 variance analysis |\n| D39 | PDF template library approved for v1 | Cache extraction mappings; reduce AI costs over time |\n| D40 | Export package approved for v1 | One-click PDF/Excel/slide export for JV partners and board |\n| D41 | State regulatory data strategy adopted | TX RRC (bulk), NM OCD (API), WY WOGCC (API) as primary; Enverus as enrichment/fallback |\n| D42 | Louisiana data via Enverus CSV fallback | SONRIS lacks reliable API; Enverus CSV covers Haynesville |\n| D43 | Unified data normalization layer | Multi-source ingestion into common schema; source provenance tracking |\n| D44 | Timeline extended to 20 weeks | Reflects state data integration, optimization features, export package |\n\n---\n\n*Document prepared by the Business Analyst agent as part of the Crucible product development framework. This document represents the v2.1 revision of the discovery phase output, incorporating client decisions on 12 BA optimization recommendations (8 approved for v1, 1 for v2, 2 deferred, 1 skipped), a state regulatory data strategy leveraging free public data from TX RRC, NM OCD, and WY WOGCC as the primary foundation with Enverus CSV as enrichment and Louisiana fallback, and expanded MVP scope and timeline. Subject to refinement based on further client feedback, technical validation, and planning phase analysis.*\n","challey/discovery":"# Challey - Discovery Document\n## Business Analyst Phase 1 Report\n\n**Project:** Challey\n**Client:** Maggie (age 13)\n**BA Agent:** Business Analyst\n**Date:** February 10, 2026\n**Status:** Discovery Complete (Skills 1-8)\n\n---\n\n## Executive Summary\n\nChalley is a chore tracking and reward management app designed for families with teenagers. The client, Maggie (13), enjoys doing chores but lacks an effective way to communicate completed work to her parents. The app will create a simple, direct workflow: Dad assigns chores with associated rewards → Maggie completes them → Maggie marks them done → Dad verifies → reward given.\n\nThis discovery phase analyzed the competitive landscape, user needs, and technical feasibility to define a focused MVP that delivers on Maggie's core need while remaining simple enough for a first-time app creator to understand and use.\n\n---\n\n## Skill 1: Intake (Client Brief)\n\n**What Maggie Told Us:**\n> \"I enjoy doing chores. But I have no way of reporting what I have done to my parents. I need a way for my dad to assign chores to me. When he assigns chores I want him to also put in some rewards I would like. Whenever I complete chores, I will mark them as complete. And then whenever he sees my work done he can reward me.\"\n\n**Key Requirements Extracted:**\n- Two user types: Parent (Dad) and Kid (Maggie)\n- Parent assigns chores\n- Parent defines rewards per chore\n- Kid marks chores complete\n- Parent verifies completed work\n- Parent grants rewards\n- Reporting/visibility of completed work\n\n**What Makes This Special:**\nMaggie ENJOYS chores (rare for teens!) — the problem isn't motivation, it's **communication and recognition**. She wants her parents to see and acknowledge her contributions.\n\n---\n\n## Skill 2: Market Research\n\n### Current Market Landscape (2026)\n\nThe chore app market is mature with 15+ established players. Apps fall into three categories:\n\n#### Category 1: Financial Education Focus\n**Examples:** Greenlight, BusyKid, Homey\n**Features:** Integrated banking, allowance tracking, savings goals, investment education\n**Pricing:** $4.99-$14.98/month\n**Target:** Parents teaching financial literacy alongside chores\n\n#### Category 2: Comprehensive Household Management\n**Examples:** S'moresUp, Family Daily, OurHome\n**Features:** Chores + calendars + grocery lists + family messaging + IoT integration\n**Pricing:** Free basic, $4.99/month premium\n**Target:** Busy families needing an \"all-in-one\" solution\n**Note:** S'moresUp even integrates with smart appliances (e.g., dishwasher assigns \"empty me\" chore)\n\n#### Category 3: Simple Chore Trackers\n**Examples:** Chorsee, Neat Kid, Family Tools, Chap\n**Features:** Core chore assignment, completion tracking, basic rewards\n**Pricing:** Free or low-cost ($1.99-$4.99 one-time or monthly)\n**Target:** Families wanting straightforward task management without complexity\n\n### Market Gaps & Opportunities\n\n**What's Missing:**\n1. **Teen-first design** — Most apps target younger kids (6-12) with gamification (monsters, points, cartoons). Teens want something more mature and respectful.\n2. **Simplicity over features** — Many apps suffer from feature bloat. Users report confusion navigating multiple tabs for calendars, allowances, savings jars, etc.\n3. **Recognition focus** — Apps emphasize rewards/money but not acknowledgment/appreciation, which research shows is a key motivator for teens.\n4. **Low/no-cost entry** — Most quality apps require subscriptions ($50-$180/year). Teens may not have credit cards or want ongoing costs.\n\n**Challey's Angle:**\nA **teen-friendly, minimalist chore tracker** that prioritizes clear communication and recognition over financial education or household management bells and whistles. Think \"simple, fast, awesome\" (Maggie's words).\n\n---\n\n## Skill 3: Competitive Analysis\n\n### Top 5 Competitors Deep Dive\n\n| App | Strengths | Weaknesses | Pricing | Target Age |\n|-----|-----------|------------|---------|------------|\n| **Chorsee** | Very simple interface, laser-focused on chores/allowances, easy setup, customizable task lists | Limited to chores only (no extras), basic design | Free basic, $2.99/month premium | 8-17 |\n| **Homey** | Detailed allowance features (per-minute rates, interest, fines), photo tasks, flexible family sizes | Complex financial math may overwhelm simple needs, premium required for 4+ users | Free (≤3 users), $4.99/month or $49.99/year unlimited | 6-16 |\n| **S'moresUp** | ChoreAI auto-assignment, smart appliance integration, comprehensive family tools (calendar, playdates, goals) | Feature overload for simple needs, \"Swiss Army knife\" approach can be confusing | Free standard, $4.99/month premium | 5-18 |\n| **Greenlight** | Banking integration, debit card for kids, strong financial education | Expensive ($5-$15/month), requires bank account setup, overkill if you just need chore tracking | $4.99-$14.98/month | 8-18 |\n| **Family Tools** | 100% free, completely ad-free, reward points for app customization | Basic feature set, fewer customization options | Free | 5-15 |\n\n### Competitive Positioning\n\n**Where Challey Fits:**\n- Simpler than S'moresUp/Homey (no banking, calendars, or IoT)\n- More teen-focused than Neat Kid/ChoreMonster (no cartoons or kid gamification)\n- Cleaner UX than Chorsee (modern, fast, intuitive)\n- Free/low-cost alternative to Greenlight/BusyKid\n\n**Key Differentiators:**\n1. **Teen-centric design language** (mature, respectful, not childish)\n2. **Recognition-first** (visible completed work, easy parent acknowledgment)\n3. **Fast workflow** (minimal taps from assignment to reward)\n4. **No subscription lock-in** (one-time purchase or free with limits)\n\n---\n\n## Skill 4: User Research\n\n### Primary Users\n\n#### User Type 1: The Teen (Maggie)\n**Age:** 13-17\n**Persona:** \"The Contributor\"\n\n**Needs:**\n- Easy way to show parents what she's accomplished\n- Clear visibility into assigned chores and associated rewards\n- Quick \"mark as done\" action from mobile\n- Sense of recognition and appreciation\n\n**Pain Points:**\n- Parents don't see completed work unless told verbally\n- Forgetting which chores have rewards\n- Feeling like contributions go unnoticed\n- Complex apps with too many screens/options\n\n**Motivations:**\n- Earning rewards (money, privileges, treats)\n- Feeling valued and trusted\n- Autonomy (choosing when to do chores within deadline)\n- Avoiding nagging/conflict with parents\n\n**Quote from Research:**\n> \"Teenagers want to feel valued, and when a chore is a responsibility and not just a menial task, it can help your teen feel more important.\"\n\n#### User Type 2: The Parent (Dad)\n**Age:** 35-55\n**Persona:** \"The Delegator\"\n\n**Needs:**\n- Fast way to assign chores from phone\n- Verification mechanism before granting rewards\n- Visibility into what's done vs. pending\n- Ability to set clear expectations upfront\n\n**Pain Points:**\n- \"I'll do it later\" syndrome (chores don't get done)\n- Constant reminders and nagging\n- Disputes about whether chores were done or done well\n- Tracking who did what in busy household\n\n**Motivations:**\n- Teaching responsibility and work ethic\n- Reducing household management burden\n- Maintaining peace (less arguing about chores)\n- Rewarding good behavior fairly\n\n**Quote from Research:**\n> \"While teenagers know what their chores are, they don't do them unless told, then respond with 'later, I'm busy now,' and often never get to it, leading to frustration and raised voices.\"\n\n### Secondary Insights\n\n**Teen Brain Development:**\nResearch notes that teenage prefrontal cortex (rational thought, consequences) is underdeveloped — teens need **clear structure, timing, and autonomy** to succeed with chores, not just threats or rewards.\n\n**Money as Motivator:**\nBiggest motivator for teens is money, but recognition/appreciation runs a close second. Both matter.\n\n**Scheduling Complexity:**\nTeens juggle school, extracurriculars, social life — chore apps need flexibility for WHEN chores happen, not just IF they happen.\n\n---\n\n## Skill 5: Feature Definition\n\n### Core Features (MVP)\n\n#### For Parents:\n1. **Create Chore** — Title, description, optional due date, assigned user, reward amount/type\n2. **View Chore Board** — See all active chores (pending, in progress, awaiting verification)\n3. **Verify Completion** — Approve or reject completed chores with optional feedback\n4. **Grant Reward** — Mark reward as given (or auto-grant on approval)\n5. **User Management** — Add family members (kids), assign roles\n\n#### For Kids:\n1. **View My Chores** — See assigned chores with details (what to do, reward, due date)\n2. **Mark Complete** — One-tap action to submit for parent review\n3. **Track Rewards** — See pending rewards, earned rewards history\n4. **Notifications** — Get alerts for new assignments, approaching deadlines\n\n#### Shared:\n1. **Simple Login** — Family code or shared account (no complex auth for MVP)\n2. **Activity Feed** — Timeline of assignments, completions, approvals\n3. **Dashboard** — Quick overview of active chores and recent activity\n\n### Feature Tagging\n\n| Feature | Tag | Rationale |\n|---------|-----|-----------|\n| Create chore (basic) | **MVP-LITE** | Core workflow requirement |\n| View chore board | **MVP-LITE** | Core workflow requirement |\n| Mark complete | **MVP-LITE** | Core workflow requirement |\n| Verify completion | **MVP-LITE** | Core workflow requirement |\n| Grant reward | **MVP-LITE** | Core workflow requirement |\n| User management (2 roles) | **MVP-LITE** | Core workflow requirement |\n| Activity feed | **MVP** | Valuable for communication/recognition |\n| Notifications | **MVP** | Reduces nagging, keeps workflow moving |\n| Track rewards history | **MVP** | Motivation and accountability |\n| Due dates | **MVP** | Structure and clarity |\n| Recurring chores | **POST-MVP** | Useful but not essential for first release |\n| Photos (before/after) | **POST-MVP** | Nice-to-have for verification |\n| Multiple reward types | **POST-MVP** | Start with points/money, expand later |\n| Allowance tracking | **POST-MVP** | Out of scope for simple tracker |\n| Calendar integration | **POST-MVP** | Feature creep risk |\n| Gamification (badges, levels) | **POST-MVP** | May feel childish for teen audience |\n| Smart home integration | **POST-MVP** | Cool but unnecessary complexity |\n\n### Feature Prioritization Rationale\n\n**MVP-LITE = Minimum Viable Product**\nThese features form the absolute core loop Maggie described: assign → complete → verify → reward. Without any one of these, the app doesn't fulfill its basic promise.\n\n**MVP = Enhanced Minimum Viable Product**\nThese features significantly improve UX and user retention without adding major complexity. Notifications prevent the \"I forgot\" problem. Activity feed provides the recognition Maggie wants. Reward history creates accountability.\n\n**POST-MVP = Future Enhancements**\nThese are \"nice to have\" but risk delaying launch or adding complexity that contradicts \"simple, fast, awesome.\" Better to ship clean MVP, gather feedback, then iterate.\n\n---\n\n## Skill 6: User Flows\n\n### Flow 1: Dad Assigns a Chore\n\n```\nSTART\n  ↓\nDad opens app → Dashboard\n  ↓\nTaps \"New Chore\" button\n  ↓\nEnters details:\n  - Chore name: \"Clean garage\"\n  - Description: \"Sweep floor, organize tools, take out trash\"\n  - Assign to: Maggie\n  - Reward: $15\n  - Due: Saturday 5pm (optional)\n  ↓\nTaps \"Assign\"\n  ↓\nChore appears on Maggie's \"My Chores\" list\n  ↓\nMaggie receives notification: \"New chore assigned: Clean garage - $15 reward\"\n  ↓\nEND\n```\n\n**Happy Path Success:** Chore created and communicated in under 30 seconds.\n\n**Alternate Paths:**\n- Dad saves as draft (assigns later)\n- Dad duplicates previous chore (recurring tasks)\n\n---\n\n### Flow 2: Maggie Completes and Reports Chore\n\n```\nSTART\n  ↓\nMaggie opens app → \"My Chores\" tab\n  ↓\nSees \"Clean garage\" chore card\n  - Shows: title, description, $15 reward, due Saturday 5pm\n  ↓\nMaggie does the chore (offline, real world)\n  ↓\nReturns to app, taps \"Clean garage\" card\n  ↓\nChore detail screen → Taps \"Mark Complete\" button\n  ↓\nOptional: Add note (\"Also washed the car!\")\n  ↓\nTaps \"Submit for Review\"\n  ↓\nChore moves to \"Awaiting Verification\" section\n  ↓\nDad receives notification: \"Maggie completed: Clean garage - Ready to verify\"\n  ↓\nEND\n```\n\n**Happy Path Success:** Reporting completion takes 3 taps + optional note.\n\n**Alternate Paths:**\n- Maggie marks \"In Progress\" first (shows Dad she's working on it)\n- Maggie adds photo proof (post-MVP feature)\n\n---\n\n### Flow 3: Dad Verifies and Grants Reward\n\n```\nSTART\n  ↓\nDad receives notification\n  ↓\nOpens app → \"Pending Verification\" section\n  ↓\nSees \"Clean garage\" awaiting review\n  ↓\nDad checks real-world work (walks to garage)\n  ↓\nReturns to app, taps chore card\n  ↓\nReviews Maggie's note\n  ↓\nDecision: Approve or Reject?\n  ↓\n  ├─ APPROVE:\n  │    ↓\n  │  Taps \"Approve & Reward\"\n  │    ↓\n  │  Chore marked complete, $15 added to Maggie's earned rewards\n  │    ↓\n  │  Maggie receives notification: \"Clean garage approved! You earned $15\"\n  │    ↓\n  │  Chore moves to \"Completed\" history\n  │    ↓\n  │  END (Happy path)\n  │\n  └─ REJECT:\n       ↓\n     Taps \"Request Changes\"\n       ↓\n     Adds feedback: \"Tools not organized, please finish\"\n       ↓\n     Chore returns to Maggie's active list with Dad's note\n       ↓\n     Maggie receives notification: \"Clean garage needs revision - see Dad's note\"\n       ↓\n     Maggie fixes issue, resubmits\n       ↓\n     Loop back to verification\n       ↓\n     END\n```\n\n**Happy Path Success:** Verification takes 2 taps if work is good.\n\n**Alternate Paths:**\n- Auto-approve after 24 hours (optional setting for trusted teens)\n- Dad marks \"Partially complete\" and adjusts reward ($10 instead of $15)\n\n---\n\n### Flow 4: Maggie Views Earned Rewards\n\n```\nSTART\n  ↓\nMaggie opens app → \"Rewards\" tab\n  ↓\nSees summary:\n  - Total earned this week: $35\n  - Total earned all time: $127\n  - Pending approval: $15 (garage chore)\n  ↓\nTaps \"History\" to see details\n  ↓\nScrolls through completed chores with dates and amounts\n  ↓\nTaps on specific chore to see details/notes\n  ↓\nEND\n```\n\n**Happy Path Success:** Clear visibility of effort → reward connection.\n\n**Alternate Paths:**\n- Export history as PDF (for tax purposes if kid runs a business, post-MVP)\n- Set savings goal (\"$200 for new bike\") with progress bar\n\n---\n\n## Skill 7: Information Architecture\n\n### Sitemap\n\n```\nChalley App\n│\n├── [AUTH] Family Login (simple code or email)\n│\n├── [PARENT VIEW]\n│   ├── Dashboard\n│   │   ├── Active chores (all users)\n│   │   ├── Pending verification\n│   │   ├── Quick stats (completed this week, total rewards paid)\n│   │   └── + New Chore button\n│   │\n│   ├── Create/Edit Chore\n│   │   ├── Form fields (name, description, assignee, reward, due date)\n│   │   └── Save/Assign button\n│   │\n│   ├── Verify Chore\n│   │   ├── Chore details\n│   │   ├── Kid's completion note\n│   │   └── Approve / Request Changes / Reject\n│   │\n│   ├── Family Management\n│   │   ├── Add/remove kids\n│   │   └── View user profiles\n│   │\n│   └── Settings\n│       ├── Notification preferences\n│       ├── Auto-approve rules\n│       └── Reward defaults\n│\n├── [KID VIEW]\n│   ├── My Chores\n│   │   ├── To Do (assigned chores)\n│   │   ├── In Progress (started but not submitted)\n│   │   ├── Awaiting Verification (submitted)\n│   │   └── Completed (approved history)\n│   │\n│   ├── Chore Detail\n│   │   ├── Description and requirements\n│   │   ├── Reward amount\n│   │   ├── Due date\n│   │   └── Mark Complete / Add Note\n│   │\n│   ├── My Rewards\n│   │   ├── Total earned (week, month, all-time)\n│   │   ├── Pending (awaiting approval)\n│   │   └── History (past rewards)\n│   │\n│   └── Activity Feed\n│       ├── New assignments\n│       ├── Approvals\n│       └── Parent comments\n│\n└── [SHARED]\n    ├── Notifications (push alerts)\n    ├── Help/Tutorial (first-time user flow)\n    └── Logout\n```\n\n### Screen Count Estimate\n\n**MVP-LITE:** 8-10 screens\n**MVP:** 12-15 screens\n**POST-MVP:** 20+ screens\n\n### Navigation Pattern\n\n**Bottom Tab Bar (Kid View):**\n- My Chores\n- Rewards\n- Activity\n\n**Bottom Tab Bar (Parent View):**\n- Dashboard\n- Verify\n- Family\n\n**Top Navigation:**\n- Settings (gear icon)\n- Notifications (bell icon)\n\n---\n\n## Skill 8: Risk Assessment\n\n### Technical Risks\n\n| Risk | Severity | Likelihood | Mitigation |\n|------|----------|------------|------------|\n| **Real-time sync issues** — Parent and kid using different devices, data out of sync | HIGH | MEDIUM | Use proven backend (Firebase, Supabase) with built-in real-time sync. Test offline scenarios. |\n| **Authentication complexity** — Teens may not have email addresses, parents need security | MEDIUM | MEDIUM | Start with simple family code system (like Jackbox games). Add proper auth post-MVP. |\n| **Platform fragmentation** — Need iOS + Android, budget may only support one | HIGH | LOW | Build as PWA (Progressive Web App) or use React Native for cross-platform. Start mobile-web, add native later. |\n| **Notification delivery** — Push alerts critical to workflow, but can be unreliable | MEDIUM | MEDIUM | Implement in-app notifications as backup. Test notification permissions onboarding carefully. |\n| **Data privacy** — Storing family data (kids' info) raises COPPA/GDPR concerns | MEDIUM | LOW | Don't collect unnecessary data. Use age-appropriate privacy policy. Consider parent-owned account model. |\n\n### Adoption Risks\n\n| Risk | Severity | Likelihood | Mitigation |\n|------|----------|------------|------------|\n| **Parent won't adopt** — If Dad doesn't use it, Maggie can't either | CRITICAL | MEDIUM | Make parent workflow extremely fast (< 30 sec to assign chore). Ensure notifications work reliably. |\n| **Competing with paper/texts** — Why use an app when sticky notes/texts work? | HIGH | MEDIUM | Emphasize unique value: reward tracking, history, no lost notes. Make onboarding show immediate value. |\n| **Feature confusion** — Too many options overwhelm first-time users | MEDIUM | HIGH | Ship MVP-LITE first. Add features via settings (opt-in). Strong onboarding tutorial. |\n| **Sibling fairness issues** — What if Maggie has siblings who feel left out or treated unfairly? | MEDIUM | MEDIUM | Support multiple kids from day one. Transparent chore assignments (everyone sees who does what). |\n| **Reward disputes** — Arguments about whether work was \"good enough\" | MEDIUM | MEDIUM | Encourage clear descriptions upfront. Feedback loop (request changes) instead of binary approve/reject. |\n\n### Scope Risks\n\n| Risk | Severity | Likelihood | Mitigation |\n|------|----------|------------|------------|\n| **Feature creep** — Client or users request calendars, allowance tracking, etc. | HIGH | HIGH | Define MVP-LITE boundaries clearly. Have \"roadmap\" for future features. Say \"yes, later\" not \"no.\" |\n| **Perfectionism** — \"Simple, fast, awesome\" → spending too long polishing UI | MEDIUM | MEDIUM | Set sprint deadlines. Ship functional MVP even if not perfect. Iterate based on feedback. |\n| **Integration requests** — Users want Venmo, bank accounts, smart home, etc. | LOW | LOW | Park for post-MVP. Keep core simple. |\n\n### Business Risks\n\n| Risk | Severity | Likelihood | Mitigation |\n|------|----------|------------|------------|\n| **Monetization unclear** — How does Challey make money? | MEDIUM | LOW | For Maggie's use case, this is less critical (personal project). If commercializing: freemium model (free for 1 family, $2.99/month unlimited) or one-time $9.99 purchase. |\n| **Competitive response** — Big players (Greenlight, S'moresUp) add \"simple mode\" | LOW | LOW | Speed to market. Focus on teen-first design (they can't pivot easily). Build community. |\n| **Maintenance burden** — App needs updates, bug fixes, server costs | MEDIUM | MEDIUM | Use low-cost/free backend tier (Firebase free plan supports small user base). Open-source if community wants to help. |\n\n### Overall Risk Profile\n\n**Biggest Threats:**\n1. **Parent adoption** — If Dad doesn't commit to using the app, it fails immediately.\n2. **Feature creep** — Adding too much too soon contradicts \"simple, fast, awesome.\"\n3. **Technical sync issues** — Poor real-time updates create frustration and distrust.\n\n**Risk Mitigation Strategy:**\n- **Phase 1:** Build MVP-LITE with only 6 core features. Test with Maggie's family.\n- **Phase 2:** Gather feedback. Fix bugs. Add top-requested MVP feature.\n- **Phase 3:** Consider beta with 5-10 families. Iterate.\n- **Phase 4:** Public launch or keep private based on goals.\n\n---\n\n## Recommendations\n\n### What to Build First (MVP-LITE)\n\n**Week 1-2: Core Workflow**\n1. Simple login (family code)\n2. Create chore (parent)\n3. View chores (kid)\n4. Mark complete (kid)\n5. Verify/approve (parent)\n6. Basic reward tracking\n\n**Week 3: Polish**\n- Notifications (push or in-app)\n- Activity feed\n- Basic dashboard\n\n**Week 4: Testing**\n- Test with Maggie's family\n- Fix bugs\n- Gather feedback\n\n### What NOT to Build (Yet)\n\n- Allowance tracking (POST-MVP)\n- Recurring chores (POST-MVP)\n- Photos (POST-MVP)\n- Calendar integration (POST-MVP)\n- Banking/Venmo (POST-MVP)\n- Gamification (POST-MVP)\n\n### Success Metrics\n\n**For Maggie:**\n- Can report completed chores in < 5 taps\n- Sees rewards earned clearly\n- Feels recognized by parents\n\n**For Dad:**\n- Can assign chore in < 30 seconds\n- Gets notified when chores complete\n- Can verify quickly from phone\n\n**For Both:**\n- Fewer verbal reminders/arguments\n- Clear record of who did what\n- Family harmony improves\n\n---\n\n## Next Steps\n\n### Phase 1 Deliverables (Complete)\n- ✅ Discovery document (this file)\n- ✅ Summary report for PM\n- 🔜 Feedback Agent review with client (Maggie)\n- 🔜 Prototype design (UI/UX Designer)\n\n### Pending Questions for Client Review\n1. **Siblings:** Does Maggie have siblings who would also use this? (Affects user management scope)\n2. **Reward types:** Is money the only reward, or also privileges (screen time, outings, etc.)?\n3. **Verification strictness:** Should Dad be able to set \"auto-approve\" for certain chores Maggie does regularly?\n4. **Mobile vs. web:** Does Maggie primarily use a phone, tablet, or computer?\n5. **Parent count:** Just Dad assigns chores, or Mom too? (Affects user roles)\n\nThese questions will be addressed during Feedback Agent review.\n\n---\n\n## Appendix: Research Sources\n\n### Market Research\n- [Kids Chores Tracker (Google Play)](https://play.google.com/store/apps/details?id=io.neatkid.android&hl=en_US)\n- [Best Chore Apps for Families | Educational App Store](https://www.educationalappstore.com/app-lists/best-family-apps)\n- [Parenting Patch: Best Chore Apps](https://parentingpatch.com/best-chore-apps-for-kids-and-what-they-offer/)\n- [Homey App Official Site](https://www.homeyapp.net/)\n- [My First Nest Egg: Top 16 Allowance Apps](https://myfirstnestegg.com/articles/allowance-chores-app-for-kids/)\n\n### Competitive Analysis\n- [KiddiKash: Best Chore Apps 2025](https://www.kiddikash.com/blog/best-chore-apps-2025)\n- [Joon: 11 Best Chore Apps](https://www.joonapp.io/post/chore-app-for-kids)\n- [Common Sense Media: S'moresUp Review](https://www.commonsensemedia.org/app-reviews/smoresup-best-chores-app)\n- [FamiSafe: 8 Best Family Chore Apps 2026](https://famisafe.wondershare.com/app-review/family-chore-app.html)\n\n### User Research\n- [Orthodontics Limited: 10 Ways to Motivate Teens](https://www.orthodonticslimited.com/parenting/motivate-your-teens-to-love-chores/)\n- [Empowering Parents: How to Get Kids to Do Chores](https://www.empoweringparents.com/article/ill-do-it-later6-ways-to-get-kids-to-do-chores-now/)\n- [Parents App: Chores for Teenagers](https://parents.app/child-ages-stages/teenagers/chores-for-teenagers/a/)\n- [Greenlight: Chore List for Teens](https://greenlight.com/learning-center/home-and-chores/chore-list-for-teens)\n\n### Design Inspiration\n- [Bright Canary: 4 Best Apps for Teens](https://www.brightcanary.io/4-best-chore-and-allowance-apps-for-teens-and-tweens/)\n- [Levelty: Gamified Chore App](https://levelty.app/)\n- [BusyKid: Chore Charts](https://busykid.com/about-busykid/chore-charts/)\n\n---\n\n**Document Status:** FINAL\n**Ready for:** Feedback Agent Review (Mode 1)\n**Next Agent:** Feedback Agent → UI/UX Designer\n","challey/future-versions":"# Challey — Future Versions & Feature Backlog\n\n**Last Updated:** February 10, 2026\n**Current Version:** v2.0 (prototype) — tagged as `v2.0-prototype`\n\n---\n\n## Version Strategy\n\nChalley will ship multiple versions tailored to different age groups:\n\n| Version | Target Age | Design Language | Key Differences |\n|---------|-----------|-----------------|-----------------|\n| **Challey Teen** | 13-17 | Sleek, mature, financial dashboard | Current version (v2+) |\n| **Challey Kids** | 8-12 | Colorful, gamified, story-driven | More badges, levels, fun animations |\n| **Challey Family** | All ages | Adaptive UI per user age | Auto-switches UI based on user age profile |\n\n---\n\n## Features Included in Current Version (v2.x)\n\n- [x] Core chore workflow (assign → complete → photo proof → verify → points)\n- [x] Points-based reward catalog (parents create, kids redeem)\n- [x] Wishlist with occasion tags (Birthday, Christmas, Holiday, Anytime)\n- [x] Parent-awarded badges for outstanding behavior\n- [x] Sibling leaderboard\n- [x] Streak counter with flame animation\n- [x] Emoji reactions on chore approvals\n- [x] Profile pictures\n- [x] 6 color themes + dark mode (kid + parent settings)\n- [x] Role switcher (Kid/Parent views)\n- [x] Notifications panel\n- [x] Education Hub placeholder (POST-MVP)\n- [x] Achievements placeholder (POST-MVP)\n- [x] Chore Swap (sibling ↔ sibling, kid → parent request) — v2.1\n- [x] Reward fulfillment tracking with parent nudges — v2.1\n- [x] Khan Academy integration — v2.1\n- [x] Canvas LMS integration — v2.1\n\n---\n\n## Backlog — Future Features (Prioritized)\n\n### Tier 1: High Impact (Next Versions)\n\n#### 1. \"Parent Forgot\" Smart Reminders\n- **What:** Escalating nudges when parents haven't verified a chore in 24h/48h\n- **Why:** #1 reason kids stop using chore apps across ALL competitors\n- **Who:** Parents (accountability), Kids (motivation preservation)\n- **Emotional impact:** Kids feel valued, not ignored\n\n#### 2. Age-Weighted Leaderboards (Fairness Algorithm)\n- **What:** Adjust points by age/capability so younger kids can compete\n- **Why:** Sibling fairness is a top complaint in multi-kid families\n- **Who:** Younger kids (8-12), Parents (fewer fights)\n- **Best for:** Challey Kids version\n\n#### 3. Teen Mode (Financial Dashboard)\n- **What:** Sleek banking-style UI with savings trends, spending graphs, budget tools\n- **Why:** No competitor offers age-appropriate financial tools for teens\n- **Who:** Teens 13-17\n- **Best for:** Challey Teen version\n\n#### 4. Auto-Verification via Health Data\n- **What:** Physical chores auto-verify via Apple Health/Google Fit step count\n- **Integration:** Apple HealthKit API (free), Health Connect API (free)\n- **Why:** Instant gratification, reduces parent verification burden\n- **Who:** All kids, Parents\n\n#### 5. Streak Freeze & Grace Periods\n- **What:** Freeze streak 2x/month (sick days, vacation, exams)\n- **Why:** Prevents Duolingo-style streak anxiety and burnout\n- **Who:** All kids\n- **Research:** 40% of teens limit app use due to streak anxiety\n\n### Tier 2: Differentiation (Post-Launch)\n\n#### 6. Charity Donation Integration\n- **Integration:** GlobalGiving API (free), Pledge API\n- **What:** Kids donate points to real charities, parents match donations\n- **Why:** Makes Challey shareable/viral; reduces \"transactional parenting\" guilt\n- **Who:** Teens (social sharing), Parents (values-based)\n\n#### 7. Google Calendar Sync with Conflict Alerts\n- **Integration:** Google Calendar API (free)\n- **What:** Sync chore due dates, alert when kid is overloaded\n- **Why:** No chore app does smart conflict detection\n- **Who:** Parents (reduce chaos), Kids (feel seen)\n\n#### 8. Voice-Activated Chore Logging\n- **Integration:** Alexa Skills API (free), Google Assistant SDK (free)\n- **What:** \"Alexa, I finished folding laundry\" → logs in Challey\n- **Why:** Faster than opening app, feels futuristic\n- **Who:** All kids, especially younger kids\n\n#### 9. Chore Negotiation System\n- **What:** Kids propose alternative chores to parents via in-app messaging\n- **Why:** Teaches negotiation, gives teens agency\n- **Who:** Teens (autonomy), Parents (teaching life skills)\n\n#### 10. Apple Pay / Google Pay Allowance Transfer\n- **Integration:** Apple Pay API ($99/yr dev account), Google Pay API ($25 one-time)\n- **What:** Parents transfer allowance directly to kid's digital wallet\n- **Why:** Points → real money, seamless\n- **Who:** Teens with digital wallets\n\n### Tier 3: Advanced (Future Roadmap)\n\n#### 11. Recurring Chores with Smart Scheduling\n- **What:** Auto-assign daily/weekly chores, rotate between kids\n- **Why:** Reduces parent setup burden\n\n#### 12. Family Messaging/Chat\n- **What:** In-app messaging between family members about chores\n- **Why:** Keeps chore discussions in context\n\n#### 13. Multi-Household Support\n- **What:** Kids in shared custody see chores from both houses\n- **Why:** Serves single parents and divorced families\n\n#### 14. Savings Goals with Progress Bars\n- **What:** Kids set savings targets (\"$200 for new bike\") with visual progress\n- **Why:** Financial literacy, motivation\n\n#### 15. Weekly Family Report\n- **What:** Auto-generated summary of who did what, points earned, rewards given\n- **Why:** Accountability and celebration\n\n#### 16. Chore Templates Library\n- **What:** Pre-built chore lists by age group (age 8-10, 11-13, 14-17)\n- **Why:** Faster onboarding for parents\n\n#### 17. Supply Tracking Alerts\n- **What:** Alert when cleaning supplies are low (user-reported)\n- **Why:** Chorsee users specifically requested this\n\n#### 18. \"Away\" Mode\n- **What:** Pause all notifications and assignments when family is on vacation\n- **Why:** Prevents notification guilt during downtime\n\n#### 19. Photo Before/After Comparison\n- **What:** Kid takes \"before\" photo when starting, \"after\" when done\n- **Why:** Visual proof of effort, satisfying comparison\n\n#### 20. Gamification System (Levels, XP, Unlocks)\n- **What:** RPG-style leveling with XP from chores, unlockable themes/avatars\n- **Why:** Engagement for younger kids (8-12)\n- **Best for:** Challey Kids version\n\n---\n\n## Integration Status Tracker\n\n| Integration | API Available | Cost | Status | Version Target |\n|------------|-------------|------|--------|----------------|\n| Google Classroom | Yes | Free | Planned | v2.x |\n| Khan Academy | Yes | Free | In Prototype | v2.1 |\n| Canvas LMS | Yes | Free | In Prototype (note: school auth needed) | v2.1 |\n| Microsoft Teams Education | Yes | Free | Backlog | v3.x |\n| Google Calendar | Yes | Free | Backlog | v3.x |\n| Apple HealthKit | Yes | Free | Backlog | v3.x |\n| Health Connect (Android) | Yes | Free | Backlog | v3.x |\n| Alexa Skills | Yes | Free | Backlog | v3.x |\n| Google Home | Yes | Free | Backlog | v3.x |\n| Firebase (push notifications) | Yes | Free | Planned | v2.x build |\n| Twilio (SMS) | Yes | ~$0.01/text | Backlog | v3.x |\n| GlobalGiving (charity) | Yes | Free | Backlog | v3.x |\n| Stripe (payments) | Yes | 2.9%/txn | Backlog | v3.x |\n| Apple Pay | Yes | $99/yr dev | Backlog | v3.x |\n| Google Pay | Yes | $25 one-time | Backlog | v3.x |\n| Schoology | Partial | Partnership | Backlog | v4.x |\n| Duolingo | No API | N/A | Not viable | — |\n| Amazon Product API | Sunsetting 2026 | N/A | Not viable | — |\n| Seesaw | No API | N/A | Not viable | — |\n| Greenlight | Closed | N/A | Not viable | — |\n\n---\n\n## Competitive Research Summary\n\n**Key gaps we exploit:**\n1. Approval delays kill motivation → Smart parent reminders\n2. Sibling competition feels unfair → Age-weighted leaderboards\n3. Teens hate childish design → Teen Mode financial dashboard\n4. Transactional parenting guilt → Charity donations + education integration\n5. Feature bloat overwhelms families → Stay simple, add features as settings\n6. Subscription fatigue → Free or low one-time cost\n7. Technical unreliability → Rock-solid basics before fancy features\n\n**Full research report:** See BA discovery document and PM competitive analysis notes.\n\n---\n\n*This document is maintained by the Project Manager and updated as features move through the pipeline.*\n"};
</script>
</head>
<body>

<!-- Header -->
<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <button class="menu-toggle" id="menu-toggle" aria-label="Toggle sidebar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
    </button>
    <div class="logo" onclick="goHome()" style="cursor:pointer">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #7cacf8">
        <polygon points="12 2 2 7 12 12 22 7 12 2"/>
        <polyline points="2 17 12 22 22 17"/>
        <polyline points="2 12 12 17 22 12"/>
      </svg>
      <span>Crucible</span>
    </div>
  </div>
  <div class="header-right">
    <div class="header-stat">
      <div class="pulse"></div>
      <span id="project-count">0 projects</span>
    </div>
  </div>
</header>

<!-- Layout -->
<div class="sidebar-backdrop" id="sidebar-backdrop"></div>
<div class="layout">
  <nav class="sidebar" id="sidebar"></nav>
  <main class="main" id="main-content"></main>
</div>

<!-- Document Viewer Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-title">Document</h3>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div class="modal-body markdown-body" id="modal-body"></div>
  </div>
</div>

<!-- Report Viewer Modal -->
<div class="report-overlay" id="report-overlay">
  <div class="report-viewer">
    <div class="report-header">
      <div class="report-header-left">
        <div class="report-header-icon" id="report-icon">&#128200;</div>
        <div>
          <h3 id="report-title">Report</h3>
          <div class="report-project" id="report-project"></div>
        </div>
      </div>
      <div class="report-actions">
        <button class="report-btn" id="report-newtab" title="Open in new tab">&#8599; New Tab</button>
        <button class="report-close" id="report-close">&times;</button>
      </div>
    </div>
    <iframe class="report-frame" id="report-frame"></iframe>
  </div>
</div>

<script>
  let projects = {};
  let selectedProject = null;

  // --- Data ---
  async function loadProjects() {
    try {
      const data = window.__STATIC_MODE__ ? window.__PROJECTS_DATA__ : await (await fetch('/api/projects')).json();
      projects = data.projects || {};
      renderSidebar();
      if (selectedProject && projects[selectedProject]) {
        renderDetail(selectedProject);
      } else {
        renderHome();
      }
      const count = Object.keys(projects).length;
      document.getElementById('project-count').textContent =
        `${count} project${count !== 1 ? 's' : ''}`;
    } catch {
      projects = {};
      renderSidebar();
      renderHome();
    }
  }

  // --- Phase helpers ---
  function getPhaseInfo(state) {
    if (!state || !state.phases) return { phase: 'unknown', label: 'Unknown', index: -1 };

    // Use state.phase as the primary source of truth
    const phaseMap = {
      discovery: { phase: 'discovery', label: 'Discovery', index: 0 },
      specification: { phase: 'specification', label: 'Specification', index: 1 },
      architecture: { phase: 'architecture', label: 'Architecture', index: 2 },
      build: { phase: 'build', label: 'Build', index: 3 },
      complete: { phase: 'complete', label: 'Complete', index: 4 },
    };

    if (state.phase && phaseMap[state.phase]) {
      return phaseMap[state.phase];
    }

    // Fallback: derive from phases object by finding the latest active/approved phase
    const phases = state.phases;
    if (phases.build && (phases.build.status === 'ready' || phases.build.status === 'in_progress')) {
      return phaseMap.build;
    }
    if (phases.architecture && (phases.architecture.feedback_gate === 'passed' || phases.architecture.status === 'approved')) {
      return phaseMap.build;
    }
    if (phases.specification && (phases.specification.feedback_gate === 'passed' || phases.specification.status === 'approved')) {
      return phaseMap.architecture;
    }
    if (phases.discovery && (phases.discovery.feedback_gate === 'passed' || phases.discovery.status === 'approved')) {
      return phaseMap.specification;
    }

    return phaseMap.discovery;
  }

  function getIndicatorColor(phase) {
    const map = { discovery: '#4ade80', specification: '#7cacf8', architecture: '#c4b5fd', build: '#fbbf24', complete: 'rgba(255,255,255,0.25)', unknown: 'rgba(255,255,255,0.25)' };
    return map[phase] || map.unknown;
  }

  function formatTimeAgo(dateStr) {
    if (!dateStr) return '';
    const diff = Date.now() - new Date(dateStr).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    return `${Math.floor(hrs / 24)}d ago`;
  }

  // --- Sidebar ---
  function renderSidebar() {
    const sidebar = document.getElementById('sidebar');
    const entries = Object.entries(projects);

    if (entries.length === 0) {
      sidebar.innerHTML = `
        <div class="sidebar-section">
          <div class="sidebar-label">Projects</div>
          <div style="padding: 16px 10px; text-align: center; color: var(--sidebar-text); font-size: 12px; line-height: 1.6;">
            No projects yet.<br>Run <code style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:3px;color:#7cacf8">/crucible</code> to start.
          </div>
        </div>`;
      return;
    }

    const active = entries.filter(([, d]) => {
      const p = getPhaseInfo(d.state);
      return p.phase !== 'complete';
    });
    const completed = entries.filter(([, d]) => {
      const p = getPhaseInfo(d.state);
      return p.phase === 'complete';
    });

    let html = '';

    if (active.length > 0) {
      html += `<div class="sidebar-section"><div class="sidebar-label">Active</div>`;
      html += active.map(([name, data]) => {
        const pi = getPhaseInfo(data.state);
        const isActive = name === selectedProject;
        return `
          <div class="nav-item ${isActive ? 'active' : ''}" onclick="selectProject('${name}')">
            <div class="indicator" style="background: ${getIndicatorColor(pi.phase)}"></div>
            <span class="name">${name}</span>
            <span class="badge badge-${pi.phase}">${pi.label}</span>
          </div>
          <div class="phase-dots">
            ${[0,1,2,3].map(i => `<div class="phase-dot ${i < pi.index ? 'done' : ''} ${i === pi.index ? 'current' : ''}"></div>`).join('')}
          </div>`;
      }).join('');
      html += `</div>`;
    }

    if (completed.length > 0) {
      html += `<div class="sidebar-section"><div class="sidebar-label">Completed</div>`;
      html += completed.map(([name]) => `
        <div class="nav-item ${name === selectedProject ? 'active' : ''}" onclick="selectProject('${name}')">
          <div class="indicator" style="background: rgba(255,255,255,0.25)"></div>
          <span class="name">${name}</span>
          <span class="badge badge-complete">Done</span>
        </div>`).join('');
      html += `</div>`;
    }

    sidebar.innerHTML = html;
  }

  // --- Navigation ---
  function goHome() {
    selectedProject = null;
    renderSidebar();
    renderHome();
  }

  // --- Home View ---
  function getGreeting() {
    const h = new Date().getHours();
    if (h < 12) return 'Good morning';
    if (h < 17) return 'Good afternoon';
    return 'Good evening';
  }

  function renderHome() {
    const main = document.getElementById('main-content');
    const entries = Object.entries(projects);
    const count = entries.length;

    // Compute stats
    const phaseCount = { discovery: 0, specification: 0, architecture: 0, build: 0 };
    let totalDeliverables = 0, completedDeliverables = 0, totalGates = 0, passedGates = 0, demosReady = 0;

    entries.forEach(([, data]) => {
      const pi = getPhaseInfo(data.state);
      if (phaseCount[pi.phase] !== undefined) phaseCount[pi.phase]++;

      const dKeys = ['discovery', 'specification', 'architecture', 'technology', 'buildPlan'];
      dKeys.forEach(k => {
        totalDeliverables++;
        if (data.deliverables?.[k]) completedDeliverables++;
      });

      const stPhases = data.state?.phases || {};
      ['discovery', 'specification', 'architecture', 'build'].forEach(g => {
        totalGates++;
        if (stPhases[g]?.feedback_gate === 'passed') passedGates++;
      });

      if (data.demo) demosReady++;
    });

    const inBuild = phaseCount.build;
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // Build activity from what we can derive
    const activities = [];
    entries.forEach(([name, data]) => {
      const pi = getPhaseInfo(data.state);
      const statePhases = data.state?.phases || {};
      const phaseColors = { discovery: 'green', specification: 'blue', architecture: 'violet', build: 'amber' };
      const dotColor = phaseColors[pi.phase] || 'blue';

      if (data.demo) activities.push({ dot: dotColor, html: `<strong>${name}</strong> interactive prototype is ready`, sort: 2 });
      if (data.researchReport) activities.push({ dot: 'blue', html: `<strong>${name}</strong> research report generated`, sort: 3 });
      if (data.buildProposal) activities.push({ dot: 'amber', html: `<strong>${name}</strong> build proposal created`, sort: 4 });

      if (statePhases.architecture?.feedback_gate === 'passed') activities.push({ dot: 'green', html: `<strong>${name}</strong> architecture gate approved`, sort: 5 });
      if (statePhases.specification?.feedback_gate === 'passed') activities.push({ dot: 'green', html: `<strong>${name}</strong> specification gate approved`, sort: 6 });
      if (statePhases.discovery?.feedback_gate === 'passed') activities.push({ dot: 'green', html: `<strong>${name}</strong> discovery gate approved`, sort: 7 });

      const agent = data.state?.currentAgent;
      if (agent) activities.push({ dot: dotColor, html: `<strong>${name}</strong> is being worked on by ${agent}`, sort: 1 });
    });

    activities.sort((a, b) => a.sort - b.sort);
    const activityHtml = activities.length > 0
      ? activities.slice(0, 8).map(a => `
          <div class="activity-item">
            <div class="act-dot ${a.dot}"></div>
            <div>
              <div class="act-text">${a.html}</div>
            </div>
          </div>`).join('')
      : '<div style="padding:12px 0;font-size:13px;color:var(--text-3);text-align:center;">No activity yet. Start a project to see updates here.</div>';

    // No projects at all
    if (count === 0) {
      main.innerHTML = `
        <div class="home">
          <div class="greeting">
            <h1>${getGreeting()}, Carlos</h1>
            <p>Welcome to Crucible. You don't have any projects yet — let's change that.</p>
            <div class="date">${dateStr}</div>
          </div>
          <div class="tip-banner">
            <div class="tip-icon">&#9889;</div>
            <div class="tip-text">
              <strong>Get started:</strong> Run <code>/crucible</code> in Claude Code to kick off your first project. The pipeline will guide you through Discovery, Specification, Architecture, and Build.
            </div>
          </div>
        </div>`;
      return;
    }

    // Build project cards
    const projectCardsHtml = entries.map(([name, data]) => {
      const pi = getPhaseInfo(data.state);
      const desc = data.state?.description || data.description || 'Product development project';
      const dKeys = [
        { k: 'discovery', l: 'D' }, { k: 'specification', l: 'S' },
        { k: 'architecture', l: 'A' }, { k: 'technology', l: 'T' }, { k: 'buildPlan', l: 'B' }
      ];

      return `
        <div class="home-project-card" onclick="selectProject('${name}')">
          <div class="hpc-top">
            <div class="hpc-name">${name}</div>
            <div class="hpc-badge hpc-badge-${pi.phase}">${pi.label}</div>
          </div>
          <div class="hpc-desc">${desc}</div>
          <div class="hpc-progress">
            ${[0,1,2,3].map(i => `<div class="hpc-seg ${i < pi.index ? 'done' : ''} ${i === pi.index ? 'active' : ''}"></div>`).join('')}
          </div>
          <div class="hpc-footer">
            <div class="hpc-meta">${pi.label} phase</div>
            <div class="hpc-deliverables">
              ${dKeys.map(d => `<div class="hpc-dd ${data.deliverables?.[d.k] ? 'ready' : ''}" title="${d.k}">${d.l}</div>`).join('')}
            </div>
          </div>
        </div>`;
    }).join('');

    main.innerHTML = `
      <div class="home">
        <div class="greeting">
          <h1>${getGreeting()}, Carlos</h1>
          <p>You have <strong>${count} active project${count !== 1 ? 's' : ''}</strong> in the pipeline. Here's what's happening.</p>
          <div class="date">${dateStr}</div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Projects</div>
            <div class="stat-value sv-blue">${count}</div>
            <div class="stat-sub">${inBuild > 0 ? inBuild + ' in build phase' : 'all in progress'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Deliverables</div>
            <div class="stat-value sv-green">${completedDeliverables}</div>
            <div class="stat-sub">of ${totalDeliverables} complete</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Gates Passed</div>
            <div class="stat-value sv-violet">${passedGates}</div>
            <div class="stat-sub">of ${totalGates} total</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Demos Ready</div>
            <div class="stat-value sv-amber">${demosReady}</div>
            <div class="stat-sub">${demosReady === 1 ? '1 prototype' : demosReady + ' prototypes'}</div>
          </div>
        </div>

        <div class="home-cols">
          <div>
            <div class="home-section-title">Your Projects</div>
            ${projectCardsHtml}
          </div>
          <div>
            <div class="home-section-title">Activity</div>
            <div class="activity-card">
              ${activityHtml}
            </div>
            <div class="tip-banner">
              <div class="tip-icon">&#9889;</div>
              <div class="tip-text">
                <strong>Tip:</strong> Run <code>/crucible</code> in Claude Code to start a new project or resume an existing one.
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }

  // --- Project Detail ---
  function selectProject(name) {
    selectedProject = name;
    renderSidebar();
    renderDetail(name);
  }

  function renderDetail(name) {
    const data = projects[name];
    if (!data) return;

    const main = document.getElementById('main-content');
    const phaseInfo = getPhaseInfo(data.state);
    const state = data.state || {};
    // Derive gates from state.phases.{name}.feedback_gate
    const phases = state.phases || {};
    const gates = {
      discovery: phases.discovery?.feedback_gate === 'passed' ? 'approved' : phases.discovery?.status,
      specification: phases.specification?.feedback_gate === 'passed' ? 'approved' : phases.specification?.status,
      architecture: phases.architecture?.feedback_gate === 'passed' ? 'approved' : phases.architecture?.status,
      build: phases.build?.feedback_gate === 'passed' ? 'approved' : phases.build?.status,
    };
    const phaseNames = ['Discovery', 'Specification', 'Architecture', 'Build'];

    const docItems = [
      { key: 'discovery', iconClass: 'green', icon: '&#128203;', name: 'Discovery', desc: 'Business analysis, user roles, market research' },
      { key: 'specification', iconClass: 'blue', icon: '&#128220;', name: 'Specification', desc: 'Functional requirements, data model, acceptance criteria' },
      { key: 'architecture', iconClass: 'violet', icon: '&#127959;', name: 'Architecture', desc: 'System design, components, ADRs' },
      { key: 'technology', iconClass: 'amber', icon: '&#9881;', name: 'Technology', desc: 'Stack recommendation, build vs buy' },
      { key: 'buildPlan', iconClass: 'teal', icon: '&#128221;', name: 'Build Plan', desc: 'Task breakdown, milestones, CLAUDE.md' },
    ];

    // Status rows
    const statusRows = [];
    if (state.currentAgent) statusRows.push({ label: 'Agent', value: state.currentAgent, cls: 'accent' });
    if (state.phases?.build?.currentBuildPhase) statusRows.push({ label: 'Build Phase', value: state.phases.build.currentBuildPhase, cls: '' });
    if (state.phases?.build?.currentTask) statusRows.push({ label: 'Current Task', value: state.phases.build.currentTask, cls: '' });
    if (state.mode) statusRows.push({ label: 'Mode', value: state.mode, cls: state.mode === 'headless' ? 'green' : '' });

    // Build progress
    const buildPhase = state.phases?.build;
    const completedTasks = buildPhase?.completedTasks?.length || 0;
    const totalTasks = buildPhase?.totalTasks || 0;
    const pct = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

    // Gate items
    const gateItems = [
      { key: 'discovery', label: 'Discovery' },
      { key: 'specification', label: 'Specification' },
      { key: 'architecture', label: 'Architecture' },
      { key: 'build', label: 'MVP Acceptance' },
    ];

    // Cost
    const costLog = state.costLog || [];
    const totalAutoApproved = costLog.reduce((sum, c) => sum + (c.monthlyCost || 0), 0);

    main.innerHTML = `
      <div class="project-detail">
        <div class="project-header">
          <div class="project-title-row">
            <h1 class="project-title">${name}</h1>
            <span class="project-status-chip">Active</span>
          </div>
          <p class="project-desc">${state.description || 'Product development project'}</p>
        </div>

        <!-- Phase Progress -->
        <div class="phase-bar">
          ${phaseNames.map((phaseName, i) => {
            let cls = '';
            if (i < phaseInfo.index) cls = 'done';
            else if (i === phaseInfo.index) cls = 'active';
            const nodeContent = i < phaseInfo.index ? '&#10003;' : (i + 1);
            const detail = i < phaseInfo.index ? 'Approved' : (i === phaseInfo.index ? (state.currentSkill || 'In progress') : '');
            return `
              <div class="phase-step ${cls}">
                <div class="phase-num">${nodeContent}</div>
                <div class="phase-text">
                  <div class="phase-name">${phaseName}</div>
                  ${detail ? `<div class="phase-detail">${detail}</div>` : ''}
                </div>
              </div>`;
          }).join('')}
        </div>

        <!-- Content Grid -->
        <div class="content-area">
          <div>
            <!-- Deliverables -->
            <div class="section">
              <div class="section-header">Deliverables</div>
              <div class="doc-list">
                ${docItems.map(d => {
                  const exists = data.deliverables?.[d.key];
                  const docName = d.key === 'buildPlan' ? 'build-plan' : d.key;
                  return `
                    <a class="doc-row ${exists ? '' : 'disabled'}"
                       ${exists ? `href="view/${name}/${docName}.html" target="_blank"` : ''}
                       style="text-decoration:none;color:inherit">
                      <div class="doc-icon ${d.iconClass}">${d.icon}</div>
                      <div class="doc-info">
                        <div class="doc-name">${d.name}</div>
                        <div class="doc-desc">${exists ? d.desc : 'Not yet created'}</div>
                      </div>
                      ${exists ? '<span class="doc-arrow">&#8250;</span>' : ''}
                    </a>`;
                }).join('')}
              </div>
            </div>

            <!-- Reports & Demo -->
            <div class="section">
              <div class="section-header">Reports &amp; Demo</div>
              <div class="action-cards">
                <div class="action-card ${data.demo ? '' : 'disabled'}"
                     ${data.demo ? `onclick="openDemo('${name}')"` : ''}>
                  <div class="action-icon demo">&#9654;</div>
                  <div class="action-info">
                    <div class="action-name">Interactive Prototype</div>
                    <div class="action-desc">Click through the approved UI prototype</div>
                  </div>
                </div>
                <a class="action-card ${data.researchReport ? '' : 'disabled'}"
                   ${data.researchReport ? `href="reports/${data.researchReport}" target="_blank"` : ''}
                   style="text-decoration:none;color:inherit">
                  <div class="action-icon report">&#128200;</div>
                  <div class="action-info">
                    <div class="action-name">Research Report</div>
                    <div class="action-desc">Market research, competitor analysis, viability</div>
                  </div>
                </a>
                <a class="action-card ${data.buildProposal ? '' : 'disabled'}"
                   ${data.buildProposal ? `href="reports/${data.buildProposal}" target="_blank"` : ''}
                   style="text-decoration:none;color:inherit">
                  <div class="action-icon proposal">&#128176;</div>
                  <div class="action-info">
                    <div class="action-name">Build Proposal</div>
                    <div class="action-desc">CapEx, OpEx, timeline, key decisions</div>
                  </div>
                </a>
              </div>
            </div>
          </div>

          <!-- Status Panel -->
          <div class="status-panel">
            ${statusRows.length > 0 ? `
            <div class="status-card">
              <div class="status-card-title">Current Activity</div>
              <div class="status-rows">
                ${statusRows.map(r => `
                  <div class="status-row">
                    <span class="label">${r.label}</span>
                    <span class="value ${r.cls}">${r.value}</span>
                  </div>`).join('')}
              </div>
            </div>` : ''}

            ${totalTasks > 0 ? `
            <div class="status-card">
              <div class="status-card-title">Build Progress</div>
              <div class="status-rows">
                <div class="status-row">
                  <span class="label">Tasks</span>
                  <span class="value">${completedTasks} / ${totalTasks}</span>
                </div>
              </div>
              <div class="progress-track">
                <div class="progress-fill" style="width: ${pct}%"></div>
              </div>
              <div class="progress-label">${pct}% complete</div>
            </div>` : ''}

            <div class="status-card">
              <div class="status-card-title">Gates</div>
              <div class="gate-list">
                ${gateItems.map(g => {
                  const status = gates[g.key];
                  const isApproved = status === 'approved';
                  const isCurrent = !isApproved && g.key === phaseNames[phaseInfo.index]?.toLowerCase();
                  return `
                    <div class="gate-item">
                      <div class="gate-icon ${isApproved ? 'pass' : (isCurrent ? 'active' : 'pending')}">
                        ${isApproved ? '&#10003;' : (isCurrent ? '&#9679;' : '')}
                      </div>
                      <span class="gate-label ${isApproved ? 'done' : ''}">${g.label}</span>
                    </div>`;
                }).join('')}
              </div>
            </div>

            <div class="status-card">
              <div class="status-card-title">Cost Tracker</div>
              <div class="status-rows">
                <div class="status-row">
                  <span class="label">Auto-approved</span>
                  <span class="value">$${totalAutoApproved}/mo</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }

  // --- Actions ---
  function openDemo(name) { openInNewTab('demos/' + name + '.html'); }

  function openReportViewer(url, title, projectName, type) {
    document.getElementById('report-title').textContent = title;
    document.getElementById('report-project').textContent = projectName;
    const icon = document.getElementById('report-icon');
    icon.className = 'report-header-icon ' + (type === 'proposal' ? 'proposal' : 'research');
    icon.innerHTML = type === 'proposal' ? '&#128176;' : '&#128200;';
    document.getElementById('report-frame').src = url;
    document.getElementById('report-newtab').onclick = () => window.open(url, '_blank');
    document.getElementById('report-overlay').classList.add('open');
  }

  function openInNewTab(url) {
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.rel = 'noopener';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function openReport(name, filename) {
    openInNewTab('reports/' + filename);
  }

  function openBuildProposal(name, filename) {
    openInNewTab('reports/' + filename);
  }

  async function openDoc(projectName, docName, displayName) {
    try {
      let md;
      if (window.__STATIC_MODE__) {
        const key = projectName + '/' + docName;
        md = window.__DOCS_DATA__[key];
        if (!md) throw new Error('Not found');
      } else {
        const res = await fetch('/api/project/' + projectName + '/doc/' + docName);
        if (!res.ok) throw new Error('Not found');
        md = await res.text();
      }
      document.getElementById('modal-title').textContent = displayName;
      document.getElementById('modal-body').innerHTML = marked.parse(md);
      document.getElementById('modal-overlay').classList.add('open');
    } catch (err) {
      alert('Could not load document: ' + err.message);
    }
  }

  // Modal close — doc viewer
  document.getElementById('modal-close').addEventListener('click', () => {
    document.getElementById('modal-overlay').classList.remove('open');
  });
  document.getElementById('modal-overlay').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) e.target.classList.remove('open');
  });

  // Modal close — report viewer
  document.getElementById('report-close').addEventListener('click', () => {
    document.getElementById('report-overlay').classList.remove('open');
    document.getElementById('report-frame').src = '';
  });
  document.getElementById('report-overlay').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      e.target.classList.remove('open');
      document.getElementById('report-frame').src = '';
    }
  });

  // Escape closes whichever modal is open
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.getElementById('modal-overlay').classList.remove('open');
      if (document.getElementById('report-overlay').classList.contains('open')) {
        document.getElementById('report-overlay').classList.remove('open');
        document.getElementById('report-frame').src = '';
      }
    }
  });

  // --- WebSocket for live updates ---
  function connectWS() {
    if (window.__STATIC_MODE__) return;
    try {
      const ws = new WebSocket('ws://' + location.host + '/ws');
      ws.onmessage = () => loadProjects();
      ws.onclose = () => setTimeout(connectWS, 3000);
      ws.onerror = () => {};
    } catch {}
  }

  // --- Mobile sidebar toggle ---
  const menuToggle = document.getElementById('menu-toggle');
  const sidebarEl = document.getElementById('sidebar');
  const backdrop = document.getElementById('sidebar-backdrop');

  function toggleSidebar() {
    sidebarEl.classList.toggle('open');
    backdrop.classList.toggle('open');
  }

  function closeSidebar() {
    sidebarEl.classList.remove('open');
    backdrop.classList.remove('open');
  }

  menuToggle.addEventListener('click', toggleSidebar);
  backdrop.addEventListener('click', closeSidebar);

  // Close sidebar on project select (mobile)
  const _origSelectProject = selectProject;
  selectProject = function(name) {
    closeSidebar();
    _origSelectProject(name);
  };

  const _origGoHome = goHome;
  goHome = function() {
    closeSidebar();
    _origGoHome();
  };

  // --- Init ---
  loadProjects();
  connectWS();
</script>

</body>
</html>
